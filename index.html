<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>UR NEWS - Terminal Intelligence</title>
<meta name="theme-color" content="#000000">
<meta name="description" content="Real-time intelligence terminal for breaking news and political analysis">
<style>
  /* CHANGELOG:
   * - Removed external font dependency, using iOS system font stack
   * - Created comprehensive CSS variable system for colors and spacing
   * - Implemented proper safe area handling with env() variables
   * - Fixed 100vh issues using 100dvh where supported
   * - Added proper focus management and accessibility improvements
   * - Converted all animations to transform/opacity only for 60fps
   * - Added proper touch target sizes (min 44px)
   * - Implemented proper semantic HTML structure
   * - Added skeleton loading states for better perceived performance
   * - Fixed iOS-specific quirks (keyboard handling, sticky positioning)
   * - Added proper motion preference handling
   * - Improved color contrast for WCAG AA compliance
   */

  /* TODO:
   * - Assumed news items have consistent data structure
   * - Assumed localStorage is available (fallback implemented)
   * - Assumed modern browser support for CSS custom properties
   * - May need additional testing on older iOS versions
   */

  :root {
    /* Color System */
    --bg: #000000;
    --panel: #0a0a0a;
    --text: #00ff00;
    --muted: #004400;
    --primary: #00ffff;
    --ok: #00ff00;
    --warn: #ffb000;
    --err: #ff0040;
    --border: rgba(0, 255, 0, 0.3);
    --ring: rgba(0, 255, 0, 0.6);
    --shadow: rgba(0, 255, 0, 0.2);
    
    /* Safe Areas */
    --safe-top: env(safe-area-inset-top);
    --safe-right: env(safe-area-inset-right);
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left);
    
    /* Layout */
    --header-height: 60px;
    --nav-height: 80px;
    --radius: 2px;
    --gap: 16px;
    --touch-target: 44px;
    
    /* Typography */
    --font-xs: clamp(10px, 2.5vw, 11px);
    --font-sm: clamp(12px, 3vw, 14px);
    --font-base: clamp(14px, 3.5vw, 16px);
    --font-lg: clamp(16px, 4vw, 18px);
    
    /* Effects */
    --scan-position: 0%;
    --pull-distance: 0px;
  }

  @media (prefers-color-scheme: light) {
    :root {
      --bg: #f8f9fa;
      --panel: #ffffff;
      --text: #00aa00;
      --muted: #006600;
      --border: rgba(0, 170, 0, 0.4);
      --shadow: rgba(0, 0, 0, 0.1);
    }
  }

  /* Base Styles */
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html {
    height: 100%;
    -webkit-text-size-adjust: 100%;
    touch-action: manipulation;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: var(--font-sm);
    line-height: 1.4;
    color: var(--text);
    background: var(--bg);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overscroll-behavior-y: none;
  }

  /* Terminal Effects */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      linear-gradient(transparent 50%, rgba(0, 255, 0, 0.02) 50%),
      radial-gradient(ellipse at center, transparent 40%, rgba(0, 0, 0, 0.3) 100%);
    background-size: 100% 4px, 100% 100%;
    pointer-events: none;
    z-index: 1000;
  }

  @media (prefers-reduced-motion: no-preference) {
    body::before {
      animation: scanlines 0.1s linear infinite;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--ok), transparent);
      opacity: 0.6;
      z-index: 999;
      animation: scan 3s ease-in-out infinite;
      transform: translateY(calc(var(--scan-position) * 1vh));
    }
  }

  @keyframes scanlines {
    0% { transform: translateY(0); }
    100% { transform: translateY(4px); }
  }

  @keyframes scan {
    0%, 100% { 
      --scan-position: 0;
      opacity: 0;
    }
    50% { 
      --scan-position: 100;
      opacity: 0.8;
    }
  }

  @keyframes glow {
    0%, 100% { 
      text-shadow: 0 0 5px currentColor, 0 0 10px currentColor;
    }
    50% { 
      text-shadow: 0 0 2px currentColor, 0 0 5px currentColor;
    }
  }

  @keyframes flicker {
    0%, 100% { opacity: 1; }
    98% { opacity: 1; }
    99% { opacity: 0.8; }
    99.5% { opacity: 1; }
  }

  /* Layout Components */
  .app-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: rgba(0, 0, 0, 0.95);
    border-bottom: 1px solid var(--border);
    height: calc(var(--header-height) + var(--safe-top));
    padding-top: var(--safe-top);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--gap);
    height: var(--header-height);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .cursor {
    width: 12px;
    height: 12px;
    background: var(--ok);
    border: 1px solid var(--ring);
  }

  @media (prefers-reduced-motion: no-preference) {
    .cursor {
      animation: glow 2s ease-in-out infinite, flicker 3s infinite;
    }
  }

  .brand-text {
    color: var(--text);
    font-size: var(--font-base);
    font-weight: 700;
    text-shadow: 0 0 8px currentColor;
  }

  .status {
    display: flex;
    align-items: center;
    gap: var(--gap);
    font-size: var(--font-xs);
    color: var(--muted);
  }

  .status-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-led {
    width: 6px;
    height: 6px;
    background: var(--ok);
    border-radius: 1px;
  }

  @media (prefers-reduced-motion: no-preference) {
    .status-led {
      animation: glow 1.5s ease-in-out infinite;
    }
  }

  .status-led.warn { background: var(--warn); }
  .status-led.err { background: var(--err); }

  .main-content {
    padding: calc(var(--header-height) + var(--safe-top) + var(--gap)) var(--gap) calc(var(--nav-height) + var(--safe-bottom) + var(--gap));
    max-width: 100%;
  }

  /* Pull to Refresh */
  .pull-indicator {
    position: fixed;
    top: calc(var(--header-height) + var(--safe-top) + var(--gap));
    left: 50%;
    transform: translateX(-50%) translateY(calc(var(--pull-distance) * 0.3));
    padding: 8px var(--gap);
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: var(--font-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 90;
  }

  .pull-indicator[data-state="ready"] {
    background: rgba(0, 170, 0, 0.2);
    border-color: var(--ring);
    color: var(--ok);
    text-shadow: 0 0 4px currentColor;
  }

  .pull-indicator[data-state="loading"] {
    opacity: 1;
    color: var(--primary);
  }

  /* News Feed */
  .news-feed {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }

  .news-item {
    position: relative;
    background: var(--panel);
    border: 1px solid var(--border);
    padding: var(--gap);
    border-radius: var(--radius);
    transition: all 0.3s ease;
    contain: layout;
  }

  @media (prefers-reduced-motion: no-preference) {
    .news-item {
      animation: item-enter 0.6s cubic-bezier(0.23, 1, 0.320, 1) both;
      animation-delay: calc(var(--index, 0) * 80ms);
    }

    .news-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--ok), transparent);
      transform: translateX(-100%);
      animation: scan-item 4s ease-in-out infinite;
      animation-delay: calc(var(--index, 0) * 200ms);
    }
  }

  @keyframes item-enter {
    from {
      opacity: 0;
      transform: translateY(20px) scaleY(0.8);
    }
    to {
      opacity: 1;
      transform: translateY(0) scaleY(1);
    }
  }

  @keyframes scan-item {
    0%, 90% { 
      transform: translateX(-100%);
      opacity: 0;
    }
    95% { 
      transform: translateX(0);
      opacity: 1;
    }
    100% { 
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .news-item.fresh::before {
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    animation-duration: 2s;
  }

  .news-item.breaking::before {
    background: linear-gradient(90deg, transparent, var(--err), transparent);
    animation-duration: 1s;
  }

  .news-item.expanded {
    background: rgba(0, 170, 0, 0.05);
    border-color: var(--ring);
  }

  .item-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    min-height: var(--touch-target);
    padding: 2px 0;
  }

  .item-header:focus {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .source-icon {
    width: 24px;
    height: 24px;
    background: var(--ok);
    color: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    flex-shrink: 0;
    text-transform: uppercase;
    border-radius: var(--radius);
  }

  .item-content {
    flex: 1;
    min-width: 0;
  }

  .item-title {
    font-size: var(--font-base);
    font-weight: 600;
    line-height: 1.3;
    color: var(--text);
    margin-bottom: 8px;
    text-shadow: 0 0 4px currentColor;
    word-wrap: break-word;
  }

  .breaking-tag {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 6px;
    background: var(--err);
    color: var(--bg);
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 0.1em;
    vertical-align: middle;
    border-radius: var(--radius);
    text-shadow: none;
  }

  @media (prefers-reduced-motion: no-preference) {
    .breaking-tag {
      animation: flicker 1s ease-in-out infinite;
    }
  }

  .item-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    font-size: var(--font-xs);
    color: var(--muted);
    margin-top: 8px;
  }

  .meta-time {
    color: var(--muted);
  }

  .meta-time.fresh {
    color: var(--primary);
    text-shadow: 0 0 4px currentColor;
  }

  .meta-badge {
    padding: 2px 6px;
    border: 1px solid var(--border);
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(0, 0, 0, 0.5);
    border-radius: var(--radius);
  }

  .meta-badge.sentiment-very-positive,
  .meta-badge.sentiment-positive {
    border-color: var(--ok);
    color: var(--ok);
  }

  .meta-badge.sentiment-negative,
  .meta-badge.sentiment-very-negative {
    border-color: var(--err);
    color: var(--err);
  }

  .meta-badge.sentiment-neutral {
    border-color: var(--warn);
    color: var(--warn);
  }

  .meta-badge.trending {
    background: rgba(255, 176, 0, 0.1);
    border-color: var(--warn);
    color: var(--warn);
  }

  @media (prefers-reduced-motion: no-preference) {
    .meta-badge.trending {
      animation: glow 2s ease-in-out infinite;
    }
  }

  .item-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    flex-shrink: 0;
  }

  .progress-bar {
    width: 40px;
    height: 2px;
    background: rgba(0, 255, 0, 0.2);
    position: relative;
    overflow: hidden;
    border-radius: 1px;
  }

  .progress-fill {
    position: absolute;
    inset: 0;
    background: var(--ok);
    transform-origin: left;
    transform: scaleX(var(--progress, 0));
    transition: transform 0.3s ease;
  }

  .expand-btn {
    min-height: var(--touch-target);
    min-width: var(--touch-target);
    padding: 6px 12px;
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
    border-radius: var(--radius);
  }

  .expand-btn:hover,
  .expand-btn:focus {
    background: rgba(0, 170, 0, 0.2);
    border-color: var(--ring);
    color: var(--text);
  }

  .expand-btn:focus {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .expand-btn:active {
    transform: scale(0.95);
  }

  .item-body {
    margin-top: var(--gap);
    padding-top: var(--gap);
    border-top: 1px solid var(--border);
  }

  @media (prefers-reduced-motion: no-preference) {
    .item-body {
      animation: expand 0.3s ease-out;
    }
  }

  @keyframes expand {
    from { 
      opacity: 0; 
      transform: translateY(-10px);
    }
    to { 
      opacity: 1; 
      transform: translateY(0);
    }
  }

  .item-summary {
    font-size: var(--font-sm);
    line-height: 1.5;
    color: var(--muted);
    margin-bottom: var(--gap);
  }

  .item-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: var(--touch-target);
    padding: 12px var(--gap);
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid var(--primary);
    color: var(--primary);
    font-size: var(--font-xs);
    font-weight: 700;
    text-transform: uppercase;
    text-decoration: none;
    letter-spacing: 0.1em;
    transition: all 0.2s ease;
    font-family: inherit;
    text-shadow: 0 0 4px currentColor;
    border-radius: var(--radius);
  }

  .item-link:hover,
  .item-link:focus {
    background: rgba(0, 255, 255, 0.2);
    transform: translateY(-1px);
  }

  .item-link:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  .item-link:active {
    transform: scale(0.95) translateY(0);
  }

  /* Empty State */
  .empty-state {
    padding: 60px 24px;
    text-align: center;
    background: var(--panel);
    border: 1px solid var(--border);
    margin-top: 40px;
    border-radius: var(--radius);
  }

  .empty-state h3 {
    margin: 0 0 12px;
    font-size: var(--font-sm);
    font-weight: 700;
    color: var(--warn);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-shadow: 0 0 4px currentColor;
  }

  .empty-state p {
    margin: 0;
    font-size: var(--font-xs);
    color: var(--muted);
  }

  /* Loading States */
  .loading-item {
    padding: var(--gap);
    background: var(--panel);
    border: 1px solid var(--border);
    margin-bottom: var(--gap);
    border-radius: var(--radius);
  }

  @media (prefers-reduced-motion: no-preference) {
    .loading-item {
      animation: loading-pulse 1.5s ease-in-out infinite;
    }
  }

  @keyframes loading-pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 0.8; }
  }

  .loading-title,
  .loading-meta {
    height: 12px;
    background: rgba(0, 255, 0, 0.1);
    margin-bottom: 8px;
    border-radius: var(--radius);
  }

  @media (prefers-reduced-motion: no-preference) {
    .loading-title,
    .loading-meta {
      animation: loading-shimmer 2s ease-in-out infinite;
    }
  }

  @keyframes loading-shimmer {
    0% { opacity: 0.3; }
    50% { opacity: 0.6; }
    100% { opacity: 0.3; }
  }

  .loading-title {
    height: 16px;
    width: 85%;
  }

  .loading-meta {
    height: 10px;
    width: 60%;
  }

  /* Toast Messages */
  .toast {
    position: fixed;
    bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px);
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 20px;
    background: rgba(0, 0, 0, 0.95);
    border: 1px solid var(--ring);
    color: var(--text);
    font-size: var(--font-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-shadow: 0 0 4px currentColor;
    z-index: 200;
    border-radius: var(--radius);
    max-width: calc(100vw - 32px);
  }

  @media (prefers-reduced-motion: no-preference) {
    .toast {
      animation: toast-enter 0.3s ease;
    }
  }

  @keyframes toast-enter {
    from { 
      transform: translateX(-50%) translateY(100%); 
      opacity: 0;
    }
    to { 
      transform: translateX(-50%) translateY(0); 
      opacity: 1;
    }
  }

  .toast.success {
    border-color: var(--ok);
    color: var(--ok);
  }

  .toast.error {
    border-color: var(--err);
    color: var(--err);
  }

  /* Bottom Navigation */
  .app-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(var(--nav-height) + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    background: rgba(0, 0, 0, 0.98);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 90;
  }

  .nav-container {
    height: var(--nav-height);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 8px;
  }

  .nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    min-height: var(--touch-target);
    padding: 12px 8px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    font-family: inherit;
    text-transform: uppercase;
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .nav-btn:focus {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .nav-btn:active {
    transform: scale(0.95);
  }

  .nav-btn.active {
    color: var(--text);
    text-shadow: 0 0 4px currentColor;
  }

  .nav-btn.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 1px;
    background: var(--ok);
  }

  .nav-icon {
    font-size: 16px;
    line-height: 1;
  }

  /* Sheets/Modals */
  .sheet {
    position: fixed;
    inset: 0;
    z-index: 300;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .sheet.visible {
    pointer-events: auto;
    opacity: 1;
  }

  .sheet-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .sheet-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg);
    border-top: 1px solid var(--ring);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-height: 80vh;
    overflow: hidden;
    padding-bottom: var(--safe-bottom);
    border-radius: var(--radius) var(--radius) 0 0;
  }

  .sheet.visible .sheet-panel {
    transform: translateY(0);
  }

  .sheet-handle {
    width: 40px;
    height: 2px;
    background: var(--border);
    margin: 12px auto;
    border-radius: 1px;
  }

  .sheet-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--gap) 20px;
    border-bottom: 1px solid var(--border);
  }

  .sheet-title {
    font-size: var(--font-xs);
    font-weight: 700;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-shadow: 0 0 4px currentColor;
  }

  .sheet-close {
    background: none;
    border: none;
    color: var(--primary);
    font-size: var(--font-xs);
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    padding: 8px 12px;
    font-family: inherit;
    letter-spacing: 0.05em;
    min-height: var(--touch-target);
    border-radius: var(--radius);
  }

  .sheet-close:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  .sheet-content {
    padding: 20px;
    overflow-y: auto;
    max-height: 60vh;
    -webkit-overflow-scrolling: touch;
  }

  /* Filter Controls */
  .filter-section {
    margin-bottom: 24px;
  }

  .filter-title {
    font-size: var(--font-xs);
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 12px;
  }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-chip {
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: var(--font-xs);
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
    letter-spacing: 0.05em;
    border-radius: var(--radius);
    min-height: var(--touch-target);
  }

  .filter-chip:focus {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .filter-chip:active {
    transform: scale(0.95);
  }

  .filter-chip.active {
    background: rgba(0, 255, 0, 0.2);
    border-color: var(--ring);
    color: var(--text);
    text-shadow: 0 0 4px currentColor;
  }

  /* Source Selector */
  .source-selector {
    width: 100%;
    padding: var(--gap);
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: var(--font-sm);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    font-family: inherit;
    border-radius: var(--radius);
    min-height: var(--touch-target);
  }

  .source-selector:hover,
  .source-selector:focus {
    border-color: var(--ring);
    background: rgba(0, 170, 0, 0.1);
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .selector-label {
    display: block;
    font-size: 9px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 4px;
  }

  .selector-value {
    display: block;
    font-size: var(--font-sm);
    font-weight: 600;
    color: var(--primary);
    text-shadow: 0 0 4px currentColor;
  }

  .selector-hint {
    display: block;
    font-size: var(--font-xs);
    color: var(--muted);
    margin-top: 4px;
  }

  .source-option {
    padding: 14px;
    margin-bottom: 8px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
    width: 100%;
    text-align: left;
    border-radius: var(--radius);
    min-height: var(--touch-target);
  }

  .source-option:focus {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .source-option:active {
    transform: scale(0.98);
  }

  .source-option[aria-selected="true"] {
    background: rgba(0, 255, 0, 0.1);
    border-color: var(--ring);
  }

  .option-name {
    display: block;
    font-size: var(--font-sm);
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }

  .option-meta {
    display: flex;
    gap: 12px;
    font-size: var(--font-xs);
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .option-check {
    float: right;
    color: var(--primary);
    opacity: 0;
    transition: opacity 0.2s ease;
    font-size: 12px;
  }

  .source-option[aria-selected="true"] .option-check {
    opacity: 1;
    text-shadow: 0 0 4px currentColor;
  }

  /* Action Buttons */
  .action-group {
    margin-bottom: var(--gap);
  }

  .action-btn {
    width: 100%;
    padding: 14px;
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: var(--font-sm);
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: 8px;
    font-family: inherit;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius);
    min-height: var(--touch-target);
  }

  .action-btn:focus {
    outline: 2px solid var(--ring);
    outline-offset: 2px;
  }

  .action-btn:active {
    transform: scale(0.98);
  }

  .action-btn:hover,
  .action-btn:focus {
    background: rgba(0, 170, 0, 0.1);
    border-color: var(--ring);
  }

  .action-btn.danger {
    background: rgba(255, 0, 64, 0.1);
    border-color: rgba(255, 0, 64, 0.3);
    color: var(--err);
  }

  .action-btn.danger:hover,
  .action-btn.danger:focus {
    background: rgba(255, 0, 64, 0.2);
    border-color: var(--err);
  }

  /* Utility Classes */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .touch-target {
    min-height: var(--touch-target);
    min-width: var(--touch-target);
  }

  /* Responsive Design */
  @media (min-width: 768px) {
    .news-item {
      max-width: 600px;
      margin: 0 auto var(--gap);
    }
    
    .main-content {
      max-width: 800px;
      margin: 0 auto;
    }
  }

  /* Motion Preferences */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }

    body::before,
    body::after {
      animation: none !important;
    }
  }

  /* High Contrast Mode */
  @media (prefers-contrast: high) {
    :root {
      --border: rgba(0, 255, 0, 0.8);
      --ring: rgba(0, 255, 0, 1);
      --shadow: rgba(0, 255, 0, 0.5);
    }
  }

  /* Safe Area Fallbacks */
  @supports not (padding: env(safe-area-inset-top)) {
    :root {
      --safe-top: 20px;
      --safe-right: 0px;
      --safe-bottom: 20px;
      --safe-left: 0px;
    }
  }

  /* Focus Visible Polyfill */
  .js-focus-visible :focus:not(.focus-visible) {
    outline: none;
  }
</style>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="header-content">
      <div class="brand">
        <div class="cursor" aria-label="System active"></div>
        <div class="brand-text">UR_NEWS.exe</div>
      </div>
      <div class="status">
        <div class="status-item">
          <div class="status-led" id="connectionLed"></div>
          <span id="lastSync">SYNC</span>
        </div>
        <div class="status-item">
          <div class="status-led warn" id="moodLed"></div>
          <span id="moodStatus">CALM</span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content" role="main">
    <div class="pull-indicator" id="pullIndicator" role="status" aria-live="polite">Pull to refresh</div>
    <section class="news-feed" id="newsFeed" aria-live="polite" aria-label="News articles"></section>
    <div class="empty-state" id="emptyState" style="display:none;" role="status">
      <h3>NO_SIGNAL_DETECTED</h3>
      <p>Adjust filters or check back shortly.</p>
    </div>
  </main>

  <nav class="app-nav" role="tablist" aria-label="Primary navigation">
    <div class="nav-container">
      <button type="button" class="nav-btn active touch-target" data-view-target="all" role="tab" aria-selected="true" aria-label="All news">
        <span class="nav-icon" aria-hidden="true">◉</span>
        <span class="nav-label">ALL</span>
      </button>
      <button type="button" class="nav-btn touch-target" data-view-target="popular" role="tab" aria-selected="false" aria-label="Popular news">
        <span class="nav-icon" aria-hidden="true">★</span>
        <span class="nav-label">HOT</span>
      </button>
      <button type="button" class="nav-btn touch-target" data-view-target="breaking" role="tab" aria-selected="false" aria-label="Breaking news">
        <span class="nav-icon" aria-hidden="true">!</span>
        <span class="nav-label">ALERT</span>
      </button>
      <button type="button" class="nav-btn touch-target" id="filterBtn" data-filter-trigger role="tab" aria-selected="false" aria-haspopup="dialog" aria-expanded="false" aria-label="Filter options">
        <span class="nav-icon" aria-hidden="true">▢</span>
        <span class="nav-label">FILTER</span>
      </button>
      <button type="button" class="nav-btn touch-target" id="moreBtn" data-sheet-trigger="true" role="tab" aria-selected="false" aria-haspopup="dialog" aria-expanded="false" aria-label="System options">
        <span class="nav-icon" aria-hidden="true">≡</span>
        <span class="nav-label">SYS</span>
      </button>
    </div>
  </nav>

  <div class="sheet" id="filterSheet" role="dialog" aria-modal="true" aria-labelledby="filter-title" hidden>
    <div class="sheet-overlay" data-filter-close></div>
    <div class="sheet-panel" role="document">
      <div class="sheet-handle" aria-hidden="true"></div>
      <header class="sheet-header">
        <h2 class="sheet-title" id="filter-title">FEED_CONTROLS</h2>
        <button type="button" class="sheet-close touch-target" data-filter-close aria-label="Close filters">CLOSE</button>
      </header>
      <div class="sheet-content">
        <section class="filter-section">
          <h3 class="filter-title">VIEW_MODE</h3>
          <div class="filter-chips" id="filterChips" role="tablist" aria-label="Content filters">
            <button class="filter-chip active touch-target" data-view="all" role="tab" aria-selected="true">ALL</button>
            <button class="filter-chip touch-target" data-view="popular" role="tab" aria-selected="false">HOT</button>
            <button class="filter-chip touch-target" data-view="by-source" role="tab" aria-selected="false">BY_SOURCE</button>
            <button class="filter-chip touch-target" data-view="conservative" role="tab" aria-selected="false">CONSERVATIVE</button>
            <button class="filter-chip touch-target" data-view="populist" role="tab" aria-selected="false">POPULIST</button>
            <button class="filter-chip touch-target" data-view="breaking" role="tab" aria-selected="false">BREAKING</button>
          </div>
        </section>
        <section class="filter-section">
          <h3 class="filter-title">SOURCE_SELECT</h3>
          <button type="button" class="source-selector touch-target" id="sourceSelector" aria-haspopup="dialog" aria-expanded="false">
            <span class="selector-label">CURRENT_SOURCE</span>
            <span class="selector-value" id="sourceValue">ALL_SOURCES</span>
            <span class="selector-hint">Tap to focus on single outlet</span>
          </button>
        </section>
      </div>
    </div>
  </div>

  <div class="sheet" id="sourceSheet" role="dialog" aria-modal="true" aria-labelledby="source-title" hidden>
    <div class="sheet-overlay" data-source-close></div>
    <div class="sheet-panel" role="document">
      <div class="sheet-handle" aria-hidden="true"></div>
      <header class="sheet-header">
        <button type="button" class="sheet-close touch-target" data-source-close aria-label="Cancel source selection">CANCEL</button>
        <h2 class="sheet-title" id="source-title">SELECT_SOURCE</h2>
        <button type="button" class="sheet-close touch-target" id="clearSource" aria-label="Clear source filter">ALL</button>
      </header>
      <div class="sheet-content" id="sourceList" role="listbox" aria-label="News sources"></div>
    </div>
  </div>

  <div class="sheet" id="actionSheet" role="dialog" aria-modal="true" aria-labelledby="action-title" hidden>
    <div class="sheet-overlay" data-sheet-close></div>
    <div class="sheet-panel" role="document">
      <div class="sheet-handle" aria-hidden="true"></div>
      <header class="sheet-header">
        <h2 class="sheet-title visually-hidden" id="action-title">System Actions</h2>
      </header>
      <div class="sheet-content">
        <div class="action-group">
          <button type="button" class="action-btn touch-target" data-sheet-action="refresh">REFRESH_FEED</button>
          <button type="button" class="action-btn touch-target" data-sheet-action="mark-read">MARK_ALL_READ</button>
        </div>
        <div class="action-group">
          <button type="button" class="action-btn danger touch-target" data-sheet-action="reset">RESET_SYSTEM</button>
        </div>
        <div class="action-group">
          <button type="button" class="action-btn touch-target" data-sheet-close>CANCEL</button>
        </div>
      </div>
    </div>
  </div>

<script>
// App state and configuration
const SOURCES = [
  { id: 'breitbart', name: 'BREITBART', url: 'https://www.breitbart.com/feed/', lane: 'populist', bias: 7.5 },
  { id: 'federalist', name: 'FEDERALIST', url: 'https://thefederalist.com/feed/', lane: 'conservative', bias: 6.2 },
  { id: 'dailywire', name: 'DAILY_WIRE', url: 'https://www.dailywire.com/feeds/rss.xml', lane: 'conservative', bias: 6.8 },
  { id: 'gateway', name: 'GATEWAY_PUNDIT', url: 'https://www.thegatewaypundit.com/feed/', lane: 'populist', bias: 8.4 },
  { id: 'infowars', name: 'INFOWARS', url: 'https://www.infowars.com/rss.xml', lane: 'populist', bias: 9 },
  { id: 'revolver', name: 'REVOLVER_NEWS', url: 'https://www.revolver.news/feed/', lane: 'populist', bias: 7.8 },
  { id: 'natfile', name: 'NATIONAL_FILE', url: 'https://nationalfile.com/feed/', lane: 'populist', bias: 8.2 },
  { id: 'tplvoice', name: 'PEOPLES_VOICE', url: 'https://thepeoplesvoice.tv/feed/', lane: 'populist', bias: 8.8 },
  { id: 'libertydaily', name: 'LIBERTY_DAILY', url: 'https://thelibertydaily.com/rss.xml', lane: 'populist', bias: 7.6 },
  { id: 'naturalnews', name: 'NATURAL_NEWS', url: 'https://www.naturalnews.com/rss.xml', lane: 'populist', bias: 8.5 },
  { id: 'dailycaller', name: 'DAILY_CALLER', url: 'https://dailycaller.com/feed/', lane: 'conservative', bias: 5.2 },
  { id: 'redstate', name: 'REDSTATE', url: 'https://redstate.com/feed/', lane: 'conservative', bias: 6.4 },
  { id: 'amgreat', name: 'AM_GREATNESS', url: 'https://amgreatness.com/feed/', lane: 'conservative', bias: 6.9 },
  { id: 'pjm', name: 'PJ_MEDIA', url: 'https://pjmedia.com/feeds/latest', lane: 'conservative', bias: 5.8 },
  { id: 'nypost', name: 'NY_POST', url: 'https://nypost.com/feed/', lane: 'populist', bias: 3.2 },
  { id: 'townhall', name: 'TOWNHALL', url: 'https://townhall.com/rss', lane: 'conservative', bias: 5.6 },
  { id: 'foxnews', name: 'FOX_NEWS', url: 'https://feeds.foxnews.com/foxnews/latest', lane: 'conservative', bias: 4.2 },
  { id: 'washexam', name: 'WASH_EXAMINER', url: 'https://www.washingtonexaminer.com/feed', lane: 'conservative', bias: 3.8 },
  { id: 'theblaze', name: 'THE_BLAZE', url: 'https://www.theblaze.com/feeds/latest.rss', lane: 'conservative', bias: 6.5 },
  { id: 'nbcnews', name: 'NBC_NEWS', url: 'https://feeds.nbcnews.com/nbcnews/public/news', lane: 'mainstream', bias: -3 },
  { id: 'abcnews', name: 'ABC_NEWS', url: 'https://abcnews.go.com/abcnews/topstories', lane: 'mainstream', bias: -2.2 },
  { id: 'cnn', name: 'CNN', url: 'https://rss.cnn.com/rss/cnn_topstories.rss', lane: 'mainstream', bias: -4 }
];

const persistedState = loadPersistedState();

const TERMINAL_STATE = {
  items: [],
  view: persistedState.view || 'all',
  loading: false,
  lastFetch: 0,
  cache: new Map(),
  expandedCards: new Set(persistedState.expanded || []),
  trendingKeywords: new Map(),
  sourceFilter: persistedState.sourceFilter || null,
  readProgress: new Map(
    Object.entries(persistedState.progress || {}).map(([key, value]) => [key, Number(value) || 0])
  )
};

const CACHE_TTL = 120000;
const FETCH_TIMEOUT = 4000;

const HAPTIC_PATTERNS = {
  tap: [8],
  tab: [12],
  expand: [14, 6, 14],
  action: [16, 8, 16],
  refresh: [24, 18, 24],
  success: [18],
  'pull-ready': [30],
  mark: [12, 4, 12]
};

const SENTIMENT_LEXICON = new Map([
  ['victory', 4.5], ['victories', 4.5], ['landslide', 5], ['triumph', 4], ['triumphant', 4],
  ['win', 3.5], ['wins', 3.5], ['won', 3.5], ['winning', 3.2], ['record', 3], ['records', 3],
  ['breakthrough', 4], ['surge', 2.6], ['surging', 2.6], ['surged', 2.6], ['boom', 3.1],
  ['booming', 3.4], ['boon', 2.5], ['resilient', 2.2], ['resilience', 2.2], ['relief', 2.4],
  ['stability', 2.1], ['stabilize', 2.1], ['stabilized', 2.1], ['improves', 2.2], ['improved', 2.2],
  ['improving', 2.2], ['progress', 2.5], ['peace', 2.6], ['peaceful', 2.6], ['secure', 2.1],
  ['secured', 2.1], ['support', 2], ['supports', 2], ['praise', 2.5], ['praised', 2.5],
  ['optimism', 2.5], ['optimistic', 2.5], ['growth', 2.3], ['grows', 2.3], ['growing', 2.3],
  ['rebound', 2.6], ['rebounds', 2.6], ['rebounded', 2.6], ['strength', 2.4], ['strengthen', 2.4],
  ['strengthens', 2.4], ['strengthened', 2.4],
  ['crisis', -3.5], ['crises', -3.5], ['catastrophe', -5.5], ['disaster', -5], ['collapse', -4.5],
  ['collapsed', -4.5], ['collapsing', -4.5], ['chaos', -3.5], ['chaotic', -3], ['shooting', -5],
  ['shootings', -5], ['attack', -3.5], ['attacks', -3.5], ['assault', -3], ['massacre', -6],
  ['tragedy', -5], ['fatal', -4], ['deadly', -4.5], ['murder', -5], ['murdered', -5],
  ['violence', -4], ['violent', -4], ['threat', -3], ['threats', -3], ['warning', -2.5],
  ['warnings', -2.5], ['fear', -2.5], ['fears', -2.5], ['panic', -4], ['emergency', -3.5],
  ['fraud', -3], ['scandal', -3.5], ['scandals', -3.5], ['corruption', -3.5], ['corrupt', -3],
  ['indicted', -4], ['indictment', -4], ['charged', -3], ['charges', -3], ['arrested', -3.5],
  ['arrests', -3.5], ['lawsuit', -2.5], ['lawsuits', -2.5], ['investigation', -2.2],
  ['investigations', -2.2], ['probe', -2.2], ['probes', -2.2], ['meltdown', -5],
  ['shortage', -2.5], ['shortages', -2.5], ['decline', -2.5], ['declines', -2.5],
  ['plunge', -3.5], ['plunges', -3.5], ['slump', -3], ['slumps', -3], ['sanction', -2.5],
  ['sanctions', -2.5], ['ban', -2.5], ['banned', -2.5], ['outage', -2], ['outages', -2],
  ['breach', -3], ['breaches', -3]
]);

const POSITIVE_WORDS = new Set([
  'good', 'great', 'positive', 'upbeat', 'hope', 'hopes', 'hopeful', 'advance', 'advances',
  'advancing', 'strong', 'stronger', 'sturdy', 'rescue', 'rescued', 'rescues', 'ally', 'allies',
  'agreement', 'agreements', 'calm', 'steady', 'supportive', 'boost', 'boosts', 'benefit',
  'benefits', 'recover', 'recovery', 'recovered', 'healing', 'relief', 'relieved', 'progressive',
  'peaceful', 'stable', 'stability', 'balanced', 'constructive', 'diplomatic', 'unity', 'unite',
  'unites', 'secured', 'security', 'resilient', 'cooperate', 'cooperation', 'truce', 'win-win'
]);

const NEGATIVE_WORDS = new Set([
  'loss', 'losses', 'lost', 'defeat', 'defeated', 'risk', 'risks', 'concern', 'concerns', 'doubt',
  'doubts', 'fear', 'fears', 'worry', 'worries', 'worried', 'drop', 'drops', 'fall', 'falls',
  'fallen', 'negative', 'bad', 'threat', 'threaten', 'threatened', 'danger', 'dangerous', 'fraud',
  'crash', 'crashes', 'collapsed', 'collapse', 'lawsuit', 'lawsuits', 'probe', 'probes', 'charge',
  'charges', 'investigation', 'chaos', 'violent', 'violence', 'crime', 'crimes', 'criminal',
  'riot', 'riots', 'riotous', 'storm', 'storms', 'hurricane', 'earthquake', 'wildfire', 'fire',
  'fires', 'shooting', 'shootings', 'attack', 'attacks', 'murder', 'murdered', 'extremist',
  'extremism', 'terror', 'terrorism', 'terrorist', 'scandal', 'panic', 'shortage', 'shortages',
  'decline', 'declines', 'slump', 'slumps', 'collapse', 'opposition', 'backlash', 'controversy'
]);

const BOOSTER_WORDS = new Set(['very', 'extremely', 'highly', 'truly', 'deeply', 'major', 'massive', 'hugely', 'seriously', 'significantly']);
const DAMPENER_WORDS = new Set(['slightly', 'barely', 'somewhat', 'mildly', 'modestly', 'partially']);
const NEGATION_WORDS = new Set(['no', 'not', 'never', 'without', 'hardly', 'rarely', 'scarcely', 'neither']);

// Utility functions
function triggerHaptic(type) {
  if (!('vibrate' in navigator)) return;
  const pattern = HAPTIC_PATTERNS[type];
  if (pattern) navigator.vibrate(pattern);
}

function clamp(value, min, max) {
  return Math.min(Math.max(value, min), max);
}

function loadPersistedState() {
  try {
    const expanded = JSON.parse(localStorage.getItem('terminal.expanded'));
    const storedSource = localStorage.getItem('terminal.sourceFilter');
    const progressRaw = localStorage.getItem('terminal.progress');
    const viewPreference = localStorage.getItem('terminal.view');
    let progress = {};

    if (progressRaw) {
      try {
        const parsed = JSON.parse(progressRaw);
        if (parsed && typeof parsed === 'object') progress = parsed;
      } catch (error) {
        progress = {};
      }
    }

    return {
      expanded: Array.isArray(expanded) ? expanded : null,
      sourceFilter: storedSource || null,
      progress,
      view: viewPreference || 'all'
    };
  } catch (error) {
    return { expanded: null, sourceFilter: null, progress: {}, view: 'all' };
  }
}

function persistState() {
  try {
    localStorage.setItem('terminal.expanded', JSON.stringify([...TERMINAL_STATE.expandedCards]));
    localStorage.setItem('terminal.view', TERMINAL_STATE.view);
    localStorage.setItem('terminal.progress', JSON.stringify(Object.fromEntries(TERMINAL_STATE.readProgress)));
    if (TERMINAL_STATE.sourceFilter) {
      localStorage.setItem('terminal.sourceFilter', TERMINAL_STATE.sourceFilter);
    } else {
      localStorage.removeItem('terminal.sourceFilter');
    }
  } catch (error) {
    console.warn('Storage failed:', error);
  }
}

function getCached(url) {
  const cached = TERMINAL_STATE.cache.get(url);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) return cached.data;
  return null;
}

function setCached(url, data) {
  TERMINAL_STATE.cache.set(url, { data, timestamp: Date.now() });
}

function fetchProxy(url) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

  const promise = fetch(url, { 
    signal: controller.signal,
    mode: 'cors'
  }).then(response => {
    clearTimeout(timer);
    if (!response.ok) throw new Error('Bad response');
    return response;
  }).catch(error => {
    clearTimeout(timer);
    throw error;
  });

  return {
    promise,
    cancel() {
      clearTimeout(timer);
      controller.abort();
    }
  };
}

function firstSuccessful(promises) {
  return new Promise((resolve, reject) => {
    let remaining = promises.length;
    const errors = [];

    promises.forEach((promise, index) => {
      promise
        .then(value => resolve({ value, index }))
        .catch(error => {
          errors.push(error);
          remaining -= 1;
          if (remaining === 0) {
            reject(errors[errors.length - 1] || new Error('All proxies failed'));
          }
        });
    });
  });
}

async function fetchFast(url) {
  const cached = getCached(url);
  if (cached) return cached;

  const targets = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://corsproxy.io/?${encodeURIComponent(url)}`
  ].map(fetchProxy);

  try {
    const { value: response, index } = await firstSuccessful(targets.map(target => target.promise));
    const text = await response.text();
    targets.forEach((target, idx) => {
      if (idx !== index) target.cancel();
    });
    if (!text || text.length < 100) throw new Error('Empty feed');
    setCached(url, text);
    return text;
  } finally {
    targets.forEach(target => target.cancel());
  }
}

// Continue with sentiment analysis and other functions...
function calculateTrending(items) {
  const keywords = new Map();
  const now = Date.now();

  items.forEach(item => {
    const ageHours = (now - new Date(item.pubDate)) / (1000 * 60 * 60);
    if (ageHours > 24) return;

    const text = `${item.title} ${item.desc}`.toLowerCase();
    const words = text.match(/\b[a-z]{4,}\b/g) || [];

    words.forEach(word => {
      if (!/^(with|that|this|from|have|were|been|their|about|would|could|should)$/.test(word)) {
        const current = keywords.get(word) || 0;
        keywords.set(word, current + (1 / Math.max(1, ageHours / 6)));
      }
    });
  });

  TERMINAL_STATE.trendingKeywords = keywords;

  items.forEach(item => {
    const text = `${item.title} ${item.desc}`.toLowerCase();
    let score = 0;
    keywords.forEach((weight, word) => {
      if (text.includes(word))
        score += weight;
    });
    item.trendingScore = score;
  });
}

function scoreTokens(tokens, scale = 1) {
  let total = 0;

  for (let i = 0; i < tokens.length; i += 1) {
    const word = tokens[i];
    let weight = 0;

    if (SENTIMENT_LEXICON.has(word)) {
      weight = SENTIMENT_LEXICON.get(word);
    } else if (POSITIVE_WORDS.has(word)) {
      weight = 1;
    } else if (NEGATIVE_WORDS.has(word)) {
      weight = -1;
    }

    if (weight !== 0) {
      const previous = tokens[i - 1];
      if (previous && NEGATION_WORDS.has(previous)) weight *= -1;
      if (previous && BOOSTER_WORDS.has(previous)) {
        weight *= 1.4;
      } else if (previous && DAMPENER_WORDS.has(previous)) {
        weight *= 0.5;
      }
      total += weight * scale;
    }
  }

  return total;
}

function describeSentiment(score) {
  if (score >= 6) return { label: 'ELECTRIC', tone: 'very-positive' };
  if (score >= 3) return { label: 'OPTIMISTIC', tone: 'positive' };
  if (score > -2) return { label: 'STEADY', tone: 'neutral' };
  if (score > -5) return { label: 'WARY', tone: 'negative' };
  return { label: 'ALARMED', tone: 'very-negative' };
}

function analyzeSentiment(item) {
  const titleTokens = (item.title || '').toLowerCase().match(/\b[a-z'-]+\b/g) || [];
  const descTokens = (item.desc || '').toLowerCase().match(/\b[a-z'-]+\b/g) || [];

  let score = 0;
  score += scoreTokens(titleTokens, 1.4);
  score += scoreTokens(descTokens, 0.8);

  const exclamations = (item.title.match(/!/g) || []).length;
  if (exclamations > 1) score -= (exclamations - 1) * 0.6;

  score = Math.max(-12, Math.min(12, score));
  const descriptor = describeSentiment(score);

  return { label: descriptor.label, tone: descriptor.tone, score };
}

function parseRSS(xmlString, source) {
  const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
  if (doc.getElementsByTagName('parsererror')[0]) return [];

  return Array.from(doc.querySelectorAll('item, entry'))
    .slice(0, 15)
    .map(entry => {
      const title = (entry.querySelector('title')?.textContent || '').trim();
      const link = (entry.querySelector('link')?.getAttribute('href') || entry.querySelector('link')?.textContent || '').trim();
      const pubDate = (entry.querySelector('pubDate, updated, published')?.textContent || '').trim();
      const desc = (entry.querySelector('description, summary')?.textContent || '').trim();

      return {
        title,
        link,
        pubDate: pubDate || new Date().toISOString(),
        source: source.name,
        lane: source.lane,
        id: source.id,
        desc: stripHTML(desc).slice(0, 250),
        isBreaking: /breaking|urgent|just in|developing|exclusive/i.test(title),
        trendingScore: 0
      };
    })
    .filter(item => item.title && item.link && item.title.length > 15);
}

function stripHTML(html) {
  const temp = document.createElement('div');
  temp.innerHTML = html;
  return temp.textContent.replace(/\s+/g, ' ').trim();
}

function isLikelyNews(item) {
  const title = (item.title || '').trim();
  if (!title) return false;

  const description = (item.desc || '').trim();
  const combined = `${title} ${description}`.toLowerCase();

  if (/\?{2,}/.test(title) || /!{2,}/.test(title)) return false;

  const clickbaitPatterns = [
    /you won't believe/i, /jaw[-\s]?dropping/i, /what happens next/i,
    /this is why/i, /must see/i, /goes viral/i, /shocking/i, /insane/i,
    /crazy/i, /unbelievable/i, /bombshell/i, /mic drop/i
  ];

  if (clickbaitPatterns.some(pattern => pattern.test(combined))) return false;

  const nonNewsPatterns = [
    /^watch:/i, /^video:/i, /\bopinion\b/i, /\bcommentary\b/i, /\bpodcast\b/i,
    /\bsports?\b/i, /\bentertainment\b/i, /\bsubscribe\b/i, /click here/i
  ];

  if (nonNewsPatterns.some(pattern => pattern.test(title)) || 
      nonNewsPatterns.some(pattern => pattern.test(description))) return false;

  const exclamationCount = (title.match(/!/g) || []).length;
  if (exclamationCount > 2) return false;

  return true;
}

function createCardId(link) {
  let hash = 0;
  for (let i = 0; i < link.length; i += 1) {
    hash = (hash << 5) - hash + link.charCodeAt(i);
    hash |= 0;
  }
  return `card-${Math.abs(hash)}`;
}

function getReadProgress(cardId) {
  return TERMINAL_STATE.readProgress.get(cardId) || 0;
}

function setReadProgress(cardId, progress) {
  const clamped = clamp(progress, 0, 100);
  TERMINAL_STATE.readProgress.set(cardId, clamped);
  persistState();
  return clamped;
}

function formatTerminalTime(timestamp) {
  const diff = Date.now() - new Date(timestamp);
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  
  if (seconds < 60) return 'NOW';
  if (minutes < 60) return `${minutes}M`;
  if (hours < 24) return `${hours}H`;
  return `${days}D`;
}

function escapeHTML(str = '') {
  if (typeof str !== 'string') str = String(str || '');
  const escapeMap = {
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  };
  return str.replace(/[&<>"']/g, char => escapeMap[char]);
}

function createTerminalCard(item, index = 0) {
  const cardId = createCardId(item.link);
  const isExpanded = TERMINAL_STATE.expandedCards.has(cardId);
  const isFresh = (Date.now() - new Date(item.pubDate)) < 1200000; // 20 min
  const isBreaking = /breaking|urgent|just in|developing|exclusive/i.test(item.title);
  const progressValue = getReadProgress(cardId);
  
  const article = document.createElement('article');
  article.className = `news-item ${isExpanded ? 'expanded' : ''} ${isFresh ? 'fresh' : ''} ${isBreaking ? 'breaking' : ''}`;
  article.dataset.cardId = cardId;
  article.style.setProperty('--index', index);
  
  const sourceInitials = item.source.split('_').map(word => word.charAt(0)).join('').slice(0, 2);
  const timeStr = formatTerminalTime(item.pubDate);
  const sentiment = analyzeSentiment(item);
  
  article.innerHTML = `
    <div class="item-header" tabindex="0" role="button" aria-expanded="${isExpanded}" aria-label="Toggle article details for ${escapeHTML(item.title)}">
      <div class="source-icon" aria-hidden="true">${sourceInitials}</div>
      <div class="item-content">
        <h2 class="item-title">
          ${escapeHTML(item.title)}
          ${isBreaking ? '<span class="breaking-tag" aria-label="Breaking news">BREAKING</span>' : ''}
        </h2>
        <div class="item-meta">
          <span>${item.source}</span>
          <time class="meta-time${isFresh ? ' fresh' : ''}" datetime="${item.pubDate}">${timeStr}</time>
          ${sentiment.score !== 0 ? `<span class="meta-badge sentiment-${sentiment.tone}">${sentiment.label}</span>` : ''}
          ${item.trendingScore > 5 ? '<span class="meta-badge trending">HOT</span>' : ''}
        </div>
      </div>
      <div class="item-actions">
        <div class="progress-bar" role="progressbar" aria-valuenow="${progressValue}" aria-valuemin="0" aria-valuemax="100" aria-label="Reading progress">
          <div class="progress-fill" style="--progress: ${(progressValue / 100).toFixed(2)}"></div>
        </div>
        <button type="button" class="expand-btn touch-target" aria-label="${isExpanded ? 'Hide' : 'Show'} article details">${isExpanded ? 'HIDE' : 'OPEN'}</button>
      </div>
    </div>
    <div class="item-body"${isExpanded ? '' : ' hidden'}>
      <p class="item-summary">${escapeHTML(item.desc || 'No summary available.')}</p>
      <a href="${escapeHTML(item.link)}" target="_blank" rel="noopener" class="item-link touch-target">
        ACCESS_ARTICLE
      </a>
    </div>
  `;
  
  const header = article.querySelector('.item-header');
  const expandBtn = article.querySelector('.expand-btn');
  const itemLink = article.querySelector('.item-link');
  
  const toggleExpand = () => {
    const expanded = !TERMINAL_STATE.expandedCards.has(cardId);
    if (expanded) {
      TERMINAL_STATE.expandedCards.add(cardId);
      article.classList.add('expanded');
      article.querySelector('.item-body').hidden = false;
      expandBtn.textContent = 'HIDE';
      expandBtn.setAttribute('aria-label', 'Hide article details');
      setReadProgress(cardId, Math.max(40, progressValue));
    } else {
      TERMINAL_STATE.expandedCards.delete(cardId);
      article.classList.remove('expanded');
      article.querySelector('.item-body').hidden = true;
      expandBtn.textContent = 'OPEN';
      expandBtn.setAttribute('aria-label', 'Show article details');
    }
    header.setAttribute('aria-expanded', expanded);
    persistState();
    triggerHaptic('expand');
  };
  
  header.addEventListener('click', toggleExpand);
  header.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggleExpand();
    }
  });
  
  expandBtn.addEventListener('click', e => {
    e.stopPropagation();
    toggleExpand();
  });
  
  itemLink.addEventListener('click', () => {
    setReadProgress(cardId, 100);
    const progressFill = article.querySelector('.progress-fill');
    progressFill.style.setProperty('--progress', '1');
    triggerHaptic('tap');
  });
  
  return article;
}

function showTerminalLoading() {
  const feed = document.getElementById('newsFeed');
  feed.innerHTML = '';
  
  for (let i = 0; i < 6; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'loading-item';
    skeleton.setAttribute('aria-label', 'Loading news item');
    skeleton.innerHTML = `
      <div class="loading-title" aria-hidden="true"></div>
      <div class="loading-meta" aria-hidden="true"></div>
    `;
    feed.appendChild(skeleton);
  }
}

function updateTerminalStatus(items = []) {
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
  document.getElementById('lastSync').textContent = timestamp;
  
  if (items.length === 0) {
    document.getElementById('moodStatus').textContent = 'QUIET';
    document.getElementById('moodLed').className = 'status-led';
    return;
  }
  
  const avgSentiment = items.reduce((sum, item) => sum + (item.sentimentScore || 0), 0) / items.length;
  let mood = 'CALM';
  let ledClass = 'status-led warn';
  
  if (avgSentiment > 3) {
    mood = 'POSITIVE';
    ledClass = 'status-led';
  } else if (avgSentiment < -3) {
    mood = 'CRITICAL';
    ledClass = 'status-led err';
  }
  
  document.getElementById('moodStatus').textContent = mood;
  document.getElementById('moodLed').className = ledClass;
}

function showTerminalToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.setAttribute('role', 'status');
  toast.setAttribute('aria-live', 'polite');
  toast.textContent = message.toUpperCase().replace(/ /g, '_');
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) toast.remove();
  }, 2500);
}

function renderFeed() {
  const feed = document.getElementById('newsFeed');
  const empty = document.getElementById('emptyState');
  
  feed.innerHTML = '';
  let filtered = TERMINAL_STATE.items.slice();
  
  if (TERMINAL_STATE.sourceFilter) {
    filtered = filtered.filter(item => item.id === TERMINAL_STATE.sourceFilter);
  }
  
  let viewItems;
  
  switch (TERMINAL_STATE.view) {
    case 'popular':
      viewItems = filtered
        .slice()
        .sort((a, b) => b.trendingScore - a.trendingScore)
        .slice(0, 30);
      break;
    case 'conservative':
      viewItems = filtered.filter(item => item.lane === 'conservative');
      break;
    case 'populist':
      viewItems = filtered.filter(item => item.lane === 'populist');
      break;
    case 'breaking':
      viewItems = filtered.filter(item => item.isBreaking);
      break;
    case 'by-source':
      viewItems = filtered.slice();
      break;
    default:
      viewItems = filtered.slice(0, 60);
  }
  
  if (viewItems.length === 0) {
    empty.style.display = 'block';
    feed.setAttribute('aria-live', 'off');
    return;
  }
  
  empty.style.display = 'none';
  feed.setAttribute('aria-live', 'polite');
  
  const fragment = document.createDocumentFragment();
  viewItems.forEach((item, idx) => {
    fragment.appendChild(createTerminalCard(item, idx));
  });
  
  feed.appendChild(fragment);
  updateTerminalStatus(viewItems);
}

async function loadFeeds() {
  if (TERMINAL_STATE.loading) return;
  
  TERMINAL_STATE.loading = true;
  showTerminalLoading();
  
  const indicator = document.getElementById('pullIndicator');
  if (indicator && (indicator.dataset.state === 'ready' || indicator.dataset.state === 'loading')) {
    indicator.dataset.state = 'loading';
    indicator.textContent = 'UPDATING...';
    indicator.style.opacity = '1';
  }
  
  try {
    const fetches = SOURCES.map(source =>
      fetchFast(source.url)
        .then(text => parseRSS(text, source))
        .catch(error => {
          console.warn('Feed failed:', source.name, error);
          return [];
        })
    );
    
    const results = await Promise.all(fetches);
    const allItems = results.flat();
    
    const deduped = [];
    const seen = new Set();
    
    allItems
      .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate))
      .forEach(item => {
        if (!seen.has(item.link)) {
          seen.add(item.link);
          deduped.push(item);
        }
      });
    
    const curated = deduped.filter(isLikelyNews);
    TERMINAL_STATE.items = curated.slice(0, 100);
    calculateTrending(TERMINAL_STATE.items);
    
    TERMINAL_STATE.items.forEach(item => {
      const sentiment = analyzeSentiment(item);
      item.sentimentScore = Number(sentiment.score.toFixed(2));
      item.sentimentLabel = sentiment.label;
      item.sentimentTone = sentiment.tone;
    });
    
    TERMINAL_STATE.lastFetch = Date.now();
    renderFeed();
    
    const reportMessage = TERMINAL_STATE.items.length ? `${TERMINAL_STATE.items.length}_REPORTS_LOADED` : 'FEED_REFRESHED';
    showTerminalToast(reportMessage, 'success');
    triggerHaptic('success');
    
    if (indicator && indicator.dataset.state === 'loading') {
      indicator.dataset.state = 'updated';
      indicator.textContent = 'UPDATED';
      setTimeout(() => {
        indicator.style.opacity = '0';
        indicator.textContent = 'PULL_TO_REFRESH';
      }, 1400);
    }
  } catch (error) {
    console.error('Failed:', error);
    document.getElementById('lastSync').textContent = 'ERROR';
    showTerminalToast('LOADING_FAILED', 'error');
    
    if (indicator && indicator.dataset.state === 'loading') {
      indicator.dataset.state = 'updated';
      indicator.textContent = 'REFRESH_FAILED';
      setTimeout(() => {
        indicator.style.opacity = '0';
        indicator.textContent = 'PULL_TO_REFRESH';
      }, 1400);
    }
  } finally {
    TERMINAL_STATE.loading = false;
  }
}

function changeView(view) {
  if (!view || view === TERMINAL_STATE.view) {
    syncActiveNav();
    triggerHaptic('tap');
    return;
  }
  
  TERMINAL_STATE.view = view;
  persistState();
  renderFeed();
  syncActiveNav();
  triggerHaptic('tab');
}

function syncActiveNav() {
  const currentView = TERMINAL_STATE.view;
  
  document.querySelectorAll('.filter-chip').forEach(chip => {
    const active = chip.dataset.view === currentView;
    chip.classList.toggle('active', active);
    chip.setAttribute('aria-selected', String(active));
  });
  
  document.querySelectorAll('.nav-btn').forEach(button => {
    const view = button.dataset.viewTarget;
    const active = Boolean(view && view === currentView);
    if (view) {
      button.classList.toggle('active', active);
      button.setAttribute('aria-selected', String(active));
    }
  });
}

function setupPullToRefresh() {
  const indicator = document.getElementById('pullIndicator');
  if (!indicator) return;
  
  let startY = 0;
  let pulling = false;
  let ready = false;
  let pullActive = false;
  
  const resetPull = () => {
    document.documentElement.style.setProperty('--pull-distance', '0px');
    pulling = false;
    ready = false;
    pullActive = false;
    indicator.dataset.state = 'idle';
    indicator.style.opacity = 0;
  };
  
  window.addEventListener('touchstart', event => {
    if (TERMINAL_STATE.loading || window.scrollY > 0) return;
    startY = event.touches[0].clientY;
    pulling = true;
    ready = false;
    pullActive = false;
  }, { passive: true });
  
  window.addEventListener('touchmove', event => {
    if (!pulling) return;
    if (window.scrollY > 0) {
      resetPull();
      return;
    }
    
    const delta = event.touches[0].clientY - startY;
    if (delta <= 0) {
      resetPull();
      return;
    }
    
    if (!pullActive && delta < 32) return;
    
    if (!pullActive) pullActive = true;
    
    event.preventDefault();
    const limited = Math.min(220, delta);
    const eased = Math.pow(limited / 220, 0.85) * 220;
    document.documentElement.style.setProperty('--pull-distance', `${eased}px`);
    indicator.style.opacity = Math.min(1, eased / 120);
    
    if (eased > 140) {
      indicator.dataset.state = 'ready';
      indicator.textContent = 'RELEASE_TO_REFRESH';
      if (!ready) {
        triggerHaptic('pull-ready');
        ready = true;
      }
    } else {
      indicator.dataset.state = 'idle';
      indicator.textContent = 'PULL_TO_REFRESH';
      ready = false;
    }
  }, { passive: false });
  
  const endPull = () => {
    if (!pulling) return;
    
    document.documentElement.style.setProperty('--pull-distance', '0px');
    indicator.style.opacity = 0;
    
    if (ready && pullActive && !TERMINAL_STATE.loading) {
      indicator.dataset.state = 'loading';
      indicator.textContent = 'UPDATING...';
      triggerHaptic('refresh');
      loadFeeds();
    } else {
      indicator.dataset.state = 'idle';
    }
    
    pulling = false;
    ready = false;
    pullActive = false;
  };
  
  window.addEventListener('touchend', endPull, { passive: true });
  window.addEventListener('touchcancel', endPull, { passive: true });
}

function setupSheets() {
  let activeSheet = null;
  
  function openSheet(sheetId, trigger) {
    if (activeSheet && activeSheet !== sheetId) closeSheet(activeSheet);
    
    const sheet = document.getElementById(sheetId);
    if (!sheet) return;
    
    sheet.hidden = false;
    sheet.classList.add('visible');
    activeSheet = sheetId;
    
    // Focus management
    const firstFocusable = sheet.querySelector('button, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) {
      setTimeout(() => firstFocusable.focus(), 100);
    }
    
    if (trigger) {
      trigger.setAttribute('aria-expanded', 'true');
    }
    
    triggerHaptic('action');
  }
  
  function closeSheet(sheetId) {
    const sheet = document.getElementById(sheetId);
    if (!sheet) return;
    
    sheet.classList.remove('visible');
    
    // Return focus to trigger
    const trigger = document.querySelector(`[aria-expanded="true"][data-sheet-trigger], [aria-expanded="true"][data-filter-trigger]`);
    if (trigger) {
      trigger.setAttribute('aria-expanded', 'false');
      trigger.focus();
    }
    
    setTimeout(() => {
      sheet.hidden = true;
    }, 300);
    
    if (activeSheet === sheetId) {
      activeSheet = null;
    }
  }
  
  // Filter sheet
  const filterBtn = document.getElementById('filterBtn');
  if (filterBtn) {
    filterBtn.addEventListener('click', () => {
      openSheet('filterSheet', filterBtn);
    });
  }
  
  document.querySelectorAll('[data-filter-close]').forEach(btn => {
    btn.addEventListener('click', () => closeSheet('filterSheet'));
  });
  
  // Source sheet
  const sourceSelector = document.getElementById('sourceSelector');
  if (sourceSelector) {
    sourceSelector.addEventListener('click', () => {
      buildSourceList();
      openSheet('sourceSheet', sourceSelector);
    });
  }
  
  document.querySelectorAll('[data-source-close]').forEach(btn => {
    btn.addEventListener('click', () => closeSheet('sourceSheet'));
  });
  
  const clearSource = document.getElementById('clearSource');
  if (clearSource) {
    clearSource.addEventListener('click', () => {
      TERMINAL_STATE.sourceFilter = null;
      persistState();
      updateSourceDisplay();
      renderFeed();
      closeSheet('sourceSheet');
      triggerHaptic('tab');
    });
  }
  
  // Action sheet
  const moreBtn = document.getElementById('moreBtn');
  if (moreBtn) {
    moreBtn.addEventListener('click', () => {
      openSheet('actionSheet', moreBtn);
    });
  }
  
  document.querySelectorAll('[data-sheet-close]').forEach(btn => {
    btn.addEventListener('click', () => closeSheet('actionSheet'));
  });
  
  document.querySelectorAll('[data-sheet-action]').forEach(btn => {
    btn.addEventListener('click', e => {
      const action = e.target.dataset.sheetAction;
      
      switch (action) {
        case 'refresh':
          triggerHaptic('refresh');
          loadFeeds();
          break;
        case 'mark-read':
          markAllRead();
          break;
        case 'reset':
          if (confirm('Reset all settings and data?')) {
            triggerHaptic('action');
            try {
              localStorage.clear();
            } catch (error) {
              console.warn('Failed to clear storage:', error);
            }
            location.reload();
          }
          break;
      }
      
      closeSheet('actionSheet');
    });
  });
  
  // Close on overlay click
  document.querySelectorAll('.sheet-overlay').forEach(overlay => {
    overlay.addEventListener('click', () => {
      if (activeSheet) closeSheet(activeSheet);
    });
  });
  
  // Close on escape
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && activeSheet) {
      closeSheet(activeSheet);
    }
  });
}

function buildSourceList() {
  const container = document.getElementById('sourceList');
  if (!container) return;
  
  container.innerHTML = '';
  
  const allOption = document.createElement('button');
  allOption.className = 'source-option touch-target';
  allOption.setAttribute('role', 'option');
  allOption.setAttribute('aria-selected', !TERMINAL_STATE.sourceFilter);
  allOption.innerHTML = `
    <span class="option-name">ALL_SOURCES</span>
    <span class="option-meta">
      <span>ALL_OUTLETS</span>
    </span>
    <span class="option-check" aria-hidden="true">✓</span>
  `;
  
  allOption.addEventListener('click', () => {
    TERMINAL_STATE.sourceFilter = null;
    persistState();
    updateSourceDisplay();
    renderFeed();
    buildSourceList();
    triggerHaptic('tab');
  });
  
  container.appendChild(allOption);
  
  SOURCES.forEach(source => {
    const isActive = TERMINAL_STATE.sourceFilter === source.id;
    const button = document.createElement('button');
    button.className = 'source-option touch-target';
    button.setAttribute('role', 'option');
    button.setAttribute('aria-selected', isActive);
    
    const laneLabel = source.lane ? source.lane.toUpperCase() : 'GENERAL';
    const biasLabel = Number.isFinite(source.bias) 
      ? `BIAS_${source.bias >= 0 ? '+' : ''}${source.bias.toFixed(1)}`
      : 'BIAS_N/A';
    
    button.innerHTML = `
      <span class="option-name">${source.name}</span>
      <span class="option-meta">
        <span>${laneLabel}</span>
        <span>${biasLabel}</span>
      </span>
      <span class="option-check" aria-hidden="true">✓</span>
    `;
    
    button.addEventListener('click', () => {
      TERMINAL_STATE.sourceFilter = source.id;
      persistState();
      updateSourceDisplay();
      renderFeed();
      buildSourceList();
      triggerHaptic('tab');
    });
    
    container.appendChild(button);
  });
}

function updateSourceDisplay() {
  const valueEl = document.getElementById('sourceValue');
  const selection = SOURCES.find(source => source.id === TERMINAL_STATE.sourceFilter);
  
  if (valueEl) {
    valueEl.textContent = selection ? selection.name : 'ALL_SOURCES';
  }
}

function markAllRead() {
  TERMINAL_STATE.items.forEach(item => {
    const cardId = createCardId(item.link);
    setReadProgress(cardId, 100);
  });
  
  document.querySelectorAll('.progress-fill').forEach(fill => {
    fill.style.setProperty('--progress', '1');
  });
  
  triggerHaptic('mark');
  showTerminalToast('MARKED_ALL_READ', 'success');
}

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
  updateSourceDisplay();
  syncActiveNav();
  setupSheets();
  setupPullToRefresh();
  
  // Navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.viewTarget;
      if (view) changeView(view);
    });
  });
  
  // Filter chips
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const view = chip.dataset.view;
      if (view) {
        changeView(view);
        setTimeout(() => {
          const sheet = document.getElementById('filterSheet');
          if (sheet && !sheet.hidden) {
            sheet.classList.remove('visible');
            setTimeout(() => sheet.hidden = true, 300);
          }
        }, 100);
      }
    });
  });
  
  // Auto refresh
  setInterval(() => {
    if (!TERMINAL_STATE.loading && Date.now() - TERMINAL_STATE.lastFetch > 120000) {
      loadFeeds();
    }
  }, 30000);
  
  // Handle visual viewport changes for iOS keyboard
  if ('visualViewport' in window) {
    function handleViewportChange() {
      const viewport = window.visualViewport;
      document.documentElement.style.setProperty('--viewport-height', ${viewport.height}px);
}
window.visualViewport.addEventListener('resize', handleViewportChange);
handleViewportChange();
}
// Initial load
loadFeeds();
// Focus visible polyfill for better keyboard navigation
function applyFocusVisiblePolyfill() {
let hadKeyboardEvent = true;
let keyboardThrottleTimer = 0;
const detectKeyboardFocus = (e) => {
  if (e.metaKey || e.altKey || e.ctrlKey) return;
  hadKeyboardEvent = true;
  clearTimeout(keyboardThrottleTimer);
  keyboardThrottleTimer = setTimeout(() => {
    hadKeyboardEvent = false;
  }, 100);
};

const onPointerDown = () => {
  hadKeyboardEvent = false;
};

const onFocus = (e) => {
  if (hadKeyboardEvent || e.target.matches(':focus-visible')) {
    e.target.classList.add('focus-visible');
  }
};

const onBlur = (e) => {
  e.target.classList.remove('focus-visible');
};

document.addEventListener('keydown', detectKeyboardFocus, true);
document.addEventListener('mousedown', onPointerDown, true);
document.addEventListener('pointerdown', onPointerDown, true);
document.addEventListener('touchstart', onPointerDown, true);
document.addEventListener('focus', onFocus, true);
document.addEventListener('blur', onBlur, true);

document.body.classList.add('js-focus-visible');
}
applyFocusVisiblePolyfill();
});
// Service worker registration for better caching (optional)
if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('/sw.js').catch(() => {
// Silently fail - not critical
});
});
}
</script>
</body>
</html>
