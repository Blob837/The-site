<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0b0f14">
    <meta name="description" content="College Football Winner Predictor with live data and ML models">
    <title>CFB Predictor</title>
    <style>
        :root {
            --bg-primary: #0b0f14;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #2a3441;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #3b82f6;
            --accent-secondary: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --border-primary: #374151;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #ffffff;
                --bg-secondary: #f8fafc;
                --bg-tertiary: #e2e8f0;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                --text-muted: #64748b;
                --border-primary: #e2e8f0;
                --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .week-nav {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .week-nav:hover {
            background: var(--accent-primary);
        }

        .week-display {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 0.375rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .settings-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.5rem;
            height: 120px;
            margin-bottom: 1rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .games-container {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            .games-container {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }
        }

        .game-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        .game-card:hover {
            transform: translateY(-2px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .game-time {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: right;
        }

        .venue {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .matchup {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .team-name {
            font-weight: bold;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .team-record {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .vs {
            margin: 0 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .prediction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
        }

        .prob-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .confidence-ring {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .confidence-ring svg {
            transform: rotate(-90deg);
        }

        .confidence-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 3;
        }

        .confidence-fill {
            fill: none;
            stroke: var(--accent-secondary);
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s ease;
        }

        .prob-text {
            font-weight: bold;
            font-size: 1.125rem;
        }

        .edge-badge {
            background: var(--accent-warning);
            color: var(--bg-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .drivers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .driver-chip {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .driver-chip.positive {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        .driver-chip.negative {
            background: var(--accent-danger);
            color: var(--text-primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            min-width: 44px;
            min-height: 44px;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 0.375rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .checkbox {
            width: 1.25rem;
            height: 1.25rem;
        }

        .button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            min-height: 44px;
        }

        .button:hover {
            background: #2563eb;
        }

        .button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .button.secondary:hover {
            background: var(--border-primary);
        }

        .button.danger {
            background: var(--accent-danger);
        }

        .button.danger:hover {
            background: #dc2626;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            padding: 1rem;
            z-index: 100;
        }

        .bottom-actions {
            display: flex;
            gap: 0.75rem;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
            flex-wrap: wrap;
        }

        .bottom-actions .button {
            flex: 1;
            min-width: 120px;
        }

        .toast {
            position: fixed;
            top: 80px;
            left: 1rem;
            right: 1rem;
            background: var(--accent-danger);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 1100;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow);
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.success {
            background: var(--accent-secondary);
        }

        .toast.warning {
            background: var(--accent-warning);
            color: var(--bg-primary);
        }

        .filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 0.375rem;
            color: var(--text-primary);
            min-height: 44px;
        }

        .sort-select {
            margin-left: auto;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">CFB Predictor</div>
            <div class="week-selector">
                <button class="week-nav" id="prevWeek" aria-label="Previous week">‚Üê</button>
                <div class="week-display" id="weekDisplay">This Weekend</div>
                <button class="week-nav" id="nextWeek" aria-label="Next week">‚Üí</button>
            </div>
            <button class="settings-btn" id="settingsBtn" aria-label="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <main class="main-content">
        <div class="filters">
            <select class="filter-select" id="conferenceFilter">
                <option value="">All Conferences</option>
            </select>
            <select class="filter-select" id="teamFilter">
                <option value="">All Teams</option>
            </select>
            <select class="filter-select sort-select" id="sortBy">
                <option value="confidence">Sort by Confidence</option>
                <option value="edge">Sort by Edge</option>
                <option value="time">Sort by Kickoff</option>
            </select>
        </div>

        <div class="games-container" id="gamesContainer">
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
            <div class="loading-skeleton"></div>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üèà</div>
            <h3>No games found</h3>
            <p>Try adjusting your filters or check back later</p>
        </div>
    </main>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" id="closeSettings">√ó</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="cfbdKey">CFBD API Key *</label>
                <input type="password" class="form-input" id="cfbdKey" placeholder="Enter your CFBD API key">
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                    Get your free key at <a href="https://collegefootballdata.com" target="_blank" style="color: var(--accent-primary);">collegefootballdata.com</a>
                </small>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" class="checkbox" id="useMarkets" checked>
                <label for="useMarkets">Use betting markets</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" class="checkbox" id="useWeather" checked>
                <label for="useWeather">Use weather forecasts</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" class="checkbox" id="manualInjuries">
                <label for="manualInjuries">Manual injury tracking</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" class="checkbox" id="demoMode">
                <label for="demoMode">Demo mode (offline data)</label>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="button" id="saveSettings">Save Settings</button>
                <button class="button secondary" id="closeSettings2">Cancel</button>
                <button class="button danger" id="forgetKeys">Forget Keys</button>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="bottom-actions">
            <button class="button" id="refreshData">Refresh Data</button>
            <button class="button" id="predict">Predict</button>
            <button class="button secondary" id="exportData">Export JSON</button>
            <button class="button secondary" id="resetApp">Reset</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Demo data that matches actual CFBD API structure
        const DEMO_DATA = {
            games: [
                {
                    id: 401628492,
                    season: 2024,
                    week: 12,
                    season_type: "regular",
                    start_date: "2024-11-30T19:30:00.000Z",
                    neutral_site: false,
                    conference_game: true,
                    home_team: "Texas A&M",
                    home_conference: "SEC",
                    home_points: null,
                    away_team: "Texas",
                    away_conference: "SEC", 
                    away_points: null,
                    venue: "Kyle Field"
                },
                {
                    id: 401628493,
                    season: 2024,
                    week: 12,
                    season_type: "regular",
                    start_date: "2024-11-30T20:00:00.000Z",
                    neutral_site: false,
                    conference_game: true,
                    home_team: "Auburn",
                    home_conference: "SEC",
                    home_points: null,
                    away_team: "Alabama", 
                    away_conference: "SEC",
                    away_points: null,
                    venue: "Jordan-Hare Stadium"
                }
            ],
            elo: [
                { team: "Texas", elo: 1650 },
                { team: "Texas A&M", elo: 1580 },
                { team: "Alabama", elo: 1620 },
                { team: "Auburn", elo: 1520 }
            ],
            ppa: [
                { team: "Texas", overall: { ppa: 0.15 }, passing: { ppa: 0.12 }, rushing: { ppa: 0.08 } },
                { team: "Texas A&M", overall: { ppa: 0.08 }, passing: { ppa: 0.06 }, rushing: { ppa: 0.04 } },
                { team: "Alabama", overall: { ppa: 0.12 }, passing: { ppa: 0.10 }, rushing: { ppa: 0.06 } },
                { team: "Auburn", overall: { ppa: 0.02 }, passing: { ppa: 0.01 }, rushing: { ppa: 0.02 } }
            ],
            lines: [
                {
                    id: 401628492,
                    season: 2024,
                    week: 12,
                    season_type: "regular",
                    start_date: "2024-11-30T19:30:00.000Z",
                    home_team: "Texas A&M",
                    away_team: "Texas",
                    home_conference: "SEC",
                    away_conference: "SEC",
                    home_score: null,
                    away_score: null,
                    lines: [
                        {
                            provider: "consensus",
                            spread: -7.5,
                            formatted_spread: "Texas A&M -7.5",
                            spread_open: -6.5,
                            over_under: 48.5,
                            over_under_open: 47.5,
                            home_moneyline: -280,
                            away_moneyline: 240
                        }
                    ]
                }
            ]
        };

        // Application state
        const AppState = {
            currentWeek: null,
            currentSeason: 2024,
            settings: {
                cfbdKey: localStorage.getItem('cfbd_key') || '',
                useMarkets: true,
                useWeather: true,
                manualInjuries: false,
                demoMode: false
            },
            cache: {
                games: null,
                metrics: null,
                weather: null,
                lines: null,
                lastUpdate: null
            },
            predictions: null
        };

        // Rate limiter
        class RateLimiter {
            constructor(tokensPerSecond = 2, maxTokens = 5) {
                this.tokensPerSecond = tokensPerSecond;
                this.maxTokens = maxTokens;
                this.tokens = maxTokens;
                this.lastRefill = Date.now();
            }

            async waitForToken() {
                const now = Date.now();
                const timePassed = (now - this.lastRefill) / 1000;
                this.tokens = Math.min(this.maxTokens, this.tokens + timePassed * this.tokensPerSecond);
                this.lastRefill = now;

                if (this.tokens >= 1) {
                    this.tokens -= 1;
                    return;
                }

                const waitTime = (1 - this.tokens) / this.tokensPerSecond * 1000;
                await new Promise(resolve => setTimeout(resolve, waitTime + Math.random() * 100));
                this.tokens = 0;
            }
        }

        // CFBD API client
        class CFBDClient {
            constructor() {
                this.baseURL = 'https://api.collegefootballdata.com';
                this.rateLimiter = new RateLimiter(2, 5);
            }

            async fetch(endpoint, params = {}) {
                if (!AppState.settings.cfbdKey && !AppState.settings.demoMode) {
                    throw new Error('CFBD API key required');
                }

                if (AppState.settings.demoMode) {
                    return this.getDemoData(endpoint);
                }

                await this.rateLimiter.waitForToken();

                const url = new URL(endpoint, this.baseURL);
                Object.entries(params).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        url.searchParams.append(key, value);
                    }
                });

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AppState.settings.cfbdKey}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.status === 401) {
                    throw new Error('Invalid CFBD API key');
                }
                if (response.status === 429) {
                    throw new Error('Rate limit exceeded, retrying...');
                }
                if (!response.ok) {
                    throw new Error(`CFBD API error: ${response.status}`);
                }

                return response.json();
            }

            getDemoData(endpoint) {
                console.log('Demo mode - endpoint:', endpoint);
                if (endpoint.includes('/games')) {
                    if (endpoint.includes('/weather')) return [];
                    return DEMO_DATA.games;
                }
                if (endpoint.includes('/ratings/elo')) return DEMO_DATA.elo;
                if (endpoint.includes('/metrics/ppa')) return DEMO_DATA.ppa;
                if (endpoint.includes('/lines')) return DEMO_DATA.lines;
                return [];
            }

            async getGames(season, week) {
                return this.fetch('/games', { 
                    year: season, 
                    week, 
                    season_type: 'regular',
                    classification: 'fbs' 
                });
            }

            async getEloRatings(season, week) {
                return this.fetch('/ratings/elo', { year: season, week });
            }

            async getPPAData(season, week) {
                return this.fetch('/metrics/ppa/teams', { year: season, week });
            }

            async getLines(season, week) {
                return this.fetch('/lines', { 
                    year: season, 
                    week, 
                    season_type: 'regular' 
                });
            }
        }

        // Math utilities
        const MathUtils = {
            sigmoid: (x) => 1 / (1 + Math.exp(-x)),
            
            calibrateProb: (rawProb) => {
                // Simple Platt scaling calibration
                const logit = Math.log(rawProb / (1 - rawProb));
                const calibratedLogit = 0.8 * logit;
                return 1 / (1 + Math.exp(-calibratedLogit));
            },
            
            spreadToProb: (spread) => {
                // Convert point spread to win probability
                return 1 / (1 + Math.exp(-spread / 14));
            },
            
            probToSpread: (prob) => {
                // Convert win probability to equivalent spread
                const logit = Math.log(prob / (1 - prob));
                return logit * 14;
            }
        };

        // Feature engineering
        class FeatureEngine {
            static engineerFeatures(game, eloData, ppaData, lines, weather) {
                const features = [];
                const featureNames = [];
                
                // Get team metrics
                const homeElo = eloData.find(t => t.team === game.home_team)?.elo || 1500;
                const awayElo = eloData.find(t => t.team === game.away_team)?.elo || 1500;
                
                const homePPA = ppaData.find(t => t.team === game.home_team)?.overall?.ppa || 0;
                const awayPPA = ppaData.find(t => t.team === game.away_team)?.overall?.ppa || 0;
                
                // Elo differential with home field advantage
                const homeAdvantage = game.neutral_site ? 0 : 65;
                const eloDiff = homeElo + homeAdvantage - awayElo;
                features.push(eloDiff);
                featureNames.push('elo_diff');
                
                // PPA differentials
                features.push(homePPA - awayPPA);
                featureNames.push('ppa_diff');
                
                // Home/Neutral flags
                features.push(game.neutral_site ? 0 : 1);
                featureNames.push('home_flag');
                
                features.push(game.neutral_site ? 1 : 0);
                featureNames.push('neutral_flag');
                
                // Weather adjustments (placeholder)
                features.push(0); // wind penalty
                features.push(0); // precip penalty
                featureNames.push('wind_penalty');
                featureNames.push('precip_penalty');
                
                // Market features if available
                const gameLines = lines.find(l => 
                    l.home_team === game.home_team && l.away_team === game.away_team
                );
                
                if (gameLines && gameLines.lines && gameLines.lines.length > 0 && AppState.settings.useMarkets) {
                    const line = gameLines.lines[0];
                    const spread = line.spread || 0;
                    features.push(spread);
                    featureNames.push('market_spread');
                } else {
                    features.push(0);
                    featureNames.push('market_spread');
                }
                
                return { features, featureNames };
            }
            
            static getGameDrivers(game, prediction, features, featureNames) {
                const drivers = [];
                
                // Elo difference driver
                const eloDiffIndex = featureNames.indexOf('elo_diff');
                const eloDiff = features[eloDiffIndex] || 0;
                if (Math.abs(eloDiff) > 50) {
                    drivers.push({
                        name: 'Elo Rating',
                        impact: eloDiff > 0 ? 'positive' : 'negative',
                        description: `${Math.abs(eloDiff).toFixed(0)} point ${eloDiff > 0 ? 'advantage' : 'disadvantage'}`
                    });
                }
                
                // PPA difference driver
                const ppaDiffIndex = featureNames.indexOf('ppa_diff');
                const ppaDiff = features[ppaDiffIndex] || 0;
                if (Math.abs(ppaDiff) > 0.05) {
                    drivers.push({
                        name: 'PPA Efficiency',
                        impact: ppaDiff > 0 ? 'positive' : 'negative',
                        description: `${(Math.abs(ppaDiff) * 100).toFixed(1)}% efficiency edge`
                    });
                }
                
                return drivers;
            }
        }

        // Main prediction engine
        class PredictionEngine {
            constructor() {
                this.cfbdClient = new CFBDClient();
                this.models = {
                    elo: { a: -0.001, b: 0.025 }
                };
            }
            
            async predict(games) {
                if (!games || games.length === 0) return [];
                
                showToast('Generating predictions...', 'success');
                
                try {
                    // Get all the data we need
                    const [eloData, ppaData, lines] = await Promise.all([
                        this.cfbdClient.getEloRatings(AppState.currentSeason, AppState.currentWeek).catch(() => []),
                        this.cfbdClient.getPPAData(AppState.currentSeason, AppState.currentWeek).catch(() => []),
                        AppState.settings.useMarkets ? 
                            this.cfbdClient.getLines(AppState.currentSeason, AppState.currentWeek).catch(() => []) : 
                            []
                    ]);

                    console.log('Data loaded:', { 
                        games: games.length, 
                        elo: eloData.length, 
                        ppa: ppaData.length, 
                        lines: lines.length 
                    });
                    
                    const predictions = [];
                    
                    for (const game of games) {
                        // Skip completed games
                        if (game.home_points !== null || game.away_points !== null) continue;
                        
                        // Engineer features
                        const { features, featureNames } = FeatureEngine.engineerFeatures(
                            game, eloData, ppaData, lines, null
                        );
                        
                        // Elo-based prediction
                        const eloDiff = features[0];
                        const probElo = MathUtils.sigmoid(this.models.elo.a + this.models.elo.b * eloDiff);
                        
                        // Calibrated final prediction
                        const probFinal = MathUtils.calibrateProb(probElo);
                        
                        // Calculate edge vs market if available
                        let edge = null;
                        const gameLines = lines.find(l => 
                            l.home_team === game.home_team && l.away_team === game.away_team
                        );
                        
                        if (gameLines && gameLines.lines && gameLines.lines.length > 0) {
                            const line = gameLines.lines[0];
                            if (line.spread !== undefined) {
                                const impliedProb = MathUtils.spreadToProb(-line.spread);
                                edge = Math.abs(probFinal - impliedProb);
                            }
                        }
                        
                        // Generate explanation
                        const drivers = FeatureEngine.getGameDrivers(game, probFinal, features, featureNames);
                        
                        predictions.push({
                            gameId: game.id,
                            homeTeam: game.home_team,
                            awayTeam: game.away_team,
                            homeWinProb: probFinal,
                            awayWinProb: 1 - probFinal,
                            confidence: Math.abs(probFinal - 0.5) * 2,
                            edge: edge,
                            drivers: drivers,
                            spreadEquiv: MathUtils.probToSpread(probFinal),
                            kickoff: game.start_date,
                            venue: game.venue
                        });
                    }
                    
                    console.log('Generated predictions:', predictions.length);
                    return predictions;
                    
                } catch (error) {
                    console.error('Prediction error:', error);
                    showToast(`Prediction error: ${error.message}`, 'danger');
                    return [];
                }
            }
        }

        // Date utilities
        const DateUtils = {
            getCurrentWeek() {
                const now = new Date();
                const season = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
                const seasonStart = new Date(season, 7, 15);
                const weekNumber = Math.ceil((now - seasonStart) / (7 * 24 * 60 * 60 * 1000));
                return Math.max(1, Math.min(15, weekNumber));
            },
            
            formatGameTime(dateString) {
                const date = new Date(dateString);
                return {
                    time: date.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        timeZoneName: 'short'
                    }),
                    date: date.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    })
                };
            }
        };

        // UI Management
        const UI = {
            showLoading() {
                const container = document.getElementById('gamesContainer');
                container.innerHTML = Array(3).fill().map(() => '<div class="loading-skeleton"></div>').join('');
            },
            
            renderGames(predictions) {
                const container = document.getElementById('gamesContainer');
                const emptyState = document.getElementById('emptyState');
                
                if (!predictions || predictions.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                // Sort predictions
                const sortBy = document.getElementById('sortBy').value;
                const sorted = [...predictions].sort((a, b) => {
                    switch (sortBy) {
                        case 'confidence':
                            return b.confidence - a.confidence;
                        case 'edge':
                            return (b.edge || 0) - (a.edge || 0);
                        case 'time':
                            return new Date(a.kickoff) - new Date(b.kickoff);
                        default:
                            return b.confidence - a.confidence;
                    }
                });
                
                container.innerHTML = sorted.map(prediction => this.renderGameCard(prediction)).join('');
            },
            
            renderGameCard(prediction) {
                const gameTime = DateUtils.formatGameTime(prediction.kickoff);
                const confidence = (prediction.confidence * 100).toFixed(0);
                const homeProb = (prediction.homeWinProb * 100).toFixed(0);
                const awayProb = (prediction.awayWinProb * 100).toFixed(0);
                
                // Calculate confidence ring
                const circumference = 2 * Math.PI * 16;
                const strokeDasharray = circumference;
                const strokeDashoffset = circumference * (1 - prediction.confidence);
                
                const edgeBadge = prediction.edge && prediction.edge > 0.1 ? 
                    `<div class="edge-badge">${(prediction.edge * 100).toFixed(0)}% edge</div>` : '';
                
                const drivers = prediction.drivers.map(driver => 
                    `<div class="driver-chip ${driver.impact}">${driver.name}: ${driver.description}</div>`
                ).join('');
                
                const favoredTeam = prediction.homeWinProb > 0.5 ? prediction.homeTeam : prediction.awayTeam;
                
                return `
                    <div class="game-card">
                        <div class="game-header">
                            <div class="game-time">
                                <div>${gameTime.date}</div>
                                <div>${gameTime.time}</div>
                            </div>
                        </div>
                        
                        <div class="venue">${prediction.venue || 'TBD'}</div>
                        
                        <div class="matchup">
                            <div class="team">
                                <div class="team-name">${prediction.awayTeam}</div>
                                <div class="team-record">${awayProb}%</div>
                            </div>
                            <div class="vs">@</div>
                            <div class="team">
                                <div class="team-name">${prediction.homeTeam}</div>
                                <div class="team-record">${homeProb}%</div>
                            </div>
                        </div>
                        
                        <div class="prediction">
                            <div class="prob-container">
                                <div class="confidence-ring">
                                    <svg width="40" height="40">
                                        <circle class="confidence-bg" cx="20" cy="20" r="16"></circle>
                                        <circle class="confidence-fill" cx="20" cy="20" r="16"
                                                stroke-dasharray="${strokeDasharray}"
                                                stroke-dashoffset="${strokeDashoffset}"></circle>
                                    </svg>
                                </div>
                                <div>
                                    <div class="prob-text">${favoredTeam}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">${confidence}% confidence</div>
                                </div>
                            </div>
                            ${edgeBadge}
                        </div>
                        
                        ${drivers ? `<div class="drivers">${drivers}</div>` : ''}
                    </div>
                `;
            },
            
            updateWeekDisplay() {
                const display = document.getElementById('weekDisplay');
                if (AppState.currentWeek === DateUtils.getCurrentWeek()) {
                    display.textContent = 'This Weekend';
                } else {
                    display.textContent = `Week ${AppState.currentWeek}`;
                }
            },
            
            populateFilters(games) {
                const conferenceFilter = document.getElementById('conferenceFilter');
                const teamFilter = document.getElementById('teamFilter');
                
                const conferences = [...new Set(games.flatMap(g => [g.away_conference, g.home_conference]).filter(Boolean))];
                const teams = [...new Set(games.flatMap(g => [g.away_team, g.home_team]))];
                
                conferenceFilter.innerHTML = '<option value="">All Conferences</option>' +
                    conferences.map(conf => `<option value="${conf}">${conf}</option>`).join('');
                
                teamFilter.innerHTML = '<option value="">All Teams</option>' +
                    teams.map(team => `<option value="${team}">${team}</option>`).join('');
            }
        };

        // Toast notifications
        function showToast(message, type = 'danger') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, type === 'success' ? 2000 : 4000);
        }

        // Settings management
        function loadSettings() {
            const settings = AppState.settings;
            document.getElementById('cfbdKey').value = settings.cfbdKey;
            document.getElementById('useMarkets').checked = settings.useMarkets;
            document.getElementById('useWeather').checked = settings.useWeather;
            document.getElementById('manualInjuries').checked = settings.manualInjuries;
            document.getElementById('demoMode').checked = settings.demoMode;
        }

        function saveSettings() {
            const settings = AppState.settings;
            settings.cfbdKey = document.getElementById('cfbdKey').value.trim();
            settings.useMarkets = document.getElementById('useMarkets').checked;
            settings.useWeather = document.getElementById('useWeather').checked;
            settings.manualInjuries = document.getElementById('manualInjuries').checked;
            settings.demoMode = document.getElementById('demoMode').checked;
            
            if (settings.cfbdKey) {
                localStorage.setItem('cfbd_key', settings.cfbdKey);
            }
            
            document.getElementById('settingsModal').classList.remove('show');
            showToast('Settings saved', 'success');
        }

        function forgetKeys() {
            localStorage.removeItem('cfbd_key');
            AppState.settings.cfbdKey = '';
            document.getElementById('cfbdKey').value = '';
            showToast('API keys forgotten', 'success');
        }

        // Main application controller
        class App {
            constructor() {
                this.predictionEngine = new PredictionEngine();
                this.init();
            }
            
            init() {
                AppState.currentWeek = DateUtils.getCurrentWeek();
                UI.updateWeekDisplay();
                this.bindEvents();
                loadSettings();
                
                if (AppState.settings.cfbdKey || AppState.settings.demoMode) {
                    this.refreshData();
                }
            }
            
            bindEvents() {
                document.getElementById('prevWeek').addEventListener('click', () => {
                    AppState.currentWeek = Math.max(1, AppState.currentWeek - 1);
                    UI.updateWeekDisplay();
                    this.refreshData();
                });
                
                document.getElementById('nextWeek').addEventListener('click', () => {
                    AppState.currentWeek = Math.min(15, AppState.currentWeek + 1);
                    UI.updateWeekDisplay();
                    this.refreshData();
                });
                
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.add('show');
                });
                
                document.getElementById('closeSettings').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('show');
                });
                
                document.getElementById('closeSettings2').addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('show');
                });
                
                document.getElementById('saveSettings').addEventListener('click', saveSettings);
                document.getElementById('forgetKeys').addEventListener('click', forgetKeys);
                
                document.getElementById('refreshData').addEventListener('click', () => this.refreshData());
                document.getElementById('predict').addEventListener('click', () => this.predict());
                document.getElementById('exportData').addEventListener('click', () => this.exportData());
                document.getElementById('resetApp').addEventListener('click', () => this.reset());
                
                document.getElementById('sortBy').addEventListener('change', () => {
                    if (AppState.predictions) {
                        UI.renderGames(AppState.predictions);
                    }
                });
                
                document.getElementById('settingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'settingsModal') {
                        e.target.classList.remove('show');
                    }
                });
            }
            
            async refreshData() {
                if (!AppState.settings.cfbdKey && !AppState.settings.demoMode) {
                    showToast('CFBD API key required. Check settings.', 'warning');
                    document.getElementById('settingsModal').classList.add('show');
                    return;
                }
                
                UI.showLoading();
                
                try {
                    const games = await this.predictionEngine.cfbdClient.getGames(
                        AppState.currentSeason, 
                        AppState.currentWeek
                    );
                    
                    console.log('Games loaded:', games);
                    
                    if (!games || games.length === 0) {
                        showToast('No games found for this week', 'warning');
                        UI.renderGames([]);
                        return;
                    }
                    
                    AppState.cache.games = games;
                    AppState.cache.lastUpdate = new Date();
                    
                    UI.populateFilters(games);
                    showToast(`Loaded ${games.length} games`, 'success');
                    
                    this.predict();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    showToast(`Error loading data: ${error.message}`, 'danger');
                    UI.renderGames([]);
                }
            }
            
            async predict() {
                if (!AppState.cache.games) {
                    showToast('Load data first', 'warning');
                    return;
                }
                
                try {
                    const predictions = await this.predictionEngine.predict(AppState.cache.games);
                    AppState.predictions = predictions;
                    UI.renderGames(predictions);
                    
                    if (predictions.length > 0) {
                        showToast(`Generated ${predictions.length} predictions`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Prediction error:', error);
                    showToast(`Prediction error: ${error.message}`, 'danger');
                }
            }
            
            exportData() {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    week: AppState.currentWeek,
                    season: AppState.currentSeason,
                    games: AppState.cache.games,
                    predictions: AppState.predictions
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cfb-predictions-week${AppState.currentWeek}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Data exported', 'success');
            }
            
            reset() {
                if (confirm('Reset all data? This will clear cache but keep settings.')) {
                    AppState.cache = { games: null, metrics: null, weather: null, lines: null, lastUpdate: null };
                    AppState.predictions = null;
                    UI.renderGames([]);
                    showToast('App reset', 'success');
                }
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });
    </script>
</body>
</html>

<!--
CFBD API Endpoints Used:
- /games?year={year}&week={week}&season_type=regular&classification=fbs
- /ratings/elo?year={year}&week={week}
- /metrics/ppa/teams?year={year}&week={week}
- /lines?year={year}&week={week}&season_type=regular

Response Structures Expected:
- Games: { id, season, week, home_team, away_team, start_date, venue, neutral_site, etc. }
- ELO: [{ team, elo }]
- PPA: [{ team, overall: { ppa }, passing: { ppa }, rushing: { ppa } }]
- Lines: [{ home_team, away_team, lines: [{ provider, spread, over_under }] }]
-->
