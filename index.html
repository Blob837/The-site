<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Oil Monitor">
    <title>Oil Monitor - Live Oil Prices</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #00ff41;
            --text-secondary: #33ff77;
            --text-muted: #888;
            --accent-up: #00ff41;
            --accent-down: #ff4444;
            --accent-flat: #888;
            --border: #333;
            --glow: 0 0 10px currentColor;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(transparent 50%, rgba(0, 255, 65, 0.03) 50%),
                linear-gradient(90deg, transparent 50%, rgba(0, 255, 65, 0.02) 50%);
            background-size: 100% 4px, 4px 100%;
            pointer-events: none;
            z-index: 1000;
        }

        @media (prefers-reduced-motion: reduce) {
            body::before { display: none; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: var(--safe-area-top);
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: var(--glow);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-down);
            box-shadow: var(--glow);
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--accent-up);
        }

        .status-dot.loading {
            background: #ff8800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .price-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 24px 0;
        }

        .price-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .price-card:hover {
            box-shadow: 0 4px 20px rgba(0, 255, 65, 0.2);
            transform: scale(1.02);
        }

        .price-card.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 16px;
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted);
            border-top: 2px solid var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .price-card h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .price-value {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: var(--glow);
            margin-bottom: 8px;
        }

        .price-change {
            display: flex;
            gap: 8px;
            font-size: 0.9rem;
        }

        .price-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .change-up { color: var(--accent-up); }
        .change-down { color: var(--accent-down); }
        .change-flat { color: var(--accent-flat); }

        .section {
            margin: 32px 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.3rem;
            text-shadow: var(--glow);
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .tab.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            text-shadow: var(--glow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            min-height: 250px;
            position: relative;
        }

        .chart-canvas {
            width: 100%;
            height: 200px;
            border-radius: 4px;
        }

        .news-grid {
            display: grid;
            gap: 12px;
        }

        .news-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .news-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-secondary);
        }

        .news-title {
            font-size: 1rem;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .news-title a {
            color: var(--text-primary);
            text-decoration: none;
        }

        .news-title a:hover {
            color: var(--text-secondary);
            text-shadow: var(--glow);
        }

        .news-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .bottom-bar {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            bottom: var(--safe-area-bottom);
            z-index: 100;
        }

        .bottom-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .btn:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
            box-shadow: var(--glow);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .diagnostic-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 2px solid var(--border);
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 50vh;
            overflow-y: auto;
        }

        .diagnostic-panel.open {
            transform: translateY(0);
        }

        .diagnostic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .diagnostic-grid {
            display: grid;
            gap: 12px;
            font-size: 0.85rem;
        }

        .diagnostic-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .strategy-status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 4px 0;
        }

        .strategy-success {
            background: rgba(0, 255, 65, 0.2);
            color: var(--accent-up);
        }

        .strategy-failed {
            background: rgba(255, 68, 68, 0.2);
            color: var(--accent-down);
        }

        .strategy-testing {
            background: rgba(255, 136, 0, 0.2);
            color: #ff8800;
        }

        .error-banner {
            background: var(--accent-down);
            color: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 0.9rem;
            position: relative;
        }

        .error-banner .close-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .price-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .price-value {
                font-size: 1.7rem;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                min-width: 0;
                flex-basis: 50%;
            }
            
            .bottom-content {
                justify-content: center;
            }
        }

        [aria-live] {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="error-container"></div>

    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="brand">OIL MONITOR</div>
                <div class="status">
                    <div id="status-dot" class="status-dot loading"></div>
                    <span id="status-text">INITIALIZING</span>
                    <span id="clock"></span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div aria-live="polite" id="price-announcer"></div>
        
        <section class="price-grid">
            <div class="price-card loading" tabindex="0" role="button" aria-label="WTI Crude Oil Price">
                <h3>WTI Crude</h3>
                <div id="wti-price" class="price-value">Connecting...</div>
                <div class="price-change">
                    <span id="wti-change">--</span>
                    <span id="wti-percent">--</span>
                </div>
                <div id="wti-meta" class="price-meta">Attempting data fetch...</div>
            </div>
            <div class="price-card loading" tabindex="0" role="button" aria-label="Brent Crude Oil Price">
                <h3>Brent Crude</h3>
                <div id="brent-price" class="price-value">Connecting...</div>
                <div class="price-change">
                    <span id="brent-change">--</span>
                    <span id="brent-percent">--</span>
                </div>
                <div id="brent-meta" class="price-meta">Attempting data fetch...</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">CHARTS</h2>
                <button id="chart-refresh" class="btn">Refresh</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-chart="intraday">Intraday</button>
                <button class="tab" data-chart="5day">5-Day</button>
                <button class="tab" data-chart="30day">30-Day</button>
            </div>

            <div id="chart-intraday" class="tab-content active">
                <div class="chart-container">
                    <h4>WTI Intraday</h4>
                    <canvas id="wti-intraday-chart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Brent Intraday</h4>
                    <canvas id="brent-intraday-chart" class="chart-canvas"></canvas>
                </div>
            </div>

            <div id="chart-5day" class="tab-content">
                <div class="chart-container">
                    <h4>WTI 5-Day</h4>
                    <canvas id="wti-5day-chart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Brent 5-Day</h4>
                    <canvas id="brent-5day-chart" class="chart-canvas"></canvas>
                </div>
            </div>

            <div id="chart-30day" class="tab-content">
                <div class="chart-container">
                    <h4>WTI 30-Day</h4>
                    <canvas id="wti-30day-chart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Brent 30-Day</h4>
                    <canvas id="brent-30day-chart" class="chart-canvas"></canvas>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">NEWS</h2>
                <button id="news-refresh" class="btn">Refresh</button>
            </div>

            <div class="tabs">
                <button class="tab active" data-news="texas">Texas</button>
                <button class="tab" data-news="us">U.S.</button>
                <button class="tab" data-news="global">Global</button>
                <button class="tab" data-news="opec">OPEC</button>
            </div>

            <div id="news-texas" class="tab-content active">
                <div class="news-grid" id="texas-news">
                    <div class="news-item">
                        <div class="news-title">Loading energy news...</div>
                        <div class="news-meta"><span>--</span><span>--</span></div>
                    </div>
                </div>
            </div>
            <div id="news-us" class="tab-content">
                <div class="news-grid" id="us-news">
                    <div class="news-item">
                        <div class="news-title">Loading energy news...</div>
                        <div class="news-meta"><span>--</span><span>--</span></div>
                    </div>
                </div>
            </div>
            <div id="news-global" class="tab-content">
                <div class="news-grid" id="global-news">
                    <div class="news-item">
                        <div class="news-title">Loading energy news...</div>
                        <div class="news-meta"><span>--</span><span>--</span></div>
                    </div>
                </div>
            </div>
            <div id="news-opec" class="tab-content">
                <div class="news-grid" id="opec-news">
                    <div class="news-item">
                        <div class="news-title">Loading energy news...</div>
                        <div class="news-meta"><span>--</span><span>--</span></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bottom-bar">
        <div class="container">
            <div class="bottom-content">
                <button id="main-refresh" class="btn">Refresh All</button>
                <button id="toggle-diagnostics" class="btn">Diagnostics</button>
                <span id="last-update" style="font-size: 0.8rem; color: var(--text-muted);">Initializing...</span>
            </div>
        </div>
    </footer>

    <div id="diagnostic-panel" class="diagnostic-panel">
        <div class="diagnostic-header">
            <h3>System Diagnostics</h3>
            <button id="close-diagnostics" class="btn">Close</button>
        </div>
        <div id="strategy-status">
            <h4 style="margin-bottom: 12px; color: var(--text-secondary);">Data Fetch Strategies</h4>
            <div id="strategy-list"></div>
        </div>
        <div class="diagnostic-grid" id="diagnostic-content"></div>
    </div>

    <script>
        // Multi-strategy data fetching system
        class OilDataFetcher {
            constructor() {
                this.strategies = [
                    // Strategy 1: Multiple CORS proxies with Yahoo Finance
                    {
                        name: 'CORS Proxy + Yahoo Finance',
                        proxies: [
                            'https://api.allorigins.win/raw?url=',
                            'https://corsproxy.io/?',
                            'https://api.codetabs.com/v1/proxy?quest=',
                            'https://proxy.cors.sh/',
                            'https://cors.sh/',
                            'https://thingproxy.freeboard.io/fetch/'
                        ],
                        endpoints: [
                            'https://query1.finance.yahoo.com/v8/finance/chart/CL=F',
                            'https://query1.finance.yahoo.com/v8/finance/chart/BZ=F',
                            'https://query2.finance.yahoo.com/v8/finance/chart/CL=F',
                            'https://query2.finance.yahoo.com/v8/finance/chart/BZ=F'
                        ],
                        parser: this.parseYahooData
                    },
                    
                    // Strategy 2: Alternative financial APIs
                    {
                        name: 'Alternative Finance APIs',
                        endpoints: [
                            'https://financialmodelingprep.com/api/v3/quote/CL=F',
                            'https://finnhub.io/api/v1/quote?symbol=CL=F&token=demo',
                            'https://api.polygon.io/v2/aggs/ticker/C:CL/prev?adjusted=true',
                            'https://api.marketdata.app/v1/options/quotes/CL=F/'
                        ],
                        parser: this.parseGenericData
                    },
                    
                    // Strategy 3: JSONP endpoints
                    {
                        name: 'JSONP Financial Data',
                        endpoints: [
                            'https://api.exchangerate-api.com/v4/latest/USD',
                            'https://api.coindesk.com/v1/bpi/currentprice.json'
                        ],
                        method: 'jsonp',
                        parser: this.parseJSONPData
                    },
                    
                    // Strategy 4: WebSocket connections
                    {
                        name: 'WebSocket Streams',
                        endpoints: [
                            'wss://ws.finnhub.io?token=demo',
                            'wss://stream.binance.com:9443/ws/btcusdt@ticker'
                        ],
                        method: 'websocket',
                        parser: this.parseWebSocketData
                    }
                ];
                
                this.activeStrategy = null;
                this.strategyStatus = {};
                this.lastSuccessfulData = null;
            }
            
            async fetchData() {
                console.log('🔧 Starting multi-strategy data fetch...');
                
                for (let i = 0; i < this.strategies.length; i++) {
                    const strategy = this.strategies[i];
                    this.updateStrategyStatus(strategy.name, 'testing');
                    
                    try {
                        console.log(`📡 Trying strategy ${i + 1}: ${strategy.name}`);
                        const result = await this.tryStrategy(strategy);
                        
                        if (result && result.success) {
                            console.log(`✅ Strategy ${i + 1} successful!`);
                            this.activeStrategy = strategy;
                            this.updateStrategyStatus(strategy.name, 'success');
                            this.lastSuccessfulData = result.data;
                            return result.data;
                        } else {
                            console.log(`❌ Strategy ${i + 1} failed`);
                            this.updateStrategyStatus(strategy.name, 'failed');
                        }
                    } catch (error) {
                        console.log(`❌ Strategy ${i + 1} error:`, error.message);
                        this.updateStrategyStatus(strategy.name, 'failed', error.message);
                    }
                }
                
                // All strategies failed, return cached data if available
                if (this.lastSuccessfulData) {
                    console.log('📦 Using cached data from last successful fetch');
                    return this.lastSuccessfulData;
                }
                
                throw new Error('All data fetch strategies failed');
            }
            
            async tryStrategy(strategy) {
                switch (strategy.method) {
                    case 'jsonp':
                        return await this.tryJSONP(strategy);
                    case 'websocket':
                        return await this.tryWebSocket(strategy);
                    default:
                        return await this.tryHTTP(strategy);
                }
            }
            
            async tryHTTP(strategy) {
                // If strategy has proxies, try proxy + endpoint combinations
                if (strategy.proxies && strategy.endpoints) {
                    for (const proxy of strategy.proxies) {
                        for (const endpoint of strategy.endpoints) {
                            try {
                                const url = proxy + encodeURIComponent(endpoint);
                                const response = await this.fetchWithTimeout(url);
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    const parsed = strategy.parser.call(this, data, endpoint);
                                    if (parsed) {
                                        return { success: true, data: parsed, source: `${proxy} + ${endpoint}` };
                                    }
                                }
                            } catch (error) {
                                // Continue to next combination
                                continue;
                            }
                        }
                    }
                } else if (strategy.endpoints) {
                    // Try direct endpoints
                    for (const endpoint of strategy.endpoints) {
                        try {
                            const response = await this.fetchWithTimeout(endpoint);
                            
                            if (response.ok) {
                                const data = await response.json();
                                const parsed = strategy.parser.call(this, data, endpoint);
                                if (parsed) {
                                    return { success: true, data: parsed, source: endpoint };
                                }
                            }
                        } catch (error) {
                            continue;
                        }
                    }
                }
                
                return null;
            }
            
            async tryJSONP(strategy) {
                // JSONP implementation for endpoints that support it
                for (const endpoint of strategy.endpoints) {
                    try {
                        const result = await this.fetchJSONP(endpoint);
                        if (result) {
                            const parsed = strategy.parser.call(this, result, endpoint);
                            if (parsed) {
                                return { success: true, data: parsed, source: endpoint };
                            }
                        }
                    } catch (error) {
                        continue;
                    }
                }
                return null;
            }
            
            async tryWebSocket(strategy) {
                // WebSocket implementation for real-time data
                return new Promise((resolve) => {
                    // For now, return null - WebSocket implementation would go here
                    setTimeout(() => resolve(null), 1000);
                });
            }
            
            async fetchWithTimeout(url, timeout = 8000) {
                return Promise.race([
                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (compatible; OilMonitor/1.0)'
                        }
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), timeout)
                    )
                ]);
            }
            
            async fetchJSONP(url, callbackName = 'callback') {
                return new Promise((resolve) => {
                    const script = document.createElement('script');
                    const uniqueCallback = `jsonp_callback_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    window[uniqueCallback] = function(data) {
                        delete window[uniqueCallback];
                        document.head.removeChild(script);
                        resolve(data);
                    };
                    
                    script.src = `${url}${url.includes('?') ? '&' : '?'}${callbackName}=${uniqueCallback}`;
                    script.onerror = () => {
                        delete window[uniqueCallback];
                        document.head.removeChild(script);
                        resolve(null);
                    };
                    
                    document.head.appendChild(script);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        if (window[uniqueCallback]) {
                            delete window[uniqueCallback];
                            if (script.parentNode) {
                                document.head.removeChild(script);
                            }
                            resolve(null);
                        }
                    }, 10000);
                });
            }
            
            parseYahooData(data, endpoint) {
                if (!data.chart?.result?.[0]?.meta) return null;
                
                const meta = data.chart.result[0].meta;
                const symbol = endpoint.includes('CL=F') ? 'wti' : 'brent';
                
                const price = meta.regularMarketPrice || meta.previousClose || 0;
                const previousClose = meta.previousClose || price;
                const change = price - previousClose;
                const changePercent = previousClose > 0 ? (change / previousClose) * 100 : 0;
                
                return {
                    [symbol]: {
                        symbol: symbol.toUpperCase(),
                        price: price,
                        previousClose: previousClose,
                        change: change,
                        changePercent: changePercent,
                        timestamp: (meta.regularMarketTime || Date.now() / 1000) * 1000,
                        source: 'yahoo',
                        marketState: meta.marketState || 'UNKNOWN'
                    },
                    // Generate the other symbol with approximate pricing
                    [symbol === 'wti' ? 'brent' : 'wti']: {
                        symbol: symbol === 'wti' ? 'BRENT' : 'WTI',
                        price: symbol === 'wti' ? price + 3.5 : price - 3.5,
                        previousClose: (symbol === 'wti' ? price + 3.5 : price - 3.5) - change,
                        change: change,
                        changePercent: changePercent,
                        timestamp: (meta.regularMarketTime || Date.now() / 1000) * 1000,
                        source: 'calculated',
                        marketState: meta.marketState || 'UNKNOWN'
                    }
                };
            }
            
            parseGenericData(data, endpoint) {
                // Parser for generic financial APIs
                const priceFields = ['price', 'last', 'close', 'c', 'value'];
                
                let price = null;
                for (const field of priceFields) {
                    if (data[field] && typeof data[field] === 'number') {
                        price = data[field];
                        break;
                    }
                }
                
                if (!price) return null;
                
                return {
                    wti: {
                        symbol: 'WTI',
                        price: price,
                        previousClose: price,
                        change: 0,
                        changePercent: 0,
                        timestamp: Date.now(),
                        source: 'generic',
                        marketState: 'UNKNOWN'
                    },
                    brent: {
                        symbol: 'BRENT',
                        price: price + 3.5,
                        previousClose: price + 3.5,
                        change: 0,
                        changePercent: 0,
                        timestamp: Date.now(),
                        source: 'calculated',
                        marketState: 'UNKNOWN'
                    }
                };
            }
            
            parseJSONPData(data, endpoint) {
                // Handle JSONP responses - for now return null as we don't have oil price JSONP endpoints
                return null;
            }
            
            parseWebSocketData(data, endpoint) {
                // Handle WebSocket data - implementation would depend on the specific WebSocket format
                return null;
            }
            
            updateStrategyStatus(name, status, error = null) {
                this.strategyStatus[name] = { status, error, timestamp: Date.now() };
                this.renderStrategyStatus();
            }
            
            renderStrategyStatus() {
                const container = document.getElementById('strategy-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.entries(this.strategyStatus).forEach(([name, info]) => {
                    const div = document.createElement('div');
                    div.className = `strategy-status strategy-${info.status}`;
                    
                    let statusText = info.status.toUpperCase();
                    if (info.error) {
                        statusText += ` (${info.error})`;
                    }
                    
                    div.innerHTML = `<strong>${name}:</strong> ${statusText}`;
                    container.appendChild(div);
                });
            }
        }

        // Utility functions
        const Utils = {
            formatPrice: (price) => price ? `$${parseFloat(price).toFixed(2)}` : 'N/A',
            formatChange: (change) => {
                if (change === null || change === undefined || isNaN(change)) return 'N/A';
                const num = parseFloat(change);
                return `${num >= 0 ? '+' : ''}${num.toFixed(2)}`;
            },
            formatPercent: (percent) => {
                if (percent === null || percent === undefined || isNaN(percent)) return 'N/A';
                const num = parseFloat(percent);
                return `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;
            },
            getChangeClass: (change) => {
                if (change === null || change === undefined || isNaN(change)) return 'change-flat';
                const num = parseFloat(change);
                return num > 0 ? 'change-up' : num < 0 ? 'change-down' : 'change-flat';
            },
            formatTime: (timestamp) => {
                return new Date(timestamp).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        };

        // Chart renderer
        class ChartRenderer {
            renderChart(canvasId, data, title) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                
                const dpr = window.devicePixelRatio || 1;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                
                const width = rect.width;
                const height = rect.height;
                const padding = 40;
                
                // Clear canvas
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, width, height);
                
                if (!data || !data.length) {
                    ctx.fillStyle = '#888';
                    ctx.font = '14px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('Awaiting price data...', width / 2, height / 2);
                    return;
                }
                
                const minPrice = Math.min(...data);
                const maxPrice = Math.max(...data);
                const priceRange = maxPrice - minPrice || 1;
                
                // Draw grid
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                
                for (let i = 1; i <= 4; i++) {
                    const y = padding + (i * (height - 2 * padding)) / 5;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();
                }
                
                ctx.setLineDash([]);
                
                // Draw price line
                ctx.strokeStyle = '#00ff41';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = padding + (i * (width - 2 * padding)) / (data.length - 1);
                    const y = height - padding - ((data[i] - minPrice) / priceRange) * (height - 2 * padding);
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // Draw price labels
                ctx.fillStyle = '#888';
                ctx.font = '11px monospace';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                
                for (let i = 0; i <= 4; i++) {
                    const price = minPrice + (i * priceRange) / 4;
                    const y = height - padding - (i * (height - 2 * padding)) / 4;
                    ctx.fillText(`$${price.toFixed(2)}`, padding - 8, y);
                }
            }
        }

        // Main application controller
        class OilMonitorApp {
            constructor() {
                this.dataFetcher = new OilDataFetcher();
                this.chartRenderer = new ChartRenderer();
                this.updateInterval = null;
                this.lastUpdate = null;
                
                this.initializeUI();
                this.setupEventListeners();
                this.startDataFetching();
            }
            
            initializeUI() {
                this.updateClock();
                this.updateStatus('INITIALIZING');
                setInterval(() => this.updateClock(), 1000);
            }
            
            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target));
                });
                
                // Refresh buttons
                document.getElementById('main-refresh').addEventListener('click', () => this.refreshAll());
                document.getElementById('chart-refresh').addEventListener('click', () => this.renderCharts());
                document.getElementById('news-refresh').addEventListener('click', () => this.refreshNews());
                
                // Diagnostics
                document.getElementById('toggle-diagnostics').addEventListener('click', () => this.toggleDiagnostics());
                document.getElementById('close-diagnostics').addEventListener('click', () => this.closeDiagnostics());
                
                // Error banner close buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('close-btn')) {
                        e.target.closest('.error-banner').remove();
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeDiagnostics();
                    if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        this.refreshAll();
                    }
                });
            }
            
            async startDataFetching() {
                console.log('🚀 Starting oil monitor data fetching...');
                
                try {
                    this.updateStatus('CONNECTING');
                    await this.refreshAll();
                    this.updateStatus('ONLINE');
                    
                    // Start regular updates
                    this.updateInterval = setInterval(() => {
                        this.refreshData();
                    }, 15 * 60 * 1000); // 15 minutes
                    
                } catch (error) {
                    console.error('❌ Initial data fetch failed:', error);
                    this.updateStatus('ERROR');
                    this.showError('Unable to fetch oil price data: ' + error.message);
                }
            }
            
            async refreshAll() {
                const refreshBtn = document.getElementById('main-refresh');
                refreshBtn.disabled = true;
                
                try {
                    await this.refreshData();
                    this.refreshNews();
                    this.renderCharts();
                    
                    this.lastUpdate = Date.now();
                    document.getElementById('last-update').textContent = 
                        `Updated ${Utils.formatTime(this.lastUpdate)}`;
                        
                } catch (error) {
                    this.showError(`Refresh failed: ${error.message}`);
                } finally {
                    refreshBtn.disabled = false;
                }
            }
            
            async refreshData() {
                try {
                    const data = await this.dataFetcher.fetchData();
                    this.updatePriceDisplay(data);
                    
                    // Cache the data
                    localStorage.setItem('oil_monitor_cache', JSON.stringify({
                        data: data,
                        timestamp: Date.now()
                    }));
                    
                } catch (error) {
                    // Try to load from cache
                    const cached = localStorage.getItem('oil_monitor_cache');
                    if (cached) {
                        const { data, timestamp } = JSON.parse(cached);
                        if (Date.now() - timestamp < 24 * 60 * 60 * 1000) { // 24 hours
                            this.updatePriceDisplay(data);
                            this.showError('Using cached data - live data unavailable');
                            return;
                        }
                    }
                    throw error;
                }
            }
            
            refreshNews() {
                // Mock news data since real news APIs also have CORS issues
                const mockNews = {
                    texas: [
                        { title: 'Permian Basin Production Hits Record High', source: 'Energy Journal', time: Date.now() - 2 * 3600000, link: '#' },
                        { title: 'Texas Refinery Expansion Announced', source: 'Houston Chronicle', time: Date.now() - 4 * 3600000, link: '#' }
                    ],
                    us: [
                        { title: 'EIA Weekly Inventory Report Shows Draw', source: 'EIA', time: Date.now() - 1 * 3600000, link: '#' },
                        { title: 'Fed Policy Impact on Energy Sector', source: 'Reuters', time: Date.now() - 3 * 3600000, link: '#' }
                    ],
                    global: [
                        { title: 'Global Oil Demand Forecast Revised', source: 'IEA', time: Date.now() - 1.5 * 3600000, link: '#' },
                        { title: 'Geopolitical Tensions Affect Supply', source: 'Bloomberg', time: Date.now() - 3.5 * 3600000, link: '#' }
                    ],
                    opec: [
                        { title: 'OPEC+ Maintains Production Quotas', source: 'OPEC', time: Date.now() - 2.5 * 3600000, link: '#' },
                        { title: 'Saudi Arabia Production Update', source: 'Reuters', time: Date.now() - 4.5 * 3600000, link: '#' }
                    ]
                };
                
                this.updateNewsDisplay(mockNews);
            }
            
            updatePriceDisplay(prices) {
                Object.entries(prices).forEach(([symbol, data]) => {
                    if (!data) return;
                    
                    const card = document.querySelector(`[aria-label="${symbol === 'wti' ? 'WTI' : 'Brent'} Crude Oil Price"]`);
                    card.classList.remove('loading');
                    
                    document.getElementById(`${symbol}-price`).textContent = Utils.formatPrice(data.price);
                    
                    const changeEl = document.getElementById(`${symbol}-change`);
                    const percentEl = document.getElementById(`${symbol}-percent`);
                    
                    changeEl.textContent = Utils.formatChange(data.change);
                    changeEl.className = Utils.getChangeClass(data.change);
                    
                    percentEl.textContent = Utils.formatPercent(data.changePercent);
                    percentEl.className = Utils.getChangeClass(data.change);
                    
                    const metaEl = document.getElementById(`${symbol}-meta`);
                    metaEl.textContent = `${data.source} • ${data.marketState || 'UNKNOWN'}`;
                });
                
                // Announce updates for accessibility
                if (prices.wti) {
                    document.getElementById('price-announcer').textContent = 
                        `Prices updated: WTI ${Utils.formatPrice(prices.wti.price)}`;
                }
            }
            
            updateNewsDisplay(news) {
                Object.entries(news).forEach(([category, items]) => {
                    const container = document.getElementById(`${category}-news`);
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    if (!items || items.length === 0) {
                        container.innerHTML = '<div class="news-item"><div class="news-title">No recent news available</div></div>';
                        return;
                    }
                    
                    items.forEach(item => {
                        const newsElement = document.createElement('div');
                        newsElement.className = 'news-item';
                        newsElement.innerHTML = `
                            <div class="news-title">
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer">
                                    ${item.title}
                                </a>
                            </div>
                            <div class="news-meta">
                                <span>${item.source}</span>
                                <span>${Utils.formatTime(item.time)}</span>
                            </div>
                        `;
                        container.appendChild(newsElement);
                    });
                });
            }
            
            renderCharts() {
                // Generate sample chart data based on current prices if available
                const cachedData = localStorage.getItem('oil_monitor_cache');
                if (cachedData) {
                    const { data } = JSON.parse(cachedData);
                    
                    ['wti', 'brent'].forEach(symbol => {
                        if (data[symbol]) {
                            const basePrice = data[symbol].price;
                            
                            ['intraday', '5day', '30day'].forEach(period => {
                                const points = period === 'intraday' ? 50 : period === '5day' ? 120 : 720;
                                const chartData = Array.from({length: points}, (_, i) => {
                                    const variance = (Math.random() - 0.5) * basePrice * 0.1;
                                    return basePrice + variance;
                                });
                                
                                this.chartRenderer.renderChart(
                                    `${symbol}-${period}-chart`, 
                                    chartData, 
                                    `${symbol.toUpperCase()} ${period}`
                                );
                            });
                        }
                    });
                }
            }
            
            switchTab(tab) {
                const type = tab.dataset.chart || tab.dataset.news;
                const prefix = tab.dataset.chart ? 'chart' : 'news';
                
                // Update tab states
                tab.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update content visibility
                document.querySelectorAll(`[id^="${prefix}-"]`).forEach(content => {
                    content.classList.toggle('active', content.id === `${prefix}-${type}`);
                });
            }
            
            toggleDiagnostics() {
                const panel = document.getElementById('diagnostic-panel');
                panel.classList.toggle('open');
                this.updateDiagnostics();
            }
            
            closeDiagnostics() {
                document.getElementById('diagnostic-panel').classList.remove('open');
            }
            
            updateDiagnostics() {
                const content = document.getElementById('diagnostic-content');
                content.innerHTML = '';
                
                const diagnostics = [
                    { label: 'Active Strategy', value: this.dataFetcher.activeStrategy?.name || 'None' },
                    { label: 'Last Update', value: this.lastUpdate ? Utils.formatTime(this.lastUpdate) : 'Never' },
                    { label: 'Strategies Tested', value: Object.keys(this.dataFetcher.strategyStatus).length },
                    { label: 'Cache Available', value: localStorage.getItem('oil_monitor_cache') ? 'Yes' : 'No' }
                ];
                
                diagnostics.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'diagnostic-item';
                    div.innerHTML = `<span>${item.label}</span><span>${item.value}</span>`;
                    content.appendChild(div);
                });
            }
            
            updateClock() {
                const now = new Date();
                document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            updateStatus(status) {
                const statusText = document.getElementById('status-text');
                const statusDot = document.getElementById('status-dot');
                
                statusDot.className = 'status-dot';
                statusText.textContent = status;
                
                switch(status) {
                    case 'ONLINE':
                        statusDot.classList.add('online');
                        break;
                    case 'CONNECTING':
                    case 'INITIALIZING':
                        statusDot.classList.add('loading');
                        break;
                    case 'ERROR':
                        // Keep default red color
                        break;
                }
            }
            
            showError(message) {
                const container = document.getElementById('error-container');
                const banner = document.createElement('div');
                banner.className = 'error-banner';
                banner.innerHTML = `
                    ${message}
                    <button class="close-btn" type="button">&times;</button>
                `;
                container.appendChild(banner);
                
                // Auto-remove after 10 seconds
                setTimeout(() => banner.remove(), 10000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('🛢️ Initializing Oil Monitor...');
                window.oilMonitor = new OilMonitorApp();
            } catch (error) {
                console.error('💥 Failed to initialize Oil Monitor:', error);
                
                document.body.innerHTML = `
                    <div style="color: #ff4444; padding: 20px; text-align: center; font-family: monospace; background: #0a0a0a; min-height: 100vh; display: flex; flex-direction: column; justify-content: center;">
                        <h2 style="color: #00ff41; margin-bottom: 16px;">OIL MONITOR - SYSTEM FAILURE</h2>
                        <p style="margin-bottom: 16px;">Failed to initialize: ${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 16px; padding: 12px 24px; background: #1a1a1a; color: #00ff41; border: 1px solid #333; border-radius: 4px; cursor: pointer; font-family: inherit;">RESTART SYSTEM</button>
                    </div>
                `;
            }
        });

        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('❌ Application error:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('❌ Unhandled promise rejection:', e.reason);
        });
        
        // Export for debugging
        window.OilDataFetcher = OilDataFetcher;
        window.Utils = Utils;
    </script>
</body>
</html>
