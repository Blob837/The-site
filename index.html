<!DOCTYPE html>
<!--
CHANGELOG:
- Replaced heavy neon theme with clean terminal dark theme using CSS variables
- Reduced CSS from 700+ to ~400 lines, removed redundant animations
- Added skeleton loading states and optimistic UI updates
- Improved keyboard navigation and focus management
- Performance: removed heavy backdrop-filters, simplified animations to transform/opacity
- Added prefers-reduced-motion support
- Maintained exact DOM structure and all existing functionality
- Optimized fetch operations and reduced layout thrash
-->
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>UR NEWS - Terminal Intelligence</title>
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Real-time intelligence terminal for breaking news and political analysis">
<style>
  :root {
    --bg: #0b0f14;
    --panel: #10161b;
    --muted: #93a1a1;
    --text: #e6edf3;
    --accent: #4cc2ff;
    --ok: #3bd671;
    --warn: #f5c451;
    --err: #ff6b6b;
    --border: #1f2a33;
    --hover: #161e24;
    --focus: #2d3748;
    --skeleton: #1a2027;
  }
  
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--text);
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
    font-size: 14px;
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    overflow-x: hidden;
  }

  /* Animations - respect motion preferences */
  @media (prefers-reduced-motion: no-preference) {
    .smooth { transition: all 0.15s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .slide { transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .fade { transition: opacity 0.15s ease; }
  }

  /* Skeleton loading */
  .skeleton {
    background: linear-gradient(90deg, var(--skeleton) 25%, var(--hover) 50%, var(--skeleton) 75%);
    background-size: 200% 100%;
    border-radius: 4px;
  }

  @media (prefers-reduced-motion: no-preference) {
    .skeleton {
      animation: shimmer 1.5s infinite;
    }
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  /* Header */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
  }
  
  .bar {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
  }
  
  .title {
    font-weight: 700;
    letter-spacing: 0.5px;
    font-size: 1.1rem;
    flex: 1;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .blip {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--ok);
    flex-shrink: 0;
  }

  @media (prefers-reduced-motion: no-preference) {
    .blip {
      animation: pulse 2s infinite;
    }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  
  .meta {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
  }
  
  /* Filter chips */
  .filters {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding: 0 1rem 1rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .filters::-webkit-scrollbar { display: none; }
  
  .chip {
    white-space: nowrap;
    padding: 0.5rem 0.8rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--panel);
    color: var(--muted);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    flex-shrink: 0;
  }

  .chip:hover {
    border-color: var(--accent);
    color: var(--text);
    background: var(--hover);
  }

  .chip:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  .chip.active {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }

  .chip[data-view="popular"].active {
    background: var(--warn);
    border-color: var(--warn);
  }
  
  /* Main content */
  main {
    padding: 1rem;
    max-width: 1000px;
    margin: 0 auto;
    padding-bottom: 4rem;
  }
  
  /* Cards */
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1rem;
    position: relative;
  }

  .card:hover {
    border-color: var(--accent);
  }

  .card.open {
    border-color: var(--accent);
  }

  .card.popular::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--warn);
  }

  .card-head {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0.8rem;
    align-items: flex-start;
    padding: 1rem;
    cursor: pointer;
  }
  
  .card-head:hover {
    background: var(--hover);
  }

  .card-head:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: -2px;
  }
  
  .favicon {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    background: var(--skeleton);
    background-size: cover;
    background-position: center;
    border: 1px solid var(--border);
    flex-shrink: 0;
    margin-top: 2px;
  }
  
  .titleline {
    font-size: 0.9rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--text);
    margin-bottom: 0.4rem;
    word-wrap: break-word;
  }
  
  .card:hover .titleline {
    color: var(--accent);
  }
  
  .tag {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    flex-wrap: wrap;
  }
  
  .badge {
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.2rem 0.4rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    background: var(--hover);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .badge.trending {
    border-color: var(--warn);
    color: var(--warn);
    background: var(--bg);
  }

  .badge.sentiment {
    background: var(--bg);
    border-color: var(--border);
    color: var(--muted);
  }

  .badge.sentiment.positive {
    border-color: var(--ok);
    color: var(--ok);
  }

  .badge.sentiment.negative {
    border-color: var(--err);
    color: var(--err);
  }

  .badge.sentiment.neutral {
    border-color: var(--muted);
    color: var(--muted);
  }

  .breaking-indicator {
    display: inline-block;
    background: var(--err);
    color: var(--bg);
    font-size: 0.6rem;
    font-weight: 700;
    padding: 0.15rem 0.3rem;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-left: 0.3rem;
    flex-shrink: 0;
  }

  @media (prefers-reduced-motion: no-preference) {
    .breaking-indicator {
      animation: pulse 1.5s infinite;
    }
  }
  
  .time {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
    white-space: nowrap;
  }
  
  .expand-btn {
    color: var(--muted);
    font-size: 0.9rem;
    user-select: none;
    flex-shrink: 0;
    width: 20px;
    text-align: center;
  }

  .card:hover .expand-btn {
    color: var(--accent);
  }

  .card.open .expand-btn {
    color: var(--accent);
    transform: rotate(180deg);
  }
  
  .card-body {
    padding: 1rem;
    font-size: 0.85rem;
    color: var(--muted);
    line-height: 1.5;
    display: none;
    background: var(--bg);
    border-top: 1px solid var(--border);
    word-wrap: break-word;
  }
  
  .card.open .card-body {
    display: block;
  }

  .card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .source-header {
    margin: 2rem 0 1rem;
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--accent);
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  
  .article-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
    background: var(--accent);
    color: var(--bg);
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-size: 0.75rem;
    text-decoration: none;
    flex: 1;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }

  .article-link:hover {
    background: var(--focus);
    color: var(--accent);
    border: 1px solid var(--accent);
  }

  .article-link:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .read-btn {
    background: var(--panel);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .read-btn:hover {
    background: var(--hover);
    border-color: var(--accent);
  }
  
  /* Article reader modal */
  .reader-modal {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 2000;
    display: none;
  }

  .reader-modal.active {
    display: flex;
    flex-direction: column;
  }

  .reader-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
  }

  .reader-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text);
    flex: 1;
    margin-right: 1rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .reader-close {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: var(--err);
    color: var(--bg);
    border: none;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: inherit;
  }

  .reader-close:hover {
    background: var(--focus);
    color: var(--err);
    border: 1px solid var(--err);
  }

  .reader-close:focus-visible {
    outline: 2px solid var(--err);
    outline-offset: 2px;
  }

  .reader-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }

  .reader-content {
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .reader-content p {
    margin-bottom: 1rem;
  }

  .reader-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: var(--muted);
    font-size: 0.85rem;
  }

  .reader-error {
    color: var(--err);
    text-align: center;
    padding: 2rem;
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    color: var(--text);
    padding: 0.8rem 1rem;
    border-radius: 6px;
    z-index: 3000;
    font-weight: 500;
    border: 1px solid var(--border);
    max-width: 85%;
    text-align: center;
    font-size: 0.8rem;
  }
  
  .toast.success {
    border-color: var(--ok);
    color: var(--ok);
  }
  
  .toast.error {
    border-color: var(--err);
    color: var(--err);
  }

  /* Reset button */
  .btn.reset {
    border: 1px solid var(--warn);
    background: var(--panel);
    color: var(--warn);
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-family: inherit;
    cursor: pointer;
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    z-index: 100;
  }
  
  .btn.reset:hover {
    background: var(--warn);
    color: var(--bg);
  }

  .btn.reset:focus-visible {
    outline: 2px solid var(--warn);
    outline-offset: 2px;
  }

  /* Source toggles */
  .src-grid {
    display: flex;
    gap: 0.4rem;
    overflow-x: auto;
    padding: 1rem 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .src-grid::-webkit-scrollbar { display: none; }

  .src {
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    background: var(--panel);
    border: 1px solid var(--border);
    font-size: 0.7rem;
    color: var(--muted);
    cursor: pointer;
    font-weight: 500;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    flex-shrink: 0;
  }

  .src:hover {
    border-color: var(--accent);
    color: var(--text);
    background: var(--hover);
  }

  .src:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .src.on {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }

  /* Empty state */
  .empty {
    color: var(--muted);
    text-align: center;
    padding: 3rem 1.5rem;
    background: var(--panel);
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .empty h3 {
    color: var(--accent);
    margin-bottom: 1rem;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Loading states */
  .loading-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .loading-title {
    height: 1.2rem;
    margin-bottom: 0.5rem;
  }

  .loading-meta {
    height: 0.8rem;
    width: 60%;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .card-actions {
      flex-direction: column;
    }
    
    .article-link {
      width: 100%;
    }

    .bar {
      padding: 0.8rem;
    }

    main {
      padding: 0.8rem;
    }
  }

  @media (max-width: 480px) {
    .title {
      font-size: 1rem;
    }
    
    .filters {
      padding: 0 0.8rem 0.8rem;
      gap: 0.3rem;
    }
    
    .chip {
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
    }
    
    .reader-body {
      padding: 1rem;
    }
  }

  /* Focus management */
  [tabindex="-1"]:focus {
    outline: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">
      <span class="blip" aria-label="Live status"></span>UR NEWS
      <span class="meta" id="lastUpdated">â€¢ INITIALIZING</span>
    </div>
  </div>
  <div class="filters" id="filters" role="tablist" aria-label="Content filters">
    <button class="chip active smooth" data-view="all" role="tab" aria-selected="true" tabindex="0">ALL</button>
    <button class="chip smooth" data-view="popular" role="tab" aria-selected="false" tabindex="-1">ðŸ”¥ TRENDING</button>
    <button class="chip smooth" data-view="by-source" role="tab" aria-selected="false" tabindex="-1">BY SOURCE</button>
    <button class="chip smooth" data-view="conservative" role="tab" aria-selected="false" tabindex="-1">CONSERVATIVE</button>
    <button class="chip smooth" data-view="populist" role="tab" aria-selected="false" tabindex="-1">POPULIST</button>
    <button class="chip smooth" data-view="breaking" role="tab" aria-selected="false" tabindex="-1">BREAKING</button>
  </div>
</header>

<main>
  <div class="src-grid" id="sourceToggles" role="group" aria-label="News sources"></div>
  <div class="list" id="feedList" role="main" aria-live="polite"></div>
  <div class="empty" id="emptyMsg" style="display:none;">
    <h3>NO ACTIVE FEEDS</h3>
    <p>Enable sources above or wait for refresh</p>
  </div>
</main>

<div class="reader-modal" id="readerModal" role="dialog" aria-modal="true" aria-labelledby="readerTitle">
  <div class="reader-header">
    <div class="reader-title" id="readerTitle"></div>
    <button class="reader-close smooth" id="readerClose" aria-label="Close reader">Ã—</button>
  </div>
  <div class="reader-body">
    <div id="readerContent"></div>
  </div>
</div>

<button class="btn reset smooth" id="resetBtn" title="Reset application">RESET</button>

<script>


const SOURCES = [
  { id: 'breitbart', name: 'Breitbart', url: 'https://www.breitbart.com/feed/', lane: 'populist' },
  { id: 'federalist', name: 'The Federalist', url: 'https://thefederalist.com/feed/', lane: 'conservative' },
  { id: 'dailywire', name: 'Daily Wire', url: 'https://www.dailywire.com/feeds/rss.xml', lane: 'conservative' },
  { id: 'gateway', name: 'Gateway Pundit', url: 'https://www.thegatewaypundit.com/feed/', lane: 'populist' },
  { id: 'infowars', name: 'InfoWars', url: 'https://www.infowars.com/rss.xml', lane: 'populist' },
  { id: 'revolver', name: 'Revolver News', url: 'https://www.revolver.news/feed/', lane: 'populist' },
  { id: 'natfile', name: 'National File', url: 'https://nationalfile.com/feed/', lane: 'populist' },
  { id: 'tplvoice', name: "People's Voice", url: 'https://thepeoplesvoice.tv/feed/', lane: 'populist' },
  { id: 'libertydaily', name: 'Liberty Daily', url: 'https://thelibertydaily.com/rss.xml', lane: 'populist' },
  { id: 'naturalnews', name: 'Natural News', url: 'https://www.naturalnews.com/rss.xml', lane: 'populist' },
  { id: 'dailycaller', name: 'Daily Caller', url: 'https://dailycaller.com/feed/', lane: 'conservative' },
  { id: 'redstate', name: 'RedState', url: 'https://redstate.com/feed/', lane: 'conservative' },
  { id: 'amgreat', name: 'AmGreatness', url: 'https://amgreatness.com/feed/', lane: 'conservative' },
  { id: 'pjm', name: 'PJ Media', url: 'https://pjmedia.com/feeds/latest', lane: 'conservative' },
  { id: 'nypost', name: 'NY Post', url: 'https://nypost.com/feed/', lane: 'populist' },
  { id: 'townhall', name: 'Townhall', url: 'https://townhall.com/rss', lane: 'conservative' },
  { id: 'foxnews', name: 'Fox News', url: 'https://feeds.foxnews.com/foxnews/latest', lane: 'conservative' },
  { id: 'washexam', name: 'Washington Examiner', url: 'https://www.washingtonexaminer.com/feed', lane: 'conservative' },
  { id: 'theblaze', name: 'The Blaze', url: 'https://www.theblaze.com/feeds/latest.rss', lane: 'conservative' }
];

const persistedState = loadPersistedState();

const STATE = {
  enabled: new Set(persistedState.enabled || SOURCES.map(source => source.id)),
  items: [],
  view: 'all',
  loading: false,
  lastFetch: 0,
  cache: new Map(),
  expandedCards: new Set(persistedState.expanded || []),
  trendingKeywords: new Map()
};

const CACHE_TTL = 120000;
const FETCH_TIMEOUT = 4000;

const POSITIVE_WORDS = new Set([
  'win', 'wins', 'won', 'victory', 'success', 'secure', 'secured', 'boost', 'rise', 'surge',
  'growth', 'growing', 'strong', 'support', 'praise', 'gain', 'gains', 'positive', 'good', 'safe',
  'peace', 'upbeat', 'improve', 'improves', 'improved', 'progress', 'benefit', 'benefits'
]);

const NEGATIVE_WORDS = new Set([
  'loss', 'losses', 'lost', 'defeat', 'crisis', 'risk', 'risks', 'fear', 'fears', 'concern',
  'concerns', 'drop', 'drops', 'decline', 'declines', 'fall', 'falls', 'negative', 'bad', 'threat',
  'threats', 'fraud', 'attack', 'attacks', 'scandal', 'crash', 'collapse', 'danger', 'lawsuit',
  'lawsuits', 'probe', 'probes', 'charge', 'charges', 'investigation', 'chaos'
]);

const ESCAPE_MAP = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#39;'
};

let domUpdates = [];

function loadPersistedState() {
  try {
    const enabled = JSON.parse(localStorage.getItem('urnews.enabled'));
    const expanded = JSON.parse(localStorage.getItem('urnews.expanded'));
    return {
      enabled: Array.isArray(enabled) && enabled.length ? enabled : null,
      expanded: Array.isArray(expanded) ? expanded : null
    };
  } catch (error) {
    return { enabled: null, expanded: null };
  }
}

function persistState() {
  try {
    localStorage.setItem('urnews.enabled', JSON.stringify([...STATE.enabled]));
    localStorage.setItem('urnews.expanded', JSON.stringify([...STATE.expandedCards]));
  } catch (error) {
    console.warn('Storage failed:', error);
  }
}

function batchDOM(fn) {
  domUpdates.push(fn);
  if (domUpdates.length === 1) {
    requestAnimationFrame(() => {
      domUpdates.forEach(update => update());
      domUpdates = [];
    });
  }
}

function getCached(url) {
  const cached = STATE.cache.get(url);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  return null;
}

function setCached(url, data) {
  STATE.cache.set(url, { data, timestamp: Date.now() });
}

function fetchProxy(url) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), FETCH_TIMEOUT);

  const promise = fetch(url, { signal: controller.signal }).then(response => {
    clearTimeout(timer);
    if (!response.ok) {
      throw new Error('Bad response');
    }
    return response;
  }).catch(error => {
    clearTimeout(timer);
    throw error;
  });

  return {
    promise,
    cancel() {
      clearTimeout(timer);
      controller.abort();
    }
  };
}

function firstSuccessful(promises) {
  return new Promise((resolve, reject) => {
    let remaining = promises.length;
    const errors = [];

    promises.forEach((promise, index) => {
      promise
        .then(value => resolve({ value, index }))
        .catch(error => {
          errors.push(error);
          remaining -= 1;
          if (remaining === 0) {
            reject(errors[errors.length - 1] || new Error('All proxies failed'));
          }
        });
    });
  });
}

async function fetchFast(url) {
  const cached = getCached(url);
  if (cached) {
    return cached;
  }

  const targets = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://corsproxy.io/?${encodeURIComponent(url)}`
  ].map(fetchProxy);

  try {
    const { value: response, index } = await firstSuccessful(targets.map(target => target.promise));
    const text = await response.text();
    targets.forEach((target, idx) => {
      if (idx !== index) {
        target.cancel();
      }
    });
    if (!text || text.length < 100) {
      throw new Error('Empty feed');
    }
    setCached(url, text);
    return text;
  } finally {
    targets.forEach(target => target.cancel());
  }
}

function calculateTrending(items) {
  const keywords = new Map();
  const now = Date.now();

  items.forEach(item => {
    const ageHours = (now - new Date(item.pubDate)) / (1000 * 60 * 60);
    if (ageHours > 24) {
      return;
    }

    const text = `${item.title} ${item.desc}`.toLowerCase();
    const words = text.match(/\b[a-z]{4,}\b/g) || [];

    words.forEach(word => {
      if (!/^(with|that|this|from|have|were|been|their|about|would|could|should)$/.test(word)) {
        const current = keywords.get(word) || 0;
        keywords.set(word, current + (1 / Math.max(1, ageHours / 6)));
      }
    });
  });

  STATE.trendingKeywords = keywords;

  items.forEach(item => {
    const text = `${item.title} ${item.desc}`.toLowerCase();
    let score = 0;
    keywords.forEach((weight, word) => {
      if (text.includes(word)) {
        score += weight;
      }
    });
    item.trendingScore = score;
  });
}

function analyzeSentiment(item) {
  const text = `${item.title} ${item.desc}`.toLowerCase();
  const tokens = text.match(/\b[a-z]+\b/g) || [];
  let score = 0;

  tokens.forEach(word => {
    if (POSITIVE_WORDS.has(word)) {
      score += 1;
    } else if (NEGATIVE_WORDS.has(word)) {
      score -= 1;
    }
  });

  const label = score > 0 ? 'POSITIVE' : score < 0 ? 'NEGATIVE' : 'NEUTRAL';
  return { label, tone: label.toLowerCase(), score };
}

function createCardId(link) {
  let hash = 0;
  for (let i = 0; i < link.length; i += 1) {
    hash = (hash << 5) - hash + link.charCodeAt(i);
    hash |= 0;
  }
  return `card-${Math.abs(hash)}`;
}

function parseRSS(xmlString, source) {
  const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
  if (doc.getElementsByTagName('parsererror')[0]) {
    return [];
  }

  return Array.from(doc.querySelectorAll('item, entry'))
    .slice(0, 15)
    .map(entry => {
      const title = (entry.querySelector('title')?.textContent || '').trim();
      const link = (entry.querySelector('link')?.getAttribute('href') || entry.querySelector('link')?.textContent || '').trim();
      const pubDate = (entry.querySelector('pubDate, updated, published')?.textContent || '').trim();
      const desc = (entry.querySelector('description, summary')?.textContent || '').trim();

      return {
        title,
        link,
        pubDate: pubDate || new Date().toISOString(),
        source: source.name,
        lane: source.lane,
        id: source.id,
        desc: stripHTML(desc).slice(0, 250),
        isBreaking: /breaking|urgent|just in|developing|exclusive/i.test(title),
        trendingScore: 0
      };
    })
    .filter(item => item.title && item.link && item.title.length > 15);
}

function stripHTML(html) {
  const temp = document.createElement('div');
  temp.innerHTML = html;
  return temp.textContent.replace(/\s+/g, ' ').trim();
}

function showLoading() {
  const feedList = document.getElementById('feedList');
  feedList.innerHTML = '';
  const fragment = document.createDocumentFragment();

  for (let i = 0; i < 8; i += 1) {
    const skeleton = document.createElement('div');
    skeleton.className = 'loading-card';
    skeleton.innerHTML = `
      <div class="skeleton loading-title"></div>
      <div class="skeleton loading-meta"></div>
    `;
    fragment.appendChild(skeleton);
  }

  feedList.appendChild(fragment);
}

async function loadFeeds() {
  if (STATE.loading) {
    return;
  }

  const enabledSources = SOURCES.filter(source => STATE.enabled.has(source.id));
  if (enabledSources.length === 0) {
    STATE.items = [];
    render();
    document.getElementById('lastUpdated').textContent = 'â€¢ NO SOURCES';
    return;
  }

  STATE.loading = true;
  STATE.lastFetch = Date.now();
  showLoading();

  try {
    const fetches = enabledSources.map(source =>
      fetchFast(source.url)
        .then(text => parseRSS(text, source))
        .catch(error => {
          console.warn('Feed failed:', source.name, error);
          return [];
        })
    );

    const results = await Promise.all(fetches);
    const allItems = results.flat();

    const deduped = [];
    const seen = new Set();

    allItems
      .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate))
      .forEach(item => {
        if (!seen.has(item.link)) {
          seen.add(item.link);
          deduped.push(item);
        }
      });

    STATE.items = deduped.slice(0, 100);
    calculateTrending(STATE.items);
    STATE.items.forEach(item => {
      const sentiment = analyzeSentiment(item);
      item.sentimentScore = sentiment.score;
      item.sentimentLabel = sentiment.label;
      item.sentimentTone = sentiment.tone;
    });

    render();
    document.getElementById('lastUpdated').textContent = `â€¢ ${new Date().toLocaleTimeString()}`;
    toast(`${STATE.items.length} articles loaded`, 'success');
  } catch (error) {
    console.error('Failed:', error);
    document.getElementById('lastUpdated').textContent = 'â€¢ RETRY';
    toast('Loading failed', 'error');
  } finally {
    STATE.loading = false;
  }
}

async function openReader(item) {
  const modal = document.getElementById('readerModal');
  const title = document.getElementById('readerTitle');
  const content = document.getElementById('readerContent');
  modal.classList.add('active');
  title.textContent = item.title;
  content.innerHTML = '<div class="reader-loading">LOADING ARTICLE...</div>';
  document.getElementById('readerClose').focus();

  let hostname = '';
  try {
    hostname = new URL(item.link).hostname;
  } catch (error) {
    hostname = '';
  }

  const blockedDomains = ['nypost.com', 'wsj.com', 'ft.com'];
  if (blockedDomains.some(domain => hostname.includes(domain))) {
    content.innerHTML = `
      <div class="reader-error">
        This source blocks external readers. Please visit the article directly.
      </div>
    `;
    return;
  }

  try {
    const proxyUrl = `https://12ft.io/${item.link}`;
    const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(proxyUrl));
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    doc.querySelectorAll('script, style, nav, header, footer, aside').forEach(el => el.remove());

    const article = doc.querySelector('article, main, [role="main"], .content, .article-body') || doc.body;
    const paragraphs = Array.from(article.querySelectorAll('p'))
      .map(p => p.textContent.trim())
      .filter(text => text.length > 50)
      .slice(0, 30)
      .map(text => `<p>${escapeHTML(text)}</p>`)
      .join('');

    content.innerHTML = `
      <div class="reader-content">
        ${paragraphs || 'Unable to extract article content.'}
      </div>
    `;
  } catch (error) {
    content.innerHTML = `
      <div class="reader-content">
        <p><strong>Summary:</strong></p>
        <p>${escapeHTML(item.desc || 'No summary available.')}</p>
        <p style="margin-top: 2rem;">
          <a href="${escapeHTML(item.link)}" target="_blank" rel="noopener" style="color: var(--accent);">
            Click here to read the full article â†’
          </a>
        </p>
      </div>
    `;
  }
}

function createCard(item) {
  const cardId = createCardId(item.link);
  const isExpanded = STATE.expandedCards.has(cardId);
  const isTrending = item.trendingScore > 5;
  const article = document.createElement('article');
  article.className = `card smooth${isExpanded ? ' open' : ''}${isTrending ? ' popular' : ''}`;
  article.dataset.cardId = cardId;

  let hostname = '';
  try {
    hostname = new URL(item.link).hostname;
  } catch (error) {
    hostname = '';
  }

  const timeString = fmtTime(item.pubDate);
  const sentimentBadge = item.sentimentLabel
    ? `<span class="badge sentiment ${item.sentimentTone}">${item.sentimentLabel}</span>`
    : '';

  article.innerHTML = `
    <div class="card-head" tabindex="0" role="button" aria-expanded="${isExpanded}" aria-controls="body-${cardId}">
      <span class="favicon" style="background-image:url('https://www.google.com/s2/favicons?domain=${hostname}&sz=64');" aria-hidden="true"></span>
      <div>
        <div class="titleline">
          ${escapeHTML(item.title)}
          ${item.isBreaking ? '<span class="breaking-indicator">BREAKING</span>' : ''}
        </div>
        <div class="tag">
          ${escapeHTML(item.source)} â€¢ <span class="time">${timeString}</span>
          ${isTrending ? '<span class="badge trending">TRENDING</span>' : ''}
          ${sentimentBadge}
        </div>
      </div>
      <div class="expand-btn" aria-hidden="true">${isExpanded ? 'â–¼' : 'â–¶'}</div>
    </div>
    <div class="card-body" id="body-${cardId}" role="region">
      <div>${escapeHTML(item.desc || 'No summary available.')}</div>
      <div class="card-actions">
        <a href="${escapeHTML(item.link)}" target="_blank" rel="noopener" class="article-link smooth">
          OPEN SOURCE
        </a>
        <button class="article-link read-btn smooth">READ HERE</button>
      </div>
    </div>
  `;

  const header = article.querySelector('.card-head');
  const expandBtn = article.querySelector('.expand-btn');
  const readBtn = article.querySelector('.read-btn');

  const toggleCard = () => {
    const isOpen = article.classList.toggle('open');
    expandBtn.textContent = isOpen ? 'â–¼' : 'â–¶';
    header.setAttribute('aria-expanded', String(isOpen));

    if (isOpen) {
      STATE.expandedCards.add(cardId);
      document.querySelectorAll('.card.open').forEach(card => {
        if (card !== article) {
          card.classList.remove('open');
          const otherBtn = card.querySelector('.expand-btn');
          const otherHeader = card.querySelector('.card-head');
          if (otherBtn) {
            otherBtn.textContent = 'â–¶';
          }
          if (otherHeader) {
            otherHeader.setAttribute('aria-expanded', 'false');
          }
          STATE.expandedCards.delete(card.dataset.cardId);
        }
      });
    } else {
      STATE.expandedCards.delete(cardId);
    }

    persistState();
  };

  header.addEventListener('click', toggleCard);
  header.addEventListener('keydown', event => {
    if (event.key === 'Enter' || event.key === ' ') {
      event.preventDefault();
      toggleCard();
    }
  });

  readBtn.addEventListener('click', event => {
    event.preventDefault();
    openReader(item);
  });

  return article;
}

function render() {
  const feedList = document.getElementById('feedList');
  const emptyMsg = document.getElementById('emptyMsg');

  batchDOM(() => {
    feedList.innerHTML = '';
    let filtered = STATE.items.filter(item => STATE.enabled.has(item.id));

    if (STATE.view === 'by-source') {
      if (filtered.length === 0) {
        emptyMsg.style.display = 'block';
        return;
      }

      emptyMsg.style.display = 'none';
      const grouped = new Map();
      filtered.forEach(item => {
        if (!grouped.has(item.source)) {
          grouped.set(item.source, []);
        }
        grouped.get(item.source).push(item);
      });

      const fragment = document.createDocumentFragment();
      Array.from(grouped.keys()).sort().forEach(sourceName => {
        const header = document.createElement('div');
        header.className = 'source-header';
        header.textContent = sourceName;
        fragment.appendChild(header);
        grouped.get(sourceName).forEach(article => {
          fragment.appendChild(createCard(article));
        });
      });

      feedList.appendChild(fragment);
      return;
    }

    switch (STATE.view) {
      case 'popular':
        filtered = filtered
          .sort((a, b) => b.trendingScore - a.trendingScore)
          .slice(0, 30);
        break;
      case 'conservative':
        filtered = filtered.filter(item => item.lane === 'conservative');
        break;
      case 'populist':
        filtered = filtered.filter(item => item.lane === 'populist');
        break;
      case 'breaking':
        filtered = filtered.filter(item => item.isBreaking);
        break;
      default:
        filtered = filtered.slice(0, 60);
    }

    if (filtered.length === 0) {
      emptyMsg.style.display = 'block';
      return;
    }

    emptyMsg.style.display = 'none';
    const fragment = document.createDocumentFragment();
    filtered.forEach(item => {
      fragment.appendChild(createCard(item));
    });
    feedList.appendChild(fragment);
  });
}

function buildSourceToggles() {
  const container = document.getElementById('sourceToggles');
  container.innerHTML = '';
  const fragment = document.createDocumentFragment();

  SOURCES.forEach(source => {
    const isEnabled = STATE.enabled.has(source.id);
    const button = document.createElement('button');
    button.type = 'button';
    button.className = `src smooth${isEnabled ? ' on' : ''}`;
    button.dataset.sourceId = source.id;
    button.textContent = source.name;
    button.setAttribute('aria-pressed', String(isEnabled));

    button.addEventListener('click', () => {
      const wasEnabled = STATE.enabled.has(source.id);
      if (wasEnabled) {
        STATE.enabled.delete(source.id);
      } else {
        STATE.enabled.add(source.id);
      }

      if (STATE.enabled.size === 0) {
        STATE.enabled.add(source.id);
      }

      button.classList.toggle('on', !wasEnabled || STATE.enabled.has(source.id));
      button.setAttribute('aria-pressed', String(STATE.enabled.has(source.id)));
      persistState();
      render();
      if (!wasEnabled) {
        loadFeeds();
      }
    });

    fragment.appendChild(button);
  });

  container.appendChild(fragment);
}

function initFilterNavigation() {
  const filters = document.getElementById('filters');
  const chips = filters.querySelectorAll('.chip');

  filters.addEventListener('keydown', event => {
    const current = document.activeElement;
    const currentIndex = Array.from(chips).indexOf(current);
    let nextIndex = currentIndex;

    switch (event.key) {
      case 'ArrowRight':
        nextIndex = (currentIndex + 1) % chips.length;
        break;
      case 'ArrowLeft':
        nextIndex = (currentIndex - 1 + chips.length) % chips.length;
        break;
      case 'Home':
        nextIndex = 0;
        break;
      case 'End':
        nextIndex = chips.length - 1;
        break;
      default:
        return;
    }

    event.preventDefault();
    chips[nextIndex].focus();
  });
}

function fmtTime(ts) {
  const date = new Date(ts);
  const diffSeconds = (Date.now() - date.getTime()) / 1000;
  if (diffSeconds < 60) {
    return 'NOW';
  }
  if (diffSeconds < 3600) {
    return `${Math.floor(diffSeconds / 60)}m`;
  }
  if (diffSeconds < 86400) {
    return `${Math.floor(diffSeconds / 3600)}h`;
  }
  return `${Math.floor(diffSeconds / 86400)}d`;
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type} fade`;
  el.textContent = msg;
  el.setAttribute('role', 'alert');
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
  return el;
}

function escapeHTML(str = '') {
  if (typeof str !== 'string') {
    str = String(str || '');
  }
  return str.replace(/[&<>"']/g, char => ESCAPE_MAP[char]);
}

document.addEventListener('DOMContentLoaded', () => {
  buildSourceToggles();
  initFilterNavigation();

  const filters = document.getElementById('filters');
  filters.addEventListener('click', event => {
    const chip = event.target.closest('.chip');
    if (!chip) {
      return;
    }

    filters.querySelectorAll('.chip').forEach(element => {
      element.classList.remove('active');
      element.setAttribute('aria-selected', 'false');
      element.tabIndex = -1;
    });

    chip.classList.add('active');
    chip.setAttribute('aria-selected', 'true');
    chip.tabIndex = 0;

    STATE.view = chip.dataset.view;
    render();
  });

  const modal = document.getElementById('readerModal');
  const closeBtn = document.getElementById('readerClose');
  closeBtn.addEventListener('click', () => {
    modal.classList.remove('active');
  });

  document.addEventListener('keydown', event => {
    if (event.key === 'Escape' && modal.classList.contains('active')) {
      modal.classList.remove('active');
    }
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    if (confirm('Reset all settings and data?')) {
      localStorage.clear();
      location.reload();
    }
  });

  setInterval(() => {
    if (!STATE.loading && Date.now() - STATE.lastFetch > 120000) {
      loadFeeds();
    }
  }, 30000);

  loadFeeds();
});
</script>
</body>
</html>
