<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b1220" />
<title>Alpha Gem Screener</title>
<style>
:root{
  --bg:#0b1220;--bg2:#0e1628;--panel:#111a2f;--panel2:#0d1527;--muted:#7f8ea3;--text:#e9eef7;--accent:#4cc9f0;--ok:#36d399;--warn:#fbbf24;--bad:#ef4444;--line:#1b2743;--pill:#15213c;--link:#90cdf4
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
.header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,var(--bg) 0%,rgba(11,18,32,.96) 65%,rgba(11,18,32,.7) 100%);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line)}
.wrap{max-width:1200px;margin:0 auto;padding:14px 14px}
.h1{font-weight:700;font-size:18px;letter-spacing:.3px}
.ts{color:var(--muted);font-variant-numeric:tabular-nums}
.pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.pill{padding:6px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:12px;display:flex;align-items:center;gap:6px}
.pill .dot{width:8px;height:8px;border-radius:50%}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
.tabs{display:flex;gap:8px;margin-top:10px}
.tab{flex:1;text-align:center;padding:10px;border-radius:10px;background:var(--panel2);border:1px solid var(--line);cursor:pointer;user-select:none}
.tab.active{outline:2px solid var(--accent);background:linear-gradient(180deg,#0e1a34,#0c182f)}
.bar{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.btn{padding:9px 12px;border-radius:10px;background:var(--panel);border:1px solid var(--line);cursor:pointer}
.btn:active{transform:translateY(1px)}
.link{color:var(--link);text-decoration:none}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:10px 8px;text-align:left}
th{font-size:12px;color:var(--muted);font-weight:600}
tbody tr{background:var(--panel);border:1px solid var(--line)}
tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
.k{font-variant-numeric:tabular-nums}
.badge{padding:2px 6px;border-radius:6px;font-size:11px;border:1px solid var(--line);background:var(--pill);color:#c7d2e5}
.badge.ok{background:rgba(54,211,153,.1);border-color:rgba(54,211,153,.3);color:#b9f6d0}
.badge.warn{background:rgba(251,191,36,.1);border-color:rgba(251,191,36,.3);color:#ffe7a3}
.badge.bad{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.3);color:#ffc0c0}
.rowexp{padding:10px 12px;background:var(--bg2);border-top:1px dashed var(--line)}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.card{flex:1 1 260px;background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:260px}
.spark{width:100%;height:60px}
.kv{display:grid;grid-template-columns:110px 1fr;gap:4px;font-size:12px;color:#cbd5e5}
.tag{padding:3px 6px;border-radius:6px;border:1px solid var(--line);background:#0f1a31;font-size:11px}
.footer{padding:12px;color:var(--muted);font-size:12px;border-top:1px solid var(--line);margin-top:12px}
.settings{position:fixed;right:12px;bottom:12px;z-index:30}
.drawer{position:fixed;inset:auto 0 0 auto;right:0;width:360px;max-width:95vw;background:var(--panel);border-left:1px solid var(--line);box-shadow:0 -2px 40px rgba(0,0,0,.35);transform:translateY(110%);transition:transform .25s ease}
.drawer.open{transform:translateY(0)}
.drawer .hdr{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
.sw{display:flex;align-items:center;gap:8px}
input[type="checkbox"]{width:18px;height:18px}
hr{border:0;border-top:1px solid var(--line);margin:10px 0}
.small{font-size:12px;color:var(--muted)}
.nowrap{white-space:nowrap}
@media(min-width:900px){.h1{font-size:20px}}
</style>
</head>
<body>
<div class="header">
  <div class="wrap">
    <div class="h1">Alpha Gem Screener <span id="ts" class="ts"></span></div>
    <div id="sourcePills" class="pills"></div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-h="week">This Week</div>
      <div class="tab" data-h="next">Next Week</div>
      <div class="tab" data-h="month">This Month</div>
      <div class="tab" data-h="long">Long Term</div>
    </div>
    <div class="bar">
      <div class="btn" id="btnRefresh">Refresh</div>
      <div class="btn" id="btnSettings">Settings</div>
      <div class="small">Universe: <span id="uCount">—</span> | Updated: <span id="lastUpd">—</span></div>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="tableWrap"></div>
  <div class="footer">
    Informational only — not investment advice. Data from public sources; may be incomplete or delayed.
  </div>
</div>

<!-- Settings Drawer -->
<div class="drawer" id="drawer">
  <div class="hdr">
    <div>Settings</div>
    <div class="btn" id="btnClose">Close</div>
  </div>
  <div style="padding:12px">
    <div class="sw"><input id="swProxy" type="checkbox"><label for="swProxy">Force proxy on first attempt</label></div>
    <div class="sw"><input id="swCache" type="checkbox" checked><label for="swCache">Enable local cache (localStorage)</label></div>
    <div class="sw"><input id="swSW" type="checkbox" checked><label for="swSW">Enable offline shell (Service Worker)</label></div>
    <hr/>
    <div class="btn" id="btnClear">Clear Cache</div>
    <div class="small" style="margin-top:6px">Cache keys: alphaGem:v1:*</div>
    <hr/>
    <div class="small">Auto-refresh every 4 hours while open.</div>
  </div>
</div>

<script>
/* =========================
   Minimal util + cache
========================= */
const VER = 'v1';
const K = (s)=>`alphaGem:${VER}:${s}`;
const state = {
  forceProxy:false,
  useCache:true,
  statuses:{
    universe:'pending',
    prices:'pending',
    gdelt:'pending',
    sec:'pending',
    reddit:'pending',
    macro:'pending'
  },
  pillsMeta:{}
};
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const fmt = (n, d=2)=> {
  if(n==null || !isFinite(n)) return '—';
  return Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
};
const pct = (x)=> isFinite(x)?(x>0?`+${fmt(x,2)}%`:`${fmt(x,2)}%`):'—';

function setStamp(){
  const el = document.getElementById('ts');
  const t = new Date();
  el.textContent = `— ${t.toLocaleString()}`;
}
setStamp();

/* =========================
   Proxy-aware fetch
   - direct, then proxy fallback unless forced
========================= */
function toProxy(url){
  // Transparent reader proxy
  // Use http:// for target to avoid double https inside proxy spec
  try {
    const u = new URL(url);
    const raw = `${u.protocol}//${u.host}${u.pathname}${u.search}`;
    return `https://r.jina.ai/${raw}`;
  } catch(e){ return `https://r.jina.ai/http://` + url.replace(/^https?:\/\//,''); }
}
async function fetchWithProxy(url, opts={}){
  const tryOrder = state.forceProxy ? ['proxy','direct'] : ['direct','proxy'];
  let lastErr;
  for(const mode of tryOrder){
    try{
      const u = mode==='proxy' ? toProxy(url) : url;
      const res = await fetch(u, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      return {ok:true, mode, text};
    }catch(e){ lastErr = e; }
  }
  return {ok:false, mode:'failed', error: lastErr};
}

/* =========================
   Source pills
========================= */
function setPill(name, mode){
  state.statuses[name] = mode;
  const label = {
    universe:'Universe',
    prices:'Prices',
    gdelt:'News',
    sec:'Filings',
    reddit:'Reddit',
    macro:'Macro'
  }[name] || name;
  const color = mode==='direct'?'ok':mode==='proxy'?'warn':mode==='failed'?'bad':'warn';
  state.pillsMeta[name] = {label, color, mode};
  renderPills();
}
function renderPills(){
  const c = document.getElementById('sourcePills');
  c.innerHTML = '';
  Object.entries(state.pillsMeta).forEach(([k,v])=>{
    const div = document.createElement('div');
    div.className='pill';
    const mtxt = v.mode==='direct'?'Direct':v.mode==='proxy'?'Proxy':'Failed';
    div.innerHTML = `<span class="dot ${v.color}"></span><span>${v.label} • ${mtxt}</span>`;
    c.appendChild(div);
  });
}

/* =========================
   Local cache
========================= */
function getCache(key, maxAgeMs){
  if(!state.useCache) return null;
  try{
    const raw = localStorage.getItem(K(key));
    if(!raw) return null;
    const {t, v} = JSON.parse(raw);
    if(Date.now() - t > maxAgeMs) return null;
    return v;
  }catch(_){ return null; }
}
function setCache(key, v){
  if(!state.useCache) return;
  localStorage.setItem(K(key), JSON.stringify({t:Date.now(), v}));
}

/* =========================
   CSV/JSON helpers
========================= */
function parseCSV(txt){
  const lines = txt.trim().split(/\r?\n/);
  const hdr = lines[0].split(',');
  const rows = lines.slice(1).map(l=>{
    const a = l.split(',');
    const o = {};
    hdr.forEach((h,i)=>o[h.trim()] = a[i]?a[i].trim():'');
    return o;
  });
  return rows;
}
function safeJSON(txt){
  try{return JSON.parse(txt)}catch(_){return null}
}

/* =========================
   Indicators
========================= */
function SMA(arr, n, accessor=(x)=>x){
  const out=[]; let sum=0;
  for(let i=0;i<arr.length;i++){
    sum += accessor(arr[i]);
    if(i>=n) sum -= accessor(arr[i-n]);
    out.push(i>=n-1 ? sum/n : null);
  }
  return out;
}
function ATR(ohlc, n=14){
  const tr=[];
  for(let i=0;i<ohlc.length;i++){
    const {High:h, Low:l, Close:c} = ohlc[i];
    const prevC = i>0? ohlc[i-1].Close : c;
    const a = parseFloat(h), b=parseFloat(l), pc=parseFloat(prevC);
    const trv = Math.max(a-b, Math.abs(a-pc), Math.abs(b-pc));
    tr.push(trv);
  }
  const out=[]; let sum=0;
  for(let i=0;i<tr.length;i++){
    sum += tr[i];
    if(i>=n) sum -= tr[i-n];
    out.push(i>=n-1 ? sum/n : null);
  }
  return out;
}
function stdev(series, n){
  const out=[]; let win=[];
  for(let i=0;i<series.length;i++){
    const v = series[i]; win.push(v);
    if(win.length>n) win.shift();
    if(win.length<n){ out.push(null); continue; }
    const m = win.reduce((a,b)=>a+b,0)/n;
    const s = Math.sqrt(win.reduce((a,b)=>a+(b-m)**2,0)/n);
    out.push(s);
  }
  return out;
}
function percentileRank(arr, val){
  if(val==null || !isFinite(val)) return 50;
  const n = arr.filter(x=>isFinite(x)).length;
  if(!n) return 50;
  const below = arr.filter(x=>isFinite(x)&&x<=val).length;
  return Math.round(100*below/n);
}
function rollingRS(series, bench, n){
  // RS = ratio of cumulative return over window vs bench
  const out = [];
  for(let i=0;i<series.length;i++){
    if(i<n-1){ out.push(null); continue; }
    const a0 = series[i-n+1], a1 = series[i];
    const b0 = bench[i-n+1], b1 = bench[i];
    if([a0,a1,b0,b1].some(v=>!isFinite(v))){ out.push(null); continue; }
    const rA = (a1-a0)/a0, rB = (b1-b0)/b0;
    out.push(rA - rB);
  }
  return out;
}

/* =========================
   Universe discovery (Wikipedia)
========================= */
async function fetchUniverse(){
  const ckey = 'universe';
  const cached = getCache(ckey, 4*3600*1000);
  if(cached){ setPill('universe','direct'); return cached; }

  // S&P 500 first, then attempt Nasdaq-100 as supplement
  const urls = [
    'https://en.wikipedia.org/wiki/List_of_S%26P_500_companies',
    'https://en.wikipedia.org/wiki/Nasdaq-100'
  ];
  let all = [];
  for(const u of urls){
    const r = await fetchWithProxy(u);
    setPill('universe', r.ok ? r.mode : 'failed');
    if(!r.ok) continue;
    const html = r.text;
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const tables = [...doc.querySelectorAll('table.wikitable')];
    if(!tables.length) continue;
    // Attempt to parse rows containing Ticker/Company/Sector
    const rows = [...tables[0].querySelectorAll('tbody tr')].slice(1).map(tr=>{
      const tds = [...tr.querySelectorAll('td')];
      if(tds.length<3) return null;
      const text = (el)=> (el ? el.textContent.trim() : '');
      let ticker = text(tds[0]).replace(/\s/g,'').toUpperCase();
      // handle when first column isn't ticker
      if(!/^[A-Z.-]{1,6}$/.test(ticker)){
        // try second cell
        ticker = text(tds[1]).replace(/\s/g,'').toUpperCase();
      }
      const name = text(tds[1]) || text(tds[0]);
      const sector = text(tds[3]) || '';
      if(!/^[A-Z.-]{1,6}$/.test(ticker)) return null;
      return {ticker, name, sector};
    }).filter(Boolean);
    all = all.concat(rows);
  }
  // Dedup, limit size for performance
  const m = new Map();
  for(const r of all){
    if(!m.has(r.ticker)) m.set(r.ticker, r);
  }
  const list = [...m.values()];
  // Cap to ~300 tickers for client perf
  const capped = list.slice(0, 300);
  setCache(ckey, capped);
  return capped;
}

/* =========================
   Prices (Stooq)
========================= */
async function fetchStooqDaily(ticker){
  // Stooq uses symbol formats; try <ticker>.us as fallback for many US stocks
  const baseTry = [
    `https://stooq.com/q/d/l/?s=${ticker.toLowerCase()}&i=d`,
    `https://stooq.com/q/d/l/?s=${ticker.toLowerCase()}.us&i=d`
  ];
  for(const u of baseTry){
    const r = await fetchWithProxy(u);
    if(r.ok){
      setPill('prices', r.mode);
      const rows = parseCSV(r.text);
      if(rows && rows.length){
        const ohlc = rows.map(x=>({
          Date: x.Date,
          Open: parseFloat(x.Open), High: parseFloat(x.High),
          Low: parseFloat(x.Low), Close: parseFloat(x.Close),
          Volume: parseFloat(x.Volume)
        })).filter(x=>isFinite(x.Close));
        if(ohlc.length>=5) return ohlc;
      }
    }
  }
  return null;
}

/* =========================
   Macro regime (SPY, VIX, DXY, US10Y)
========================= */
async function fetchMacro(){
  const ckey='macro';
  const cached = getCache(ckey, 2*3600*1000);
  if(cached){ setPill('macro','direct'); return cached; }
  const sym = [
    {k:'SPY', s:'spy.us'},
    {k:'VIX', s:'^vix'},
    {k:'DXY', s:'dxy.us'},
    {k:'US10Y', s:'us10y'}
  ];
  const out = {};
  for(const {k,s} of sym){
    const r = await fetchWithProxy(`https://stooq.com/q/d/l/?s=${encodeURIComponent(s)}&i=d`);
    setPill('macro', r.ok ? r.mode : 'failed');
    if(!r.ok){ out[k]=null; continue; }
    const rows = parseCSV(r.text).map(x=>({Close:parseFloat(x.Close)})).filter(x=>isFinite(x.Close));
    out[k] = rows.map(x=>x.Close);
  }
  setCache(ckey, out);
  return out;
}
function detectRegime(m){
  // Simple: if SPY 20d return > 0 and VIX 20d change < 0 => Risk-On, else Risk-Off; neutral otherwise
  const spy = m.SPY||[];
  const vix = m.VIX||[];
  const n=20;
  const last = spy.length-1;
  const spyr = (last>=n)? (spy[last]-spy[last-n])/spy[last-n] : 0;
  const vixc = (vix.length>n)? (vix[vix.length-1]-vix[vix.length-1-n]) : 0;
  let tag='Neutral';
  if(spyr>0 && vixc<0) tag='Risk-On';
  else if(spyr<0 && vixc>0) tag='Risk-Off';
  const mult = {T:1,S:1,F:1,P:1};
  if(tag==='Risk-On'){ mult.T=1.1; mult.S=1.1; mult.F=0.95; mult.P=1.05; }
  if(tag==='Risk-Off'){ mult.T=0.9; mult.S=0.9; mult.F=1.1; mult.P=1.05; }
  return {tag, mult};
}

/* =========================
   News (GDELT)
========================= */
async function fetchGDELT(query){
  const base = `http://api.gdeltproject.org/api/v2/doc/doc?format=json&query=${encodeURIComponent(query)}&maxrecords=50&sort=DateDesc`;
  const r = await fetchWithProxy(base);
  setPill('gdelt', r.ok ? r.mode : 'failed');
  if(!r.ok) return [];
  const js = safeJSON(r.text);
  const arts = js && js.articles ? js.articles : [];
  return arts.map(a=>({
    date:a.date,
    lang:a.language,
    domain:a.domain,
    title:a.title,
    url:a.url,
    tone: parseFloat(a.tone)||0
  }));
}

/* =========================
   Filings (SEC)
========================= */
let SEC_MAP = null;
async function ensureSECTable(){
  if(SEC_MAP) return;
  const r = await fetchWithProxy('https://www.sec.gov/files/company_tickers.json');
  setPill('sec', r.ok ? r.mode : 'failed');
  if(!r.ok){ SEC_MAP = {}; return; }
  const js = safeJSON(r.text);
  const map = {};
  if(js){
    for(const k of Object.keys(js)){
      const o = js[k];
      map[o.ticker?.toUpperCase?.()] = ('0000000000'+o.cik_str).slice(-10);
    }
  }
  SEC_MAP = map;
}
async function fetchSEC(ticker){
  await ensureSECTable();
  const cik = SEC_MAP[ticker];
  if(!cik) return {events:[]};
  const url = `https://data.sec.gov/submissions/CIK${cik}.json`;
  const r = await fetchWithProxy(url);
  setPill('sec', r.ok ? r.mode : 'failed');
  if(!r.ok) return {events:[]};
  const js = safeJSON(r.text);
  const recent = js && js.filings && js.filings.recent ? js.filings.recent : null;
  if(!recent) return {events:[]};
  const forms = recent.form || [];
  const dates = recent.filingDate || [];
  const acc = [];
  for(let i=0;i<forms.length;i++){
    const f = forms[i], d = dates[i];
    if(!f || !d) continue;
    if(/^(8-K|10-Q|13D|13G|SC 13D|SC 13G)$/i.test(f)) acc.push({form:f, date:d});
  }
  return {events:acc.slice(0,10)};
}

/* =========================
   Reddit velocity
========================= */
async function fetchReddit(ticker){
  const url = `https://www.reddit.com/search.json?q=${encodeURIComponent(ticker)}&sort=new`;
  const r = await fetchWithProxy(url);
  setPill('reddit', r.ok ? r.mode : 'failed');
  if(!r.ok) return {rate:0, pos:0, neg:0, n:0};
  const js = safeJSON(r.text);
  const posts = js && js.data && js.data.children ? js.data.children.map(x=>x.data) : [];
  const now = Date.now()/1000;
  let count=0, pos=0, neg=0;
  const lexPos = ['beat','surge','breakout','bull','up','upgrade','contract','award','deal'];
  const lexNeg = ['miss','dump','bear','down','downgrade','delay','lawsuit','fraud','halt'];
  for(const p of posts){
    const ageH = (now - (p.created_utc||now))/3600;
    if(ageH<=72) count++;
    const t = (p.title||'').toLowerCase() + ' ' + (p.selftext||'').toLowerCase();
    let s=0;
    for(const w of lexPos) if(t.includes(w)) s++;
    for(const w of lexNeg) if(t.includes(w)) s--;
    if(s>0) pos++; else if(s<0) neg++;
  }
  return {rate:count/72, pos, neg, n:posts.length};
}

/* =========================
   Technical + scoring
========================= */
function computeTech(ohlc){
  const closes = ohlc.map(o=>o.Close);
  const vols = ohlc.map(o=>o.Volume||0);
  const sma20 = SMA(closes,20);
  const sma50 = SMA(closes,50);
  const sma150 = SMA(closes,150);
  const sma200 = SMA(closes,200);
  const atr14 = ATR(ohlc,14);
  const std20 = stdev(closes,20);
  const bbw = closes.map((c,i)=>{
    const m=sma20[i], s=std20[i];
    if(m==null||s==null) return null;
    const upper=m+2*s, lower=m-2*s;
    return (upper-lower)/m;
  });
  const volRatio20 = vols.map((v,i)=>{
    const win = vols.slice(Math.max(0,i-19), i+1);
    const avg = win.reduce((a,b)=>a+b,0)/(win.length||1);
    return avg? v/avg : null;
  });
  return {sma20,sma50,sma150,sma200,atr14,bbw,volRatio20,closes};
}
function scoreBlocks(sym, tech, benchRS20, benchRS60, benchRS120, newsStats, filingStats){
  // Technical (T)
  const n = tech.closes.length;
  const i = n-1;
  const c = tech.closes[i];
  const s20 = tech.sma20[i], s50=tech.sma50[i], s150=tech.sma150[i], s200=tech.sma200[i];
  const trendStack = (c>s200?12.5:0) + (s200&&s150&&s150>s200?12.5:0) + (s150&&s50&&s50>s150?12.5:0) + (s50&&s20&&s20>s50?12.5:0);
  const rsPct = percentileRank(benchRS60, benchRS60[benchRS60.length-1]);// use 60d RS
  const bbwNow = tech.bbw[i];
  const bbwPct = percentileRank(tech.bbw.filter(Boolean), bbwNow);
  const squeezeBreakout = bbwNow!=null && bbwPct<35 && c>s20 ? 15 : 0;
  const avwap = s200? (c>s200?10:0) : 0; // proxy for anchored VWAP reclaim
  const parabolic = ((c - tech.closes[Math.max(0,i-5)]) / tech.closes[Math.max(0,i-5)])>0.25 ? -10 : 0;
  let T = trendStack + (rsPct*0.25) + squeezeBreakout + avwap + parabolic;

  // Filings (F)
  let F = 0;
  const forms = filingStats.events||[];
  const recent = forms.slice(0,5).map(x=>x.form.toUpperCase());
  if(recent.some(f=>/8-K/.test(f))) F += 25;
  if(recent.some(f=>/10-Q/.test(f))) F += 5;
  if(recent.some(f=>/13D|SC 13D/.test(f))) F += 10;
  if(recent.some(f=>/13G|SC 13G/.test(f))) F += 5;
  if(recent.some(f=>/NT 10-Q|NT 10-K/.test(f))) F -= 10;

  // Sentiment (S)
  const toneMed = newsStats.toneMedPct||50;
  const tailInv = newsStats.toneTailInvPct||50;
  const density = Math.min(100, newsStats.docDensity*10);
  const reddit = Math.min(100, newsStats.redditVelocity*50);
  const dupPenalty = Math.min(10, (newsStats.dupDomains||0)*2);
  let S = (toneMed*0.4) + (tailInv*0.2) + (density) + (reddit*0.3) - dupPenalty;

  // Positioning (P)
  const volPct = percentileRank(tech.volRatio20.filter(Boolean), tech.volRatio20[i]);
  const atrPct = percentileRank(tech.atr14.filter(Boolean), tech.atr14[i]);
  const rev5 = (tech.closes[i]-tech.closes[Math.max(0,i-5)])/tech.closes[Math.max(0,i-5)];
  const rev10 = (tech.closes[i]-tech.closes[Math.max(0,i-10)])/tech.closes[Math.max(0,i-10)];
  const reversalFreq = (rev5*rev10<0)? 15: 0;
  const crowdingPenalty = (newsStats.dupDomains>3)? 20: 0;
  let P = (volPct*0.3) + (atrPct*0.25) + reversalFreq - crowdingPenalty;

  return {T, F, S, P};
}
function compositeAlpha(blocks, regime){
  const {T,F,S,P} = blocks;
  const mult = regime.mult;
  const base = (0.35*T*mult.T + 0.20*F*mult.F + 0.30*S*mult.S + 0.15*P*mult.P);
  const triggers = [
    (T>60), // breakout-ish
    (S>60), // tone spike-ish
    (F>20)  // filings positive
  ].filter(Boolean).length;
  const penalty = triggers>=2 ? 0 : 15;
  return Math.max(0, base - penalty);
}
function horizonAlpha(blocks, regime){
  const {T,F,S,P} = blocks;
  const m = regime.mult;
  const h = {
    week:  (0.45*T*m.T + 0.35*S*m.S + 0.15*P*m.P + 0.05*F*m.F),
    next:  (0.40*T*m.T + 0.30*S*m.S + 0.15*P*m.P + 0.15*F*m.F),
    month: (0.35*T*m.T + 0.30*S*m.S + 0.15*P*m.P + 0.20*F*m.F),
    long:  (0.25*T*m.T + 0.20*S*m.S + 0.15*P*m.P + 0.40*F*m.F),
  };
  return h;
}

/* =========================
   News/filings aggregation → sentiment stats
========================= */
function newsStatsFrom(gdelt, reddit){
  const tones = gdelt.map(x=>x.tone).filter(x=>isFinite(x));
  tones.sort((a,b)=>a-b);
  const med = tones.length? tones[Math.floor(tones.length/2)] : 0;
  const tail = tones.length? (tones.filter(x=>x<0).length/tones.length) : 0;
  const uniqueDomains = new Set(gdelt.map(x=>x.domain)).size;
  const dupDomains = Math.max(0, gdelt.length - uniqueDomains);
  // document density: per 48h
  const now = Date.now();
  const last48 = gdelt.filter(x=>{
    const d = new Date(x.date.replace(/^(\d{4})(\d{2})(\d{2}).*/,'$1-$2-$3'));
    return now - d.getTime() < 48*3600*1000;
  }).length;
  const toneMedPct = percentileRank(tones, med);
  const toneTailInvPct = Math.round(100*(1 - tail)); // fewer negative → higher
  return {
    toneMedPct, toneTailInvPct,
    docDensity: last48, dupDomains,
    redditVelocity: reddit.rate || 0
  };
}

/* =========================
   End-to-end pipeline
========================= */
async function buildUniverseAndScore(){
  document.getElementById('tableWrap').innerHTML = '';
  setStamp();

  const macro = await fetchMacro();
  const regime = detectRegime(macro);

  const uni = await fetchUniverse();
  document.getElementById('uCount').textContent = uni.length;
  const spy = await fetchStooqDaily('SPY') || await fetchStooqDaily('SPY');
  const spyClose = spy ? spy.map(x=>x.Close) : [];

  const results = [];
  const limit = Math.min(uni.length, 120); // throttle initial run for perf
  // Simple concurrency control
  const pool = 6;
  let idx = 0;
  const workers = Array.from({length:pool}, async ()=>{
    while(idx<limit){
      const me = idx++;
      const u = uni[me];
      // Price series
      const px = await fetchStooqDaily(u.ticker);
      if(!px || px.length<60){ continue; }

      // Liquidity and price filters
      const vols = px.map(o=>o.Volume||0);
      const vwin = vols.slice(-20);
      const vmed = vwin.sort((a,b)=>a-b)[Math.floor(vwin.length/2)]||0;
      const lastC = px[px.length-1].Close;
      if(vmed<200000 || lastC<1 || lastC>1000) continue; // drop penny/illiquid

      // Indicators + RS
      const tech = computeTech(px);
      let rs20=[], rs60=[], rs120=[];
      if(spyClose.length===px.length){
        rs20 = rollingRS(px.map(x=>x.Close), spyClose, 20);
        rs60 = rollingRS(px.map(x=>x.Close), spyClose, 60);
        rs120= rollingRS(px.map(x=>x.Close), spyClose, 120);
      }else{
        // length mismatch: approximate by self
        rs60 = tech.closes.map(()=>0);
        rs20 = rs60; rs120 = rs60;
      }

      // News / Reddit / SEC
      const [gdelt, red, sec] = await Promise.all([
        fetchGDELT(u.ticker + ' OR ' + u.name),
        fetchReddit(u.ticker),
        fetchSEC(u.ticker)
      ]);
      const nstat = newsStatsFrom(gdelt, red);

      const blocks = scoreBlocks(u.ticker, tech, rs20, rs60, rs120, nstat, sec);
      const alpha = compositeAlpha(blocks, regime);
      const h = horizonAlpha(blocks, regime);

      results.push({
        sym:u.ticker, name:u.name, sector:u.sector,
        price:lastC,
        RS: percentileRank(rs60.filter(x=>x!=null), rs60[rs60.length-1]),
        volSpike: tech.volRatio20[tech.volRatio20.length-1],
        tone: nstat.toneMedPct,
        mentions: Math.round((nstat.redditVelocity||0)*100)/100,
        catalysts: (sec.events||[]).slice(0,3),
        alpha, blocks, h,
        tech, px, gdelt
      });
    }
  });
  await Promise.all(workers);

  const filtered = results
    .filter(x=>isFinite(x.alpha))
    // Down-rank parabolic low-volume spikes
    .map(x=>{
      const last = x.px.length-1;
      const g5 = (x.px[last].Close - x.px[Math.max(0,last-5)].Close)/x.px[Math.max(0,last-5)].Close;
      if(g5>0.25 && (x.volSpike||0)<1.2) x.alpha *= 0.85;
      return x;
    });

  const ranks = {
    week:  [...filtered].sort((a,b)=>b.h.week-a.h.week).slice(0,50),
    next:  [...filtered].sort((a,b)=>b.h.next-a.h.next).slice(0,50),
    month: [...filtered].sort((a,b)=>b.h.month-a.h.month).slice(0,50),
    long:  [...filtered].sort((a,b)=>b.h.long-a.h.long).slice(0,50),
  };

  setCache('lastResults', {at:Date.now(), ranks});
  document.getElementById('lastUpd').textContent = new Date().toLocaleTimeString();
  renderTable('week', ranks.week, regime);
  // prime pills if missing
  ['universe','prices','gdelt','sec','reddit','macro'].forEach(k=>{
    if(!state.pillsMeta[k]) setPill(k,'warn');
  });
  startAutoRefresh();
}

/* =========================
   Render
========================= */
function renderTable(horizon, list, regime){
  const wrap = document.getElementById('tableWrap');
  wrap.innerHTML = `
  <table>
    <thead>
      <tr>
        <th>#</th><th>Ticker</th><th>Price</th><th>α-Score</th>
        <th>RS</th><th>Vol Spike</th><th>Tone</th><th>Mentions</th><th>Catalysts</th><th></th>
      </tr>
    </thead>
    <tbody>${list.map((x,i)=>rowHTML(horizon,x,i,regime)).join('')}</tbody>
  </table>`;
  // attach expand handlers
  wrap.querySelectorAll('[data-exp]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const k = btn.getAttribute('data-exp');
      const more = document.getElementById(`exp-${k}`);
      more.style.display = more.style.display==='block' ? 'none':'block';
      if(more.style.display==='block') drawSpark(k);
    });
  });
}
function rowHTML(h, x, i, regime){
  const hs = {week:'week', next:'next', month:'month', long:'long'}[h]||'week';
  const a = x.h[hs];
  const kval = (x)=> isFinite(x)? fmt(x,2):'—';
  const cats = x.catalysts.map(c=>`<span class="tag">${c.form} • ${c.date}</span>`).join(' ') || '<span class="small">—</span>';
  const id = `${h}-${i}`;
  const toneBadge = x.tone>=60?'ok':x.tone>=40?'warn':'bad';
  const volBadge = (x.volSpike||0)>=1.3?'ok':(x.volSpike||0)>=1.05?'warn':'bad';
  return `
  <tr>
    <td class="k nowrap">${i+1}</td>
    <td class="nowrap"><strong>${x.sym}</strong> <span class="small">• ${x.name}</span></td>
    <td class="k">$${kval(x.price)}</td>
    <td class="k"><span class="badge ${a>=70?'ok':a>=50?'warn':'bad'}">${kval(a)}</span></td>
    <td class="k">${kval(x.RS)}</td>
    <td class="k"><span class="badge ${volBadge}">${kval(x.volSpike)}</span></td>
    <td class="k"><span class="badge ${toneBadge}">${kval(x.tone)}</span></td>
    <td class="k">${kval(x.mentions)}</td>
    <td>${cats}</td>
    <td class="nowrap"><a class="link" href="javascript:void(0)" data-exp="${id}">Details</a></td>
  </tr>
  <tr id="exp-${id}" style="display:none"><td colspan="10">
    <div class="rowexp">
      <div class="flex">
        <div class="card" style="min-width:320px">
          <canvas id="spark-${id}" class="spark"></canvas>
          <div class="small">Price 120d</div>
        </div>
        <div class="card">
          <div class="kv">
            <div>Regime</div><div>${regime.tag}</div>
            <div>T</div><div>${fmt(x.blocks.T,1)}</div>
            <div>F</div><div>${fmt(x.blocks.F,1)}</div>
            <div>S</div><div>${fmt(x.blocks.S,1)}</div>
            <div>P</div><div>${fmt(x.blocks.P,1)}</div>
            <div>α</div><div>${fmt(x.alpha,1)}</div>
          </div>
        </div>
        <div class="card" style="flex:2">
          <div class="small" style="margin-bottom:6px">Catalyst Timeline</div>
          <div>${x.catalysts.map(c=>`<span class="tag">${c.date} · ${c.form}</span>`).join(' ') || '<span class="small">No recent 8-K/10-Q/13D/13G detected</span>'}</div>
          <hr/>
          <div class="small" style="margin-bottom:6px">News (GDELT) — latest 6</div>
          <div>${x.gdelt.slice(0,6).map(g=>`<div class="small">• ${g.date} — ${g.domain} — tone ${fmt(g.tone,1)}</div>`).join('')}</div>
        </div>
      </div>
      <hr/>
      <div class="small">Provenance: Prices — Stooq (${state.pillsMeta.prices?.mode||'—'}), News — GDELT (${state.pillsMeta.gdelt?.mode||'—'}), Filings — SEC (${state.pillsMeta.sec?.mode||'—'}), Reddit (${state.pillsMeta.reddit?.mode||'—'}), Universe — Wikipedia (${state.pillsMeta.universe?.mode||'—'})</div>
    </div>
  </td></tr>`;
}
function drawSpark(id){
  const [h, idx] = id.split('-');
  const cache = getCache('lastResults', 4*3600*1000);
  if(!cache) return;
  const list = cache.ranks[h]||[];
  const x = list[parseInt(idx,10)];
  if(!x) return;
  const data = x.px.slice(-120).map(o=>o.Close);
  const c = document.getElementById(`spark-${id}`);
  const ctx = c.getContext('2d');
  const w = c.width = c.clientWidth;
  const hgt = c.height = c.clientHeight;
  ctx.clearRect(0,0,w,hgt);
  const min = Math.min(...data), max=Math.max(...data);
  const pad=6;
  ctx.lineWidth=1.5;
  ctx.strokeStyle='#9ad8ff';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad + i*( (w-2*pad)/(data.length-1||1) );
    const y = hgt-pad - ( (v-min)/(max-min||1) )*(hgt-2*pad);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* =========================
   Tabs + UI
========================= */
document.getElementById('tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const h = t.getAttribute('data-h');
  const cache = getCache('lastResults', 4*3600*1000);
  if(cache){
    const key = h==='week'?'week':h==='next'?'next':h==='month'?'month':'long';
    renderTable(key, cache.ranks[key], {tag:'—', mult:{T:1,S:1,F:1,P:1}});
  }
});
document.getElementById('btnRefresh').addEventListener('click', ()=>buildUniverseAndScore());
const drawer = document.getElementById('drawer');
document.getElementById('btnSettings').addEventListener('click', ()=>drawer.classList.add('open'));
document.getElementById('btnClose').addEventListener('click', ()=>drawer.classList.remove('open'));
document.getElementById('swProxy').addEventListener('change', e=>state.forceProxy=e.target.checked);
document.getElementById('swCache').addEventListener('change', e=>state.useCache=e.target.checked);
document.getElementById('btnClear').addEventListener('click', ()=>{
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith(`alphaGem:${VER}:`)) localStorage.removeItem(k); });
  document.getElementById('lastUpd').textContent='—';
});

/* =========================
   Service Worker (optional)
========================= */
async function setupSW(){
  try{
    if(!('serviceWorker' in navigator)) return;
    if(!document.getElementById('swSW').checked) return;
    const swCode = `
      const SHELL=['./'];
      self.addEventListener('install',e=>{
        e.waitUntil(caches.open('alphaGem-shell').then(c=>c.addAll(SHELL)));
        self.skipWaiting();
      });
      self.addEventListener('activate',e=>self.clients.claim());
      self.addEventListener('fetch',e=>{
        const u = new URL(e.request.url);
        if(u.origin===location.origin){
          e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
        } // passthrough for network sources
      });`;
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    await navigator.serviceWorker.register(url);
  }catch(_){}
}

/* =========================
   Auto-refresh every 4h
========================= */
let autoTimer=null;
function startAutoRefresh(){
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(()=>{
    if(document.hidden) return;
    buildUniverseAndScore();
  }, 4*3600*1000);
}

/* =========================
   Boot
========================= */
(async function boot(){
  await setupSW();
  const saved = getCache('lastResults', 4*3600*1000);
  if(saved){
    renderTable('week', saved.ranks.week, {tag:'—', mult:{T:1,S:1,F:1,P:1}});
  }
  buildUniverseAndScore();
})();
</script>
</body>
</html>
