<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>UR NEWS - Terminal Intelligence</title>
<meta name="theme-color" content="#0d1117" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Real-time political intelligence terminal">
<link rel="preconnect" href="https://api.allorigins.win">
<link rel="preconnect" href="https://r.jina.ai">
<link rel="dns-prefetch" href="//www.google.com">
<style>
  :root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --surface: #30363d;
    --surface-hover: #484f58;
    --border: #21262d;
    --text-primary: #f0f6fc;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --accent-green: #238636;
    --accent-amber: #d29922;
    --accent-cyan: #56d4dd;
    --accent-red: #da3633;
    --accent-purple: #8957e5;
    --gradient-primary: conic-gradient(from 0deg, transparent, rgba(35, 134, 54, 0.05), transparent);
    --gradient-secondary: linear-gradient(45deg, rgba(86, 212, 221, 0.03), rgba(137, 87, 229, 0.03));
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  }

  @media (prefers-reduced-motion: reduce) {
    :root {
      --gradient-primary: var(--bg-secondary);
      --gradient-secondary: var(--bg-secondary);
    }
    
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    font-weight: 400;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }

  /* Safe area handling */
  body {
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    overflow-x: hidden;
  }

  /* Animated gradients */
  @keyframes gradient-shift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  @keyframes pulse-green {
    0%, 100% { box-shadow: 0 0 5px rgba(35, 134, 54, 0.3); }
    50% { box-shadow: 0 0 15px rgba(35, 134, 54, 0.6); }
  }

  /* App Shell */
  .app-shell {
    min-height: 100vh;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--gradient-primary);
    backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid var(--border);
    box-shadow: var(--shadow-md);
  }

  @supports not (backdrop-filter: blur(20px)) {
    .header {
      background: var(--bg-secondary);
    }
  }

  .header::before {
    content: "";
    position: absolute;
    inset: 0;
    background: var(--gradient-secondary);
    background-size: 400% 400%;
    animation: gradient-shift 25s ease-in-out infinite;
    opacity: 0.8;
  }

  .header-content {
    position: relative;
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    min-height: 60px;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent-green);
    flex-shrink: 0;
    animation: pulse-green 2s infinite;
  }

  .title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex: 1;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
    white-space: nowrap;
  }

  .btn:hover, .btn:focus {
    background: var(--surface-hover);
    border-color: var(--text-muted);
    outline: none;
  }

  .btn:active {
    transform: translateY(1px);
  }

  .btn.active {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: var(--bg-primary);
  }

  /* Filters */
  .filters {
    padding: 0 1rem 1rem;
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .filters::-webkit-scrollbar {
    display: none;
  }

  .filter-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .filter-chip:hover {
    background: var(--surface-hover);
    color: var(--text-secondary);
  }

  .filter-chip.active {
    background: var(--accent-cyan);
    border-color: var(--accent-cyan);
    color: var(--bg-primary);
  }

  /* Main Content */
  .main {
    flex: 1;
    padding: 1rem;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }

  /* Stats Bar */
  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
  }

  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-green);
    line-height: 1;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-top: 0.25rem;
  }

  /* Article List */
  .article-list {
    display: grid;
    gap: 1rem;
  }

  .article-skeleton {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    position: relative;
    overflow: hidden;
    height: 120px;
  }

  .article-skeleton::after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.02), transparent);
    transform: translateX(-100%);
    animation: shimmer 2s infinite;
  }

  .skeleton-line {
    background: var(--bg-tertiary);
    border-radius: 4px;
    margin-bottom: 0.5rem;
  }

  .skeleton-line:nth-child(1) { width: 80%; height: 18px; }
  .skeleton-line:nth-child(2) { width: 60%; height: 14px; }
  .skeleton-line:nth-child(3) { width: 100%; height: 12px; }
  .skeleton-line:nth-child(4) { width: 90%; height: 12px; }

  .article {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.15s ease;
    position: relative;
    opacity: 0;
    animation: fadeIn 0.3s ease forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .article:hover {
    border-color: var(--surface-hover);
    box-shadow: var(--shadow-sm);
  }

  .article-header {
    display: grid;
    grid-template-columns: 20px 1fr 24px;
    gap: 0.75rem;
    align-items: flex-start;
    padding: 1rem;
    cursor: pointer;
  }

  .article-icon {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    background: var(--bg-tertiary);
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .article-content {
    min-width: 0; /* Allow flex items to shrink */
  }

  .article-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    flex-wrap: wrap;
  }

  .article-source {
    font-weight: 500;
    color: var(--text-secondary);
  }

  .article-time {
    opacity: 0.8;
  }

  .sentiment-badge {
    padding: 0.125rem 0.375rem;
    border-radius: 12px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .sentiment-positive { background: rgba(35, 134, 54, 0.2); color: var(--accent-green); }
  .sentiment-negative { background: rgba(218, 54, 51, 0.2); color: var(--accent-red); }
  .sentiment-neutral { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }

  .breaking-badge {
    background: var(--accent-red);
    color: white;
    padding: 0.125rem 0.375rem;
    border-radius: 12px;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .action-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0;
    transition: all 0.15s ease;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .action-btn:hover {
    color: var(--text-secondary);
  }

  /* Action Sheet */
  .action-sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    border-radius: 12px 12px 0 0;
    padding: 1rem;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    z-index: 200;
    box-shadow: var(--shadow-lg);
  }

  .action-sheet.show {
    transform: translateY(0);
  }

  .action-sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .action-sheet-title {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .action-sheet-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
  }

  .action-sheet-actions {
    display: grid;
    gap: 0.5rem;
  }

  .action-sheet-btn {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .action-sheet-btn:hover {
    background: var(--surface-hover);
  }

  /* Overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 150;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .overlay.show {
    opacity: 1;
    visibility: visible;
  }

  /* Toast */
  .toast {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 80px);
    left: 1rem;
    right: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    box-shadow: var(--shadow-md);
    transform: translateY(-100px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 300;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .toast.success { border-left: 4px solid var(--accent-green); }
  .toast.error { border-left: 4px solid var(--accent-red); }
  .toast.info { border-left: 4px solid var(--accent-cyan); }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
  }

  .empty-state h3 {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
  }

  /* Pull to Refresh */
  .pull-refresh {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: -60px;
    transition: margin-top 0.3s ease;
  }

  .pull-refresh.active {
    margin-top: 0;
  }

  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top: 2px solid var(--accent-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 640px) {
    .header-content {
      padding: 0.75rem;
      gap: 0.75rem;
    }

    .title {
      font-size: 1.125rem;
    }

    .main {
      padding: 0.75rem;
    }

    .stats {
      gap: 0.75rem;
    }

    .stat {
      padding: 0.5rem;
    }

    .stat-value {
      font-size: 1.25rem;
    }

    .article-header {
      padding: 0.75rem;
      gap: 0.5rem;
    }

    .article-title {
      font-size: 0.875rem;
    }
  }

  /* High contrast support */
  @media (prefers-contrast: high) {
    :root {
      --border: #484f58;
      --surface: #21262d;
      --text-muted: #8b949e;
    }
  }
</style>
</head>
<body>
  <div class="app-shell">
    <header class="header">
      <div class="header-content">
        <div class="status-indicator"></div>
        <h1 class="title">UR NEWS</h1>
        <div class="header-actions">
          <button class="btn" id="refreshBtn">Refresh</button>
          <button class="btn active" id="politicsBtn">Politics Only</button>
        </div>
      </div>
      <div class="filters" id="filters">
        <div class="filter-chip active" data-view="all">All</div>
        <div class="filter-chip" data-view="conservative">Conservative</div>
        <div class="filter-chip" data-view="populist">Populist</div>
        <div class="filter-chip" data-view="breaking">Breaking</div>
      </div>
    </header>

    <main class="main">
      <div class="pull-refresh" id="pullRefresh">
        <div class="spinner"></div>
        <span>Pull to refresh...</span>
      </div>

      <div class="stats" id="stats">
        <div class="stat">
          <span class="stat-value" id="totalCount">0</span>
          <span class="stat-label">Articles</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="sourceCount">0</span>
          <span class="stat-label">Sources</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="breakingCount">0</span>
          <span class="stat-label">Breaking</span>
        </div>
      </div>

      <div class="article-list" id="articleList">
        <!-- Articles will be rendered here -->
      </div>

      <div class="empty-state" id="emptyState" style="display: none;">
        <h3>No Articles Found</h3>
        <p>Check your filters or try refreshing</p>
      </div>
    </main>
  </div>

  <!-- Action Sheet -->
  <div class="overlay" id="overlay"></div>
  <div class="action-sheet" id="actionSheet">
    <div class="action-sheet-header">
      <div class="action-sheet-title">Article Actions</div>
      <button class="action-sheet-close" id="closeActionSheet">&times;</button>
    </div>
    <div class="action-sheet-actions">
      <button class="action-sheet-btn" id="openArticle">
        <span>🔗</span> Open Article
      </button>
      <button class="action-sheet-btn" id="saveArticle">
        <span>💾</span> Save for Later
      </button>
      <button class="action-sheet-btn" id="hideArticle">
        <span>👁️</span> Hide Article
      </button>
      <button class="action-sheet-btn" id="shareArticle">
        <span>📤</span> Share
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
(function() {
  'use strict';

  // News sources - politics-focused only
  const SOURCES = [
    { id: 'breitbart', name: 'Breitbart', url: 'https://www.breitbart.com/feed/', lane: 'populist' },
    { id: 'federalist', name: 'The Federalist', url: 'https://thefederalist.com/feed/', lane: 'conservative' },
    { id: 'dailywire', name: 'Daily Wire', url: 'https://www.dailywire.com/feeds/rss.xml', lane: 'conservative' },
    { id: 'gateway', name: 'Gateway Pundit', url: 'https://www.thegatewaypundit.com/feed/', lane: 'populist' },
    { id: 'revolver', name: 'Revolver News', url: 'https://www.revolver.news/feed/', lane: 'populist' },
    { id: 'dailycaller', name: 'Daily Caller', url: 'https://dailycaller.com/feed/', lane: 'conservative' },
    { id: 'redstate', name: 'RedState', url: 'https://redstate.com/feed/', lane: 'conservative' },
    { id: 'townhall', name: 'Townhall', url: 'https://townhall.com/rss', lane: 'conservative' },
    { id: 'foxnews', name: 'Fox News', url: 'https://feeds.foxnews.com/foxnews/latest', lane: 'conservative' },
    { id: 'washexam', name: 'Washington Examiner', url: 'https://www.washingtonexaminer.com/feed', lane: 'conservative' },
    { id: 'theblaze', name: 'The Blaze', url: 'https://www.theblaze.com/feeds/latest.rss', lane: 'conservative' },
    { id: 'nypost', name: 'NY Post', url: 'https://nypost.com/feed/', lane: 'populist' }
  ];

  // Gossip/celebrity filter patterns
  const GOSSIP_SOURCES = [
    'page six', 'tmz', 'us weekly', 'e!', 'radar online', 'people magazine',
    'daily mail showbiz', 'ok!', 'perez hilton', 'huffpost entertainment',
    'buzzfeed celeb', 'vanity fair hollywood', 'the sun showbiz'
  ];

  const GOSSIP_KEYWORDS = [
    'celebrity', 'hollywood', 'kardashian', 'jenner', 'swift', 'bieber',
    'hadid', 'megan fox', 'machine gun kelly', 'travis kelce', 'royal family',
    'royals', 'prince william', 'princess kate', 'affair', 'breakup',
    'baby bump', 'red carpet', 'outfit', 'paparazzi', 'fashion', 'style',
    'dating', 'relationship', 'wedding', 'divorce', 'custody'
  ];

  const POLITICS_KEYWORDS = [
    'election', 'congress', 'senate', 'house', 'governor', 'policy',
    'bill', 'act', 'supreme court', 'white house', 'administration',
    'campaign', 'debate', 'ballot', 'legislation', 'geopolitics',
    'treaty', 'sanction', 'nato', 'minister', 'parliament', 'president',
    'politics', 'political', 'government', 'federal', 'state', 'democrat',
    'republican', 'conservative', 'liberal', 'vote', 'voter', 'constitution',
    'amendment', 'court', 'judge', 'justice', 'law', 'legal', 'regulation'
  ];

  // Application state
  const state = {
    articles: [],
    filteredArticles: [],
    currentView: 'all',
    politicsOnly: true,
    loading: false,
    lastRefresh: 0,
    currentArticle: null,
    cache: new Map(),
    abortController: null
  };

  // DOM elements
  const elements = {
    articleList: document.getElementById('articleList'),
    emptyState: document.getElementById('emptyState'),
    totalCount: document.getElementById('totalCount'),
    sourceCount: document.getElementById('sourceCount'),
    breakingCount: document.getElementById('breakingCount'),
    refreshBtn: document.getElementById('refreshBtn'),
    politicsBtn: document.getElementById('politicsBtn'),
    filters: document.getElementById('filters'),
    pullRefresh: document.getElementById('pullRefresh'),
    actionSheet: document.getElementById('actionSheet'),
    overlay: document.getElementById('overlay'),
    toast: document.getElementById('toast')
  };

  // Utility functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function stripHtml(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    return div.textContent || div.innerText || '';
  }

  function formatTime(dateString) {
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'now';
      if (diffMins < 60) return `${diffMins}m`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h`;
      return `${Math.floor(diffMins / 1440)}d`;
    } catch (e) {
      return 'unknown';
    }
  }

  function getHostname(url) {
    try {
      return new URL(url).hostname;
    } catch (e) {
      return 'unknown';
    }
  }

  function showToast(message, type = 'info') {
    const toast = elements.toast;
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }

  function normalizeTitle(title) {
    return title
      .toLowerCase()
      .replace(/[^\w\s]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function calculateSimilarity(title1, title2) {
    const words1 = normalizeTitle(title1).split(' ');
    const words2 = normalizeTitle(title2).split(' ');
    
    const set1 = new Set(words1);
    const set2 = new Set(words2);
    
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    
    return intersection.size / union.size;
  }

  // Politics/gossip filtering
  function isPolitical(article) {
    if (!state.politicsOnly) return true;
    
    const text = `${article.title} ${article.description || ''}`.toLowerCase();
    
    // Check for gossip source patterns
    for (const pattern of GOSSIP_SOURCES) {
      if (article.source.toLowerCase().includes(pattern)) {
        return false;
      }
    }
    
    // Check for gossip keywords
    for (const keyword of GOSSIP_KEYWORDS) {
      if (text.includes(keyword)) {
        return false;
      }
    }
    
    // Check for political keywords (bonus points)
    let politicalScore = 0;
    for (const keyword of POLITICS_KEYWORDS) {
      if (text.includes(keyword)) {
        politicalScore++;
      }
    }
    
    // If we have political indicators, it's likely political
    if (politicalScore >= 2) return true;
    
    // Default to keeping if uncertain (better than filtering out
// valid political content)
    return true;
  }

  function isBreaking(article) {
    const text = `${article.title} ${article.description || ''}`.toLowerCase();
    const breakingPatterns = [
      'breaking', 'urgent', 'alert', 'just in', 'developing', 'live',
      'happening now', 'this just in', 'confirmed', 'exclusive'
    ];
    
    return breakingPatterns.some(pattern => text.includes(pattern));
  }

  function getSentiment(article) {
    const text = `${article.title} ${article.description || ''}`.toLowerCase();
    
    const positive = ['victory', 'win', 'success', 'triumph', 'boom', 'surge'];
    const negative = ['crisis', 'collapse', 'scandal', 'fraud', 'attack', 'threat'];
    
    let score = 0;
    positive.forEach(word => { if (text.includes(word)) score += 1; });
    negative.forEach(word => { if (text.includes(word)) score -= 1; });
    
    if (score > 0) return 'positive';
    if (score < 0) return 'negative';
    return 'neutral';
  }

  // Fetch with timeout and error handling
  async function fetchWithTimeout(url, timeout = 12000) {
    if (state.abortController) {
      state.abortController.abort();
    }
    
    state.abortController = new AbortController();
    
    const proxies = [
      url => fetch(url, { 
        signal: state.abortController.signal,
        headers: { 'User-Agent': 'NewsBot/1.0' }
      }),
      url => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, {
        signal: state.abortController.signal
      }),
      url => fetch(`https://r.jina.ai/${url}`, {
        signal: state.abortController.signal
      })
    ];

    for (let i = 0; i < proxies.length; i++) {
      try {
        const response = await Promise.race([
          proxies[i](url),
          new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Timeout')), timeout)
          )
        ]);
        
        if (response.ok) {
          const text = await response.text();
          if (text && text.length > 100) {
            return text;
          }
        }
      } catch (error) {
        if (error.name === 'AbortError') throw error;
        console.warn(`Proxy ${i + 1} failed:`, error.message);
        continue;
      }
    }
    
    throw new Error('All proxies failed');
  }

  // RSS parsing
  function parseRSS(xmlText, source) {
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, 'text/xml');
      
      if (doc.querySelector('parsererror')) {
        throw new Error('Invalid XML');
      }
      
      const items = Array.from(doc.querySelectorAll('item, entry'));
      
      return items.slice(0, 20).map(item => {
        const title = item.querySelector('title')?.textContent?.trim() || '';
        const link = item.querySelector('link')?.getAttribute('href') || 
                    item.querySelector('link')?.textContent?.trim() || '';
        const description = stripHtml(
          item.querySelector('description, summary, content\\:encoded')?.textContent || ''
        ).slice(0, 200);
        const pubDate = item.querySelector('pubDate, updated, published')?.textContent || '';
        
        return {
          id: `${source.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          title,
          link,
          description,
          pubDate,
          source: source.name,
          sourceId: source.id,
          lane: source.lane,
          isBreaking: isBreaking({ title, description }),
          sentiment: getSentiment({ title, description })
        };
      }).filter(article => 
        article.title && 
        article.link && 
        article.title.length > 10 &&
        isPolitical(article)
      );
    } catch (error) {
      console.error('RSS parse error:', error);
      return [];
    }
  }

  // Deduplication
  function deduplicateArticles(articles) {
    const seen = new Map();
    const deduplicated = [];
    
    for (const article of articles) {
      const normalizedTitle = normalizeTitle(article.title);
      let isDuplicate = false;
      
      // Check against existing articles
      for (const [existingTitle, existingArticle] of seen) {
        if (calculateSimilarity(normalizedTitle, existingTitle) > 0.85) {
          isDuplicate = true;
          // Keep the one with better description or more recent
          if (article.description.length > existingArticle.description.length) {
            const index = deduplicated.indexOf(existingArticle);
            if (index !== -1) {
              deduplicated[index] = article;
              seen.set(normalizedTitle, article);
            }
          }
          break;
        }
      }
      
      if (!isDuplicate) {
        seen.set(normalizedTitle, article);
        deduplicated.push(article);
      }
    }
    
    return deduplicated;
  }

  // Article rendering
  function createSkeletonCard() {
    const article = document.createElement('article');
    article.className = 'article-skeleton';
    article.innerHTML = `
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
    `;
    return article;
  }

  function createArticleCard(article, index) {
    const articleEl = document.createElement('article');
    articleEl.className = 'article';
    articleEl.style.animationDelay = `${index * 50}ms`;
    
    const hostname = getHostname(article.link);
    const timeString = formatTime(article.pubDate);
    
    articleEl.innerHTML = `
      <div class="article-header">
        <img class="article-icon" 
             src="https://www.google.com/s2/favicons?domain=${escapeHtml(hostname)}&sz=64" 
             alt="" 
             loading="lazy">
        <div class="article-content">
          <h3 class="article-title">${escapeHtml(article.title)}</h3>
          <div class="article-meta">
            <span class="article-source">${escapeHtml(article.source)}</span>
            <span>•</span>
            <span class="article-time">${escapeHtml(timeString)}</span>
            ${article.isBreaking ? '<span class="breaking-badge">Breaking</span>' : ''}
            <span class="sentiment-badge sentiment-${article.sentiment}">${article.sentiment}</span>
          </div>
        </div>
        <button class="action-btn" aria-label="Article actions">⋮</button>
      </div>
    `;
    
    // Add click handlers
    const header = articleEl.querySelector('.article-header');
    const actionBtn = articleEl.querySelector('.action-btn');
    
    header.addEventListener('click', (e) => {
      if (e.target === actionBtn) return;
      window.open(article.link, '_blank', 'noopener,noreferrer');
    });
    
    actionBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showActionSheet(article);
    });
    
    return articleEl;
  }

  // Action sheet
  function showActionSheet(article) {
    state.currentArticle = article;
    elements.overlay.classList.add('show');
    elements.actionSheet.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function hideActionSheet() {
    elements.overlay.classList.remove('show');
    elements.actionSheet.classList.remove('show');
    document.body.style.overflow = '';
    state.currentArticle = null;
  }

  // Batch rendering for performance
  function renderArticles() {
    elements.articleList.innerHTML = '';
    
    if (state.filteredArticles.length === 0) {
      elements.emptyState.style.display = 'block';
      return;
    }
    
    elements.emptyState.style.display = 'none';
    
    // Create document fragment for batch DOM updates
    const fragment = document.createDocumentFragment();
    
    // Render in batches of 20 to avoid blocking
    const batchSize = 20;
    let currentBatch = 0;
    
    function renderBatch() {
      const start = currentBatch * batchSize;
      const end = Math.min(start + batchSize, state.filteredArticles.length);
      
      for (let i = start; i < end; i++) {
        const article = state.filteredArticles[i];
        const card = createArticleCard(article, i);
        fragment.appendChild(card);
      }
      
      elements.articleList.appendChild(fragment);
      currentBatch++;
      
      if (end < state.filteredArticles.length) {
        requestAnimationFrame(renderBatch);
      }
    }
    
    // Start first batch
    requestAnimationFrame(renderBatch);
  }

  // Filtering
  function applyFilters() {
    let filtered = state.articles;
    
    // Apply view filter
    if (state.currentView !== 'all') {
      switch (state.currentView) {
        case 'conservative':
          filtered = filtered.filter(a => a.lane === 'conservative');
          break;
        case 'populist':
          filtered = filtered.filter(a => a.lane === 'populist');
          break;
        case 'breaking':
          filtered = filtered.filter(a => a.isBreaking);
          break;
      }
    }
    
    state.filteredArticles = filtered;
    updateStats();
    renderArticles();
  }

  // Stats update
  function updateStats() {
    elements.totalCount.textContent = state.filteredArticles.length;
    elements.sourceCount.textContent = new Set(state.articles.map(a => a.sourceId)).size;
    elements.breakingCount.textContent = state.filteredArticles.filter(a => a.isBreaking).length;
  }

  // Loading articles with staggered fetch
  async function loadArticles() {
    if (state.loading) return;
    
    const now = Date.now();
    if (now - state.lastRefresh < 30000) { // 30 second rate limit
      showToast('Please wait before refreshing again', 'info');
      return;
    }
    
    state.loading = true;
    state.lastRefresh = now;
    elements.refreshBtn.textContent = 'Loading...';
    elements.refreshBtn.disabled = true;
    
    // Show skeleton loaders
    elements.articleList.innerHTML = '';
    for (let i = 0; i < 8; i++) {
      elements.articleList.appendChild(createSkeletonCard());
    }
    
    try {
      const results = [];
      
      // Stagger requests to avoid overwhelming servers
      for (let i = 0; i < SOURCES.length; i += 3) {
        const batch = SOURCES.slice(i, i + 3);
        const batchPromises = batch.map(async source => {
          try {
            // Check cache first (5 minute TTL)
            const cacheKey = `${source.id}-${Math.floor(now / 300000)}`;
            if (state.cache.has(cacheKey)) {
              return state.cache.get(cacheKey);
            }
            
            const xmlText = await fetchWithTimeout(source.url);
            const articles = parseRSS(xmlText, source);
            
            // Cache the result
            state.cache.set(cacheKey, articles);
            
            return articles;
          } catch (error) {
            console.warn(`Failed to load ${source.name}:`, error.message);
            return [];
          }
        });
        
        const batchResults = await Promise.allSettled(batchPromises);
        results.push(...batchResults
          .filter(r => r.status === 'fulfilled')
          .map(r => r.value)
        );
        
        // Small delay between batches
        if (i + 3 < SOURCES.length) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
      
      // Flatten, deduplicate, and sort
      const allArticles = results.flat();
      const deduplicated = deduplicateArticles(allArticles);
      
      state.articles = deduplicated
        .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate))
        .slice(0, 200); // Limit total articles
      
      applyFilters();
      
      showToast(`Loaded ${state.articles.length} articles`, 'success');
      
      // Clean old cache entries
      if (state.cache.size > 50) {
        const oldKeys = Array.from(state.cache.keys()).slice(0, 20);
        oldKeys.forEach(key => state.cache.delete(key));
      }
      
    } catch (error) {
      console.error('Load failed:', error);
      showToast('Failed to load articles', 'error');
      
      // Try to load from cache as fallback
      try {
        const cached = JSON.parse(localStorage.getItem('ur-news-cache') || '[]');
        if (cached.length > 0) {
          state.articles = cached;
          applyFilters();
          showToast('Loaded cached articles', 'info');
        }
      } catch (e) {
        elements.emptyState.style.display = 'block';
      }
    } finally {
      state.loading = false;
      elements.refreshBtn.textContent = 'Refresh';
      elements.refreshBtn.disabled = false;
    }
  }

  // Pull to refresh
  let pullStartY = 0;
  let pullCurrentY = 0;
  let pullDiff = 0;
  let isPulling = false;

  function handleTouchStart(e) {
    if (window.scrollY > 0) return;
    pullStartY = e.touches[0].clientY;
  }

  function handleTouchMove(e) {
    if (window.scrollY > 0 || state.loading) return;
    
    pullCurrentY = e.touches[0].clientY;
    pullDiff = pullCurrentY - pullStartY;
    
    if (pullDiff > 0) {
      isPulling = true;
      e.preventDefault();
      
      const pullDistance = Math.min(pullDiff * 0.5, 60);
      elements.pullRefresh.style.marginTop = `${pullDistance - 60}px`;
      
      if (pullDistance >= 50) {
        elements.pullRefresh.classList.add('active');
      }
    }
  }

  function handleTouchEnd() {
    if (!isPulling) return;
    
    isPulling = false;
    elements.pullRefresh.style.marginTop = '-60px';
    
    if (elements.pullRefresh.classList.contains('active')) {
      elements.pullRefresh.classList.remove('active');
      loadArticles();
    }
  }

  // Service Worker for caching
  function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) return;
    
    const swCode = `
      const CACHE_NAME = 'ur-news-v1';
      const urlsToCache = ['/'];
      
      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
        );
      });
      
      self.addEventListener('fetch', event => {
        if (event.request.url.includes('/feed') || event.request.url.includes('rss')) {
          event.respondWith(
            caches.open(CACHE_NAME).then(cache => {
              return fetch(event.request).then(response => {
                cache.put(event.request, response.clone());
                return response;
              }).catch(() => {
                return cache.match(event.request);
              });
            })
          );
        }
      });
    `;
    
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    
    navigator.serviceWorker.register(swUrl).catch(console.warn);
  }

  // Event listeners
  function setupEventListeners() {
    // Refresh button
    elements.refreshBtn.addEventListener('click', loadArticles);
    
    // Politics filter toggle
    elements.politicsBtn.addEventListener('click', () => {
      state.politicsOnly = !state.politicsOnly;
      elements.politicsBtn.classList.toggle('active', state.politicsOnly);
      elements.politicsBtn.textContent = state.politicsOnly ? 'Politics Only' : 'All Topics';
      applyFilters();
    });
    
    // View filters
    elements.filters.addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-chip')) return;
      
      elements.filters.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      
      e.target.classList.add('active');
      state.currentView = e.target.dataset.view;
      applyFilters();
    });
    
    // Action sheet
    elements.overlay.addEventListener('click', hideActionSheet);
    elements.closeActionSheet.addEventListener('click', hideActionSheet);
    
    document.getElementById('openArticle').addEventListener('click', () => {
      if (state.currentArticle) {
        window.open(state.currentArticle.link, '_blank', 'noopener,noreferrer');
        hideActionSheet();
      }
    });
    
    document.getElementById('saveArticle').addEventListener('click', () => {
      if (state.currentArticle) {
        const saved = JSON.parse(localStorage.getItem('ur-news-saved') || '[]');
        saved.unshift(state.currentArticle);
        localStorage.setItem('ur-news-saved', JSON.stringify(saved.slice(0, 100)));
        showToast('Article saved', 'success');
        hideActionSheet();
      }
    });
    
    document.getElementById('shareArticle').addEventListener('click', async () => {
      if (state.currentArticle && navigator.share) {
        try {
          await navigator.share({
            title: state.currentArticle.title,
            url: state.currentArticle.link
          });
          hideActionSheet();
        } catch (e) {
          // Fallback to clipboard
          navigator.clipboard?.writeText(state.currentArticle.link);
          showToast('Link copied to clipboard', 'success');
          hideActionSheet();
        }
      }
    });
    
    // Pull to refresh
    document.addEventListener('touchstart', handleTouchStart, { passive: false });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd);
    
    // Visibility change handling
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        // Auto-refresh if data is stale (10+ minutes)
        if (Date.now() - state.lastRefresh > 600000) {
          loadArticles();
        }
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        loadArticles();
      }
      
      if (e.key === 'Escape') {
        hideActionSheet();
      }
    });
  }

  // Persistence
  function saveState() {
    try {
      localStorage.setItem('ur-news-cache', JSON.stringify(state.articles.slice(0, 50)));
    } catch (e) {
      // Storage full or disabled
    }
  }

  function loadState() {
    try {
      const cached = localStorage.getItem('ur-news-cache');
      if (cached) {
        const articles = JSON.parse(cached);
        if (Array.isArray(articles) && articles.length > 0) {
          state.articles = articles;
          applyFilters();
        }
      }
    } catch (e) {
      // Invalid cache
    }
  }

  // Auto-save state periodically
  setInterval(saveState, 60000);
  window.addEventListener('beforeunload', saveState);

  // Initialize
  function init() {
    setupEventListeners();
    registerServiceWorker();
    loadState();
    
    // Initial load with small delay for better perceived performance
    setTimeout(loadArticles, 100);
    
    // Auto-refresh every 10 minutes
    setInterval(() => {
      if (!state.loading && document.visibilityState === 'visible') {
        loadArticles();
      }
    }, 600000);
  }

  // Start the app
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
  </script>
</body>
</html>

  
