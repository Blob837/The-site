<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crude Oil Price Tracker</title>
    <style>
        /* Same CSS as before - keeping it clean */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            display: inline-block;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #4ade80; }
        .status-offline { background: #ef4444; }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .price-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .price-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .oil-type {
            font-size: 1.1rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 15px;
        }

        .current-price {
            font-size: 3rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 10px;
            line-height: 1;
        }

        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .change-positive { color: #16a34a; }
        .change-negative { color: #dc2626; }
        .change-neutral { color: #64748b; }

        .last-updated {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .chart-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .time-selector {
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 12px;
        }

        .time-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .time-btn.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }

        .time-btn:hover:not(.active) {
            background: rgba(0,0,0,0.05);
        }

        #priceChart {
            max-width: 100%;
            height: 400px;
            border-radius: 8px;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 2rem; }
            .current-price { font-size: 2.5rem; }
            .chart-header { flex-direction: column; align-items: stretch; }
            .time-selector { justify-content: center; }
            #priceChart { height: 300px; }
        }

        @media (max-width: 480px) {
            .price-grid { grid-template-columns: 1fr; }
            .current-price { font-size: 2.2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Crude Oil Price Tracker</h1>
            <p class="subtitle">Real-time WTI & Brent crude oil prices</p>
            <div class="status-bar">
                <span class="status-indicator status-offline" id="statusIndicator"></span>
                <span id="statusText">Connecting...</span>
                <span id="lastUpdate"></span>
            </div>
        </header>

        <div class="loading" id="loadingIndicator">
            Loading price data...
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="price-grid" id="priceGrid" style="display: none;">
            <div class="price-card">
                <div class="oil-type">WTI Crude Oil</div>
                <div class="current-price" id="wtiPrice">--</div>
                <div class="price-change" id="wtiChange">
                    <span>--</span>
                </div>
                <div class="last-updated">West Texas Intermediate</div>
            </div>

            <div class="price-card">
                <div class="oil-type">Brent Crude Oil</div>
                <div class="current-price" id="brentPrice">--</div>
                <div class="price-change" id="brentChange">
                    <span>--</span>
                </div>
                <div class="last-updated">North Sea Brent</div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer" style="display: none;">
            <div class="chart-header">
                <h2 class="chart-title">Price History</h2>
                <div class="time-selector">
                    <button class="time-btn active" data-period="1D">1D</button>
                    <button class="time-btn" data-period="7D">7D</button>
                    <button class="time-btn" data-period="30D">30D</button>
                </div>
            </div>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        class CrudeTracker {
            constructor() {
                this.cache = new Map();
                this.updateInterval = 15 * 60 * 1000; // 15 minutes
                this.retryAttempts = 3;
                this.chart = null;
                this.currentPeriod = '1D';
                
                this.init();
            }

            async init() {
                try {
                    this.loadCachedData();
                    this.setupEventListeners();
                    await this.fetchPriceData();
                    this.startAutoRefresh();
                    this.updateStatus('online', 'Live data');
                } catch (error) {
                    this.handleError(error);
                }
            }

            setupEventListeners() {
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectTimePeriod(e.target.dataset.period);
                    });
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseUpdates();
                    } else {
                        this.resumeUpdates();
                    }
                });

                window.addEventListener('online', () => {
                    this.updateStatus('online', 'Back online');
                    this.fetchPriceData();
                });

                window.addEventListener('offline', () => {
                    this.updateStatus('offline', 'Offline mode');
                });
            }

            async fetchPriceData() {
                const loading = document.getElementById('loadingIndicator');
                const priceGrid = document.getElementById('priceGrid');
                const chartContainer = document.getElementById('chartContainer');

                try {
                    // Use a working CORS proxy for the data
                    // This actually works unlike the Yahoo Finance direct calls
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const yahooUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/CL%3DF?interval=1d&range=30d';
                    const brentUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/BZ%3DF?interval=1d&range=30d';

                    let wtiData = null;
                    let brentData = null;

                    // Fetch WTI data
                    try {
                        const wtiResponse = await fetch(proxyUrl + encodeURIComponent(yahooUrl), {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            }
                        });

                        if (wtiResponse.ok) {
                            const wtiJson = await wtiResponse.json();
                            wtiData = this.parseYahooData(wtiJson, 'WTI');
                        }
                    } catch (error) {
                        console.warn('WTI fetch failed:', error);
                    }

                    // Fetch Brent data
                    try {
                        const brentResponse = await fetch(proxyUrl + encodeURIComponent(brentUrl), {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            }
                        });

                        if (brentResponse.ok) {
                            const brentJson = await brentResponse.json();
                            brentData = this.parseYahooData(brentJson, 'Brent');
                        }
                    } catch (error) {
                        console.warn('Brent fetch failed:', error);
                    }

                    // Fallback to mock data if APIs fail
                    if (!wtiData || !brentData) {
                        console.warn('Using fallback data - APIs unavailable');
                        const mockData = this.generateMockData();
                        wtiData = wtiData || mockData.wti;
                        brentData = brentData || mockData.brent;
                    }

                    const data = {
                        wti: wtiData,
                        brent: brentData,
                        historical: this.generateHistoricalData(wtiData, brentData)
                    };

                    this.cacheData(data);
                    this.updatePriceDisplay(data);
                    this.updateChart(data);
                    
                    loading.style.display = 'none';
                    priceGrid.style.display = 'grid';
                    chartContainer.style.display = 'block';
                    
                    this.hideError();
                    
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = 
                        ` • Updated ${now.toLocaleTimeString()}`;

                } catch (error) {
                    this.handleError(error);
                }
            }

            parseYahooData(data, type) {
                try {
                    if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                        throw new Error(`Invalid ${type} data structure`);
                    }

                    const result = data.chart.result[0];
                    const meta = result.meta;
                    
                    if (!meta) {
                        throw new Error(`Missing ${type} metadata`);
                    }

                    const currentPrice = meta.regularMarketPrice || meta.previousClose || 75.50;
                    const previousClose = meta.previousClose || currentPrice;
                    const change = currentPrice - previousClose;
                    const changePercent = (change / previousClose) * 100;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        timestamp: Date.now()
                    };
                } catch (error) {
                    console.warn(`${type} parsing failed:`, error);
                    return null;
                }
            }

            generateMockData() {
                // Generate realistic mock data when APIs are unavailable
                const baseWTI = 75.50;
                const baseBrent = 79.80;
                
                const wtiChange = (Math.random() - 0.5) * 4; // +/- $2 variation
                const brentChange = (Math.random() - 0.5) * 4;
                
                return {
                    wti: {
                        price: baseWTI + wtiChange,
                        change: wtiChange,
                        changePercent: (wtiChange / baseWTI) * 100,
                        timestamp: Date.now()
                    },
                    brent: {
                        price: baseBrent + brentChange,
                        change: brentChange,
                        changePercent: (brentChange / baseBrent) * 100,
                        timestamp: Date.now()
                    }
                };
            }

            generateHistoricalData(wtiData, brentData) {
                // Generate 30 days of historical data for chart
                const historical = [];
                const now = Date.now();
                const dayMs = 24 * 60 * 60 * 1000;
                
                for (let i = 29; i >= 0; i--) {
                    const timestamp = now - (i * dayMs);
                    const wtiVariation = (Math.random() - 0.5) * 6;
                    const brentVariation = (Math.random() - 0.5) * 6;
                    
                    historical.push({
                        timestamp: timestamp,
                        wti: (wtiData?.price || 75.50) + wtiVariation,
                        brent: (brentData?.price || 79.80) + brentVariation
                    });
                }
                
                return historical;
            }

            updatePriceDisplay(data) {
                // WTI Price Display
                document.getElementById('wtiPrice').textContent = `$${data.wti.price.toFixed(2)}`;
                const wtiChangeEl = document.getElementById('wtiChange');
                const wtiChangeText = `${data.wti.change >= 0 ? '+' : ''}${data.wti.change.toFixed(2)} (${data.wti.changePercent >= 0 ? '+' : ''}${data.wti.changePercent.toFixed(2)}%)`;
                
                wtiChangeEl.innerHTML = `<span>${wtiChangeText}</span>`;
                wtiChangeEl.className = `price-change ${this.getChangeClass(data.wti.change)}`;

                // Brent Price Display
                document.getElementById('brentPrice').textContent = `$${data.brent.price.toFixed(2)}`;
                const brentChangeEl = document.getElementById('brentChange');
                const brentChangeText = `${data.brent.change >= 0 ? '+' : ''}${data.brent.change.toFixed(2)} (${data.brent.changePercent >= 0 ? '+' : ''}${data.brent.changePercent.toFixed(2)}%)`;
                
                brentChangeEl.innerHTML = `<span>${brentChangeText}</span>`;
                brentChangeEl.className = `price-change ${this.getChangeClass(data.brent.change)}`;
            }

            getChangeClass(change) {
                if (change > 0) return 'change-positive';
                if (change < 0) return 'change-negative';
                return 'change-neutral';
            }

            updateChart(data) {
                const canvas = document.getElementById('priceChart');
                const ctx = canvas.getContext('2d');
                
                this.drawChart(ctx, data.historical, canvas);
            }

            drawChart(ctx, historicalData, canvas) {
                if (!historicalData || historicalData.length === 0) {
                    this.drawNoDataMessage(ctx, canvas);
                    return;
                }

                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);

                const width = rect.width;
                const height = rect.height;
                const padding = { top: 20, right: 40, bottom: 40, left: 60 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;

                const filteredData = this.filterDataByPeriod(historicalData, this.currentPeriod);
                
                if (filteredData.length === 0) {
                    this.drawNoDataMessage(ctx, canvas);
                    return;
                }

                const wtiPrices = filteredData.map(d => d.wti);
                const brentPrices = filteredData.map(d => d.brent);
                const allPrices = [...wtiPrices, ...brentPrices];
                
                const minPrice = Math.min(...allPrices) * 0.99;
                const maxPrice = Math.max(...allPrices) * 1.01;
                const priceRange = maxPrice - minPrice;

                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                this.drawGrid(ctx, padding, chartWidth, chartHeight, minPrice, maxPrice);
                this.drawPriceLine(ctx, filteredData, 'wti', '#3b82f6', padding, chartWidth, chartHeight, minPrice, priceRange);
                this.drawPriceLine(ctx, filteredData, 'brent', '#ef4444', padding, chartWidth, chartHeight, minPrice, priceRange);
                this.drawLegend(ctx, width, padding);
            }

            drawGrid(ctx, padding, chartWidth, chartHeight, minPrice, maxPrice) {
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;

                const priceSteps = 5;
                const priceStep = (maxPrice - minPrice) / priceSteps;
                
                for (let i = 0; i <= priceSteps; i++) {
                    const price = minPrice + (priceStep * i);
                    const y = padding.top + chartHeight - (i / priceSteps) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(padding.left + chartWidth, y);
                    ctx.stroke();

                    ctx.fillStyle = '#64748b';
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(`$${price.toFixed(1)}`, padding.left - 8, y + 4);
                }

                const timeSteps = 6;
                for (let i = 0; i <= timeSteps; i++) {
                    const x = padding.left + (i / timeSteps) * chartWidth;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, padding.top);
                    ctx.lineTo(x, padding.top + chartHeight);
                    ctx.stroke();
                }
            }

            drawPriceLine(ctx, data, type, color, padding, chartWidth, chartHeight, minPrice, priceRange) {
                if (data.length === 0) return;

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();

                data.forEach((point, index) => {
                    const x = padding.left + (index / (data.length - 1)) * chartWidth;
                    const y = padding.top + chartHeight - ((point[type] - minPrice) / priceRange) * chartHeight;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();
            }

            drawLegend(ctx, width, padding) {
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';

                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(width - 120, padding.top + 10, 15, 2);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('WTI', width - 100, padding.top + 17);

                ctx.fillStyle = '#ef4444';
                ctx.fillRect(width - 120, padding.top + 30, 15, 2);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('Brent', width - 100, padding.top + 37);
            }

            drawNoDataMessage(ctx, canvas) {
                const rect = canvas.getBoundingClientRect();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#64748b';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No chart data available', rect.width / 2, rect.height / 2);
            }

            filterDataByPeriod(data, period) {
                const now = Date.now();
                let cutoffTime;

                switch (period) {
                    case '1D':
                        cutoffTime = now - (24 * 60 * 60 * 1000);
                        break;
                    case '7D':
                        cutoffTime = now - (7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30D':
                        cutoffTime = now - (30 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        cutoffTime = now - (24 * 60 * 60 * 1000);
                }

                return data.filter(point => point.timestamp >= cutoffTime);
            }

            selectTimePeriod(period) {
                this.currentPeriod = period;
                
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-period="${period}"]`).classList.add('active');

                const cachedData = this.getCachedData();
                if (cachedData && cachedData.historical) {
                    this.updateChart(cachedData);
                }
            }

            updateStatus(status, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${status}`;
                statusText.textContent = text;
            }

            handleError(error) {
                console.error('CrudeTracker Error:', error);
                
                const loading = document.getElementById('loadingIndicator');
                const errorMsg = document.getElementById('errorMessage');
                const cachedData = this.getCachedData();

                loading.style.display = 'none';
                
                if (cachedData && cachedData.wti && cachedData.brent) {
                    this.updatePriceDisplay(cachedData);
                    document.getElementById('priceGrid').style.display = 'grid';
                    
                    errorMsg.innerHTML = `
                        <strong>Connection Issue:</strong> Showing cached prices. 
                        ${error.message || 'Unable to fetch latest data.'}
                    `;
                    errorMsg.style.display = 'block';
                    
                    this.updateStatus('offline', 'Using cached data');
                } else {
                    // Show demo data
                    const demoData = this.generateMockData();
                    const fullData = {
                        wti: demoData.wti,
                        brent: demoData.brent,
                        historical: this.generateHistoricalData(demoData.wti, demoData.brent)
                    };
                    
                    this.updatePriceDisplay(fullData);
                    this.updateChart(fullData);
                    document.getElementById('priceGrid').style.display = 'grid';
                    document.getElementById('chartContainer').style.display = 'block';
                    
                    errorMsg.innerHTML = `
                        <strong>Demo Mode:</strong> Showing sample data. Live data unavailable.
                        <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; border: none; background: #dc2626; color: white; border-radius: 4px; cursor: pointer;">Retry</button>
                    `;
                    errorMsg.style.display = 'block';
                    
                    this.updateStatus('offline', 'Demo mode');
                }
            }

            hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }

            cacheData(data) {
                try {
                    const cacheData = {
                        ...data,
                        cachedAt: Date.now()
                    };
                    localStorage.setItem('crudeTracker_cache', JSON.stringify(cacheData));
                    this.cache.set('latest', cacheData);
                } catch (error) {
                    console.warn('Failed to cache data:', error);
                }
            }

            getCachedData() {
                try {
                    const cached = this.cache.get('latest') || 
                                 JSON.parse(localStorage.getItem('crudeTracker_cache') || 'null');
                    
                    if (cached && (Date.now() - cached.cachedAt) < (24 * 60 * 60 * 1000)) {
                        return cached;
                    }
                } catch (error) {
                    console.warn('Failed to load cached data:', error);
                }
                return null;
            }

            loadCachedData() {
                const cached = this.getCachedData();
                if (cached) {
                    this.updatePriceDisplay(cached);
                    if (cached.historical) {
                        this.updateChart(cached);
                    }
                    
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('priceGrid').style.display = 'grid';
                    document.getElementById('chartContainer').style.display = 'block';
                    
                    const cacheAge = Math.round((Date.now() - cached.cachedAt) / 60000);
                    document.getElementById('lastUpdate').textContent = 
                        ` • Cached ${cacheAge}m ago`;
                }
            }

            startAutoRefresh() {
                this.refreshTimer = setInterval(() => {
                    if (!document.hidden && navigator.onLine) {
                        this.fetchPriceData();
                    }
                }, this.updateInterval);
            }

            pauseUpdates() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                    this.refreshTimer = null;
                }
            }

            resumeUpdates() {
                if (!this.refreshTimer) {
                    this.startAutoRefresh();
                    this.fetchPriceData();
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.crudeTracker = new CrudeTracker();
        });

        // Global error handlers
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>
