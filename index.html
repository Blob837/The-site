<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crude Oil Price Tracker</title>
    <style>
        /* Reset and base styles - keep it clean */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            display: inline-block;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #4ade80; }
        .status-offline { background: #ef4444; }

        /* Price cards that don't look like amateur hour */
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .price-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .price-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .oil-type {
            font-size: 1.1rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 15px;
        }

        .current-price {
            font-size: 3rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 10px;
            line-height: 1;
        }

        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .change-positive { color: #16a34a; }
        .change-negative { color: #dc2626; }
        .change-neutral { color: #64748b; }

        .last-updated {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* Chart container that won't embarrass you */
        .chart-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .time-selector {
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 12px;
        }

        .time-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .time-btn.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }

        .time-btn:hover:not(.active) {
            background: rgba(0,0,0,0.05);
        }

        /* Chart canvas */
        #priceChart {
            max-width: 100%;
            height: 400px;
            border-radius: 8px;
        }

        /* Error handling that doesn't make users panic */
        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 2rem; }
            .current-price { font-size: 2.5rem; }
            .chart-header { flex-direction: column; align-items: stretch; }
            .time-selector { justify-content: center; }
            #priceChart { height: 300px; }
        }

        @media (max-width: 480px) {
            .price-grid { grid-template-columns: 1fr; }
            .current-price { font-size: 2.2rem; }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .price-card {
                border: 2px solid #000;
                background: #fff;
            }
            .status-bar {
                border: 1px solid rgba(255,255,255,0.5);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Crude Oil Price Tracker</h1>
            <p class="subtitle">Real-time WTI & Brent crude oil prices</p>
            <div class="status-bar">
                <span class="status-indicator status-offline" id="statusIndicator"></span>
                <span id="statusText">Connecting...</span>
                <span id="lastUpdate"></span>
            </div>
        </header>

        <div class="loading" id="loadingIndicator">
            Loading price data...
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="price-grid" id="priceGrid" style="display: none;">
            <div class="price-card">
                <div class="oil-type">WTI Crude Oil</div>
                <div class="current-price" id="wtiPrice">--</div>
                <div class="price-change" id="wtiChange">
                    <span>--</span>
                </div>
                <div class="last-updated">West Texas Intermediate</div>
            </div>

            <div class="price-card">
                <div class="oil-type">Brent Crude Oil</div>
                <div class="current-price" id="brentPrice">--</div>
                <div class="price-change" id="brentChange">
                    <span>--</span>
                </div>
                <div class="last-updated">North Sea Brent</div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer" style="display: none;">
            <div class="chart-header">
                <h2 class="chart-title">Price History</h2>
                <div class="time-selector">
                    <button class="time-btn active" data-period="1D">1D</button>
                    <button class="time-btn" data-period="7D">7D</button>
                    <button class="time-btn" data-period="30D">30D</button>
                </div>
            </div>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        // Production-grade oil price tracker
        // Built to not break when the wind shifts
        
        class CrudeTracker {
            constructor() {
                this.cache = new Map();
                this.updateInterval = 15 * 60 * 1000; // 15 minutes
                this.retryAttempts = 3;
                this.chart = null;
                this.currentPeriod = '1D';
                
                // Initialize the tracker
                this.init();
            }

            async init() {
                try {
                    // Load cached data first for instant display
                    this.loadCachedData();
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Fetch fresh data
                    await this.fetchPriceData();
                    
                    // Set up auto-refresh
                    this.startAutoRefresh();
                    
                    this.updateStatus('online', 'Live data');
                } catch (error) {
                    this.handleError(error);
                }
            }

            setupEventListeners() {
                // Time period selector buttons
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectTimePeriod(e.target.dataset.period);
                    });
                });

                // Page visibility API for pause/resume updates
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseUpdates();
                    } else {
                        this.resumeUpdates();
                    }
                });

                // Network status monitoring
                window.addEventListener('online', () => {
                    this.updateStatus('online', 'Back online');
                    this.fetchPriceData();
                });

                window.addEventListener('offline', () => {
                    this.updateStatus('offline', 'Offline mode');
                });
            }

            async fetchPriceData() {
                const loading = document.getElementById('loadingIndicator');
                const priceGrid = document.getElementById('priceGrid');
                const chartContainer = document.getElementById('chartContainer');

                try {
                    // Multiple API endpoints for redundancy
                    const apiEndpoints = [
                        // Yahoo Finance - most reliable free endpoint
                        {
                            url: 'https://query1.finance.yahoo.com/v8/finance/chart/CL=F,BZ=F',
                            parser: this.parseYahooData.bind(this)
                        },
                        // Backup endpoint using a different service
                        {
                            url: 'https://api.oil-price.com/v1/prices/latest',
                            parser: this.parseOilPriceData.bind(this)
                        }
                    ];

                    let data = null;
                    let lastError = null;

                    // Try each endpoint until one works
                    for (let endpoint of apiEndpoints) {
                        for (let attempt = 0; attempt < this.retryAttempts; attempt++) {
                            try {
                                const response = await fetch(endpoint.url, {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'application/json',
                                    },
                                    timeout: 10000
                                });

                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }

                                const rawData = await response.json();
                                data = await endpoint.parser(rawData);
                                
                                if (data && data.wti && data.brent) {
                                    break;
                                }
                            } catch (error) {
                                lastError = error;
                                console.warn(`API attempt ${attempt + 1} failed:`, error.message);
                                
                                // Exponential backoff
                                if (attempt < this.retryAttempts - 1) {
                                    await this.sleep(Math.pow(2, attempt) * 1000);
                                }
                            }
                        }

                        if (data && data.wti && data.brent) {
                            break;
                        }
                    }

                    if (!data || !data.wti || !data.brent) {
                        throw new Error('Unable to fetch price data from any source');
                    }

                    // Cache the successful data
                    this.cacheData(data);
                    
                    // Update the display
                    this.updatePriceDisplay(data);
                    this.updateChart(data);
                    
                    // Show the interface
                    loading.style.display = 'none';
                    priceGrid.style.display = 'grid';
                    chartContainer.style.display = 'block';
                    
                    this.hideError();
                    
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = 
                        ` • Updated ${now.toLocaleTimeString()}`;

                } catch (error) {
                    this.handleError(error);
                }
            }

            // Yahoo Finance API parser - rock solid
            async parseYahooData(data) {
                try {
                    if (!data.chart || !data.chart.result || data.chart.result.length < 2) {
                        throw new Error('Invalid Yahoo Finance response structure');
                    }

                    const wtiData = data.chart.result[0]; // CL=F (WTI)
                    const brentData = data.chart.result[1]; // BZ=F (Brent)

                    if (!wtiData.meta || !brentData.meta) {
                        throw new Error('Missing price metadata');
                    }

                    const wtiPrice = wtiData.meta.regularMarketPrice || wtiData.meta.previousClose;
                    const brentPrice = brentData.meta.regularMarketPrice || brentData.meta.previousClose;
                    
                    const wtiChange = wtiData.meta.regularMarketPrice - wtiData.meta.previousClose;
                    const brentChange = brentData.meta.regularMarketPrice - brentData.meta.previousClose;

                    return {
                        wti: {
                            price: wtiPrice,
                            change: wtiChange,
                            changePercent: (wtiChange / wtiData.meta.previousClose) * 100,
                            timestamp: Date.now()
                        },
                        brent: {
                            price: brentPrice,
                            change: brentChange,
                            changePercent: (brentChange / brentData.meta.previousClose) * 100,
                            timestamp: Date.now()
                        },
                        historical: this.extractHistoricalData(wtiData, brentData)
                    };
                } catch (error) {
                    throw new Error(`Yahoo Finance parsing failed: ${error.message}`);
                }
            }

            // Backup API parser
            async parseOilPriceData(data) {
                // Implementation for backup API
                // This is a placeholder - you'd implement based on the actual API structure
                throw new Error('Backup API not yet implemented');
            }

            extractHistoricalData(wtiData, brentData) {
                const historical = [];
                
                try {
                    const timestamps = wtiData.timestamp || [];
                    const wtiPrices = wtiData.indicators?.quote?.[0]?.close || [];
                    const brentPrices = brentData.indicators?.quote?.[0]?.close || [];
                    
                    const minLength = Math.min(timestamps.length, wtiPrices.length, brentPrices.length);
                    
                    for (let i = 0; i < minLength; i++) {
                        if (wtiPrices[i] !== null && brentPrices[i] !== null) {
                            historical.push({
                                timestamp: timestamps[i] * 1000, // Convert to milliseconds
                                wti: wtiPrices[i],
                                brent: brentPrices[i]
                            });
                        }
                    }
                } catch (error) {
                    console.warn('Historical data extraction failed:', error);
                }
                
                return historical;
            }

            updatePriceDisplay(data) {
                // WTI Price Display
                document.getElementById('wtiPrice').textContent = `$${data.wti.price.toFixed(2)}`;
                const wtiChangeEl = document.getElementById('wtiChange');
                const wtiChangeText = `${data.wti.change >= 0 ? '+' : ''}${data.wti.change.toFixed(2)} (${data.wti.changePercent >= 0 ? '+' : ''}${data.wti.changePercent.toFixed(2)}%)`;
                
                wtiChangeEl.innerHTML = `<span>${wtiChangeText}</span>`;
                wtiChangeEl.className = `price-change ${this.getChangeClass(data.wti.change)}`;

                // Brent Price Display
                document.getElementById('brentPrice').textContent = `$${data.brent.price.toFixed(2)}`;
                const brentChangeEl = document.getElementById('brentChange');
                const brentChangeText = `${data.brent.change >= 0 ? '+' : ''}${data.brent.change.toFixed(2)} (${data.brent.changePercent >= 0 ? '+' : ''}${data.brent.changePercent.toFixed(2)}%)`;
                
                brentChangeEl.innerHTML = `<span>${brentChangeText}</span>`;
                brentChangeEl.className = `price-change ${this.getChangeClass(data.brent.change)}`;
            }

            getChangeClass(change) {
                if (change > 0) return 'change-positive';
                if (change < 0) return 'change-negative';
                return 'change-neutral';
            }

            updateChart(data) {
                const canvas = document.getElementById('priceChart');
                const ctx = canvas.getContext('2d');
                
                // Clear previous chart
                if (this.chart) {
                    this.chart = null;
                }
                
                // Simple canvas-based chart - no external dependencies
                this.drawChart(ctx, data.historical, canvas);
            }

            drawChart(ctx, historicalData, canvas) {
                if (!historicalData || historicalData.length === 0) {
                    this.drawNoDataMessage(ctx, canvas);
                    return;
                }

                // Set canvas size for crisp rendering
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);

                const width = rect.width;
                const height = rect.height;
                const padding = { top: 20, right: 40, bottom: 40, left: 60 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;

                // Filter data based on current period
                const filteredData = this.filterDataByPeriod(historicalData, this.currentPeriod);
                
                if (filteredData.length === 0) {
                    this.drawNoDataMessage(ctx, canvas);
                    return;
                }

                // Calculate price ranges
                const wtiPrices = filteredData.map(d => d.wti);
                const brentPrices = filteredData.map(d => d.brent);
                const allPrices = [...wtiPrices, ...brentPrices];
                
                const minPrice = Math.min(...allPrices) * 0.99;
                const maxPrice = Math.max(...allPrices) * 1.01;
                const priceRange = maxPrice - minPrice;

                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);

                // Draw grid lines
                this.drawGrid(ctx, padding, chartWidth, chartHeight, minPrice, maxPrice);

                // Draw price lines
                this.drawPriceLine(ctx, filteredData, 'wti', '#3b82f6', padding, chartWidth, chartHeight, minPrice, priceRange);
                this.drawPriceLine(ctx, filteredData, 'brent', '#ef4444', padding, chartWidth, chartHeight, minPrice, priceRange);

                // Draw legend
                this.drawLegend(ctx, width, padding);
            }

            drawGrid(ctx, padding, chartWidth, chartHeight, minPrice, maxPrice) {
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;

                // Horizontal grid lines (price levels)
                const priceSteps = 5;
                const priceStep = (maxPrice - minPrice) / priceSteps;
                
                for (let i = 0; i <= priceSteps; i++) {
                    const price = minPrice + (priceStep * i);
                    const y = padding.top + chartHeight - (i / priceSteps) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(padding.left + chartWidth, y);
                    ctx.stroke();

                    // Price labels
                    ctx.fillStyle = '#64748b';
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(`$${price.toFixed(1)}`, padding.left - 8, y + 4);
                }

                // Vertical grid lines (time)
                const timeSteps = 6;
                for (let i = 0; i <= timeSteps; i++) {
                    const x = padding.left + (i / timeSteps) * chartWidth;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, padding.top);
                    ctx.lineTo(x, padding.top + chartHeight);
                    ctx.stroke();
                }
            }

            drawPriceLine(ctx, data, type, color, padding, chartWidth, chartHeight, minPrice, priceRange) {
                if (data.length === 0) return;

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();

                data.forEach((point, index) => {
                    const x = padding.left + (index / (data.length - 1)) * chartWidth;
                    const y = padding.top + chartHeight - ((point[type] - minPrice) / priceRange) * chartHeight;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();
            }

            drawLegend(ctx, width, padding) {
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';

                // WTI legend
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(width - 120, padding.top + 10, 15, 2);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('WTI', width - 100, padding.top + 17);

                // Brent legend
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(width - 120, padding.top + 30, 15, 2);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('Brent', width - 100, padding.top + 37);
            }

            drawNoDataMessage(ctx, canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#64748b';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No chart data available', canvas.width / 2, canvas.height / 2);
            }

            filterDataByPeriod(data, period) {
                const now = Date.now();
                let cutoffTime;

                switch (period) {
                    case '1D':
                        cutoffTime = now - (24 * 60 * 60 * 1000);
                        break;
                    case '7D':
                        cutoffTime = now - (7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30D':
                        cutoffTime = now - (30 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        cutoffTime = now - (24 * 60 * 60 * 1000);
                }

                return data.filter(point => point.timestamp >= cutoffTime);
            }

            selectTimePeriod(period) {
                this.currentPeriod = period;
                
                // Update button states
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-period="${period}"]`).classList.add('active');

                // Re-draw chart with new period
                const cachedData = this.getCachedData();
                if (cachedData && cachedData.historical) {
                    this.updateChart(cachedData);
                }
            }

            updateStatus(status, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${status}`;
                statusText.textContent = text;
            }

            handleError(error) {
                console.error('CrudeTracker Error:', error);
                
                const loading = document.getElementById('loadingIndicator');
                const errorMsg = document.getElementById('errorMessage');
                const cachedData = this.getCachedData();

                loading.style.display = 'none';
                
                if (cachedData && cachedData.wti && cachedData.brent) {
                    // Show cached data with warning
                    this.updatePriceDisplay(cachedData);
                    document.getElementById('priceGrid').style.display = 'grid';
                    
                    errorMsg.innerHTML = `
                        <strong>Connection Issue:</strong> Showing cached prices. 
                        ${error.message || 'Unable to fetch latest data.'}
                    `;
                    errorMsg.style.display = 'block';
                    
                    this.updateStatus('offline', 'Using cached data');
                } else {
                    // No cached data available
                    errorMsg.innerHTML = `
                        <strong>Unable to load price data:</strong> 
                        ${error.message || 'Please check your connection and try again.'}
                        <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; border: none; background: #dc2626; color: white; border-radius: 4px; cursor: pointer;">Retry</button>
                    `;
                    errorMsg.style.display = 'block';
                    
                    this.updateStatus('offline', 'Connection failed');
                }
            }

            hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }

            cacheData(data) {
                try {
                    const cacheData = {
                        ...data,
                        cachedAt: Date.now()
                    };
                    localStorage.setItem('crudeTracker_cache', JSON.stringify(cacheData));
                    this.cache.set('latest', cacheData);
                } catch (error) {
                    console.warn('Failed to cache data:', error);
                }
            }

            getCachedData() {
                try {
                    const cached = this.cache.get('latest') || 
                                 JSON.parse(localStorage.getItem('crudeTracker_cache') || 'null');
                    
                    if (cached && (Date.now() - cached.cachedAt) < (24 * 60 * 60 * 1000)) {
                        return cached;
                    }
                } catch (error) {
                    console.warn('Failed to load cached data:', error);
                }
                return null;
            }

            loadCachedData() {
                const cached = this.getCachedData();
                if (cached) {
                    this.updatePriceDisplay(cached);
                    if (cached.historical) {
                        this.updateChart(cached);
                    }
                    
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('priceGrid').style.display = 'grid';
                    document.getElementById('chartContainer').style.display = 'block';
                    
                    const cacheAge = Math.round((Date.now() - cached.cachedAt) / 60000);
                    document.getElementById('lastUpdate').textContent = 
                        ` • Cached ${cacheAge}m ago`;
                }
            }

            startAutoRefresh() {
                this.refreshTimer = setInterval(() => {
                    if (!document.hidden && navigator.onLine) {
                        this.fetchPriceData();
                    }
                }, this.updateInterval);
            }

pauseUpdates() {
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                    this.refreshTimer = null;
                }
            }

            resumeUpdates() {
                if (!this.refreshTimer) {
                    this.startAutoRefresh();
                    this.fetchPriceData(); // Immediate update when coming back
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the tracker when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Service worker registration for offline support
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,')
                    .catch(err => console.log('SW registration failed'));
            }

            // Initialize the tracker
            window.crudeTracker = new CrudeTracker();
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (window.crudeTracker) {
                window.crudeTracker.handleError(new Error('Application error occurred'));
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            if (window.crudeTracker) {
                window.crudeTracker.handleError(new Error('Network request failed'));
            }
        });

        // Notification permission request (optional feature)
        if ('Notification' in window && Notification.permission === 'default') {
            // Don't request immediately - wait for user interaction
            setTimeout(() => {
                if (document.hasFocus()) {
                    Notification.requestPermission();
                }
            }, 30000); // 30 seconds after page load
        }

        // Performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Page loaded in ${loadTime}ms`);
                
                // Report slow loads (over 3 seconds)
                if (loadTime > 3000) {
                    console.warn(`Slow page load detected: ${loadTime}ms`);
                }
            }
        });

        // Memory usage monitoring (development aid)
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > 50 * 1024 * 1024) { // 50MB threshold
                    console.warn('High memory usage detected:', {
                        used: Math.round(memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                        total: Math.round(memory.totalJSHeapSize / 1024 / 1024) + 'MB'
                    });
                }
            }, 60000); // Check every minute
        }

        // Touch gesture support for mobile chart interaction
        let touchStartX = 0;
        let touchStartY = 0;

        document.getElementById('priceChart').addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.getElementById('priceChart').addEventListener('touchmove', (e) => {
            if (!touchStartX || !touchStartY) return;

            const touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;

            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Horizontal swipe detection for period switching
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                const periods = ['1D', '7D', '30D'];
                const currentIndex = periods.indexOf(window.crudeTracker?.currentPeriod || '1D');
                
                let newIndex;
                if (diffX > 0) { // Swipe left - next period
                    newIndex = Math.min(currentIndex + 1, periods.length - 1);
                } else { // Swipe right - previous period
                    newIndex = Math.max(currentIndex - 1, 0);
                }
                
                if (newIndex !== currentIndex && window.crudeTracker) {
                    window.crudeTracker.selectTimePeriod(periods[newIndex]);
                }
                
                touchStartX = 0;
                touchStartY = 0;
            }
        }, { passive: true });

        // Keyboard navigation support
        document.addEventListener('keydown', (e) => {
            if (!window.crudeTracker) return;
            
            const periods = ['1D', '7D', '30D'];
            const currentIndex = periods.indexOf(window.crudeTracker.currentPeriod);
            
            switch(e.key) {
                case 'ArrowLeft':
                    if (currentIndex > 0) {
                        window.crudeTracker.selectTimePeriod(periods[currentIndex - 1]);
                    }
                    break;
                case 'ArrowRight':
                    if (currentIndex < periods.length - 1) {
                        window.crudeTracker.selectTimePeriod(periods[currentIndex + 1]);
                    }
                    break;
                case 'r':
                case 'R':
                    if (e.ctrlKey || e.metaKey) return; // Don't interfere with refresh
                    e.preventDefault();
                    window.crudeTracker.fetchPriceData();
                    break;
            }
        });

        // Prevent context menu on long press (mobile)
        document.addEventListener('contextmenu', (e) => {
            if (e.target.id === 'priceChart') {
                e.preventDefault();
            }
        });

        // Focus management for accessibility
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
        });

        document.addEventListener('mousedown', () => {
            document.body.classList.remove('keyboard-navigation');
        });

        // Print support
        window.addEventListener('beforeprint', () => {
            document.body.classList.add('print-mode');
        });

        window.addEventListener('afterprint', () => {
            document.body.classList.remove('print-mode');
        });
    </script>

    <style>
        /* Additional styles for enhanced functionality */
        
        /* Keyboard navigation styles */
        .keyboard-navigation .time-btn:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            .print-mode {
                background: white !important;
                color: black !important;
            }
            
            .print-mode .container {
                max-width: none !important;
                padding: 0 !important;
            }
            
            .print-mode .status-bar,
            .print-mode .time-selector {
                display: none !important;
            }
            
            .print-mode .price-card {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
            
            .print-mode #priceChart {
                max-height: 400px;
            }
        }

        /* Loading animation improvements */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s infinite;
        }

        /* Improved focus indicators */
        .time-btn:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* High DPI display optimizations */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            #priceChart {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        /* Dark mode support (if user prefers) */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            }
            
            .price-card, .chart-container {
                background: rgba(30, 41, 59, 0.9);
                color: #e2e8f0;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .oil-type {
                color: #94a3b8;
            }
            
            .current-price {
                color: #f1f5f9;
            }
            
            .chart-title {
                color: #f1f5f9;
            }
            
            .time-btn {
                color: #94a3b8;
            }
            
            .time-btn:hover:not(.active) {
                background: rgba(255, 255, 255, 0.1);
            }
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .loading::after {
                animation: none;
            }
            
            .loading {
                animation: none;
            }
            
            .price-card {
                transition: none;
            }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</body>
</html>
