<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>Crude Oil Price Tracker</title>
<meta name="description" content="Mobile-first crude oil pricing tracker for WTI and Brent. No keys. Single-file. GitHub Pages ready." />
<meta name="theme-color" content="#0b0f12" />
<style>
  :root{
    --bg:#0b0f12;--bg2:#11161b;--card:#121920;--ink:#e6eef5;--muted:#9fb0bf;
    --up:#19c37d;--down:#ff5a6e;--amber:#ffb020;--accent:#39a0ff;--grid:#1b232b;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --radius:14px;--radius-sm:10px;--pad:14px;--gap:12px;
    --tap:48px;--mono:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    --sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:var(--sans); color:var(--ink); background:linear-gradient(180deg,#0b0f12 0%, #0e1318 60%, #0b0f12 100%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:980px;margin:0 auto;padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-left)) max(20px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-right))}
  header{
    display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:12px
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:7px;background:radial-gradient(120% 120% at 20% 20%, #19324a 0%, #0d1b27 50%, #05080b 100%); box-shadow:inset 0 0 0 1px #233040, 0 10px 24px rgba(0,0,0,.45); position:relative}
  .logo::after{content:"";position:absolute;inset:5px;border-radius:5px;background:conic-gradient(from 210deg, #39a0ff, #19c37d, #ffb020, #39a0ff)}
  h1{font-size:16px;letter-spacing:.4px;margin:0;color:#eaf2f9}
  .meta{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
  @media (min-width:780px){.grid{grid-template-columns:1fr 1fr}}
  .card{
    background:linear-gradient(180deg,#0d141a 0%, #0b1116 100%);
    border-radius:var(--radius);
    border:1px solid #1b2733; box-shadow:var(--shadow);
    padding:var(--pad);
  }
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .ticker{display:flex;align-items:center;gap:10px}
  .chip{font-family:var(--mono); font-size:12px; padding:4px 8px; border-radius:8px; background:#0a1218; border:1px solid #1b2733; color:#a9c2d8}
  .price{font-size:28px;font-weight:700; letter-spacing:.2px}
  .chg{font-family:var(--mono);font-size:13px;padding:6px 8px;border-radius:9px;border:1px solid #1b2733;background:#0b1218}
  .chg.up{color:var(--up);border-color:#174233;background:#0c1a14}
  .chg.down{color:var(--down);border-color:#3b1a22;background:#190e11}
  .stamp{font-size:12px;color:var(--muted); margin-top:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  button, .btn{
    appearance:none; border:none; cursor:pointer; color:#dbe8f3; background:#0e151b; border:1px solid #243444;
    padding:10px 12px; border-radius:10px; min-height:var(--tap); font-size:14px; touch-action:manipulation
  }
  button[aria-pressed="true"]{outline:2px solid var(--accent); background:#0b1320}
  .split{display:grid; grid-template-columns:1fr; gap:var(--gap)}
  @media (min-width:560px){.split{grid-template-columns:1fr 1fr}}
  canvas{width:100%; height:220px; display:block; border-radius:12px; background:linear-gradient(180deg,#0a1217,#0a1114); border:1px solid #1b2733}
  .alertBox{display:grid;gap:10px}
  .input{
    display:flex;gap:8px; align-items:center; background:#0e151b; border:1px solid #243444; border-radius:10px; padding:8px 10px
  }
  .input input{
    flex:1; min-height:var(--tap); border:none; outline:none; background:transparent; color:#e6eef5; font-size:16px; font-family:var(--mono)
  }
  .status{display:flex;gap:10px; align-items:center; flex-wrap:wrap}
  .badge{padding:6px 8px; border-radius:9px; font-size:12px; border:1px solid #1b2733; background:#0b1218; color:#a9c2d8}
  .badge.live{border-color:#21462c; color:#b9f3d6; background:#0f1b14}
  .badge.closed{border-color:#3b2a1a; color:#ffd9a3; background:#1a140d}
  .err{color:#ffd3da}
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
  /* micro-reduced motion support */
  @media (prefers-reduced-motion:no-preference){
    .card{transition:transform .2s ease, border-color .2s ease}
    .card:focus-within, .card:hover{transform:translateY(-1px); border-color:#2a3c4e}
  }
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Crude Oil Price Tracker">
  <header aria-label="Header">
    <div class="brand">
      <div aria-hidden="true" class="logo"></div>
      <div>
        <h1>Crude Oil Price Tracker</h1>
        <div class="meta" id="meta">No keys • Single-file • Offline-capable</div>
      </div>
    </div>
    <div class="status" aria-live="polite">
      <span class="badge" id="marketBadge">Market: —</span>
      <span class="badge" id="pollBadge" title="Auto-refresh cadence">Refresh: 15m</span>
    </div>
  </header>

  <main class="grid">
    <!-- DASHBOARD -->
    <section class="card" aria-labelledby="dashTitle">
      <h2 id="dashTitle" class="sr-only">Price Dashboard</h2>
      <div class="split" role="region" aria-label="Spot prices">
        <div class="panel" id="panel-wti" aria-label="WTI panel">
          <div class="row">
            <div class="ticker">
              <span class="chip" aria-label="Symbol">WTI</span>
              <span class="chip" title="Yahoo symbol">CL=F</span>
            </div>
            <div class="row" style="gap:8px">
              <span class="price" id="wtiPrice">—</span>
              <span class="chg" id="wtiChg">—</span>
            </div>
          </div>
          <div class="stamp" id="wtiStamp">Awaiting data…</div>
          <div class="controls" role="group" aria-label="WTI ranges">
            <button class="rangeBtn" data-series="wti" data-range="1d" aria-pressed="false">1D</button>
            <button class="rangeBtn" data-series="wti" data-range="7d" aria-pressed="false">7D</button>
            <button class="rangeBtn" data-series="wti" data-range="30d" aria-pressed="true">30D</button>
            <button class="rangeBtn" data-series="wti" data-range="all" aria-pressed="false">All</button>
          </div>
          <canvas id="wtiChart" aria-label="WTI chart" role="img"></canvas>
        </div>

        <div class="panel" id="panel-brent" aria-label="Brent panel">
          <div class="row">
            <div class="ticker">
              <span class="chip">BRENT</span>
              <span class="chip" title="Yahoo symbol">BZ=F</span>
            </div>
            <div class="row" style="gap:8px">
              <span class="price" id="brentPrice">—</span>
              <span class="chg" id="brentChg">—</span>
            </div>
          </div>
          <div class="stamp" id="brentStamp">Awaiting data…</div>
          <div class="controls" role="group" aria-label="Brent ranges">
            <button class="rangeBtn" data-series="brent" data-range="1d" aria-pressed="false">1D</button>
            <button class="rangeBtn" data-series="brent" data-range="7d" aria-pressed="false">7D</button>
            <button class="rangeBtn" data-series="brent" data-range="30d" aria-pressed="true">30D</button>
            <button class="rangeBtn" data-series="brent" data-range="all" aria-pressed="false">All</button>
          </div>
          <canvas id="brentChart" aria-label="Brent chart" role="img"></canvas>
        </div>
      </div>
    </section>

    <!-- ALERTS -->
    <section class="card" aria-labelledby="alertTitle">
      <h2 id="alertTitle" class="sr-only">Alerts & Notifications</h2>
      <div class="alertBox">
        <div class="row">
          <div class="badge" id="notifyStatus" aria-live="polite">Notifications: Off</div>
          <button id="enableNotify">Enable Notifications</button>
        </div>
        <div class="input" aria-label="WTI alert">
          <label for="wtiAlert" class="sr-only">WTI alert threshold</label>
          <input id="wtiAlert" type="number" step="0.01" placeholder="WTI alert @ price (e.g., 70)" inputmode="decimal" />
          <button id="saveWtiAlert">Save WTI Alert</button>
        </div>
        <div class="input" aria-label="Brent alert">
          <label for="brentAlert" class="sr-only">Brent alert threshold</label>
          <input id="brentAlert" type="number" step="0.01" placeholder="Brent alert @ price (e.g., 75)" inputmode="decimal" />
          <button id="saveBrentAlert">Save Brent Alert</button>
        </div>
        <div class="stamp" id="alertInfo">Set one-time price alerts. Alerts fire when the last price equals or crosses your threshold.</div>
      </div>
    </section>

    <!-- SYSTEM -->
    <section class="card" aria-labelledby="sysTitle">
      <h2 id="sysTitle" class="sr-only">System</h2>
      <div class="row" style="align-items:flex-start">
        <div>
          <div class="badge" id="sourceBadge" title="Active data source">Source: Auto</div>
          <div class="badge" id="cacheBadge" title="Cache state">Cache: —</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="refreshBtn" title="Force refresh">Refresh Now</button>
          <button id="purgeCacheBtn" title="Clear local cache">Clear Cache</button>
        </div>
      </div>
      <div class="stamp" id="sysMsg" aria-live="polite"></div>
      <div class="stamp err" id="errMsg" role="status" aria-live="assertive"></div>
    </section>
  </main>
</div>

<script>
/* ============
   CONFIG
=========== */
const SYMS = { wti: 'CL=F', brent: 'BZ=F' };
const LSKEY = 'crude_oil_tracker_v1';
const POLL_MINUTES = 15;
const TZ = 'America/Chicago';

/* ============
   UTIL
=========== */
const $ = sel => document.querySelector(sel);
const fmt = new Intl.NumberFormat(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
const fmtPct = new Intl.NumberFormat(undefined,{style:'percent', minimumFractionDigits:2, maximumFractionDigits:2});
const toCT = d => new Date(d.toLocaleString('en-US',{timeZone:TZ}));
const nowCT = () => toCT(new Date());
const isoLocal = (d) => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().replace('T',' ').slice(0,19);

function isMarketOpenCT(dateCT=nowCT()){
  const d = new Date(dateCT);
  const day = d.getDay(); // 0 Sun ... 6 Sat
  // CME Globex for NYMEX energy futures: Sun-Fri 5:00 PM–4:00 PM CT, daily maintenance 4:00–5:00 PM CT
  if (day===6) return false; // Saturday closed
  // Sunday special-case: before 5pm open, after 5pm open running into Monday
  const h = d.getHours(), m = d.getMinutes();
  const t = h*60+m;
  const openStart = 17*60; // 5:00 PM
  const maintStart = 16*60; // 4:00 PM
  if (day===0){ // Sunday
    return t>=openStart; // 5pm–midnight open
  }
  // Mon–Fri: open all day except maintenance 4–5pm
  if (t>=maintStart && t<openStart) return false; // 4–5pm maintenance
  return true;
}

function setBadge(id, text, cls){
  const el = $(id);
  el.textContent = text;
  el.classList.remove('live','closed');
  if (cls) el.classList.add(cls);
}

function saveCache(state){
  try{
    localStorage.setItem(LSKEY, JSON.stringify(state));
    $('#cacheBadge').textContent = 'Cache: Saved';
  }catch(e){ $('#cacheBadge').textContent = 'Cache: Failed'; }
}
function loadCache(){
  try{
    const raw = localStorage.getItem(LSKEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}

/* ============
   DATA SOURCES (multi-fallback, no keys)
   Order:
   1) Direct Yahoo Finance chart API (CORS usually ok)
   2) Yahoo via r.jina.ai CORS cache proxy (static GET)
   3) Stooq CSV via r.jina.ai (daily)
=========== */
async function fetchYahooChart(symbol, range='1mo', interval='1h', viaProxy=false){
  const base = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}`;
  const url = viaProxy ? `https://r.jina.ai/http://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}` : base;
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  const json = await res.json();
  const r = json?.chart?.result?.[0];
  if(!r || !r.timestamp || !r.indicators?.quote?.[0]?.close) throw new Error('Malformed Yahoo response');
  const tzOff = (r.meta.gmtoffset ?? 0) * 1000;
  const points = r.timestamp.map((ts,i)=>({ t: new Date((ts*1000) + tzOff), v: r.indicators.quote[0].close[i] })).filter(p=>Number.isFinite(p.v));
  const last = points[points.length-1]?.v ?? NaN;
  const prev = points[points.length-2]?.v ?? NaN;
  return { points, last, prev, source: viaProxy?'Yahoo (proxy)':'Yahoo' };
}

async function fetchStooqCSV(symbol){ // symbol like CL=F -> cl.f ; BZ=F -> brn.f
  const map = { 'CL=F':'cl.f', 'BZ=F':'brn.f' };
  const code = map[symbol] || symbol.toLowerCase();
  const url = `https://r.jina.ai/http://stooq.com/q/d/l/?s=${encodeURIComponent(code)}&i=d`;
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text = await res.text();
  const lines = text.trim().split('\n').slice(1);
  const points = lines.map(line=>{
    const [date, open, high, low, close] = line.split(',');
    return { t: new Date(date+'T20:00:00Z'), v: parseFloat(close) };
  }).filter(p=>Number.isFinite(p.v));
  const last = points[points.length-1]?.v ?? NaN;
  const prev = points[points.length-2]?.v ?? NaN;
  return { points, last, prev, source:'Stooq (proxy)' };
}

async function getSeries(symbol){
  // Prefer intraday for 30d/1h from Yahoo; fall back in order
  try{ return await fetchYahooChart(symbol,'1mo','1h',false); }
  catch(e1){
    try{ return await fetchYahooChart(symbol,'1mo','1h',true); }
    catch(e2){
      return await fetchStooqCSV(symbol);
    }
  }
}

/* ============
   RENDER: Minimal canvas chart with pan/zoom + range filters
=========== */
class MiniChart{
  constructor(canvas){
    this.c = canvas; this.ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
    this.data = []; this.viewStart = 0; this.viewEnd = 1; // [0..1] relative
    this.padding = { l:40, r:10, t:8, b:22 };
    this._bind();
    this._resize();
  }
  setData(points){
    this.data = points;
    this.viewStart = Math.max(0, 1 - 30/Math.max(30, points.length)); // default to ~last 30 points
    this.viewEnd = 1;
    this.draw();
  }
  setRange(days){
    if(!this.data.length){ this.draw(); return; }
    if(days==='all'){ this.viewStart = 0; this.viewEnd = 1; }
    else{
      const ms = { '1d': 24*3600e3, '7d': 7*24*3600e3, '30d': 30*24*3600e3 }[days] || 30*24*3600e3;
      const lastT = this.data[this.data.length-1].t.getTime();
      const startT = lastT - ms;
      const idx = this.data.findIndex(p=>p.t.getTime()>=startT);
      this.viewStart = Math.max(0, (idx<=0?0:idx)/this.data.length);
      this.viewEnd = 1;
    }
    this.draw();
  }
  _bind(){
    window.addEventListener('resize', ()=>this._resize(), { passive:true });
    let dragging=false, lastX=0, pinchDist0=0, viewSpan0=0;
    const onPointerDown = (e)=>{ dragging=true; lastX=e.clientX; this.c.setPointerCapture(e.pointerId); };
    const onPointerMove = (e)=>{
      if(e.pointerType==='touch' && e.isPrimary===false){
        // naive pinch support using two touches from TouchEvent API (fallback)
        // browsers fire PointerEvents per finger; we implement wheel zoom instead for simplicity
        return;
      }
      if(dragging){
        const dx = (e.clientX - lastX) / this.c.clientWidth;
        const span = this.viewEnd - this.viewStart;
        this.viewStart = Math.max(0, Math.min(1-span, this.viewStart - dx));
        this.viewEnd = this.viewStart + span;
        lastX = e.clientX;
        this.draw();
      }
    };
    const onPointerUp = (e)=>{ dragging=false; try{ this.c.releasePointerCapture(e.pointerId);}catch{} };
    const onWheel = (e)=>{
      e.preventDefault();
      const rect = this.c.getBoundingClientRect();
      const x = (e.clientX-rect.left)/rect.width;
      const zoom = Math.exp(-e.deltaY*0.0015);
      const span = this.viewEnd - this.viewStart;
      let newSpan = span/zoom;
      newSpan = Math.max(0.02, Math.min(1, newSpan));
      const center = this.viewStart + span*x;
      this.viewStart = Math.max(0, Math.min(1-newSpan, center - newSpan*x));
      this.viewEnd = this.viewStart + newSpan;
      this.draw();
    };
    this.c.addEventListener('pointerdown', onPointerDown);
    this.c.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);
    this.c.addEventListener('wheel', onWheel, { passive:false });
  }
  _resize(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const w = this.c.clientWidth, h = this.c.clientHeight;
    this.c.width = Math.floor(w*dpr); this.c.height = Math.floor(h*dpr);
    this.ctx.setTransform(dpr,0,0,dpr,0,0);
    this.draw();
  }
  draw(){
    const ctx = this.ctx, {width:w, height:h} = this.c;
    const W = this.c.clientWidth, H = this.c.clientHeight;
    ctx.clearRect(0,0,W,H);
    // background grid
    ctx.fillStyle = '#0a1116'; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle = '#1b2733'; ctx.lineWidth = 1;
    for(let i=0;i<6;i++){ const y = this.padding.t + (H-this.padding.t-this.padding.b)*i/5; ctx.beginPath(); ctx.moveTo(this.padding.l,y+.5); ctx.lineTo(W-this.padding.r,y+.5); ctx.stroke(); }
    const data = this.data;
    if(!data || data.length<2){
      ctx.fillStyle = '#9fb0bf'; ctx.fillText('No data', this.padding.l+10, H/2); return;
    }
    const a = Math.floor(this.viewStart * data.length);
    const b = Math.max(a+1, Math.floor(this.viewEnd * data.length));
    const segment = data.slice(a,b);
    const min = segment.reduce((m,p)=>Math.min(m,p.v), +Infinity);
    const max = segment.reduce((m,p)=>Math.max(m,p.v), -Infinity);
    const xScale = (t,i)=> this.padding.l + (W-this.padding.l-this.padding.r) * (i/(segment.length-1));
    const yScale = v => this.padding.t + (H-this.padding.t-this.padding.b) * (1 - ((v-min)/(max-min||1)));
    // axis labels
    ctx.fillStyle = '#9fb0bf'; ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.textAlign='right'; ctx.textBaseline='middle';
    for(let i=0;i<=5;i++){ const val = min + (max-min)*i/5; const y=yScale(val); ctx.fillText(val.toFixed(2), this.padding.l-6, y); }
    // line
    ctx.lineWidth = 2.0; ctx.strokeStyle = '#39a0ff';
    ctx.beginPath();
    segment.forEach((p,i)=>{ const x=xScale(p.t,i), y=yScale(p.v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.stroke();
    // last point dot
    const last = segment[segment.length-1]; const lx=xScale(last.t,segment.length-1), ly=yScale(last.v);
    ctx.fillStyle = '#e6eef5'; ctx.beginPath(); ctx.arc(lx,ly,3,0,Math.PI*2); ctx.fill();
  }
}

/* ============
   STATE
=========== */
const state = {
  wti: { series: [], last:null, prev:null, range:'30d', chart:null, src:'—', stamp:null },
  brent: { series: [], last:null, prev:null, range:'30d', chart:null, src:'—', stamp:null },
  lastFetch: null, marketOpen: null
};

/* ============
   UI HOOKUP
=========== */
function setChange(el, last, prev){
  if(!Number.isFinite(last) || !Number.isFinite(prev)){ el.textContent = '—'; el.className='chg'; return; }
  const chg = last - prev; const pct = prev ? chg/prev : 0;
  el.textContent = `${chg>=0?'+':''}${fmt.format(chg)} (${fmtPct.format(pct)})`;
  el.className = 'chg ' + (chg>=0?'up':'down');
}
function updateDashboard(){
  $('#wtiPrice').textContent   = Number.isFinite(state.wti.last) ? fmt.format(state.wti.last) : '—';
  $('#brentPrice').textContent = Number.isFinite(state.brent.last) ? fmt.format(state.brent.last) : '—';
  setChange($('#wtiChg'), state.wti.last, state.wti.prev);
  setChange($('#brentChg'), state.brent.last, state.brent.prev);
  $('#wtiStamp').textContent = state.wti.stamp ? `Last update: ${state.wti.stamp}` : '—';
  $('#brentStamp').textContent = state.brent.stamp ? `Last update: ${state.brent.stamp}` : '—';
  $('#sourceBadge').textContent = `Source: ${state.wti.src === state.brent.src ? state.wti.src : 'Mixed'}`;
}
function setRangeButtons(series, range){
  document.querySelectorAll(`.rangeBtn[data-series="${series}"]`).forEach(btn=>{
    btn.setAttribute('aria-pressed', btn.dataset.range===range ? 'true':'false');
  });
}

async function refreshAll({force=false}={}){
  $('#errMsg').textContent = '';
  const open = isMarketOpenCT();
  state.marketOpen = open;
  setBadge('#marketBadge', open?'Market: Open':'Market: Closed', open?'live':'closed');

  const t0 = performance.now();
  try{
    const [wti, brent] = await Promise.all([ getSeries(SYMS.wti), getSeries(SYMS.brent) ]);
    const ts = isoLocal(nowCT());
    Object.assign(state.wti, { series:wti.points, last:wti.last, prev:wti.prev, src:wti.source, stamp:ts });
    Object.assign(state.brent, { series:brent.points, last:brent.last, prev:brent.prev, src:brent.source, stamp:ts });
    // charts
    if(!state.wti.chart){ state.wti.chart = new MiniChart($('#wtiChart')); }
    if(!state.brent.chart){ state.brent.chart = new MiniChart($('#brentChart')); }
    state.wti.chart.setData(state.wti.series);
    state.brent.chart.setData(state.brent.series);
    state.wti.chart.setRange(state.wti.range);
    state.brent.chart.setRange(state.brent.range);
    updateDashboard();
    state.lastFetch = Date.now();
    saveCache({ meta:{ ts:state.lastFetch }, wti:state.wti, brent:state.brent });
    checkAlerts();
    $('#sysMsg').textContent = `Fetched in ${Math.round(performance.now()-t0)} ms`;
  }catch(err){
    $('#errMsg').textContent = 'Data fetch failed. Using cache if available.';
    const cached = loadCache();
    if(cached){
      Object.assign(state.wti, cached.wti);
      Object.assign(state.brent, cached.brent);
      if(!state.wti.chart) state.wti.chart = new MiniChart($('#wtiChart'));
      if(!state.brent.chart) state.brent.chart = new MiniChart($('#brentChart'));
      state.wti.chart.setData(state.wti.series||[]);
      state.brent.chart.setData(state.brent.series||[]);
      state.wti.chart.setRange(state.wti.range);
      state.brent.chart.setRange(state.brent.range);
      updateDashboard();
      $('#sysMsg').textContent = 'Loaded from cache';
    }else{
      $('#sysMsg').textContent = 'No cache available';
    }
  }
}

/* ============
   RANGES + CONTROLS
=========== */
document.querySelectorAll('.rangeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const k = btn.dataset.series;
    const rng = btn.dataset.range;
    state[k].range = rng;
    setRangeButtons(k, rng);
    if(state[k].chart) state[k].chart.setRange(rng);
  });
});

$('#refreshBtn').addEventListener('click', ()=>refreshAll({force:true}));
$('#purgeCacheBtn').addEventListener('click', ()=>{
  localStorage.removeItem(LSKEY);
  $('#cacheBadge').textContent='Cache: Cleared';
});

/* ============
   POLLER (15m during market, 60m otherwise)
=========== */
function schedulePoller(){
  const open = isMarketOpenCT();
  const mins = open ? POLL_MINUTES : 60;
  setTimeout(async ()=>{
    await refreshAll();
    schedulePoller();
  }, mins*60*1000);
}

/* ============
   NOTIFICATIONS & ALERTS
=========== */
let swReg = null;
async function ensureSW(){
  if(!('serviceWorker' in navigator)) return null;
  if(swReg) return swReg;
  // Inline service worker via Blob (keeps repo single-file)
  const swCode = `
    self.addEventListener('install', e=>{
      e.waitUntil((async()=>{ const cache = await caches.open('cot-v1'); await cache.addAll(['./']); })());
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{ self.clients.claim(); });
    self.addEventListener('fetch', e=>{
      const url = new URL(e.request.url);
      if(e.request.method!=='GET') return;
      e.respondWith((async()=>{
        const cache = await caches.open('cot-v1');
        const cached = await cache.match(e.request);
        try{
          const net = await fetch(e.request);
          cache.put(e.request, net.clone()).catch(()=>{});
          return net;
        }catch(err){
          if(cached) return cached;
          throw err;
        }
      })());
    });
    self.addEventListener('notificationclick', e=>{
      e.notification.close();
      e.waitUntil(self.clients.matchAll({type:'window'}).then(clients=>{
        if(clients.length) clients[0].focus();
        else self.clients.openWindow('./');
      }));
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const url = URL.createObjectURL(blob);
  try{ swReg = await navigator.serviceWorker.register(url, { scope:'./' }); }catch{}
  return swReg;
}

function getAlerts(){
  try{
    const raw = localStorage.getItem(LSKEY+'_alerts'); return raw?JSON.parse(raw):{ wti:null, brent:null };
  }catch{ return { wti:null, brent:null }; }
}
function setAlerts(a){
  localStorage.setItem(LSKEY+'_alerts', JSON.stringify(a));
  $('#alertInfo').textContent = `WTI alert: ${a.wti??'—'} • Brent alert: ${a.brent??'—'}`;
}
function checkAlerts(){
  const a = getAlerts();
  const hits = [];
  if(a.wti!=null && Number.isFinite(state.wti.last) && ((state.wti.prev<=a.wti && state.wti.last>=a.wti) || (state.wti.prev>=a.wti && state.wti.last<=a.wti))) hits.push({k:'WTI', at:a.wti, px:state.wti.last});
  if(a.brent!=null && Number.isFinite(state.brent.last) && ((state.brent.prev<=a.brent && state.brent.last>=a.brent) || (state.brent.prev>=a.brent && state.brent.last<=a.brent))) hits.push({k:'Brent', at:a.brent, px:state.brent.last});
  if(!hits.length) return;
  notify(`${hits.map(h=>`${h.k} hit ${fmt.format(h.at)} (last ${fmt.format(h.px)})`).join(' • ')}`);
  // one-shot alerts: clear after firing
  const next = getAlerts();
  hits.forEach(h=>{ if(h.k==='WTI') next.wti=null; if(h.k==='Brent') next.brent=null; });
  setAlerts(next);
}

async function notify(msg){
  try{
    const reg = await ensureSW();
    if(!('Notification' in window)) return;
    if(Notification.permission!=='granted'){
      const perm = await Notification.requestPermission();
      if(perm!=='granted'){ $('#notifyStatus').textContent='Notifications: Denied'; return; }
    }
    $('#notifyStatus').textContent='Notifications: On';
    if(reg?.showNotification){
      reg.showNotification('Crude Oil Alert', { body: msg, icon: undefined, badge: undefined });
    }else{
      new Notification('Crude Oil Alert', { body: msg });
    }
  }catch{}
}

$('#enableNotify').addEventListener('click', ()=>notify('Notifications enabled. You will receive price alerts when thresholds are met.'));

$('#saveWtiAlert').addEventListener('click', ()=>{
  const v = parseFloat($('#wtiAlert').value);
  const a = getAlerts(); a.wti = Number.isFinite(v) ? v : null; setAlerts(a);
});
$('#saveBrentAlert').addEventListener('click', ()=>{
  const v = parseFloat($('#brentAlert').value);
  const a = getAlerts(); a.brent = Number.isFinite(v) ? v : null; setAlerts(a);
});

/* ============
   DAILY SUMMARY (on first load each day)
=========== */
function dailySummary(){
  const key = LSKEY+'_summary_date';
  const today = nowCT().toISOString().slice(0,10);
  const last = localStorage.getItem(key);
  if(last===today) return;
  localStorage.setItem(key, today);
  if(Number.isFinite(state.wti.last) && Number.isFinite(state.brent.last)){
    notify(`Daily Summary — WTI ${fmt.format(state.wti.last)} (${($('#wtiChg').textContent)}) • Brent ${fmt.format(state.brent.last)} (${($('#brentChg').textContent)})`);
  }
}

/* ============
   STARTUP
=========== */
(async function init(){
  // Restore cached immediately for instant paint
  const cached = loadCache();
  if(cached){
    Object.assign(state.wti, cached.wti);
    Object.assign(state.brent, cached.brent);
    if(state.wti.series?.length){
      state.wti.chart = new MiniChart($('#wtiChart')); state.wti.chart.setData(state.wti.series); state.wti.chart.setRange(state.wti.range||'30d');
    }
    if(state.brent.series?.length){
      state.brent.chart = new MiniChart($('#brentChart')); state.brent.chart.setData(state.brent.series); state.brent.chart.setRange(state.brent.range||'30d');
    }
    updateDashboard();
    $('#cacheBadge').textContent='Cache: Warm';
    $('#sysMsg').textContent='Boot from cache; syncing…';
  }else{
    $('#cacheBadge').textContent='Cache: Empty';
  }
  setBadge('#marketBadge', isMarketOpenCT()?'Market: Open':'Market: Closed', isMarketOpenCT()?'live':'closed');
  setAlerts(getAlerts());
  await ensureSW();
  await refreshAll();
  schedulePoller();
  dailySummary();
})();
</script>
</body>
</html>