<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CFB 2025 Dark Dashboard</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0f14;
      --panel: #10161b;
      --panel-elevated: #121c23;
      --text: #e6edf3;
      --muted: #93a1a1;
      --accent: #4cc2ff;
      --accent-soft: rgba(76, 194, 255, 0.16);
      --ok: #3bd671;
      --warn: #f5c451;
      --err: #ff6b6b;
      --border: #1f2a33;
      --shadow: 0 16px 32px rgba(0, 0, 0, 0.35);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --nav-height: 64px;
      --bottom-height: 62px;
      --touch-target: 48px;
      --font: "SF Pro Text", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --transition-fast: 150ms;
    }

    @media (prefers-reduced-motion: reduce) {
      :root {
        --transition-fast: 0ms;
      }
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
    }

    body {
      display: flex;
      justify-content: center;
    }

    #app {
      position: relative;
      width: 100%;
      max-width: 900px;
      min-height: 100vh;
      background: linear-gradient(160deg, rgba(16, 22, 27, 0.94), rgba(10, 14, 18, 0.97));
      display: flex;
      flex-direction: column;
      padding-top: calc(var(--nav-height) + env(safe-area-inset-top, 0px));
      padding-bottom: calc(var(--bottom-height) + env(safe-area-inset-bottom, 0px));
      overflow: hidden;
    }

    .topbar {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 900px;
      height: calc(var(--nav-height) + env(safe-area-inset-top, 0px));
      padding: env(safe-area-inset-top, 0px) 16px 8px 16px;
      background: rgba(16, 22, 27, 0.92);
      backdrop-filter: blur(16px);
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 8px;
      z-index: 20;
      border-bottom: 1px solid rgba(31, 42, 51, 0.6);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand svg {
      width: 40px;
      height: 40px;
      background: var(--accent-soft);
      border-radius: 12px;
      padding: 8px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .brand-text span {
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.01em;
    }

    .brand-text small {
      color: var(--muted);
      font-size: 11px;
      font-weight: 500;
    }

    .topnav {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-left: auto;
    }

    .nav-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      position: relative;
      min-width: 68px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .nav-btn.active {
      color: var(--text);
    }

    .nav-btn.active::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 4px;
      height: 3px;
      background: var(--accent);
      border-radius: 999px;
      box-shadow: 0 0 12px rgba(76, 194, 255, 0.45);
    }

    .nav-btn:focus-visible, .icon-button:focus-visible, .chip:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .icon-button {
      appearance: none;
      border: none;
      background: rgba(76, 194, 255, 0.08);
      color: var(--text);
      padding: 10px;
      border-radius: 12px;
      width: var(--touch-target);
      height: var(--touch-target);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-button svg {
      width: 22px;
      height: 22px;
    }

    main#view {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding: 12px 16px;
      overflow: hidden;
    }

    .view-scroll {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 24px;
    }

    .view-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .view-scroll::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 2px;
    }

    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 16px;
    }

    .section-header h2 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .section-header span {
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(76, 194, 255, 0.15);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .pill.warn {
      background: rgba(245, 196, 81, 0.18);
      color: var(--warn);
    }

    .pill.ok {
      background: rgba(59, 214, 113, 0.18);
      color: var(--ok);
    }

    .scores-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 12px;
    }

    .scores-scroll {
      position: relative;
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      padding-bottom: 16px;
    }

    .virtual-region {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
    }

    .game-card {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: var(--shadow);
      padding: 16px;
      margin: 0 0 12px 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      transition: transform var(--transition-fast) ease, border-color var(--transition-fast) ease;
    }

    .game-card.live {
      border-color: rgba(76, 194, 255, 0.45);
    }

    .game-card:active {
      transform: scale(0.99);
    }

    .game-header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .team-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 6px 0;
    }

    .team-row + .team-row {
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .team-logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .team-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      mix-blend-mode: screen;
    }

    .team-logo svg {
      width: 42px;
      height: 42px;
    }

    .team-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .team-name {
      font-weight: 600;
      font-size: 15px;
    }

    .team-conf {
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.04em;
    }

    .team-score {
      font-size: 20px;
      font-weight: 700;
    }

    .team-rank {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      margin-right: 6px;
    }

    .game-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .meta-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
    }

    .meta-item svg {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      background: rgba(76, 194, 255, 0.12);
      border-radius: 999px;
      padding: 4px 10px;
    }

    .game-expanded {
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding-top: 12px;
      display: grid;
      gap: 10px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .stat-card {
      background: var(--panel-elevated);
      border-radius: var(--radius-md);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-card span.label {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .stat-card strong {
      font-size: 16px;
      font-weight: 700;
    }

    .scoring-list {
      display: grid;
      gap: 6px;
    }

    .scoring-item {
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-md);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .chip {
      appearance: none;
      border: none;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.06em;
      min-width: 64px;
    }

    .chip[aria-checked="true"] {
      background: rgba(76, 194, 255, 0.16);
      color: var(--accent);
    }

    .week-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 900px;
      height: calc(var(--bottom-height) + env(safe-area-inset-bottom, 0px));
      padding: 8px 16px calc(8px + env(safe-area-inset-bottom, 0px));
      background: rgba(12, 18, 24, 0.96);
      backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 15;
    }

    .week-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .week-controls button {
      appearance: none;
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      width: var(--touch-target);
      height: var(--touch-target);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .week-controls span {
      font-size: 16px;
      font-weight: 700;
      min-width: 90px;
      text-align: center;
    }

    .week-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .empty-state {
      margin: auto;
      text-align: center;
      max-width: 320px;
      padding: 24px;
      background: rgba(16, 22, 27, 0.92);
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(255, 255, 255, 0.08);
      display: grid;
      gap: 12px;
    }

    .empty-state svg {
      width: 56px;
      height: 56px;
      justify-self: center;
    }

    .empty-state h3 {
      margin: 0;
      font-size: 18px;
    }

    .empty-state p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .toast-container {
      position: fixed;
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      max-width: 320px;
      width: calc(100% - 48px);
      z-index: 40;
      display: grid;
      gap: 8px;
    }

    .toast {
      background: rgba(12, 18, 24, 0.96);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 12px 14px;
      display: grid;
      gap: 4px;
      font-size: 13px;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.45);
      animation: toast-in var(--transition-fast) ease;
    }

    .toast.error {
      border-color: rgba(255, 107, 107, 0.4);
      color: var(--err);
    }

    .toast.warn {
      border-color: rgba(245, 196, 81, 0.4);
      color: var(--warn);
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translate(-50%, 20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    .settings-view {
      display: grid;
      gap: 16px;
    }

    .settings-group {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .settings-group h3 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.02em;
    }

    .form-row {
      display: grid;
      gap: 6px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    input, select, textarea {
      appearance: none;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px;
      color: var(--text);
      font-size: 15px;
      font-family: var(--font);
    }

    input:focus-visible, select:focus-visible, textarea:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      background: rgba(76, 194, 255, 0.18);
      color: var(--accent);
    }

    .btn.secondary {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.08);
    }

    .leaderboard {
      display: grid;
      gap: 12px;
    }

    .leader-card {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .leader-card h4 {
      margin: 0;
      font-size: 15px;
      letter-spacing: 0.02em;
    }

    .leader-rows {
      display: grid;
      gap: 8px;
    }

    .leader-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
    }

    .search-view {
      display: grid;
      gap: 12px;
    }

    .search-results {
      display: grid;
      gap: 10px;
    }

    .result-card {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .result-card span {
      font-size: 14px;
      font-weight: 600;
    }

    .team-index {
      display: grid;
      gap: 10px;
    }

    .team-card {
      background: var(--panel);
      border-radius: var(--radius-lg);
      padding: 12px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .team-card small {
      color: var(--muted);
      font-size: 12px;
    }

    .team-detail {
      display: grid;
      gap: 16px;
    }

    .team-detail h2 {
      margin: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .team-detail .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .team-schedule {
      display: grid;
      gap: 8px;
    }

    .schedule-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
      padding: 8px 10px;
      font-size: 12px;
    }

    .compare-tool {
      background: var(--panel);
      border-radius: var(--radius-lg);
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: grid;
      gap: 12px;
    }

    .compare-grid {
      display: grid;
      gap: 10px;
    }

    .sparkline {
      width: 100%;
      height: 60px;
    }

    .skeleton {
      position: relative;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.06);
    }

    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.12), transparent);
      animation: shimmer 1.2s infinite;
    }

    @keyframes shimmer {
      100% {
        transform: translateX(100%);
      }
    }

    .diagnostics {
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .log-table {
      max-height: 180px;
      overflow-y: auto;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      padding: 8px;
      display: grid;
      gap: 6px;
    }

    .log-entry {
      display: grid;
      gap: 2px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding-bottom: 6px;
    }

    .log-entry:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .key-overlay {
      position: absolute;
      inset: 0;
      background: rgba(11, 15, 20, 0.94);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 30;
    }

    .key-overlay.active {
      display: flex;
    }

    @media (max-width: 640px) {
      .brand-text span {
        font-size: 13px;
      }
      .topnav {
        gap: 2px;
      }
      .nav-btn {
        padding: 8px 10px;
        min-width: auto;
        font-size: 12px;
      }
      .week-controls span {
        min-width: 70px;
      }
      .team-row {
        grid-template-columns: auto 1fr auto;
      }
    }
  </style>
</head>
<body>
  <svg aria-hidden="true" style="position:absolute; width:0; height:0; overflow:hidden;">
    <symbol id="icon-football" viewBox="0 0 24 24">
      <path fill="currentColor" d="M3.5 12C3.5 7.86 7.86 3.5 12 3.5s8.5 4.36 8.5 8.5-4.36 8.5-8.5 8.5S3.5 16.14 3.5 12Zm6.8-4.2-1.3 1.3 2 2-2 2 1.3 1.3 2-2 2 2 1.3-1.3-2-2 2-2-1.3-1.3-2 2-2-2Z"/>
    </symbol>
    <symbol id="icon-clock" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Zm-.75-15v5.25l4.25 2.55.75-1.22-3.5-2.08V7h-1.5Z"/>
    </symbol>
    <symbol id="icon-tv" viewBox="0 0 24 24">
      <path fill="currentColor" d="M4 5h16a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-5l1.5 2h-7L11 18H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Zm0 2v9h16V7H4Z"/>
    </symbol>
    <symbol id="icon-venue" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 2 3 7v2h18V7l-9-5Zm0 2.18L17.74 7H6.26L12 4.18ZM4 11h16v9H4v-9Zm2 2v5h12v-5H6Z"/>
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <path fill="currentColor" d="m19.14 12.94.86-.94-.86-.94 1.26-2.2-1.64-1.64-2.2 1.26-.94-.86-.94.86-2.2-1.26-1.64 1.64 1.26 2.2-.86.94.86.94-1.26 2.2 1.64 1.64 2.2-1.26.94.86.94-.86 2.2 1.26 1.64-1.64-1.26-2.2Z"/>
    </symbol>
    <symbol id="icon-chevron-left" viewBox="0 0 24 24">
      <path fill="currentColor" d="m15.41 7.41-1.41-1.41L8.59 11l5.41 5.41 1.41-1.41L11.41 11l4-3.59Z"/>
    </symbol>
    <symbol id="icon-chevron-right" viewBox="0 0 24 24">
      <path fill="currentColor" d="m8.59 16.59 1.41 1.41L15.41 13 10 7.59 8.59 9l4 4-4 3.59Z"/>
    </symbol>
    <symbol id="icon-weather" viewBox="0 0 24 24">
      <path fill="currentColor" d="M6 13a4 4 0 1 1 3.87-5h.13a5 5 0 1 1 4.9 6h-8.9Zm2.78-2H15a3 3 0 1 0-1.2-5.78l-.83.34-.3-.86A3 3 0 1 0 8 11h.78ZM7 16h10l-2 6h-6l-2-6Z"/>
    </symbol>
    <symbol id="icon-link" viewBox="0 0 24 24">
      <path fill="currentColor" d="M10.59 13.41a1 1 0 0 0 1.41 1.41l4.24-4.24a3 3 0 0 0-4.24-4.24l-1.18 1.18 1.41 1.41 1.18-1.18a1 1 0 1 1 1.41 1.41l-4.24 4.24ZM13.41 10.59a1 1 0 0 0-1.41-1.41L7.76 13.41a3 3 0 0 0 4.24 4.24l1.18-1.18-1.41-1.41-1.18 1.18a1 1 0 0 1-1.41-1.41l4.24-4.24Z"/>
    </symbol>
    <symbol id="icon-search" viewBox="0 0 24 24">
      <path fill="currentColor" d="m15.5 14 5 5-1.5 1.5-5-5V14l-.5-.5a6.5 6.5 0 1 1 1.5-1.5l.5.5Zm-5 0a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Z"/>
    </symbol>
    <symbol id="icon-star" viewBox="0 0 24 24">
      <path fill="currentColor" d="m12 3 2.47 5 5.53.8-4 3.89.94 5.51L12 16.77 7.06 18.2 8 12.69l-4-3.89 5.53-.8L12 3Z"/>
    </symbol>
    <symbol id="icon-trending" viewBox="0 0 24 24">
      <path fill="currentColor" d="M3 17 9.5 9l4 4 6-7 1.5 1.32-7.5 9-4-4L5 18 3 17Z"/>
    </symbol>
    <symbol id="icon-refresh" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 6V3l-4 4 4 4V8a4 4 0 1 1-4 4H6a6 6 0 1 0 6-6Z"/>
    </symbol>
    <symbol id="icon-alert" viewBox="0 0 24 24">
      <path fill="currentColor" d="M11 7h2v6h-2V7Zm0 8h2v2h-2v-2Zm1-13 10 18H1L12 2Zm0 3.46L4.53 19h14.94L12 5.46Z"/>
    </symbol>
    <symbol id="icon-info" viewBox="0 0 24 24">
      <path fill="currentColor" d="M11 9h2V7h-2v2Zm0 8h2v-6h-2v6Zm1-16a10 10 0 1 1 0 20 10 10 0 0 1 0-20Zm0 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16Z"/>
    </symbol>
    <symbol id="icon-pause" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7 4h4v16H7V4Zm6 0h4v16h-4V4Z"/>
    </symbol>
    <symbol id="icon-play" viewBox="0 0 24 24">
      <path fill="currentColor" d="M8 5v14l11-7-11-7Z"/>
    </symbol>
  </svg>
  <div id="app">
    <div class="key-overlay" id="keyless-overlay" role="alertdialog" aria-modal="true" aria-labelledby="keyless-title">
      <div class="empty-state">
        <svg><use href="#icon-alert"></use></svg>
        <h3 id="keyless-title">API key required</h3>
        <p>Paste your CFBD v2 bearer token in Settings to start streaming 2025 data. We never send your key anywhere else and it stays on this device.</p>
        <button class="btn" id="keyless-open">Open settings</button>
      </div>
    </div>
    <header class="topbar" role="banner">
      <div class="brand" aria-label="College Football 2025 Dashboard">
        <svg><use href="#icon-football"></use></svg>
        <div class="brand-text">
          <span>CFB '25 Command Center</span>
          <small>Live scores, stats &amp; odds</small>
        </div>
      </div>
      <nav class="topnav" aria-label="Primary">
        <button class="nav-btn" data-route="#/scores">Scores</button>
        <button class="nav-btn" data-route="#/teams">Teams</button>
        <button class="nav-btn" data-route="#/rankings">Rankings</button>
        <button class="nav-btn" data-route="#/stats">Stats</button>
        <button class="nav-btn" data-route="#/search">Search</button>
        <button class="nav-btn" data-route="#/settings">Settings</button>
      </nav>
      <button class="icon-button" aria-label="Settings" data-route="#/settings">
        <svg><use href="#icon-settings"></use></svg>
      </button>
    </header>
    <main id="view" role="main" tabindex="-1">
      <div class="empty-state">
        <svg><use href="#icon-football"></use></svg>
        <h3>Load up week action</h3>
        <p>Choose a week to see kickoffs, live drives, media info, betting lines and more. Paste your CFBD key in settings to begin.</p>
      </div>
    </main>
    <footer class="week-bar" role="contentinfo">
      <div class="week-controls">
        <button id="week-prev" aria-label="Previous week"><svg><use href="#icon-chevron-left"></use></svg></button>
        <span id="week-label">Week --</span>
        <button id="week-next" aria-label="Next week"><svg><use href="#icon-chevron-right"></use></svg></button>
      </div>
      <div class="week-filters" role="radiogroup" aria-label="Score filters">
        <button class="chip" data-filter="all" role="radio" aria-checked="true">All</button>
        <button class="chip" data-filter="top25" role="radio" aria-checked="false">Top25</button>
        <button class="chip" data-filter="live" role="radio" aria-checked="false">Live</button>
        <button class="chip" data-filter="final" role="radio" aria-checked="false">Final</button>
      </div>
    </footer>
  </div>
  <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>
  <script>
    (() => {
      const API_BASE = 'https://apinext.collegefootballdata.com';
      const STORAGE_KEY = 'cfbd-2025-dashboard';
      const APP_VERSION = '1.0.0';
      const DEFAULT_POLL_MS = 45000;
      const MAX_LOG = 60;
      const TEAM_CACHE_TTL = 7 * 24 * 60 * 60 * 1000;
      const WEEK_CACHE_TTL = 3 * 60 * 60 * 1000;
      const RANKINGS_CACHE_TTL = 2 * 60 * 60 * 1000;
      const LINES_CACHE_TTL = 60 * 60 * 1000;
      const BOX_CACHE_TTL = 30 * 60 * 1000;

      const persisted = safeParse(localStorage.getItem(STORAGE_KEY)) || {};
      const memoryCache = new Map();
      const persistentCache = persisted.caches || {};
      let persistTimer = null;

      const diagnostics = {
        requestCount: 0,
        cacheHits: persisted.cacheHits || 0,
        cacheMisses: persisted.cacheMisses || 0,
        lastError: persisted.lastError || null,
        inflight: 0,
        livePaused: false
      };

      const requestLog = [];
      const inflight = new Map();
      let pollTimer = null;

      const state = {
        apiKey: persisted.apiKey || '',
        year: 2025,
        week: persisted.week || null,
        seasonType: 'regular',
        division: 'fbs',
        filter: persisted.filter || 'all',
        pollingMs: persisted.pollingMs || DEFAULT_POLL_MS,
        tzOffset: new Date().getTimezoneOffset(),
        route: parseHash(location.hash),
        expanded: new Set()
      };

      const viewRoot = document.getElementById('view');
      const navButtons = Array.from(document.querySelectorAll('.nav-btn'));
      const filterButtons = Array.from(document.querySelectorAll('.week-filters .chip'));
      const weekLabel = document.getElementById('week-label');
      const toastContainer = document.getElementById('toast-container');
      const keylessOverlay = document.getElementById('keyless-overlay');
      const keylessOpen = document.getElementById('keyless-open');
      const weekPrev = document.getElementById('week-prev');
      const weekNext = document.getElementById('week-next');

      keylessOpen.addEventListener('click', () => navigate('#/settings'));

      navButtons.forEach(btn => {
        btn.addEventListener('click', ev => {
          const route = btn.dataset.route;
          if (route) {
            ev.preventDefault();
            navigate(route);
          }
        });
      });

      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;
          if (filter && state.filter !== filter) {
            state.filter = filter;
            persistState();
            updateFilterUI();
            if (state.route.view === 'scores') {
              renderScores();
            }
          }
        });
      });

      weekPrev.addEventListener('click', () => changeWeek(-1));
      weekNext.addEventListener('click', () => changeWeek(1));

      window.addEventListener('hashchange', () => {
        state.route = parseHash(location.hash);
        renderRoute();
      });

      document.addEventListener('visibilitychange', () => {
        diagnostics.livePaused = document.hidden;
        if (document.hidden) {
          stopPolling();
        } else if (state.route.view === 'scores') {
          maybeSchedulePolling();
        }
        updateDiagnostics();
      });

      function safeParse(raw) {
        if (!raw) return null;
        try {
          return JSON.parse(raw);
        } catch (err) {
          console.warn('Failed to parse persisted state', err);
          return null;
        }
      }

      function parseHash(hash) {
        const clean = (hash || '#/scores').replace(/^#/, '');
        const parts = clean.split('/').filter(Boolean);
        const view = parts[0] || 'scores';
        const rest = parts.slice(1);
        return { view, parts: rest };
      }

      function persistState() {
        if (persistTimer) {
          clearTimeout(persistTimer);
        }
        persistTimer = setTimeout(() => {
          const data = {
            version: APP_VERSION,
            apiKey: state.apiKey,
            week: state.week,
            filter: state.filter,
            pollingMs: state.pollingMs,
            caches: persistentCache,
            cacheHits: diagnostics.cacheHits,
            cacheMisses: diagnostics.cacheMisses,
            lastError: diagnostics.lastError
          };
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch (err) {
            console.warn('Persist failed', err);
          }
        }, 150);
      }

      function cacheKeyFrom(path, params) {
        const usp = new URLSearchParams(params || {});
        const search = usp.toString();
        return search ? `${path}?${search}` : path;
      }
      function getCache(key) {
        const now = Date.now();
        const mem = memoryCache.get(key);
        if (mem && mem.exp > now) {
          diagnostics.cacheHits++;
          return mem.value;
        }
        const persistedItem = persistentCache[key];
        if (persistedItem && persistedItem.exp > now) {
          memoryCache.set(key, persistedItem);
          diagnostics.cacheHits++;
          return persistedItem.value;
        }
        diagnostics.cacheMisses++;
        return null;
      }

      function setCache(key, value, ttl, persist = false) {
        const exp = Date.now() + ttl;
        const entry = { value, exp };
        memoryCache.set(key, entry);
        if (persist) {
          persistentCache[key] = entry;
          persistState();
        }
      }

      function clearCaches() {
        memoryCache.clear();
        Object.keys(persistentCache).forEach(k => delete persistentCache[k]);
        diagnostics.cacheHits = 0;
        diagnostics.cacheMisses = 0;
        persistState();
        showToast('Caches cleared. Data will refresh on next load.', 'info');
      }

      function recordRequest({ url, status, ms, fromCache }) {
        diagnostics.requestCount++;
        requestLog.unshift({ url, status, ms, fromCache, ts: new Date().toISOString() });
        if (requestLog.length > MAX_LOG) {
          requestLog.length = MAX_LOG;
        }
        updateDiagnostics();
      }

      function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      async function fetchJSON(path, params = {}, options = {}) {
        const key = options.cacheKey || cacheKeyFrom(path, params);
        const ttl = options.ttl ?? WEEK_CACHE_TTL;
        const persist = options.persist ?? false;
        const cached = getCache(key);
        if (cached) {
          recordRequest({ url: key, status: 'cache', ms: 0, fromCache: true });
          return { data: cached, ms: 0, fromCache: true };
        }
        if (!state.apiKey) {
          throw new Error('API_KEY_REQUIRED');
        }
        if (inflight.has(key)) {
          return inflight.get(key);
        }
        const url = new URL(path, API_BASE);
        Object.entries(params || {}).forEach(([k, v]) => {
          if (v !== undefined && v !== null && v !== '') {
            url.searchParams.set(k, v);
          }
        });
        const fetchPromise = (async () => {
          const attempts = 3;
          for (let attempt = 1; attempt <= attempts; attempt++) {
            const started = performance.now();
            try {
              diagnostics.inflight++;
              const res = await fetch(url.toString(), {
                headers: {
                  'Authorization': `Bearer ${state.apiKey}`,
                  'Accept': 'application/json'
                }
              });
              const ms = Math.round(performance.now() - started);
              if (!res.ok) {
                if (res.status === 401 || res.status === 403) {
                  diagnostics.lastError = `Auth ${res.status}`;
                  persistState();
                  showToast('Authorization failed. Check your CFBD key.', 'error');
                  navigate('#/settings');
                  throw new Error(`AUTH_${res.status}`);
                }
                if (res.status === 404) {
                  diagnostics.lastError = `404 ${path}`;
                  recordRequest({ url: url.toString(), status: res.status, ms, fromCache: false });
                  return { data: null, ms, fromCache: false };
                }
                if (res.status === 429 || res.status >= 500) {
                  const backoff = (Math.pow(2, attempt) + Math.random()) * 400;
                  await delay(backoff);
                  continue;
                }
                const text = await res.text();
                diagnostics.lastError = `${res.status}: ${text}`;
                persistState();
                recordRequest({ url: url.toString(), status: res.status, ms, fromCache: false });
                throw new Error(`HTTP_${res.status}`);
              }
              const data = await res.json();
              recordRequest({ url: url.toString(), status: res.status, ms, fromCache: false });
              setCache(key, data, ttl, persist);
              return { data, ms, fromCache: false };
            } catch (err) {
              if (err.message.startsWith('AUTH_') || err.message === 'API_KEY_REQUIRED') {
                throw err;
              }
              if (attempt === attempts) {
                diagnostics.lastError = err.message;
                persistState();
                showToast(`Request failed: ${err.message}`, 'error');
                throw err;
              }
            } finally {
              diagnostics.inflight = Math.max(0, diagnostics.inflight - 1);
              updateDiagnostics();
            }
          }
        })();
        inflight.set(key, fetchPromise);
        try {
          return await fetchPromise;
        } finally {
          inflight.delete(key);
        }
      }
      function navigate(route) {
        if (location.hash !== route) {
          location.hash = route;
        } else {
          state.route = parseHash(route);
          renderRoute();
        }
      }

      function updateFilterUI() {
        filterButtons.forEach(btn => {
          const active = btn.dataset.filter === state.filter;
          btn.setAttribute('aria-checked', active);
          btn.classList.toggle('active', active);
        });
        persistState();
      }

      function updateNav() {
        navButtons.forEach(btn => {
          const view = parseHash(btn.dataset.route || '#/scores').view;
          btn.classList.toggle('active', view === state.route.view);
        });
      }

      function updateWeekLabel() {
        weekLabel.textContent = state.week ? `Week ${state.week}` : 'Week --';
        persistState();
      }

      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<strong>${type.toUpperCase()}</strong><span>${escapeHtml(message)}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translate(-50%, -16px)';
        }, 3600);
        setTimeout(() => toast.remove(), 4200);
      }

      function escapeHtml(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch] || ch));
      }

      function applyKeylessState() {
        keylessOverlay.classList.toggle('active', !state.apiKey);
      }

      function parseDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function formatKickoff(dateStr) {
        const date = parseDate(dateStr);
        if (!date) return 'TBD';
        return date.toLocaleString(undefined, {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
      }

      function formatShortTime(dateStr) {
        const date = parseDate(dateStr);
        if (!date) return 'TBD';
        return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      }

      function formatDelta(value) {
        if (value == null) return '–';
        const num = Number(value);
        if (!Number.isFinite(num) || num === 0) return '–';
        return num > 0 ? `+${num}` : `${num}`;
      }

      function deriveLive(game) {
        const status = (game.status || '').toLowerCase();
        if (!status) return false;
        if (status.includes('in progress') || status.includes('live')) return true;
        if (game.clock && !status.includes('final')) return true;
        if (game.period && !status.includes('final') && !status.includes('scheduled')) return true;
        return false;
      }

      function statusLabel(game) {
        const status = (game.status || '').toLowerCase();
        if (status.includes('final')) {
          const ot = Number(game.period);
          return ot > 4 ? `Final/${ot - 4}OT` : 'Final';
        }
        if (status.includes('scheduled') || status.includes('pre-game')) {
          return formatShortTime(game.startDate);
        }
        if (game.clock) {
          return `${game.period ? `Q${game.period}` : ''} ${game.clock}`.trim();
        }
        return game.status || 'TBD';
      }

      function computePossession(game) {
        if (!game?.situation) return null;
        const { possession, down, distance } = game.situation;
        if (!possession) return null;
        const downLabel = down ? `${down}${['st','nd','rd','th'][Math.min(down,4)-1] || 'th'} & ${distance || ''}` : '';
        return `${possession} ${downLabel}`.trim();
      }
      const teamStore = {
        ready: false,
        map: new Map(),
        byConference: new Map(),
        async ensure() {
          if (this.ready) return this.map;
          const cached = getCache('teams-2025');
          if (cached) {
            this.hydrate(cached);
            this.ready = true;
            return this.map;
          }
          const { data } = await fetchJSON('/teams/fbs', { year: state.year }, { cacheKey: 'teams-2025', ttl: TEAM_CACHE_TTL, persist: true });
          if (Array.isArray(data)) {
            this.hydrate(data);
            setCache('teams-2025', data, TEAM_CACHE_TTL, true);
            this.ready = true;
          }
          return this.map;
        },
        hydrate(list) {
          this.map.clear();
          this.byConference.clear();
          (list || []).forEach(team => {
            if (!team?.school) return;
            this.map.set(team.school, team);
            const conf = team.conference || 'Independent';
            if (!this.byConference.has(conf)) this.byConference.set(conf, []);
            this.byConference.get(conf).push(team);
          });
          this.byConference.forEach(arr => arr.sort((a, b) => a.school.localeCompare(b.school)));
        }
      };

      async function resolveCurrentWeek() {
        if (!state.apiKey) return;
        try {
          const { data } = await fetchJSON('/calendar', { year: state.year }, { cacheKey: 'calendar-2025', ttl: 6 * 60 * 60 * 1000, persist: true });
          const today = new Date();
          let activeWeek = null;
          if (Array.isArray(data)) {
            for (const entry of data) {
              if (entry.seasonType !== state.seasonType) continue;
              const start = parseDate(entry.firstGameStart || entry.firstGameStartDate || entry.firstGameStartTime);
              const end = parseDate(entry.lastGameStart || entry.lastGameStartDate || entry.lastGameStartTime);
              if (start && end && today >= start && today <= new Date(end.getTime() + 6 * 60 * 60 * 1000)) {
                activeWeek = entry.week;
                break;
              }
              if (start && today >= start) {
                activeWeek = entry.week;
              }
            }
          }
          state.week = activeWeek || data?.[data.length - 1]?.week || 1;
          updateWeekLabel();
        } catch (err) {
          console.warn('Week resolve failed', err);
          if (!state.week) {
            state.week = 1;
            updateWeekLabel();
          }
        }
      }

      async function changeWeek(delta) {
        if (!state.week) return;
        const next = Math.max(1, state.week + delta);
        if (next === state.week) return;
        state.week = next;
        updateWeekLabel();
        persistState();
        if (state.route.view === 'scores') renderScores();
        if (state.route.view === 'rankings') renderRankings();
      }

      function updateDiagnostics() {
        const diagnosticsPanel = document.getElementById('diagnostics-panel');
        if (diagnosticsPanel) {
          diagnosticsPanel.innerHTML = `
            <div>Requests: ${diagnostics.requestCount}</div>
            <div>Cache hits: ${diagnostics.cacheHits} · Misses: ${diagnostics.cacheMisses}</div>
            <div>Inflight: ${diagnostics.inflight}</div>
            <div>Polling: ${state.pollingMs / 1000}s ${diagnostics.livePaused ? '(paused)' : ''}</div>
            <div>Last error: ${diagnostics.lastError || 'None'}</div>
          `;
        }
        const logContainer = document.getElementById('request-log');
        if (logContainer) {
          logContainer.innerHTML = requestLog.length
            ? requestLog.map(entry => `
              <div class="log-entry">
                <strong>${entry.status}</strong>
                <span>${escapeHtml(entry.url)}</span>
                <span>${entry.ms}ms · ${entry.fromCache ? 'cache' : 'network'} · ${new Date(entry.ts).toLocaleTimeString()}</span>
              </div>
            `).join('')
            : '<span>No requests yet.</span>';
        }
      }

      function stopPolling() {
        if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }

      function maybeSchedulePolling(hasLive) {
        stopPolling();
        const shouldPoll = (hasLive !== false) && state.pollingMs > 0 && !document.hidden;
        if (!shouldPoll) return;
        pollTimer = setInterval(() => {
          if (state.route.view === 'scores') {
            renderScores({ background: true });
          }
        }, state.pollingMs);
      }

      function computeRankingsMap(rankings) {
        const map = new Map();
        (rankings || []).forEach(poll => {
          (poll.ranks || []).forEach(entry => {
            const team = entry.team || entry.school;
            if (!team) return;
            if (!map.has(team)) map.set(team, {});
            map.get(team)[poll.poll] = { rank: entry.rank, previous: entry.previous };
          });
        });
        return map;
      }
      function renderRoute() {
        updateNav();
        updateFilterUI();
        updateWeekLabel();
        applyKeylessState();
        switch (state.route.view) {
          case 'scores':
            renderScores();
            break;
          case 'teams':
            if (state.route.parts.length) {
              const name = decodeURIComponent(state.route.parts.join('/'));
              teamStore.ensure().then(() => renderTeamDetail(name));
            } else {
              renderTeams();
            }
            break;
          case 'rankings':
            renderRankings();
            break;
          case 'stats':
            renderStats();
            break;
          case 'search':
            renderSearch();
            break;
          case 'settings':
            renderSettings();
            break;
          default:
            renderNotFound();
        }
      }

      function renderNotFound() {
        stopPolling();
        viewRoot.innerHTML = `
          <div class="view-scroll">
            <div class="empty-state">
              <svg><use href="#icon-alert"></use></svg>
              <h3>Not found</h3>
              <p>The requested view is not available. Return to scores to continue.</p>
              <button class="btn" id="return-home">Go to Scores</button>
            </div>
          </div>
        `;
        viewRoot.querySelector('#return-home').addEventListener('click', () => navigate('#/scores'));
      }

      function createLogo(team, fallback) {
        const color = team?.color ? `#${team.color}` : 'rgba(255,255,255,0.06)';
        const alt = team?.alt_color ? `#${team.alt_color}` : 'rgba(255,255,255,0.22)';
        const logos = Array.isArray(team?.logos) ? team.logos.filter(src => /^https:/i.test(src)) : [];
        if (logos.length) {
          const img = document.createElement('img');
          img.src = logos[0];
          img.alt = `${team?.school || fallback} logo`;
          img.decoding = 'async';
          img.loading = 'lazy';
          return img;
        }
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 64 64');
        svg.innerHTML = `
          <rect width="64" height="64" rx="14" fill="${color}" />
          <text x="50%" y="52%" text-anchor="middle" font-family="var(--font)" font-weight="700" font-size="26" fill="${alt}">${escapeHtml((fallback || '?').slice(0, 3).toUpperCase())}</text>
        `;
        return svg;
      }

      function renderSkeletonCards(count = 4) {
        return `<div class="scores-view"><div class="scores-scroll">${Array.from({ length: count }).map(() => `
          <div class="game-card">
            <div class="skeleton" style="width:120px;height:12px;border-radius:8px;"></div>
            <div class="team-row">
              <div class="team-logo skeleton"></div>
              <div style="flex:1;display:grid;gap:6px;">
                <div class="skeleton" style="height:14px;border-radius:8px;"></div>
                <div class="skeleton" style="height:12px;border-radius:8px;width:60%;"></div>
              </div>
              <div class="skeleton" style="width:48px;height:20px;border-radius:8px;"></div>
            </div>
            <div class="team-row">
              <div class="team-logo skeleton"></div>
              <div style="flex:1;display:grid;gap:6px;">
                <div class="skeleton" style="height:14px;border-radius:8px;"></div>
                <div class="skeleton" style="height:12px;border-radius:8px;width:60%;"></div>
              </div>
              <div class="skeleton" style="width:48px;height:20px;border-radius:8px;"></div>
            </div>
            <div class="skeleton" style="height:12px;border-radius:8px;width:80%;"></div>
          </div>`).join('')}</div></div>`;
      }

      async function loadWeekBundle(week) {
        if (!week) return {};
        const gamesKey = `games-${week}`;
        const scoreboardKey = `scoreboard-${week}`;
        const linesKey = `lines-${week}`;
        const mediaKey = `media-${week}`;
        const weatherKey = `weather-${week}`;
        const rankingsKey = `rankings-${week}`;
        const promises = [
          fetchJSON('/games', { year: state.year, week, seasonType: state.seasonType, division: state.division }, { cacheKey: gamesKey, ttl: WEEK_CACHE_TTL, persist: true }),
          fetchJSON('/scoreboard', { year: state.year, week }, { cacheKey: scoreboardKey, ttl: WEEK_CACHE_TTL, persist: true }),
          fetchJSON('/lines', { year: state.year, week }, { cacheKey: linesKey, ttl: LINES_CACHE_TTL, persist: true }),
          fetchJSON('/games/media', { year: state.year, week }, { cacheKey: mediaKey, ttl: WEEK_CACHE_TTL }),
          fetchJSON('/games/weather', { year: state.year, week }, { cacheKey: weatherKey, ttl: WEEK_CACHE_TTL }),
          fetchJSON('/rankings', { year: state.year, week }, { cacheKey: rankingsKey, ttl: RANKINGS_CACHE_TTL, persist: true })
        ];
        const results = await Promise.allSettled(promises);
        const [gamesRes, scoreboardRes, linesRes, mediaRes, weatherRes, rankingsRes] = results.map(r => r.status === 'fulfilled' ? r.value.data : null);
        return {
          games: gamesRes,
          scoreboard: scoreboardRes,
          lines: linesRes,
          media: mediaRes,
          weather: weatherRes,
          rankings: rankingsRes
        };
      }

      function composeGames(bundle, rankingMap) {
        const games = Array.isArray(bundle.games) ? bundle.games : Array.isArray(bundle?.games?.games) ? bundle.games.games : [];
        const scoreboardGames = Array.isArray(bundle.scoreboard?.games) ? bundle.scoreboard.games : [];
        const scoreboardById = new Map(scoreboardGames.map(game => [game.id || game.gameId || game.game_id, game]));
        const mediaById = new Map((bundle.media || []).map(entry => [entry.id || entry.gameId, entry]));
        const weatherById = new Map((bundle.weather || []).map(entry => [entry.id || entry.gameId, entry]));
        const linesById = new Map();
        (Array.isArray(bundle.lines) ? bundle.lines : []).forEach(entry => {
          if (!entry) return;
          const id = entry.gameId || entry.id;
          if (!linesById.has(id)) {
            linesById.set(id, []);
          }
          linesById.get(id).push(entry);
        });
        const teamMap = teamStore.map;
        return games.map(game => {
          const id = game.id || game.gameId;
          const scoreboard = scoreboardById.get(id) || {};
          const media = mediaById.get(id) || {};
          const weather = weatherById.get(id) || {};
          const lineEntries = linesById.get(id) || [];
          const homeInfo = teamMap.get(game.homeTeam) || teamMap.get(game.home_team) || {};
          const awayInfo = teamMap.get(game.awayTeam) || teamMap.get(game.away_team) || {};
          const isLive = deriveLive(game);
          const pos = computePossession(scoreboard);
          return {
            ...game,
            scoreboard,
            media,
            weather,
            lines: lineEntries,
            homeInfo,
            awayInfo,
            isLive,
            statusLabel: statusLabel(scoreboard.status ? scoreboard : game),
            possession: pos,
            rankings: rankingMap
          };
        });
      }

      function filterGames(games) {
        switch (state.filter) {
          case 'top25':
            return games.filter(game => hasTop25(game));
          case 'live':
            return games.filter(game => game.isLive);
          case 'final':
            return games.filter(game => (game.status || '').toLowerCase().includes('final'));
          default:
            return games;
        }
      }

      function hasTop25(game) {
        const map = game.rankings;
        if (!map) return false;
        const homeRanks = map.get(game.homeTeam) || map.get(game.home_team) || {};
        const awayRanks = map.get(game.awayTeam) || map.get(game.away_team) || {};
        return Object.values(homeRanks).some(r => r.rank && r.rank <= 25) ||
               Object.values(awayRanks).some(r => r.rank && r.rank <= 25);
      }

      function attachRankingBadge(teamName, rankingMap) {
        return getRankBadge(teamName, rankingMap);
      }

      function getRankBadge(teamName, rankingMap) {
        if (!teamName || !rankingMap?.has(teamName)) return '';
        const pollEntry = rankingMap.get(teamName);
        const pollNames = ['AP Top 25', 'Coaches Poll', 'CFP Rankings'];
        for (const poll of pollNames) {
          if (pollEntry[poll]) {
            return `<span class="team-rank">${pollEntry[poll].rank}</span>`;
          }
        }
        const first = Object.values(pollEntry)[0];
        if (first) {
          return `<span class="team-rank">${first.rank}</span>`;
        }
        return '';
      }

      function createGameCard(game, rankingMap) {
        const card = document.createElement('article');
        card.className = `game-card${game.isLive ? ' live' : ''}`;
        card.tabIndex = 0;
        card.setAttribute('role', 'button');
        card.setAttribute('aria-expanded', state.expanded.has(game.id) ? 'true' : 'false');
        card.dataset.gameId = game.id;

        const homeRank = attachRankingBadge(game.homeTeam, rankingMap);
        const awayRank = attachRankingBadge(game.awayTeam, rankingMap);
        const liveBadge = game.isLive ? `<span class="live-badge"><svg width="12" height="12"><use href="#icon-play"></use></svg>${escapeHtml(game.statusLabel)}</span>` : `<span class="badge">${escapeHtml(game.statusLabel)}</span>`;
        const weather = game.weather;
        const weatherText = weather && (weather.temperature || weather.wind)
          ? `${weather.temperature ? weather.temperature + '°' : ''}${weather.wind ? ` · ${weather.wind}` : ''}`
          : null;
        const mediaText = game.media?.tv || game.media?.tvNetwork || (Array.isArray(game.media?.tvStations) ? game.media.tvStations.join(', ') : null);
        const lines = game.lines || [];
        const primaryLine = lines[0];
        const lineText = primaryLine ? `${primaryLine.provider || ''} ${primaryLine.spread ? primaryLine.spread : ''}${primaryLine.overUnder ? ` · O/U ${primaryLine.overUnder}` : ''}`.trim() : null;

        card.innerHTML = `
          <div class="game-header">
            <div class="game-meta">
              <span class="pill">${escapeHtml(formatKickoff(game.startDate))}</span>
              ${mediaText ? `<span class="meta-item"><svg><use href="#icon-tv"></use></svg>${escapeHtml(mediaText)}</span>` : ''}
              ${weatherText ? `<span class="meta-item"><svg><use href="#icon-weather"></use></svg>${escapeHtml(weatherText)}</span>` : ''}
              ${game.venue ? `<span class="meta-item"><svg><use href="#icon-venue"></use></svg>${escapeHtml(game.venue)}</span>` : ''}
            </div>
            ${liveBadge}
          </div>
          <div class="team-row" data-team="home">
            <div class="team-logo"></div>
            <div class="team-meta">
              <div class="team-name">${homeRank}${escapeHtml(game.homeTeam || game.home_team || '')}</div>
              <div class="team-conf">${escapeHtml(game.homeConference || game.home_conference || '')}</div>
            </div>
            <div class="team-score">${game.homePoints ?? game.home_points ?? '–'}</div>
          </div>
          <div class="team-row" data-team="away">
            <div class="team-logo"></div>
            <div class="team-meta">
              <div class="team-name">${awayRank}${escapeHtml(game.awayTeam || game.away_team || '')}</div>
              <div class="team-conf">${escapeHtml(game.awayConference || game.away_conference || '')}</div>
            </div>
            <div class="team-score">${game.awayPoints ?? game.away_points ?? '–'}</div>
          </div>
          ${lineText ? `<div class="meta-item" style="align-self:flex-start;"><svg><use href="#icon-trending"></use></svg>${escapeHtml(lineText)}</div>` : ''}
        `;
        const homeLogoContainer = card.querySelector('.team-row[data-team="home"] .team-logo');
        const awayLogoContainer = card.querySelector('.team-row[data-team="away"] .team-logo');
        if (homeLogoContainer) {
          homeLogoContainer.appendChild(createLogo(game.homeInfo, (game.homeTeam || '').slice(0, 3)));
        }
        if (awayLogoContainer) {
          awayLogoContainer.appendChild(createLogo(game.awayInfo, (game.awayTeam || '').slice(0, 3)));
        }

        card.addEventListener('click', () => toggleGameExpansion(game, card));
        card.addEventListener('keypress', ev => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            toggleGameExpansion(game, card);
          }
        });
        return card;
      }

      function setExpansionState(card, expanded) {
        card.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        card.classList.toggle('expanded', expanded);
      }

      async function toggleGameExpansion(game, card) {
        const isExpanded = state.expanded.has(game.id);
        if (isExpanded) {
          state.expanded.delete(game.id);
          const expandedEl = card.querySelector('.game-expanded');
          if (expandedEl) expandedEl.remove();
          setExpansionState(card, false);
          return;
        }
        state.expanded.add(game.id);
        setExpansionState(card, true);
        const expanded = document.createElement('div');
        expanded.className = 'game-expanded';
        expanded.innerHTML = `<div class="skeleton" style="height:120px;border-radius:12px;"></div>`;
        card.appendChild(expanded);
        try {
          const [teamStatsRes, advRes, playerRes] = await Promise.allSettled([
            fetchJSON('/games/teams', { gameId: game.id }, { cacheKey: `game-teams-${game.id}`, ttl: BOX_CACHE_TTL }),
            fetchJSON('/game/box/advanced', { gameId: game.id }, { cacheKey: `game-adv-${game.id}`, ttl: BOX_CACHE_TTL }),
            fetchJSON('/games/players', { gameId: game.id }, { cacheKey: `game-players-${game.id}`, ttl: BOX_CACHE_TTL })
          ]);
          const stats = teamStatsRes.status === 'fulfilled' ? teamStatsRes.value.data : [];
          const adv = advRes.status === 'fulfilled' ? advRes.value.data : null;
          const players = playerRes.status === 'fulfilled' ? playerRes.value.data : null;
          expanded.innerHTML = '';
          expanded.appendChild(renderStatsBlock(stats, adv));
          expanded.appendChild(renderScoringBlock(game));
          if (Array.isArray(players) && players.length) {
            expanded.appendChild(renderPlayersBlock(players));
          }
        } catch (err) {
          expanded.innerHTML = `<div class="empty-state" style="background:rgba(16,22,27,0.86);"><svg><use href="#icon-alert"></use></svg><p>Unable to load box score right now.</p></div>`;
        }
      }

      function renderStatsBlock(stats, adv) {
        const container = document.createElement('div');
        container.className = 'stat-grid';
        const statMap = new Map();
        (stats || []).forEach(team => {
          statMap.set(team.team || team.school, team);
        });
        const metrics = [
          { key: 'totalYards', label: 'Total Yards', getter: t => getStat(t, 'totalYards') },
          { key: 'passingYards', label: 'Passing', getter: t => getStat(t, 'passingYards') },
          { key: 'rushingYards', label: 'Rushing', getter: t => getStat(t, 'rushingYards') },
          { key: 'yardsPerPlay', label: 'Yards/Play', getter: t => getStat(t, 'yardsPerPlay') },
          { key: 'turnovers', label: 'Turnovers', getter: t => getStat(t, 'turnovers') },
          { key: 'possession', label: 'Possession', getter: t => getStat(t, 'possessionTime') }
        ];
        metrics.forEach(metric => {
          const card = document.createElement('div');
          card.className = 'stat-card';
          const values = [];
          statMap.forEach(entry => {
            values.push({ team: entry.team || entry.school, value: metric.getter(entry) });
          });
          card.innerHTML = `
            <span class="label">${escapeHtml(metric.label)}</span>
            ${values.map(v => `<strong>${escapeHtml(String(v.team))}: ${escapeHtml(String(v.value ?? '–'))}</strong>`).join('')}
          `;
          container.appendChild(card);
        });
        if (adv && Array.isArray(adv.teams)) {
          adv.teams.forEach(team => {
            const advStats = (team.stats || []).slice(0, 3).map(stat => `${stat?.category || ''}: ${stat?.stat || ''}`).join(' · ');
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `
              <span class="label">Advanced · ${escapeHtml(team.team || '')}</span>
              <strong>${escapeHtml(advStats || 'No advanced metrics')}</strong>
            `;
            container.appendChild(card);
          });
        }
        return container;
      }

      function getStat(team, key) {
        if (!team) return '–';
        if (team[key] !== undefined) return team[key];
        if (Array.isArray(team.stats)) {
          const entry = team.stats.find(stat => (stat.category || '').toLowerCase() === key.toLowerCase());
          if (entry) return entry.stat;
        }
        return '–';
      }

      function renderScoringBlock(game) {
        const container = document.createElement('div');
        container.className = 'leader-card';
        container.innerHTML = '<h4>Scoring summary</h4>';
        const list = document.createElement('div');
        list.className = 'scoring-list';
        const scoring = extractScoring(game);
        if (!scoring.length) {
          list.innerHTML = '<span style="color:var(--muted);">No scoring events available yet.</span>';
        } else {
          list.innerHTML = scoring.map(play => `
            <div class="scoring-item">
              <strong>${escapeHtml(play.title)}</strong>
              <span>${escapeHtml(play.detail || '')}</span>
              <span style="color:var(--muted);">${escapeHtml(play.clock || '')}</span>
            </div>
          `).join('');
        }
        container.appendChild(list);
        return container;
      }

      function extractScoring(game) {
        const scoreboard = game.scoreboard || {};
        const plays = scoreboard.scoringPlays || scoreboard.plays || [];
        if (Array.isArray(plays) && plays.length) {
          return plays.map(play => ({
            title: play.team || play.description || 'Score',
            detail: play.text || play.description || '',
            clock: play.clock || play.period
          }));
        }
        if (Array.isArray(scoreboard.scoring) && scoreboard.scoring.length) {
          return scoreboard.scoring.map(item => ({
            title: `${item.period ? `Q${item.period}` : ''} ${item.team || ''}`.trim(),
            detail: item.text || `${item.team} scored`,
            clock: item.clock || ''
          }));
        }
        return [];
      }

      function renderPlayersBlock(players) {
        const container = document.createElement('div');
        container.className = 'leader-card';
        container.innerHTML = '<h4>Player leaders</h4>';
        const list = document.createElement('div');
        list.className = 'leader-rows';
        const groups = new Map();
        players.forEach(player => {
          const statType = player.category || player.statType || 'Other';
          if (!groups.has(statType)) groups.set(statType, []);
          groups.get(statType).push(player);
        });
        const topGroups = Array.from(groups.entries()).slice(0, 3);
        list.innerHTML = topGroups.map(([category, list]) => {
          const top = list.slice(0, 3).map(p => `${p.player || p.name} ${p.stat || ''}`).join(' · ');
          return `<div>${escapeHtml(category)} · ${escapeHtml(top)}</div>`;
        }).join('');
        container.appendChild(list);
        return container;
      }

      function renderScores({ background } = {}) {
        if (!state.apiKey) {
          applyKeylessState();
          viewRoot.innerHTML = `
            <div class="view-scroll">
              <div class="empty-state">
                <svg><use href="#icon-alert"></use></svg>
                <h3>Enter your API key</h3>
                <p>Save your CFBD v2 bearer token in settings to load 2025 FBS scores.</p>
                <button class="btn" id="settings-shortcut">Open settings</button>
              </div>
            </div>`;
          viewRoot.querySelector('#settings-shortcut').addEventListener('click', () => navigate('#/settings'));
          stopPolling();
          return;
        }
        applyKeylessState();
        if (!state.week) {
          viewRoot.innerHTML = renderSkeletonCards();
        }
        const container = document.createElement('div');
        container.className = 'scores-view';
        const scroll = document.createElement('div');
        scroll.className = 'scores-scroll';
        container.appendChild(scroll);
        if (!background) {
          viewRoot.innerHTML = '';
          viewRoot.appendChild(container);
        }

        Promise.all([teamStore.ensure(), loadWeekBundle(state.week)]).then(([teams, bundle]) => {
          const rankingMap = computeRankingsMap(bundle.rankings?.find?.(r => r.week === state.week)?.polls || bundle.rankings?.polls || bundle.rankings || []);
          const games = composeGames(bundle, rankingMap);
          const filtered = filterGames(games);
          if (!filtered.length) {
            viewRoot.innerHTML = `
              <div class="view-scroll">
                <div class="empty-state">
                  <svg><use href="#icon-football"></use></svg>
                  <h3>No games match filters</h3>
                  <p>Try switching to a different filter or week.</p>
                </div>
              </div>`;
            stopPolling();
            return;
          }
          renderVirtualList(scroll, filtered, game => createGameCard(game, rankingMap));
          const anyLive = filtered.some(game => game.isLive);
          maybeSchedulePolling(anyLive);
        }).catch(err => {
          console.error(err);
          stopPolling();
          viewRoot.innerHTML = `
            <div class="view-scroll">
              <div class="empty-state">
                <svg><use href="#icon-alert"></use></svg>
                <h3>Unable to load week</h3>
                <p>${escapeHtml(err.message || 'Unknown error')}</p>
              </div>
            </div>`;
        });
      }

      function renderVirtualList(container, items, renderItem, itemHeight = 200, overscan = 3) {
        container.innerHTML = '';
        container.style.position = 'relative';
        const spacer = document.createElement('div');
        spacer.style.height = `${items.length * itemHeight}px`;
        spacer.style.pointerEvents = 'none';
        const region = document.createElement('div');
        region.className = 'virtual-region';
        container.appendChild(spacer);
        container.appendChild(region);

        function draw() {
          const scrollTop = container.scrollTop;
          const height = container.clientHeight;
          const start = Math.max(0, Math.floor(scrollTop / itemHeight) - overscan);
          const end = Math.min(items.length, Math.ceil((scrollTop + height) / itemHeight) + overscan);
          region.style.transform = `translateY(${start * itemHeight}px)`;
          const fragment = document.createDocumentFragment();
          for (let i = start; i < end; i++) {
            fragment.appendChild(renderItem(items[i], i));
          }
          region.replaceChildren(fragment);
        }

        container.addEventListener('scroll', draw, { passive: true });
        const resizeObserver = new ResizeObserver(() => draw());
        resizeObserver.observe(container);
        draw();
      }

      function renderTeams() {
        stopPolling();
        const view = document.createElement('div');
        view.className = 'view-scroll';
        view.innerHTML = `
          <div class="section-header">
            <h2>Teams</h2>
            <span>2025 FBS index</span>
          </div>
          <input type="search" id="team-filter" placeholder="Filter by school or conference" aria-label="Filter teams" />
          <div class="team-index" id="team-index"></div>
        `;
        viewRoot.innerHTML = '';
        viewRoot.appendChild(view);
        const input = view.querySelector('#team-filter');
        const list = view.querySelector('#team-index');
        teamStore.ensure().then(() => {
          renderTeamIndex(list, '');
        });
        input.addEventListener('input', () => {
          renderTeamIndex(list, input.value.trim());
        });
      }

      function renderTeamIndex(container, filter) {
        const teams = Array.from(teamStore.map.values());
        const query = filter.toLowerCase();
        const filtered = query
          ? teams.filter(team => `${team.school} ${team.conference}`.toLowerCase().includes(query))
          : teams;
        container.innerHTML = filtered.map(team => `
          <button class="team-card" data-team="${encodeURIComponent(team.school)}">
            <div class="team-logo"></div>
            <div>
              <div class="team-name">${escapeHtml(team.school)}</div>
              <small>${escapeHtml(team.conference || 'Independent')}</small>
            </div>
            <svg width="18" height="18"><use href="#icon-chevron-right"></use></svg>
          </button>
        `).join('');
        container.querySelectorAll('.team-card').forEach(card => {
          const name = decodeURIComponent(card.dataset.team || '');
          const info = teamStore.map.get(name);
          const logoHolder = card.querySelector('.team-logo');
          if (logoHolder && info) {
            logoHolder.appendChild(createLogo(info, name.slice(0, 3)));
          }
          card.addEventListener('click', () => {
            navigate(`#/teams/${encodeURIComponent(name)}`);
          });
        });
      }

      function renderTeamDetail(teamName) {
        stopPolling();
        const info = teamStore.map.get(teamName);
        if (!info) {
          viewRoot.innerHTML = `
            <div class="view-scroll">
              <div class="empty-state">
                <svg><use href="#icon-alert"></use></svg>
                <h3>Team not found</h3>
                <p>Return to the index to browse the FBS teams.</p>
                <button class="btn" id="team-back">All teams</button>
              </div>
            </div>`;
          viewRoot.querySelector('#team-back').addEventListener('click', () => navigate('#/teams'));
          return;
        }
        const view = document.createElement('div');
        view.className = 'view-scroll';
        view.innerHTML = `
          <div class="team-detail">
            <div>
              <h2><span class="team-logo" id="team-detail-logo"></span>${escapeHtml(teamName)} <small style="color:var(--muted);font-size:14px;">${escapeHtml(info.mascot || '')}</small></h2>
              <div class="summary">
                <span class="pill">${escapeHtml(info.conference || 'Independent')}</span>
                <span class="pill">${escapeHtml(info.division || '')}</span>
              </div>
            </div>
            <div class="leader-card" id="team-record">Loading record...</div>
            <div class="leader-card">
              <h4>Season schedule</h4>
              <div class="team-schedule" id="team-schedule"></div>
            </div>
            <div class="leader-card" id="team-advanced">Loading advanced profile...</div>
          </div>
        `;
        viewRoot.innerHTML = '';
        viewRoot.appendChild(view);
        const logoHolder = view.querySelector('#team-detail-logo');
        logoHolder.appendChild(createLogo(info, teamName.slice(0, 3)));
        Promise.allSettled([
          fetchJSON('/records', { year: state.year, team: teamName }, { cacheKey: `record-${teamName}`, ttl: WEEK_CACHE_TTL }),
          fetchJSON('/games', { year: state.year, team: teamName }, { cacheKey: `games-team-${teamName}`, ttl: WEEK_CACHE_TTL }),
          fetchJSON('/stats/season', { year: state.year, team: teamName }, { cacheKey: `stats-season-${teamName}`, ttl: WEEK_CACHE_TTL }),
          fetchJSON('/stats/season/advanced', { year: state.year, team: teamName }, { cacheKey: `stats-adv-${teamName}`, ttl: WEEK_CACHE_TTL })
        ]).then(([recordRes, gamesRes, statsRes, advRes]) => {
          const recordEl = view.querySelector('#team-record');
          if (recordRes.status === 'fulfilled') {
            const rec = (recordRes.value.data || []).find(r => r.team === teamName) || recordRes.value.data?.[0];
            if (rec) {
              const overall = rec.total?.wins !== undefined ? `${rec.total.wins}-${rec.total.losses}` : '–';
              recordEl.innerHTML = `
                <h4>Record</h4>
                <div class="stat-grid">
                  <div class="stat-card"><span class="label">Overall</span><strong>${overall}</strong></div>
                  <div class="stat-card"><span class="label">Conference</span><strong>${rec.conference?.wins ?? '–'}-${rec.conference?.losses ?? '–'}</strong></div>
                  <div class="stat-card"><span class="label">Home</span><strong>${rec.home?.wins ?? '–'}-${rec.home?.losses ?? '–'}</strong></div>
                  <div class="stat-card"><span class="label">Away</span><strong>${rec.away?.wins ?? '–'}-${rec.away?.losses ?? '–'}</strong></div>
                </div>`;
            } else {
              recordEl.textContent = 'Record unavailable.';
            }
          } else {
            recordEl.textContent = 'Record unavailable.';
          }
          const scheduleEl = view.querySelector('#team-schedule');
          if (gamesRes.status === 'fulfilled') {
            const schedule = gamesRes.value.data || [];
            if (schedule.length) {
              scheduleEl.innerHTML = schedule.map(game => {
                const opponent = game.homeTeam === teamName ? game.awayTeam : game.homeTeam;
                const result = game.homePoints != null && game.awayPoints != null
                  ? `${game.homePoints}-${game.awayPoints}`
                  : formatShortTime(game.startDate);
                return `<div class="schedule-row"><span>${formatShortTime(game.startDate)}</span><span>${escapeHtml(opponent || '')}</span><span>${escapeHtml(result)}</span></div>`;
              }).join('');
            } else {
              scheduleEl.innerHTML = '<span style="color:var(--muted);">Schedule not published.</span>';
            }
          } else {
            scheduleEl.innerHTML = '<span style="color:var(--muted);">Schedule unavailable.</span>';
          }
          const advEl = view.querySelector('#team-advanced');
          const advStats = advRes.status === 'fulfilled' ? advRes.value.data?.[0] : null;
          const baseStats = statsRes.status === 'fulfilled' ? statsRes.value.data?.[0] : null;
          advEl.innerHTML = `
            <h4>Performance profile</h4>
            <div class="stat-grid">
              <div class="stat-card"><span class="label">Points/Game</span><strong>${baseStats?.points?.offense ?? '–'}</strong></div>
              <div class="stat-card"><span class="label">Points Allowed</span><strong>${baseStats?.points?.defense ?? '–'}</strong></div>
              <div class="stat-card"><span class="label">EPA Offense</span><strong>${advStats?.offense?.epa ?? '–'}</strong></div>
              <div class="stat-card"><span class="label">EPA Defense</span><strong>${advStats?.defense?.epa ?? '–'}</strong></div>
              <div class="stat-card"><span class="label">Success Rate Off</span><strong>${advStats?.offense?.successRate ?? '–'}</strong></div>
              <div class="stat-card"><span class="label">Success Rate Def</span><strong>${advStats?.defense?.successRate ?? '–'}</strong></div>
            </div>
          `;
        });
      }

      function renderRankings() {
        stopPolling();
        if (!state.apiKey) {
          applyKeylessState();
          renderScores();
          return;
        }
        const view = document.createElement('div');
        view.className = 'view-scroll';
        view.innerHTML = `
          <div class="section-header">
            <h2>Rankings</h2>
            <span>Week ${state.week}</span>
          </div>
          <div id="rankings-body">${renderSkeletonCards(2)}</div>
        `;
        viewRoot.innerHTML = '';
        viewRoot.appendChild(view);
        fetchJSON('/rankings', { year: state.year, week: state.week }, { cacheKey: `rankings-${state.week}`, ttl: RANKINGS_CACHE_TTL, persist: true }).then(res => {
          const polls = res.data?.polls || res.data || [];
          const body = view.querySelector('#rankings-body');
          if (!Array.isArray(polls) || !polls.length) {
            body.innerHTML = '<div class="empty-state"><h3>No rankings</h3><p>Polls are unavailable for this week.</p></div>';
            return;
          }
          body.innerHTML = polls.map(poll => {
            const rows = (poll.ranks || []).map(rank => {
              const delta = rank.previous ? rank.previous - rank.rank : null;
              return `
                <div class="leader-row">
                  <span>${rank.rank}</span>
                  <span>${escapeHtml(rank.team || rank.school)}</span>
                  <span style="color:${delta > 0 ? 'var(--ok)' : delta < 0 ? 'var(--err)' : 'var(--muted)'};">${formatDelta(delta)}</span>
                </div>`;
            }).join('');
            return `
              <div class="leader-card">
                <h4>${escapeHtml(poll.poll)}</h4>
                <div class="leader-rows">${rows}</div>
              </div>`;
          }).join('');
        });
      }

      function renderStats() {
        stopPolling();
        if (!state.apiKey) {
          applyKeylessState();
          renderScores();
          return;
        }
        const view = document.createElement('div');
        view.className = 'view-scroll';
        view.innerHTML = `
          <div class="section-header">
            <h2>Season stats</h2>
            <span>2025 Leaders</span>
          </div>
          <div class="leaderboard" id="stats-leaders">
            ${renderSkeletonCards(2)}
          </div>
          <div class="compare-tool" id="compare-tool">
            <h4>Compare teams</h4>
            <div class="compare-grid">
              <label for="compare-a">Team A</label>
              <input list="teams-list" id="compare-a" placeholder="Type a team" />
              <label for="compare-b">Team B</label>
              <input list="teams-list" id="compare-b" placeholder="Type a team" />
            </div>
            <svg class="sparkline" id="compare-chart" viewBox="0 0 320 60" preserveAspectRatio="none"></svg>
            <div id="compare-summary" style="font-size:13px;color:var(--muted);"></div>
            <datalist id="teams-list"></datalist>
          </div>
        `;
        viewRoot.innerHTML = '';
        viewRoot.appendChild(view);
        teamStore.ensure().then(() => {
          const datalist = view.querySelector('#teams-list');
          datalist.innerHTML = Array.from(teamStore.map.keys()).map(name => `<option value="${escapeHtml(name)}"></option>`).join('');
        });
        Promise.all([
          fetchJSON('/stats/season', { year: state.year }, { cacheKey: 'stats-season-2025', ttl: WEEK_CACHE_TTL }),
          fetchJSON('/stats/season/advanced', { year: state.year }, { cacheKey: 'stats-adv-2025', ttl: WEEK_CACHE_TTL })
        ]).then(([seasonRes, advRes]) => {
          const leadersEl = view.querySelector('#stats-leaders');
          const seasonStats = seasonRes.data || [];
          const advStats = advRes.data || [];
          const offenseLeaders = seasonStats
            .filter(stat => stat.category === 'offense' || stat.statType === 'yardsPerGame')
            .sort((a, b) => Number(b.stat) - Number(a.stat))
            .slice(0, 5);
          const defenseLeaders = seasonStats
            .filter(stat => stat.category === 'defense')
            .sort((a, b) => Number(a.stat) - Number(b.stat))
            .slice(0, 5);
          const efficiency = advStats
            .filter(stat => stat.statType === 'successRate' || stat.category === 'ppa')
            .slice(0, 5);
          leadersEl.innerHTML = `
            ${renderLeaderCard('Offense yards', offenseLeaders)}
            ${renderLeaderCard('Defense yards allowed', defenseLeaders)}
            ${renderLeaderCard('Advanced efficiency', efficiency)}
          `;
        });

        const compareA = view.querySelector('#compare-a');
        const compareB = view.querySelector('#compare-b');
        function updateCompare() {
          const teamA = compareA.value.trim();
          const teamB = compareB.value.trim();
          if (!teamA || !teamB) return;
          Promise.all([
            fetchJSON('/stats/season/advanced', { year: state.year, team: teamA }, { cacheKey: `adv-${teamA}`, ttl: WEEK_CACHE_TTL }),
            fetchJSON('/stats/season/advanced', { year: state.year, team: teamB }, { cacheKey: `adv-${teamB}`, ttl: WEEK_CACHE_TTL })
          ]).then(([aRes, bRes]) => {
            const a = aRes.data?.[0];
            const b = bRes.data?.[0];
            renderCompareChart(a, b, teamA, teamB);
          });
        }
        compareA.addEventListener('change', updateCompare);
        compareB.addEventListener('change', updateCompare);
      }

      function renderLeaderCard(title, rows) {
        if (!rows || !rows.length) {
          return `<div class="leader-card"><h4>${escapeHtml(title)}</h4><span style="color:var(--muted);">No data</span></div>`;
        }
        return `
          <div class="leader-card">
            <h4>${escapeHtml(title)}</h4>
            <div class="leader-rows">
              ${rows.map((row, index) => `
                <div class="leader-row">
                  <span>${index + 1}</span>
                  <span>${escapeHtml(row.team || row.school || row.name || '')}</span>
                  <span>${escapeHtml(String(row.stat ?? row.value ?? ''))}</span>
                </div>`).join('')}
            </div>
          </div>`;
      }

      function renderCompareChart(a, b, teamA, teamB) {
        const chart = document.getElementById('compare-chart');
        const summary = document.getElementById('compare-summary');
        if (!a || !b) {
          summary.textContent = 'Comparison data unavailable.';
          return;
        }
        const metrics = ['ppa', 'successRate', 'explosiveness', 'availableYards'];
        const pointsA = metrics.map((metric, idx) => {
          const val = Number(a.offense?.[metric] || 0);
          return { x: (idx / (metrics.length - 1)) * 320, y: 60 - (val * 60) };
        });
        const pointsB = metrics.map((metric, idx) => {
          const val = Number(b.offense?.[metric] || 0);
          return { x: (idx / (metrics.length - 1)) * 320, y: 60 - (val * 60) };
        });
        chart.innerHTML = `
          <polyline fill="none" stroke="var(--accent)" stroke-width="2" points="${pointsA.map(p => `${p.x},${p.y}`).join(' ')}" />
          <polyline fill="none" stroke="var(--warn)" stroke-width="2" points="${pointsB.map(p => `${p.x},${p.y}`).join(' ')}" />
        `;
        summary.innerHTML = `${escapeHtml(teamA)} vs ${escapeHtml(teamB)} · Higher line means better metric.`;
      }

      function renderSearch() {
        stopPolling();
        const view = document.createElement('div');
        view.className = 'view-scroll search-view';
        view.innerHTML = `
          <div class="section-header">
            <h2>Search</h2>
            <span>Teams &amp; games</span>
          </div>
          <input type="search" id="search-input" placeholder="Search teams, games, venues" aria-label="Search" />
          <div class="search-results" id="search-results"></div>
        `;
        viewRoot.innerHTML = '';
        viewRoot.appendChild(view);
        const input = view.querySelector('#search-input');
        const resultsEl = view.querySelector('#search-results');
        input.addEventListener('input', () => {
          performSearch(input.value.trim(), resultsEl);
        });
        performSearch('', resultsEl);
      }

      function performSearch(query, container) {
        if (!query) {
          container.innerHTML = '<span style="color:var(--muted);">Start typing to search across the 2025 season.</span>';
          return;
        }
        const q = query.toLowerCase();
        const teams = Array.from(teamStore.map.values()).filter(team => fuzzyMatch(team.school, q) || fuzzyMatch(team.mascot, q));
        const games = [];
        for (const key in persistentCache) {
          if (key.startsWith('games-')) {
            const data = persistentCache[key].value || [];
            data.forEach(game => {
              if ([game.homeTeam, game.awayTeam, game.venue].some(field => fuzzyMatch(field, q))) {
                games.push(game);
              }
            });
          }
        }
        container.innerHTML = `
          ${teams.slice(0, 5).map(team => `
            <button class="result-card" data-team="${encodeURIComponent(team.school)}">
              <div class="team-logo"></div>
              <span>${escapeHtml(team.school)}</span>
            </button>`).join('')}
          ${games.slice(0, 5).map(game => `
            <button class="result-card" data-game="${game.id}">
              <span>${escapeHtml(game.awayTeam)} at ${escapeHtml(game.homeTeam)}</span>
              <small>${escapeHtml(formatKickoff(game.startDate))}</small>
            </button>`).join('')}
        `;
        container.querySelectorAll('.result-card[data-team]').forEach(btn => {
          const name = decodeURIComponent(btn.dataset.team);
          const info = teamStore.map.get(name);
          const logoHolder = btn.querySelector('.team-logo');
          if (logoHolder && info) logoHolder.appendChild(createLogo(info, name.slice(0, 3)));
          btn.addEventListener('click', () => navigate(`#/teams/${encodeURIComponent(name)}`));
        });
        container.querySelectorAll('.result-card[data-game]').forEach(btn => {
          btn.addEventListener('click', () => {
            navigate('#/scores');
            setTimeout(() => {
              state.expanded.add(Number(btn.dataset.game));
              renderScores();
            }, 100);
          });
        });
      }

      function fuzzyMatch(value, query) {
        if (!value || !query) return false;
        const haystack = value.toLowerCase();
        if (haystack.includes(query)) return true;
        let idx = 0;
        for (const char of haystack) {
          if (char === query[idx]) {
            idx++;
            if (idx === query.length) return true;
          }
        }
        return false;
      }

      function renderSettings() {
        stopPolling();
        const view = document.createElement('div');
        view.className = 'view-scroll settings-view';
        view.innerHTML = `
          <div class="settings-group">
            <h3>API access</h3>
            <div class="form-row">
              <label for="api-key">CFBD v2 bearer token</label>
              <input type="password" id="api-key" placeholder="Paste your key" value="${escapeHtml(state.apiKey)}" autocomplete="off" />
              <button class="btn secondary" id="toggle-key">Show</button>
            </div>
            <button class="btn" id="save-key">Save key</button>
          </div>
          <div class="settings-group">
            <h3>Polling</h3>
            <div class="form-row">
              <label for="polling">Refresh interval (seconds)</label>
              <input type="range" min="15" max="120" step="5" value="${state.pollingMs / 1000}" id="polling" />
              <span id="polling-label">${state.pollingMs / 1000}s</span>
            </div>
            <button class="btn secondary" id="clear-cache">Clear caches</button>
          </div>
          <div class="settings-group">
            <h3>Diagnostics</h3>
            <div class="diagnostics" id="diagnostics-panel"></div>
            <div class="log-table" id="request-log"></div>
          </div>
        `;
        viewRoot.innerHTML = '';
        viewRoot.appendChild(view);
        const keyInput = view.querySelector('#api-key');
        const toggle = view.querySelector('#toggle-key');
        toggle.addEventListener('click', () => {
          if (keyInput.type === 'password') {
            keyInput.type = 'text';
            toggle.textContent = 'Hide';
          } else {
            keyInput.type = 'password';
            toggle.textContent = 'Show';
          }
        });
        view.querySelector('#save-key').addEventListener('click', () => {
          state.apiKey = keyInput.value.trim();
          applyKeylessState();
          persistState();
          showToast('API key saved locally.', 'info');
          if (!state.week) {
            resolveCurrentWeek().then(() => renderScores());
          }
        });
        const pollingRange = view.querySelector('#polling');
        const pollingLabel = view.querySelector('#polling-label');
        pollingRange.addEventListener('input', () => {
          pollingLabel.textContent = `${pollingRange.value}s`;
        });
        pollingRange.addEventListener('change', () => {
          state.pollingMs = Number(pollingRange.value) * 1000;
          persistState();
          maybeSchedulePolling();
        });
        view.querySelector('#clear-cache').addEventListener('click', clearCaches);
        updateDiagnostics();
      }

      function init() {
        applyKeylessState();
        updateFilterUI();
        updateWeekLabel();
        if (!state.apiKey) {
          navigate('#/settings');
        } else {
          resolveCurrentWeek().then(() => {
            if (!location.hash || location.hash === '#/') {
              navigate('#/scores');
            } else {
              renderRoute();
            }
          });
        }
        renderRoute();
      }

      init();
    })();
  </script>
</body>
</html>
