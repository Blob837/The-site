<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Crude Oil Price Tracker</title>
<meta name="theme-color" content="#0b1220" />
<style>
  :root{
    --bg:#0b1220;--panel:#111a2e;--muted:#7b89a6;--text:#e6eefc;--up:#25b36a;--down:#ff4d4f;--accent:#4aa3ff;
    --card:#0f1730;--border:#1f2a48;--warn:#ffb020;--good:#2fbf71;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:radial-gradient(1200px 800px at 70% -10%,#152144 0%,#0b1220 48%) fixed;color:var(--text);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:12px 12px 80px}
  header{
    display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 2px 14px
  }
  .title{
    display:flex;gap:10px;align-items:center
  }
  .logo{
    width:36px;height:36px;border-radius:10px;background:
      conic-gradient(from 210deg at 65% 35%,#2f7aff 0 25%,#2fbf71 0 50%,#7b89a6 0 75%,#2f7aff 0 100%);
    filter:saturate(1.1) drop-shadow(0 6px 18px rgba(0,0,0,.35));
  }
  h1{font-size:18px;margin:0 0 2px;font-weight:700;letter-spacing:.2px}
  .sub{font-size:12px;color:var(--muted)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{
    background:linear-gradient(180deg,#1a2542,#131c33);
    color:#eaf2ff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600;
    cursor:pointer;user-select:none;transition:transform .08s ease,opacity .2s ease,background .2s;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#10192f}
  .btn.ghost{background:transparent;border-color:#2a3863;color:#c9d6f7}
  .btn.ok{background:linear-gradient(180deg,#1f7a4f,#155a3a);border-color:#1a8a59}
  .btn.warn{background:linear-gradient(180deg,#5a3a15,#4a2d0f);border-color:#9a6a1a}
  .grid{display:grid;gap:12px;grid-template-columns:1fr;align-items:stretch}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .card{
    background:linear-gradient(180deg,rgba(29,40,78,.55),rgba(11,18,32,.75));
    border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(2,8,20,.35) inset, 0 10px 26px rgba(0,0,0,.2)
  }
  .price-card{display:flex;flex-direction:column;gap:10px}
  .row{display:flex;justify-content:space-between;align-items:end;gap:12px}
  .instrument{font-size:13px;color:#a9b7d3}
  .big{font-size:28px;font-weight:800;letter-spacing:.3px}
  .delta{font-weight:700}
  .delta.up{color:var(--up)} .delta.down{color:var(--down)}
  .meta{font-size:12px;color:#9db0d8;display:flex;gap:12px;flex-wrap:wrap}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0f1730;font-weight:700}
  .pill.open{color:var(--good);border-color:#196b45}
  .pill.closed{color:#ff7377;border-color:#75343a}
  .chart-wrap{display:flex;flex-direction:column;gap:10px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1730;color:#cbd8f6;cursor:pointer}
  .tab.active{background:#162245;color:#fff}
  canvas{width:100%;height:300px;border-radius:10px;background:linear-gradient(180deg,#0c1427,#0b1220)}
  .status{font-size:12px;color:#93a7cf}
  .err{color:#ff8b8e}
  .alert-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="number"], input[type="text"]{
    background:#0e1730;border:1px solid var(--border);color:#e6eefc;border-radius:10px;padding:8px 10px;width:100%;
    outline:none
  }
  label{font-size:12px;color:#9db0d8}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .foot{position:fixed;inset:auto 10px 10px 10px;display:flex;justify-content:space-between;align-items:center;
        background:#0a1121; border:1px solid var(--border);border-radius:12px;padding:8px 12px;color:#98abd6}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .sr{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Crude Oil Price Tracker</h1>
        <div class="sub">WTI (CL=F) &amp; Brent (BZ=F) — single-file, offline-capable</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="notifyBtn" class="btn secondary">Enable Notifications</button>
      <button id="clearCacheBtn" class="btn ghost" title="Clear cached data">Clear Cache</button>
    </div>
  </header>

  <section class="grid" aria-label="Price dashboard">
    <article class="card price-card" id="card-wti" aria-live="polite">
      <div class="row">
        <div>
          <div class="instrument">WTI Crude — <span class="mono">CL=F</span></div>
          <div class="big" id="wtiPrice">—</div>
        </div>
        <div>
          <div id="wtiDelta" class="delta">—</div>
          <div class="status" id="wtiSource">source: —</div>
        </div>
      </div>
      <div class="meta">
        <div class="pill" id="wtiUpdated">updated —</div>
        <div class="pill" id="marketPill">market —</div>
      </div>
    </article>

    <article class="card price-card" id="card-brent" aria-live="polite">
      <div class="row">
        <div>
          <div class="instrument">Brent Crude — <span class="mono">BZ=F</span></div>
          <div class="big" id="brentPrice">—</div>
        </div>
        <div>
          <div id="brentDelta" class="delta">—</div>
          <div class="status" id="brentSource">source: —</div>
        </div>
      </div>
      <div class="meta">
        <div class="pill" id="brentUpdated">updated —</div>
        <div class="pill" id="healthPill">health —</div>
      </div>
    </article>
  </section>

  <section class="card chart-wrap" aria-label="Charts">
    <div class="row" style="align-items:center">
      <div class="tabs" role="tablist" aria-label="Range">
        <button class="tab active" role="tab" aria-selected="true" data-range="1d">1D</button>
        <button class="tab" role="tab" aria-selected="false" data-range="7d">7D</button>
        <button class="tab" role="tab" aria-selected="false" data-range="30d">30D</button>
      </div>
      <div class="status" id="chartStatus">—</div>
    </div>
    <canvas id="chart" width="1000" height="360" aria-label="Price chart" role="img"></canvas>
    <div class="status">Drag to pan • Pinch/scroll to zoom • Double-tap/click to reset</div>
  </section>

  <section class="card" aria-label="Alerts">
    <div class="alert-row">
      <label for="wtiAlert">WTI alert:</label>
      <input id="wtiAlert" type="number" step="0.01" placeholder="e.g., 60.00" />
      <label for="brentAlert">Brent alert:</label>
      <input id="brentAlert" type="number" step="0.01" placeholder="e.g., 65.00" />
      <button id="saveAlerts" class="btn ok">Save Alerts</button>
      <button id="testAlert" class="btn warn">Test Notification</button>
    </div>
    <div class="status" id="alertStatus">Notifications: —</div>
  </section>

  <section class="card" aria-label="Diagnostics">
    <div class="kv">
      <div>
        <div class="status">Cache keys</div>
        <div class="mono" id="keys">—</div>
      </div>
      <div>
        <div class="status">Last error</div>
        <div class="mono err" id="lastErr">—</div>
      </div>
    </div>
  </section>
</div>

<div class="foot">
  <div>Offline-capable. Single <span class="mono">index.html</span>. No build.</div>
  <div id="tick" class="mono">—</div>
</div>

<script>
/* ===== Service Worker (single-file via Blob) for offline ===== */
(function registerSW(){
  const swCode = `
    const CACHE = 'oiltracker-v2';
    self.addEventListener('install', e=>{
      e.waitUntil((async()=>{ const c=await caches.open(CACHE); await c.addAll(['./']); })());
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>self.clients.claim());
    self.addEventListener('fetch', e=>{
      const url = new URL(e.request.url);
      if (e.request.mode === 'navigate') {
        e.respondWith((async()=>{ const cache=await caches.open(CACHE);
          try{ const res=await fetch(e.request); cache.put('./',res.clone()); return res; }
          catch{ return (await cache.match('./')) || Response.error(); }
        })());
        return;
      }
      // Network-first for data, cache-first for this file
      if (/query[12]\\.finance\\.yahoo\\.com|stooq\\.com|r\\.jina\\.ai/.test(url.host+url.pathname)) {
        e.respondWith((async()=>{ try{ return await fetch(e.request); }
          catch{ const c=await caches.open(CACHE); const m=await c.match(e.request); return m || Response.error(); } })());
      } else if (url.pathname.endsWith('/index.html') || url.pathname === '/' ) {
        e.respondWith(caches.match('./'));
      }
    });
    // Notification click focus
    self.addEventListener('notificationclick', e=>{
      e.notification.close();
      e.waitUntil((async()=>{ const all=await clients.matchAll({type:'window'});
        if(all.length) return all[0].focus();
        return clients.openWindow('./');
      })());
    });
  `;
  try{
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url);
  }catch{}
})();

/* ===== Utilities ===== */
const $ = sel => document.querySelector(sel);
const fmtUSD = v => (v==null||isNaN(v))?'—':'$'+Number(v).toFixed(2);
const nowIso = ()=> new Date().toISOString();
const ago = ts => {
  const d = new Date(ts); if(!+d) return '—';
  const ms = Date.now()-d.getTime(); const m=Math.floor(ms/60000), h=(m/60)|0;
  if (m<1) return 'just now'; if(m<60) return `${m}m ago`; if(h<24) return `${h}h ago`;
  return d.toLocaleString();
};
const store = {
  get(k, def=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) },
  del(k){ localStorage.removeItem(k) }
};
const tickEl = $('#tick'); setInterval(()=>tickEl.textContent = new Date().toLocaleTimeString(), 1000);

/* ===== Market hours (approx; CME NYMEX) =====
   Regular: Sun 5:00p – Fri 4:00p CT, daily halt 4:00p–5:00p CT
*/
function marketStatus(date=new Date()){
  const ctOffset = -5 * 60; // America/Chicago offset approximation (minutes) — DST handling not exact offline
  const utcMin = date.getUTCMinutes() + date.getUTCHours()*60 + date.getUTCDate()*1440;
  // Simple proxy: closed on Saturday; on Sunday open after 17:00 CT; daily maintenance 16:00–17:00 CT
  const day = date.getUTCDay(); // 0=Sun
  const hh = date.getHours(), mm = date.getMinutes(); // local as proxy for display
  const minsLocal = hh*60+mm;
  const openDaily = minsLocal >= 17*60 || minsLocal < 16*60;
  const weekend = day===6; // Saturday
  const sundayBefore17 = (day===0 && minsLocal < 17*60);
  const closed = weekend || sundayBefore17 || (!openDaily);
  return { open: !closed, note: closed ? 'Closed' : 'Open', window: '≈ Sun 5:00p – Fri 4:00p CT' };
}

/* ===== Data sources (no keys; CORS-safe via public proxy) =====
   Primary: Yahoo Finance (JSON). Fallback: Stooq (CSV).
   Proxy: https://r.jina.ai/http://<target> — adds permissive CORS and streams plain text.
*/
const JINA = 'https://r.jina.ai/http://';
const Yahoo = {
  quoteUrl: (symbols)=> `${JINA}query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols)}`,
  chartUrl: (symbol, range, interval)=> `${JINA}query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}`
};
const Stooq = {
  csvDaily:(symbol)=> `${JINA}stooq.com/q/d/l/?s=${symbol}&i=d`,
};
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'}); const t = await r.text();
  try{ return JSON.parse(t) }catch{ throw new Error('Bad JSON from '+url) }
}
async function fetchCSV(url){
  const r = await fetch(url, {cache:'no-store'}); const t = await r.text();
  return t.trim().split(/\r?\n/).map(l=>l.split(','));
}

/* ===== Loaders ===== */
async function getQuote(){
  // attempt yahoo v7
  try{
    const q = await fetchJSON(Yahoo.quoteUrl('CL=F,BZ=F'));
    const rows = q.quoteResponse?.result || [];
    const pick = s => rows.find(r=>r.symbol===s) || {};
    return {
      src:'Yahoo',
      wti:{ price: pick('CL=F').regularMarketPrice, change: pick('CL=F').regularMarketChange, pct: pick('CL=F').regularMarketChangePercent, ts: pick('CL=F').regularMarketTime*1000 || Date.now() },
      brent:{ price: pick('BZ=F').regularMarketPrice, change: pick('BZ=F').regularMarketChange, pct: pick('BZ=F').regularMarketChangePercent, ts: pick('BZ=F').regularMarketTime*1000 || Date.now() }
    };
  }catch(e1){
    // fallback to Stooq last close from CSV (CL.F / CB.F)
    const [cl, cb] = await Promise.all([fetchCSV(Stooq.csvDaily('cl.f')), fetchCSV(Stooq.csvDaily('cb.f'))]);
    const head = cl[0]; // Date,Open,High,Low,Close,Volume
    const toObj = rows => {
      const [h,...data] = rows;
      const map = idx => data.length? data[data.length-1][idx] : null;
      const get = k => map(head.indexOf(k));
      return { price: parseFloat(get('Close')), change: null, pct: null, ts: new Date(get('Date')).getTime() };
    };
    return { src:'Stooq', wti: toObj(cl), brent: toObj(cb) };
  }
}
async function getHistory(symbol, range){
  // map range->interval
  const map = { '1d': {range:'5d', interval:'30m'}, '7d':{range:'7d',interval:'1h'}, '30d':{range:'1mo',interval:'1d'} };
  const r = map[range] || map['30d'];
  try{
    const j = await fetchJSON(Yahoo.chartUrl(symbol, r.range, r.interval));
    const res = j.chart?.result?.[0];
    const tzOff = (res.meta?.gmtoffset ?? 0) * 1000;
    const xs = res.timestamp || [];
    const ohlc = res.indicators?.quote?.[0] || {};
    const closes = ohlc.close || [];
    const pairs = xs.map((t,i)=>[ (t*1000)+0, closes[i] ]).filter(p=> Number.isFinite(p[1]) );
    return { src:'Yahoo', data:pairs };
  }catch(e1){
    // fallback stooq daily CSV
    const csv = await fetchCSV(Stooq.csvDaily(symbol.toLowerCase().replace('=f','.') ));
    const head = csv[0]; const dateIdx = head.indexOf('Date'); const closeIdx=head.indexOf('Close');
    const rows = csv.slice(1).slice(-30).map(r=>[new Date(r[dateIdx]).getTime(), parseFloat(r[closeIdx])]).filter(p=>Number.isFinite(p[1]));
    return { src:'Stooq', data: rows };
  }
}

/* ===== Chart (vanilla canvas with pan/zoom) ===== */
const chart = (function(){
  const cv = $('#chart'), ctx = cv.getContext('2d');
  let dataWTI=[], dataBRENT=[], view={minX:0,maxX:1,minY:0,maxY:1}, active='WTI';
  function setData(wti, brent){ dataWTI=wti; dataBRENT=brent; autoscale(); draw(); }
  function setActive(a){ active=a; autoscale(); draw(); }
  function autoscale(){
    const d = (active==='WTI'?dataWTI:dataBRENT);
    if(!d.length){ view={minX:0,maxX:1,minY:0,maxY:1}; return }
    const xs=d.map(p=>p[0]), ys=d.map(p=>p[1]);
    const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
    const pad = (maxY-minY)*0.08 || 1;
    view={minX,maxX,minY:minY-pad,maxY:maxY+pad};
  }
  function toPx(x,y){
    const W=cv.width,H=cv.height, {minX,maxX,minY,maxY}=view;
    const px=(x-minX)/(maxX-minX)*W;
    const py=H - (y-minY)/(maxY-minY)*H;
    return [px,py];
  }
  function grid(){
    const W=cv.width,H=cv.height; ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='rgba(140,170,230,.25)'; ctx.lineWidth=1;
    // vertical time ticks (4)
    for(let i=0;i<5;i++){
      const x = i/4*W; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    // horizontal price ticks (4) + labels
    ctx.fillStyle='#9db0d8'; ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial';
    for(let i=0;i<5;i++){
      const y = i/4*H; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
      const p = (view.maxY - (i/4)*(view.maxY-view.minY)).toFixed(2);
      ctx.fillText('$'+p, 6, Math.max(12,y-2));
    }
    // legend
    ctx.fillStyle='#cbd8f6';
    ctx.fillText(active==='WTI'?'WTI (CL=F)':'Brent (BZ=F)', W-170, 18);
  }
  function line(data,color){
    if(!data.length) return;
    ctx.beginPath();
    data.forEach((p,i)=>{ const [x,y]=toPx(p[0],p[1]); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.lineWidth=2; ctx.strokeStyle = color; ctx.stroke();
  }
  function draw(){
    grid();
    line(active==='WTI'?dataWTI:dataBRENT, active==='WTI'?'#4aa3ff':'#2fbf71');
  }
  // pan & zoom
  let dragging=false,lastX=0;
  cv.addEventListener('pointerdown',e=>{dragging=true; lastX=e.clientX; cv.setPointerCapture(e.pointerId);});
  cv.addEventListener('pointerup',e=>{dragging=false; cv.releasePointerCapture(e.pointerId);});
  cv.addEventListener('pointerleave',()=>dragging=false);
  cv.addEventListener('pointermove',e=>{
    if(!dragging) return;
    const W=cv.width, span=view.maxX-view.minX;
    const dx = (e.clientX-lastX)/W*span;
    view.minX -= dx; view.maxX -= dx; lastX=e.clientX; draw();
  });
  // wheel zoom or pinch
  cv.addEventListener('wheel',e=>{
    e.preventDefault();
    const factor = e.deltaY>0 ? 1.1 : 0.9;
    const mx = view.minX + (e.offsetX/cv.width)*(view.maxX-view.minX);
    const newSpan = (view.maxX-view.minX)*factor;
    view.minX = mx - (mx-view.minX)*factor;
    view.maxX = view.minX + newSpan;
    draw();
  }, {passive:false});
  cv.addEventListener('dblclick',()=>{ autoscale(); draw(); });

  return { setData, setActive, autoscale, draw };
})();

/* ===== App logic ===== */
const UI = {
  wtiPrice: $('#wtiPrice'), brentPrice: $('#brentPrice'),
  wtiDelta: $('#wtiDelta'), brentDelta: $('#brentDelta'),
  wtiUpdated: $('#wtiUpdated'), brentUpdated: $('#brentUpdated'),
  wtiSource: $('#wtiSource'), brentSource: $('#brentSource'),
  marketPill: $('#marketPill'), healthPill: $('#healthPill'),
  chartStatus: $('#chartStatus'), lastErr: $('#lastErr'), keys: $('#keys'),
  rangeTabs: Array.from(document.querySelectorAll('.tab')),
};
function setDelta(el, ch, pct){
  if(ch==null||pct==null){ el.textContent='—'; el.classList.remove('up','down'); return }
  const up = ch >= 0; el.textContent = `${up?'+':''}${ch.toFixed(2)} (${(pct*100? pct: pct).toFixed(2)}%)`;
  el.classList.toggle('up', up); el.classList.toggle('down', !up);
}
function pulse(el){ el.style.transform='scale(1.02)'; setTimeout(()=>el.style.transform='',120); }
function updateMarketPills(){
  const m = marketStatus(new Date());
  UI.marketPill.textContent = `market ${m.open?'open':'closed'}`;
  UI.marketPill.className = 'pill ' + (m.open?'open':'closed');
  UI.healthPill.textContent = `cache ${(store.get('hist.wti')&&store.get('hist.brent'))?'ok':'cold'}`;
}
function renderKeys(){
  const ks = [];
  for(let i=0;i<localStorage.length;i++){ ks.push(localStorage.key(i)) }
  UI.keys.textContent = ks.sort().join(', ') || '—';
}

/* ===== Notifications & Alerts ===== */
const alertInputs = { wti: $('#wtiAlert'), brent: $('#brentAlert'), save: $('#saveAlerts'), test: $('#testAlert'), btn: $('#notifyBtn'), status: $('#alertStatus') };
async function ensureNotifyPerm(){
  if(!('Notification' in window)) return false;
  if(Notification.permission==='granted') return true;
  if(Notification.permission==='denied') return false;
  const p = await Notification.requestPermission(); return p==='granted';
}
function notify(title, body){
  if(Notification.permission==='granted'){ new Notification(title, { body, tag:'oil-tracker', renotify:true }); }
}
alertInputs.btn.addEventListener('click', async ()=>{
  const ok = await ensureNotifyPerm();
  alertInputs.status.textContent = ok?'Notifications enabled':'Blocked by browser';
});
alertInputs.test.addEventListener('click', ()=> notify('Oil Tracker — Test','Notifications are working.'));
alertInputs.save.addEventListener('click', ()=>{
  const w = parseFloat(alertInputs.wti.value), b = parseFloat(alertInputs.brent.value);
  if(Number.isFinite(w)) store.set('alert.wti', w); else store.del('alert.wti');
  if(Number.isFinite(b)) store.set('alert.brent', b); else store.del('alert.brent');
  alertInputs.status.textContent = 'Alerts saved';
});

/* ===== Refresh cycle ===== */
const REFRESH_MIN = 15;
let currentRange = store.get('ui.range','30d');
function setRange(r){ currentRange=r; store.set('ui.range',r); UI.rangeTabs.forEach(t=>t.classList.toggle('active', t.dataset.range===r)); }
UI.rangeTabs.forEach(tab=>tab.addEventListener('click', async ()=>{
  setRange(tab.dataset.range);
  await loadCharts();
  chart.draw();
}));

$('#refreshBtn').addEventListener('click', ()=> boot(true));
$('#clearCacheBtn').addEventListener('click', ()=>{
  localStorage.clear(); renderKeys(); boot(true);
});

function applyQuote(q){
  UI.wtiPrice.textContent = fmtUSD(q.wti.price);
  UI.brentPrice.textContent = fmtUSD(q.brent.price);
  setDelta(UI.wtiDelta, q.wti.change, q.wti.pct);
  setDelta(UI.brentDelta, q.brent.change, q.brent.pct);
  UI.wtiUpdated.textContent = 'updated ' + ago(q.wti.ts);
  UI.brentUpdated.textContent = 'updated ' + ago(q.brent.ts);
  UI.wtiSource.textContent = 'source: ' + q.src;
  UI.brentSource.textContent = 'source: ' + q.src;
  pulse($('#card-wti')); pulse($('#card-brent'));

  const wAlert = store.get('alert.wti'), bAlert = store.get('alert.brent');
  if(Number.isFinite(wAlert) && q.wti.price!=null){
    const hit = q.wti.price <= wAlert;
    if(hit && !store.get('alert.hit.wti')){ notify('WTI alert', `WTI touched ${fmtUSD(q.wti.price)} ≤ ${fmtUSD(wAlert)}`); store.set('alert.hit.wti', true); }
    if(!hit) store.del('alert.hit.wti');
  }
  if(Number.isFinite(bAlert) && q.brent.price!=null){
    const hit = q.brent.price <= bAlert;
    if(hit && !store.get('alert.hit.brent')){ notify('Brent alert', `Brent touched ${fmtUSD(q.brent.price)} ≤ ${fmtUSD(bAlert)}`); store.set('alert.hit.brent', true); }
    if(!hit) store.del('alert.hit.brent');
  }
}

async function loadQuotes(force=false){
  const key='quote.latest';
  const cached = store.get(key);
  const m = marketStatus();
  const fresh = cached && (Date.now() - (cached._ts||0) < (m.open? REFRESH_MIN*60*1000 : 30*60*1000));
  if(cached && !force && fresh){ applyQuote(cached); return cached }
  try{
    const q = await getQuote();
    const payload = {...q, _ts:Date.now()};
    store.set(key, payload);
    applyQuote(payload);
    renderKeys();
    return payload;
  }catch(e){
    UI.lastErr.textContent = e.message;
    if(cached){ applyQuote(cached); return cached }
    throw e;
  }
}

async function loadCharts(){
  UI.chartStatus.textContent = 'Loading chart…';
  try{
    const [w, b] = await Promise.all([
      getHistory('CL=F', currentRange),
      getHistory('BZ=F', currentRange)
    ]);
    store.set('hist.wti', {range:currentRange, ...w, _ts:Date.now()});
    store.set('hist.brent', {range:currentRange, ...b, _ts:Date.now()});
    chart.setData(w.data, b.data);
    chart.setActive('WTI'); // default
    UI.chartStatus.textContent = `Data: ${w.src}/${b.src} · points ${w.data.length}/${b.data.length}`;
  }catch(e){
    UI.lastErr.textContent = e.message;
    const cw = store.get('hist.wti'), cb = store.get('hist.brent');
    if(cw?.data && cb?.data){ chart.setData(cw.data, cb.data); chart.autoscale(); UI.chartStatus.textContent='Loaded from cache'; }
    else UI.chartStatus.textContent='No chart data';
  }
}

/* ===== Boot ===== */
async function boot(force=false){
  updateMarketPills();
  setRange(store.get('ui.range','30d'));
  try{ await loadQuotes(force) }catch{}
  try{ await loadCharts() }catch{}
}
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){ boot(true) }
});
setInterval(()=>{ const m=marketStatus(); if(m.open) boot(true) }, REFRESH_MIN*60*1000);

/* ===== Initialize ===== */
(async ()=>{
  renderKeys();
  const w = store.get('alert.wti'), b = store.get('alert.brent');
  if(w) alertInputs.wti.value = w;
  if(b) alertInputs.brent.value = b;
  if('Notification' in window && Notification.permission==='granted'){ alertInputs.status.textContent='Notifications enabled' }
  boot(false);
})();
</script>
</body>
</html>
