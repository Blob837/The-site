<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>UR NEWS</title>
<meta name="theme-color" content="#0a0a0a" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0a0a0a;
    --panel:#0f0f0f;
    --line:#1a1a1a;
    --ink:#e0e0e0;
    --muted:#8a8a8a;
    --accent:#ff4444;
    --secondary:#44ff44;
    --warning:#ffaa44;
    --border:#333;
    --chip:#151515;
    --glow-red: rgba(255, 68, 68, 0.3);
    --glow-green: rgba(68, 255, 68, 0.3);
  }
  
  *{box-sizing:border-box}
  html,body{height:100%}
  html{background-color:var(--bg)}
  
  body{
    margin:0; background-color:var(--bg); color:var(--ink);
    font-family: 'JetBrains Mono', 'SF Mono', ui-monospace, Menlo, Consolas, monospace;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeSpeed;
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    overflow-x: hidden;
  }
  
  /* Enhanced CRT effect with flicker animation */
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:1000;
    background: 
      repeating-linear-gradient(90deg, rgba(255,68,68,.02), rgba(255,68,68,.02) 1px, transparent 1px, transparent 3px),
      repeating-linear-gradient(180deg, rgba(255,255,255,.015), rgba(255,255,255,.015) 1px, transparent 1px, transparent 2px);
    animation: flicker 0.15s infinite linear alternate;
  }
  
  @keyframes flicker { 0%{opacity:1} 100%{opacity:0.96} }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
  @keyframes slideIn { from{transform:translateY(-10px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes glow { 0%,100%{box-shadow:0 0 5px var(--glow-red)} 50%{box-shadow:0 0 15px var(--glow-red)} }

  /* Enhanced Header */
  header{
    position:sticky; top:0; z-index:100;
    background: linear-gradient(180deg, var(--bg), rgba(10,10,10,0.95));
    backdrop-filter: blur(10px);
    border-bottom:2px solid var(--accent);
    box-shadow:0 0 20px rgba(255,68,68,0.2), 0 8px 32px rgba(0,0,0,0.4);
  }
  
  .bar{ 
    display:flex; gap:1rem; align-items:center; padding:1rem; 
    background: linear-gradient(90deg, transparent, rgba(255,68,68,0.05), transparent);
  }
  
  .title{ 
    font-weight:900; letter-spacing:2px; font-size:1.5rem; flex:1; 
    color:var(--accent); text-shadow: 0 0 10px var(--glow-red);
    position: relative;
  }
  
  .title::after{
    content: 'â–ˆ'; color: var(--accent); animation: pulse 1s infinite;
    margin-left: 4px;
  }
  
  .blip{
    width:12px; height:12px; border-radius:50%; 
    background:var(--accent); margin-right:0.8rem;
    box-shadow:0 0 15px var(--accent), inset 0 0 8px rgba(255,255,255,0.3);
    animation: glow 2s infinite;
  }
  
  .meta{font-size:0.85rem; color:var(--muted); font-weight:500}
  
  .btn{
    appearance:none; border:2px solid var(--accent); background:var(--panel); color:var(--ink);
    padding:0.7rem 1rem; border-radius:8px; font-weight:800; font-size:0.9rem;
    text-transform: uppercase; letter-spacing: 1px;
    transition: all 0.2s ease; cursor: pointer;
    box-shadow: 0 0 10px rgba(255,68,68,0.1);
  }
  
  .btn:hover{
    background:var(--accent); color:var(--bg);
    box-shadow: 0 0 20px var(--glow-red);
    transform: translateY(-1px);
  }
  
  .btn:active{transform:translateY(1px)}
  
  .btn.secondary{
    border-color: var(--secondary); 
    box-shadow: 0 0 10px rgba(68,255,68,0.1);
  }
  
  .btn.secondary:hover{
    background:var(--secondary); color:var(--bg);
    box-shadow: 0 0 20px var(--glow-green);
  }

  /* Enhanced Filters */
  .filters{ 
    display:flex; gap:0.8rem; overflow:auto; padding:0 1rem 1rem; 
    scrollbar-width: none;
  }
  .filters::-webkit-scrollbar{display:none}
  
  .chip{
    white-space:nowrap; padding:0.5rem 1rem; border-radius:20px; 
    border:1px solid var(--border); background:var(--chip); color:var(--muted); 
    font-size:0.8rem; cursor:pointer; user-select:none;
    transition: all 0.3s ease; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  .chip:hover{
    border-color: var(--accent); 
    box-shadow: 0 0 10px rgba(255,68,68,0.2);
    transform: translateY(-2px);
  }
  
  .chip.active{
    background:var(--accent); color:var(--bg); border-color:var(--accent);
    box-shadow:0 0 15px var(--glow-red);
  }

  /* Enhanced Main Content */
  main{padding:1rem; max-width:900px; margin:0 auto; padding-bottom: 7rem;}
  
  .hint{
    font-size:0.75rem; color:var(--muted); margin:0.5rem 0;
    background: var(--panel); padding: 0.8rem; border-radius: 8px;
    border-left: 4px solid var(--accent);
  }
  
  .src-grid{
    display:flex; gap:0.6rem; overflow:auto; padding:0.5rem 0 1rem;
    scrollbar-width: none;
  }
  .src-grid::-webkit-scrollbar{display:none}
  
  .src{
    padding:0.5rem 0.8rem; border-radius:8px; background:var(--chip); 
    border:1px solid var(--border); font-size:0.8rem; color:var(--muted); 
    cursor:pointer; user-select:none; transition: all 0.2s ease;
    font-weight: 600; white-space: nowrap;
  }
  
  .src:hover{
    border-color: var(--secondary);
    box-shadow: 0 0 8px rgba(68,255,68,0.2);
    transform: translateY(-1px);
  }
  
  .src.on{
    color:var(--ink); background:var(--secondary); border-color:var(--secondary);
    box-shadow:0 0 10px var(--glow-green);
  }
  
  .src.solo{
    outline:2px dashed var(--warning);
    animation: pulse 1.5s infinite;
  }

  /* Enhanced Cards */
  .list{display:grid; gap:1rem; margin-top:1rem}
  
  .card{
    background:linear-gradient(145deg, var(--panel), var(--chip));
    border:1px solid var(--line); border-radius:12px; overflow:hidden;
    box-shadow:0 8px 25px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05);
    transition: all 0.3s ease; position: relative;
  }
  
  .card:hover{
    transform: translateY(-4px);
    box-shadow:0 12px 35px rgba(0,0,0,0.5), 0 0 20px rgba(255,68,68,0.1);
    border-color: var(--accent);
  }
  
  .card-head{
    display:grid; grid-template-columns:auto 1fr auto; gap:0.8rem; 
    align-items:start; padding:1rem; cursor:pointer; position: relative;
  }
  
  .card-head::before{
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background: linear-gradient(90deg, var(--accent), var(--secondary), var(--accent));
    opacity: 0; transition: opacity 0.3s ease;
  }
  
  .card:hover .card-head::before{ opacity: 1; }
  
  .tag{font-size:0.75rem; color:var(--muted); font-weight: 500}
  
  .badge{
    font-size:0.7rem; font-weight:900; padding:0.2rem 0.5rem; 
    border:1px solid var(--border); border-radius:12px; 
    color:var(--ink); background:var(--chip); margin-left:0.5rem;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  .badge.alarm{border-color:#ff4444; color:#ff8888; background:#2a1010}
  .badge.angry{border-color:#ff6644; color:#ffaa88; background:#2a1510}
  .badge.grim{border-color:#666; color:#aaa; background:#1a1a1a}
  .badge.hope{border-color:#44ff44; color:#88ff88; background:#102a10}
  .badge.neutral{border-color:#4488ff; color:#88bbff; background:#101520}
  
  .hline{height:1px; background:linear-gradient(90deg, transparent, var(--line), transparent)}
  
  .titleline{
    font-size:1rem; font-weight:800; line-height:1.3; color:var(--ink);
    margin-bottom: 0.5rem;
  }
  
  .time{font-size:0.75rem; color:var(--muted); font-weight: 500}
  
  .card-body{
    padding:1rem; font-size:0.9rem; color:#c8c8c8; display:none;
    background: rgba(0,0,0,0.2); border-top: 1px solid var(--line);
  }
  
  .card.open .card-body{
    display:block; animation:slideIn 0.3s ease-out;
  }

  /* Enhanced Footer */
  .footer{
    position:fixed; bottom:0; left:0; right:0; z-index:90;
    background: linear-gradient(180deg, rgba(10,10,10,0.95), var(--bg));
    backdrop-filter: blur(15px);
    padding:1rem calc(1rem + env(safe-area-inset-bottom));
    border-top:2px solid var(--accent);
    box-shadow: 0 0 20px rgba(255,68,68,0.2), 0 -8px 32px rgba(0,0,0,0.4);
  }
  
  .footgrid{display:flex; gap:1rem; align-items:center;}
  .footgrid .btn{flex:1}
  
  .count{
    font-size:0.85rem; color:var(--muted); font-weight: 600;
    background: var(--chip); padding: 0.5rem 0.8rem; border-radius: 6px;
    border: 1px solid var(--border);
  }

  /* Enhanced styling */
  a{color:var(--accent); text-decoration:none; font-weight: 600}
  a:hover{color:var(--secondary); text-shadow: 0 0 5px var(--glow-green)}
  
  .empty{
    color:var(--muted); text-align:center; padding:3rem 1rem;
    background: var(--panel); border-radius: 12px; border: 1px solid var(--border);
  }
  
  .favicon{
    width:20px; height:20px; border-radius:4px; 
    background:var(--chip); display:inline-block; 
    background-size:cover; background-position:center;
    border: 1px solid var(--border);
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }

  /* Loading States */
  .loading {
    position: relative;
    overflow: hidden;
  }
  
  .loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,68,68,0.1), transparent);
    animation: loading 1.5s infinite;
  }
  
  @keyframes loading {
    0% { left: -100%; }
    100% { left: 100%; }
  }

  /* Responsive */
  @media (max-width: 600px) {
    .title { font-size: 1.2rem; }
    .bar { padding: 0.8rem; }
    main { padding: 0.8rem; }
    .card-head { padding: 0.8rem; }
    .footgrid { flex-direction: column; gap: 0.8rem; }
    .footgrid .btn { flex: none; width: 100%; }
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">
      <span class="blip"></span>UR NEWS
      <span class="meta" id="lastUpdated"></span>
    </div>
    <button class="btn" id="refreshBtn" aria-label="Refresh">REFRESH</button>
  </div>
  <div class="filters" id="filters">
    <div class="chip active" data-view="all">ALL SOURCES</div>
    <div class="chip" data-view="by-source">BY SOURCE</div>
    <div class="chip" data-view="conservative">CONSERVATIVE</div>
    <div class="chip" data-view="populist">POPULIST</div>
    <div class="chip" data-view="breaking">BREAKING</div>
  </div>
</header>

<main>
  <div class="hint">
    <strong>OPERATIONAL GUIDE:</strong> Tap source to SOLO | Long-press to toggle | Tap headline to expand | Long-press headline to open in new tab
  </div>
  <div class="src-grid" id="sourceToggles"></div>
  <div class="list" id="feedList"></div>
  <div class="empty" id="emptyMsg" style="display:none;">
    <h3>NO ACTIVE FEEDS</h3>
    <p>Hit REFRESH to pull latest intel or enable more sources above</p>
  </div>
</main>

<div class="footer">
  <div class="footgrid">
    <div class="count" id="countInfo">0 articles loaded</div>
    <button class="btn secondary" id="saveBtn">SAVE CONFIG</button>
    <button class="btn" id="clearBtn">RESET ALL</button>
  </div>
</div>

<script>
/* ================= ENHANCED CORE SYSTEM ================= */

const SOURCES = [
  { id:'breitbart',   name:'Breitbart',            url:'https://www.breitbart.com/feed/',                     lane:'populist' },
  { id:'federalist',  name:'The Federalist',       url:'https://thefederalist.com/feed/',                     lane:'conservative' },
  { id:'dailywire',   name:'Daily Wire',           url:'https://www.dailywire.com/feeds/rss.xml',             lane:'conservative' },
  { id:'gateway',     name:'Gateway Pundit',       url:'https://www.thegatewaypundit.com/feed/',              lane:'populist' },
  { id:'infowars',    name:'InfoWars',             url:'https://www.infowars.com/rss.xml',                    lane:'populist' },
  { id:'revolver',    name:'Revolver News',        url:'https://www.revolver.news/feed/',                     lane:'populist' },
  { id:'natfile',     name:'National File',        url:'https://nationalfile.com/feed/',                      lane:'populist' },
  { id:'tplvoice',    name:"People's Voice",       url:'https://thepeoplesvoice.tv/feed/',                    lane:'populist' },
  { id:'libertydaily',name:'Liberty Daily',        url:'https://thelibertydaily.com/rss.xml',                 lane:'populist' },
  { id:'naturalnews', name:'Natural News',         url:'https://www.naturalnews.com/rss.xml',                 lane:'populist' },
  { id:'dailycaller', name:'Daily Caller',         url:'https://dailycaller.com/feed/',                       lane:'conservative' },
  { id:'redstate',    name:'RedState',             url:'https://redstate.com/feed/',                          lane:'conservative' },
  { id:'amgreat',     name:'AmGreatness',          url:'https://amgreatness.com/feed/',                       lane:'conservative' },
  { id:'pjm',         name:'PJ Media',             url:'https://pjmedia.com/feeds/latest',                    lane:'conservative' },
  { id:'nypost',      name:'NY Post',              url:'https://nypost.com/feed/',                            lane:'populist' },
  { id:'townhall',    name:'Townhall',             url:'https://townhall.com/rss',                            lane:'conservative' },
  { id:'foxnews',     name:'Fox News',             url:'https://feeds.foxnews.com/foxnews/latest',            lane:'conservative' },
  { id:'washexam',    name:'Washington Examiner',  url:'https://www.washingtonexaminer.com/feed',             lane:'conservative' },
  { id:'theblaze',    name:'The Blaze',            url:'https://www.theblaze.com/feeds/latest.rss',           lane:'conservative' }
];

const STATE = {
  enabled: new Set(loadEnabled() || SOURCES.map(s=>s.id)),
  items: [],
  view: 'all',
  lastSolo: null,
  loading: false
};

function loadEnabled(){
  try { return JSON.parse(localStorage.getItem('urnews.enabled')) } catch(e){ return null }
}

function saveEnabled(){
  localStorage.setItem('urnews.enabled', JSON.stringify([...STATE.enabled]));
  toast('Configuration saved successfully', 'success');
}

function resetAll(){
  if(confirm('Reset all settings and reload sources?')){
    localStorage.removeItem('urnews.enabled');
    STATE.enabled = new Set(SOURCES.map(s=>s.id));
    STATE.lastSolo = null;
    STATE.view = 'all';
    document.querySelector('.chip.active').classList.remove('active');
    document.querySelector('[data-view="all"]').classList.add('active');
    buildSourceToggles();
    loadFeeds();
    toast('System reset complete', 'success');
  }
}

function toast(msg, type = 'info'){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = `
    position:fixed; bottom:120px; left:50%; transform:translateX(-50%);
    background:${type === 'success' ? 'var(--secondary)' : 'var(--accent)'};
    color:var(--bg); padding:0.8rem 1.2rem; border-radius:8px; z-index:999;
    font-weight:600; box-shadow:0 8px 25px rgba(0,0,0,0.4);
    animation:slideIn 0.3s ease-out;
  `;
  document.body.appendChild(el);
  setTimeout(()=>{ 
    el.style.transition='all 0.3s ease'; 
    el.style.opacity='0'; 
    el.style.transform='translateX(-50%) translateY(-10px)';
    setTimeout(()=>el.remove(),300)
  }, 2000);
}

function addLongPress(target, fn){
  let t; 
  const start = ()=> t=setTimeout(fn, 500);
  const end = ()=> { clearTimeout(t); t=null; }
  target.addEventListener('touchstart', start, {passive:true});
  target.addEventListener('touchend', end, {passive:true});
  target.addEventListener('touchcancel', end, {passive:true});
  target.addEventListener('mousedown', start);
  target.addEventListener('mouseup', end);
  target.addEventListener('mouseleave', end);
}

function fmtTime(ts){
  const d = new Date(ts);
  if (isNaN(d)) return '';
  const now = new Date();
  const diff = (now - d)/1000;
  if (diff < 60) return 'LIVE';
  if (diff < 3600) return Math.floor(diff/60)+'m';
  if (diff < 86400) return Math.floor(diff/3600)+'h';
  if (diff < 86400*7) return Math.floor(diff/86400)+'d';
  return d.toLocaleDateString();
}

function isLikelyAd(item){
  const t = (item.title||'').toLowerCase();
  const d = (item.desc||'').toLowerCase();
  const u = (item.link||'').toLowerCase();
  const badTitle = /(sponsored|advert|advertisement|promo|deal:|shop|store|buy now|subscribe|newsletter|podcast)/i;
  const badPath  = /(sponsor|advert|ads?|subscribe|newsletter|shop|store|deals?|promo|coupons?|terms|privacy)/i;
  const badDesc  = /(sponsored|advertisement|promo|shop now|limited time|subscribe)/i;
  return badTitle.test(t) || badDesc.test(d) || badPath.test(u);
}

async function fetchTextWithFallback(url){
  const proxies = [
    url => fetch(url, {mode:'cors'}),
    url => fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url)),
    url => fetch('https://r.jina.ai/http/' + url.replace(/^https?:\/\//,''))
  ];
  
  for(const proxy of proxies){
    try{ 
      const r = await proxy(url); 
      if (r.ok) return await r.text(); 
    }catch(e){ continue; }
  }
  throw new Error('All fetch methods failed for ' + url);
}

function parseRSS(xmlString, source){
  if (!xmlString.trim().startsWith('<')) {
    const lines = xmlString.split('\n').map(l=>l.trim()).filter(Boolean);
    const picks = [];
    for (let i=0;i<lines.length;i++){
      const l = lines[i];
      if (/^#|^##/.test(l)) {
        const title = l.replace(/^#+\s*/,'').trim();
        let link = '';
        for (let j=i+1;j<i+6 && j<lines.length;j++){
          const m = lines[j].match(/https?:\/\/\S+/);
          if (m){ link = m[0].replace(/[)\]]+$/,''); break; }
        }
        if (title && link) {
          const it = {title, link, pubDate: new Date().toISOString(), source: source.name, lane: source.lane, id: source.id, desc:''};
          if (!isLikelyAd(it)) picks.push(it);
        }
      }
      if (picks.length >= 8) break;
    }
    return picks;
  }

  const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
  if (doc.getElementsByTagName('parsererror')[0]) return [];

  const items = Array.from(doc.querySelectorAll('item, entry')).slice(0, 40).map(it=>{
    const title = (it.querySelector('title')?.textContent||'').trim();
    const link = (it.querySelector('link')?.getAttribute('href') || it.querySelector('link')?.textContent || '').trim();
    const pub = (it.querySelector('pubDate, updated, published')?.textContent||'').trim();
    const desc = (it.querySelector('description, summary, content\\:encoded')?.textContent||'').trim();
    return { 
      title, link, 
      pubDate: pub || new Date().toISOString(), 
      source: source.name, 
      lane: source.lane, 
      id: source.id, 
      desc: strip(desc),
      isBreaking: isBreakingNews(title, desc)
    };
  }).filter(x=>x.title && x.link && !isLikelyAd(x));

  return items;
}

function isBreakingNews(title, desc){
  const text = (title + " " + (desc||"")).toLowerCase();
  const breaking = /breaking|urgent|alert|just in|developing|live|update:|now:|confirmed|exclusive|bombshell/i;
  return breaking.test(text);
}

function sentimentWord(title, desc){
  const text = (title + " " + (desc||"")).toLowerCase();

  const pos = ["win","wins","victory","triumph","surge for","boom","celebrate","acquit","cleared","record high","optimism","upbeat","rally","success","achieve"];
  const neg_alarm = ["emergency","catastrophe","collapse","panic","terror","lockdown","martial law","shooting","assassination","bomb","attack","threat","fatal","dead","crash","war","missile","riot","explosion","nuclear","apocalypse","crisis"];
  const neg_angry = ["fraud","rigged","corrupt","betray","sellout","traitor","censorship","witch hunt","backlash","outrage","cover-up","lies","scandal","indicted","indictment","arrest","impeach","ban","boycott","sanction","exposed"];
  const neg_grim  = ["recession","inflation","border crisis","fentanyl","crime wave","illegal immigration","shortage","decline","drop","cut","loss","collapse","debt","deficit","surge in crime","overdose","bankrupt","layoffs"];

  let score = 0, tag = "NEUTRAL", cls = "neutral";

  for (const w of pos){ if (text.includes(w)) score += 2; }
  for (const w of neg_alarm){ if (text.includes(w)) score -= 3; }
  for (const w of neg_angry){ if (text.includes(w)) score -= 2; }
  for (const w of neg_grim){ if (text.includes(w)) score -= 1; }

  if (score >= 2) { tag = "POSITIVE"; cls="hope"; }
  else if (score <= -3) { tag = "CRITICAL"; cls="alarm"; }
  else if (score == -2) { tag = "HOSTILE"; cls="angry"; }
  else if (score == -1) { tag = "NEGATIVE"; cls="grim"; }
  return {tag, cls};
}

function strip(html){
  if (!html) return '';
  const tmp = document.createElement('div'); 
  tmp.innerHTML = html;
  return (tmp.textContent || tmp.innerText || '').slice(0, 200);
}

async function loadFeeds(){
  if(STATE.loading) return;
  STATE.loading = true;
  
  const refreshBtn = document.getElementById('refreshBtn');
  refreshBtn.classList.add('loading');
  refreshBtn.textContent = 'LOADING...';
  
  try {
    const enabledList = SOURCES.filter(s=>STATE.enabled.has(s.id));
    const tasks = enabledList.map(async src=>{
      try{
        const txt = await fetchTextWithFallback(src.url);
        return parseRSS(txt, src);
      }catch(e){
        console.warn('Failed', src.name, e);
        return [];
      }
    });
    
    const results = (await Promise.allSettled(tasks)).flatMap(r=> r.status==='fulfilled' ? r.value : []);
    results.sort((a,b)=> new Date(b.pubDate) - new Date(a.pubDate));
    STATE.items = results.slice(0, 200);
    
    const now = new Date();
    document.getElementById('lastUpdated').textContent = `â€¢ UPDATED ${now.toLocaleTimeString()}`;
    
    render();
    toast(`Loaded ${STATE.items.length} articles from ${enabledList.length} sources`, 'success');
  } catch(e) {
    toast('Feed loading failed - check connection', 'error');
  } finally {
    STATE.loading = false;
    refreshBtn.classList.remove('loading');
    refreshBtn.textContent = 'REFRESH';
  }
}

function card(item){
  const el = document.createElement('article');
  el.className = 'card';
  const host = safeHost(item.link);
  const mood = sentimentWord(item.title||'', item.desc||'');
  const timeStr = fmtTime(item.pubDate);
  
  el.innerHTML = `
    <div class="card-head" role="button" tabindex="0" aria-expanded="false">
      <span class="favicon" style="background-image:url('https://www.google.com/s2/favicons?domain=${host}&sz=64');"></span>
      <div>
        <div class="titleline">${escapeHTML(item.title)}${item.isBreaking ? ' ðŸ”´' : ''}</div>
        <div class="tag">
          ${escapeHTML(item.source)} â€¢ <span class="â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹time">${escapeHTML(timeStr)}</span>
          <span class="badge ${mood.cls}">${mood.tag}</span>
        </div>
      </div>
      <div class="time">â–¶</div>
    </div>
    <div class="hline"></div>
    <div class="card-body">
      <div>${escapeHTML(item.desc || 'No summary available.')}</div>
      <div style="margin-top:1rem;">
        <a href="${item.link}" target="_blank" rel="noopener">OPEN ARTICLE â†—</a>
      </div>
    </div>
  `;
  
  const head = el.querySelector('.card-head');
  head.addEventListener('click', ()=>{
    const open = el.classList.toggle('open');
    head.setAttribute('aria-expanded', open ? 'true' : 'false');
    head.querySelector('.time').textContent = open ? 'â–¼' : 'â–¶';
  });
  
  addLongPress(head, ()=> {
    window.open(item.link, '_blank');
    toast('Opening in new tab...', 'info');
  });
  
  return el;
}

function render(){
  const list = document.getElementById('feedList');
  const empty = document.getElementById('emptyMsg');
  const countInfo = document.getElementById('countInfo');
  list.innerHTML = '';

  let items = STATE.items.filter(it=> STATE.enabled.has(it.id));
  
  if (STATE.view === 'conservative') items = items.filter(i=> i.lane==='conservative');
  if (STATE.view === 'populist') items = items.filter(i=> i.lane==='populist');
  if (STATE.view === 'breaking') items = items.filter(i=> i.isBreaking);

  countInfo.textContent = `${items.length} articles loaded`;

  if (!items.length){
    empty.style.display = 'block';
    return;
  } else {
    empty.style.display = 'none';
  }

  if (STATE.view === 'by-source'){
    const by = {};
    for (const it of items) { (by[it.source] ||= []).push(it); }
    Object.keys(by).sort().forEach(src=>{
      const hdr = document.createElement('div');
      hdr.className = 'tag'; 
      hdr.style.cssText = 'margin:1.5rem 0 1rem; font-size:1rem; font-weight:800; color:var(--accent); text-transform:uppercase; letter-spacing:1px;';
      hdr.textContent = `${src} â€¢ ${by[src].length} ARTICLES`;
      list.appendChild(hdr);
      by[src].slice(0,30).forEach(it=> list.appendChild(card(it)));
    });
  } else {
    items.slice(0,150).forEach(it=> list.appendChild(card(it)));
  }
}

function buildSourceToggles(){
  const host = document.getElementById('sourceToggles');
  host.innerHTML = '';
  
  SOURCES.forEach(src=>{
    const b = document.createElement('button');
    b.className = 'src' + (STATE.enabled.has(src.id) ? ' on' : '');
    b.textContent = src.name;
    b.dataset.id = src.id;
    b.setAttribute('aria-pressed', STATE.enabled.has(src.id) ? 'true' : 'false');

    // Short tap = SOLO this source
    b.addEventListener('click', ()=>{
      const id = b.dataset.id;
      const onlyThis = new Set([id]);
      const alreadySolo = (STATE.enabled.size === 1 && STATE.enabled.has(id));
      
      if (!alreadySolo){
        STATE.lastSolo = new Set(STATE.enabled);
        STATE.enabled = onlyThis;
        markSolo(id);
        toast(`SOLO MODE: ${src.name}`, 'info');
      } else {
        STATE.enabled = STATE.lastSolo && STATE.lastSolo.size ? new Set(STATE.lastSolo) : new Set(SOURCES.map(s=>s.id));
        clearSolo();
        toast('SOLO MODE DISABLED', 'info');
      }
      syncButtons();
      render();
    });

    // Long-press = toggle include/exclude
    addLongPress(b, ()=>{
      const id = b.dataset.id;
      if (STATE.enabled.has(id)) {
        STATE.enabled.delete(id);
      } else {
        STATE.enabled.add(id);
      }
      
      if (STATE.enabled.size === 0) STATE.enabled = new Set([id]); // never zero
      STATE.lastSolo = null;
      clearSolo();
      syncButtons();
      render();
      toast(STATE.enabled.has(id) ? `Enabled ${src.name}` : `Disabled ${src.name}`, 'info');
    });

    host.appendChild(b);
  });

  function syncButtons(){
    document.querySelectorAll('.src').forEach(btn=>{
      const on = STATE.enabled.has(btn.dataset.id);
      btn.classList.toggle('on', on);
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
  }
  function markSolo(id){
    document.querySelectorAll('.src').forEach(btn=>{
      btn.classList.toggle('solo', btn.dataset.id === id);
    });
  }
  function clearSolo(){
    document.querySelectorAll('.src').forEach(btn=> btn.classList.remove('solo'));
  }
}

function buildFilters(){
  const filters = document.getElementById('filters');
  filters.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if (!chip) return;
    filters.querySelectorAll('.chip').forEach(c=> c.classList.remove('active'));
    chip.classList.add('active');
    STATE.view = chip.dataset.view;
    render();
  });
}

function escapeHTML(str=''){ 
  return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); 
}

function safeHost(url){ 
  try { return new URL(url).hostname; } catch(e){ return '' } 
}

function init(){
  buildFilters();
  buildSourceToggles();
  document.getElementById('refreshBtn').addEventListener('click', loadFeeds);
  document.getElementById('saveBtn').addEventListener('click', saveEnabled);
  document.getElementById('clearBtn').addEventListener('click', resetAll);
  loadFeeds();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>