<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    UR Oil Monitor — Single-file, GitHub Pages–ready (v1.1, news CORS hardening)
    - Mobile-first, dark by default
    - Real-time WTI/Brent via Yahoo Finance (no API keys)
    - News via RSS with robust CORS chain and HTML scraping fallback
    - Auto-refresh: prices 60s, news 10m; adaptive backoff; pause on background
    - Offline-first display using localStorage caches
    - Works as a single index.html on GitHub Pages; no build, no deps
    - Service worker hook included for optional future sw.js (not required)
  -->

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Real-time WTI and Brent prices with oil-industry news. Mobile-first, works on GitHub Pages." />

  <!-- Social / SEO -->
  <meta property="og:title" content="UR Oil Monitor — Real-Time WTI + Oil News" />
  <meta property="og:description" content="Real-time WTI and Brent prices with oil-industry news. Mobile-first, works offline with cached data." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="data:image/svg+xml;charset=utf-8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'><rect width='100%' height='100%' fill='%230b0f14'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Inter,system-ui,Segoe UI,Roboto,Arial' font-size='64' fill='%23a7b3c6'>UR Oil Monitor</text></svg>" />
  <meta name="twitter:card" content="summary_large_image" />

  <title>UR Oil Monitor — Real-Time WTI + Oil News</title>

  <!-- Minimal PWA Manifest (inline data URL) -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"UR Oil Monitor","short_name":"Oil Monitor","start_url":"./","display":"standalone","background_color":"#0b0f14","theme_color":"#0b0f14","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 256 256%27%3E%3Crect width=%27256%27 height=%27256%27 fill=%27%230b0f14%27/%3E%3Cpath d=%27M128 28c41 58 74 94 74 126a74 74 0 1 1-148 0c0-32 33-68 74-126z%27 fill=%27%23b5e48c%27/%3E%3C/svg%3E","type":"image/svg+xml","sizes":"256x256"}]}' />

  <style>
    :root {
      --bg: #0b0f14;
      --bg-elev: #10161e;
      --bg-press: #0c1219;
      --text: #c9d4e0;
      --text-dim: #a7b3c6;
      --muted: #2a3746;
      --accent: #7cc5ff;
      --good: #4caf50;
      --bad: #e53935;
      --warn: #ffb300;
      --card-radius: 14px;
      --tap: 14px;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7fafc;
        --bg-elev: #ffffff;
        --bg-press: #eef2f7;
        --text: #0f1720;
        --text-dim: #3a4a5c;
        --muted: #d7e0ea;
        --accent: #0366d6;
        --good: #2e7d32;
        --bad: #b71c1c;
        --warn: #b26a00;
        --shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      }
    }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
    }
    * { box-sizing: border-box; }
    a { color: var(--accent); text-decoration: none; }
    a:active { opacity: .8; }

    .app {
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
      padding: env(safe-area-inset-top) 14px calc(env(safe-area-inset-bottom) + 14px);
      max-width: 940px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 4px 0;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: .2px; font-size: 18px;
    }
    .brand .mark {
      width: 28px; height: 28px; border-radius: 8px;
      background: radial-gradient(120% 120% at 30% 30%, #1a2735 0%, #0b0f14 60%),
                  conic-gradient(from 0deg, #2a3746, #0b0f14);
      position: relative; overflow: hidden; box-shadow: var(--shadow);
    }
    .brand .mark::after {
      content: ""; position: absolute; inset: 2px; border-radius: 6px;
      background: radial-gradient(180% 120% at 0% 0%, #b5e48c22 0, transparent 60%);
    }
    .controls { display: flex; gap: 8px; }
    .btn {
      -webkit-tap-highlight-color: transparent;
      background: var(--bg-elev);
      border: 1px solid var(--muted);
      color: var(--text);
      padding: 10px 14px; border-radius: 12px;
      font-weight: 600; font-size: 14px;
      box-shadow: var(--shadow); transform: translateZ(0);
      transition: transform .12s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      touch-action: manipulation;
    }
    .btn:active { transform: scale(.98); background: var(--bg-press); }
    .btn.small { padding: 8px 10px; font-size: 13px; border-radius: 10px; }

    .cards { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 800px) { .cards { grid-template-columns: 1.25fr 1fr; } }

    .card {
      background: var(--bg-elev);
      border: 1px solid var(--muted);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }
    .card header { padding: 12px 14px; border-bottom: 1px solid var(--muted); }
    .section-title {
      font-size: 14px; color: var(--text-dim); text-transform: uppercase; letter-spacing: .14em; font-weight: 700;
    }

    .prices { display: grid; grid-template-rows: auto auto 1fr; gap: 8px; }
    .ticker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 12px 2px; }
    .ticker {
      background: linear-gradient(180deg, transparent, rgba(255,255,255,0.02));
      border: 1px solid var(--muted);
      border-radius: 12px; padding: 10px 12px;
      display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 4px 6px;
    }
    .sym { font-weight: 800; letter-spacing: .3px; }
    .name { color: var(--text-dim); font-size: 12px; }
    .last { font-family: var(--mono); font-variant-numeric: tabular-nums; font-size: 20px; font-weight: 800; }
    .chg { font-family: var(--mono); font-variant-numeric: tabular-nums; font-weight: 700; }
    .chg.up { color: var(--good); }
    .chg.down { color: var(--bad); }
    .meta { color: var(--text-dim); font-size: 11px; }
    .sparks { padding: 0 12px 12px; }
    canvas { width: 100%; height: 56px; display: block; }

    .news-list { list-style: none; margin: 0; padding: 6px 8px 12px; display: grid; gap: 10px; }
    .news-item {
      display: grid; gap: 6px;
      padding: 10px 10px;
      border: 1px solid var(--muted); border-radius: 12px;
      transition: background .2s ease, border-color .2s ease, transform .12s ease;
    }
    .news-item:active { transform: scale(.995); background: var(--bg-press); }
    .news-headline { font-weight: 700; line-height: 1.25; }
    .news-meta { font-size: 12px; color: var(--text-dim); display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { padding: 2px 8px; border: 1px solid var(--muted); border-radius: 999px; font-size: 11px; color: var(--text-dim); }
    .src-ogj { border-color: #6fbf73aa; }
    .src-reuters { border-color: #6fa8ffaa; }
    .src-bloomberg { border-color: #b388ffaa; }
    .src-texas { border-color: #ffb74daa; }
    .src-eia { border-color: #ffd54faa; }

    .statusbar {
      display: flex; gap: 8px; align-items: center; justify-content: space-between;
      padding: 8px 10px 12px; font-size: 12px; color: var(--text-dim);
      border-top: 1px dashed var(--muted);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--good); box-shadow: 0 0 0 3px color-mix(in oklab, var(--good) 30%, transparent); }
    .status-dot.offline { background: var(--warn); }
    .mono { font-family: var(--mono); font-variant-numeric: tabular-nums; }

    .fade-in { animation: fade .25s ease both; }
    @keyframes fade { from { opacity: 0; transform: translateY(2px) } to { opacity: 1; transform: translateY(0) } }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>UR Oil Monitor</div>
      </div>
      <div class="controls">
        <button class="btn small" id="refreshBtn" aria-label="Refresh now">Refresh</button>
        <button class="btn small" id="installBtn" aria-label="Install to Home Screen" hidden>Install</button>
      </div>
    </header>

    <div class="cards">
      <section class="card prices" aria-labelledby="prices-title">
        <header><div class="section-title" id="prices-title">Prices</div></header>
        <div class="ticker-grid">
          <div class="ticker" id="wti">
            <div class="sym">WTI <span class="name">Crude Oil (CL=F)</span></div>
            <div class="last mono" data-field="last">—</div>
            <div class="meta" data-field="time">—</div>
            <div class="chg" data-field="chg">—</div>
          </div>
          <div class="ticker" id="brent">
            <div class="sym">Brent <span class="name">Crude (BZ=F)</span></div>
            <div class="last mono" data-field="last">—</div>
            <div class="meta" data-field="time">—</div>
            <div class="chg" data-field="chg">—</div>
          </div>
        </div>
        <div class="sparks">
          <canvas id="sparkline" width="800" height="160" aria-label="Recent WTI price chart" role="img"></canvas>
        </div>
        <div class="statusbar">
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="status-dot" id="netDot"></span>
            <span id="netStatus">Online</span>
          </div>
          <div>
            <span class="mono">Price refresh: 60s</span> • <span class="mono">News refresh: 10m</span>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="news-title">
        <header><div class="section-title" id="news-title">News</div></header>
        <ul class="news-list" id="newsList" aria-live="polite"></ul>
      </section>
    </div>
  </div>

  <script>
    /* ===== Config ===== */
    const CFG = {
      priceSymbols: {
        WTI: { sym: 'CL=F', el: document.getElementById('wti') },
        BRENT: { sym: 'BZ=F', el: document.getElementById('brent') },
      },
      priceIntervalMs: 60_000,
      newsIntervalMs: 10 * 60_000,
      fetchTimeoutMs: 10_000,
      yahooChartBase: 'https://query1.finance.yahoo.com/v8/finance/chart/',
      // Hardened proxy chain: direct → cors-anywhere → AllOrigins (raw → get/contents) → r.jina.ai mirror
      proxies: [
        u => u,
        u => `https://cors-anywhere.herokuapp.com/${u}`,
        u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
        u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
        u => `https://r.jina.ai/http/${u.replace(/^https?:\/\//,'')}`,
      ],
      rssFeeds: [
        { name: 'Oil & Gas Journal', tagClass: 'src-ogj', url: 'https://www.ogj.com/rss.html', bucket: 'US' },
        { name: 'Reuters Business', tagClass: 'src-reuters', url: 'https://feeds.reuters.com/reuters/businessNews', bucket: 'Global' },
        { name: 'Rigzone', tagClass: 'src-bloomberg', url: 'https://www.rigzone.com/news/rss/', bucket: 'Global' },
        { name: 'Houston Chronicle Energy', tagClass: 'src-texas', url: 'https://www.houstonchronicle.com/business/energy/index.rss', bucket: 'Texas' },
        { name: 'Texas Tribune Energy', tagClass: 'src-texas', url: 'https://www.texastribune.org/energy/feed/atom/', bucket: 'Texas' },
        { name: 'EIA Today in Energy', tagClass: 'src-eia', url: 'https://www.eia.gov/rss/todayinenergy.xml', bucket: 'US' },
      ],
      storageKeys: {
        prices: 'ur.prices.v1',
        spark: 'ur.spark.v1',
        news: 'ur.news.v1',
        meta: 'ur.meta.v1'
      }
    };

    /* ===== Utilities ===== */
    const $ = sel => document.querySelector(sel);
    const fmt = (n, dp=2) => n.toLocaleString(undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp});
    const nowIso = () => new Date().toISOString();
    const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
    const withTimeout = (p, ms) => Promise.race([ p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms)) ]);

    function statusOnline(online) {
      const dot = $('#netDot'); const txt = $('#netStatus');
      if (online) { dot.classList.remove('offline'); txt.textContent = 'Online'; }
      else { dot.classList.add('offline'); txt.textContent = 'Offline (cached)'; }
    }
    window.addEventListener('online', ()=>statusOnline(true));
    window.addEventListener('offline', ()=>statusOnline(false));
    statusOnline(navigator.onLine);

    /* ===== CORS fetch with unified fallback chain ===== */
    async function fetchWithProxies(url, opts = {}) {
      let lastErr = null;
      for (const wrap of CFG.proxies) {
        const wrapped = wrap(url);
        try {
          const resp = await withTimeout(fetch(wrapped, opts), CFG.fetchTimeoutMs);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          // AllOrigins /get returns JSON with { contents }
          if (wrapped.includes('api.allorigins.win/get')) {
            const j = await resp.json();
            return new Response(j.contents, { headers: { 'content-type': 'text/xml; charset=utf-8' } });
          }
          return resp;
        } catch (e) {
          lastErr = e;
          continue;
        }
      }
      throw lastErr || new Error('fetch failed');
    }

    /* ===== Price fetching & rendering ===== */
    async function getYahooPrice(symbol, range='1d', interval='1m') {
      const url = `${CFG.yahooChartBase}${encodeURIComponent(symbol)}?range=${range}&interval=${interval}`;
      const resp = await fetchWithProxies(url, { headers: { 'x-requested-with': 'ur-oil-monitor' }});
      const json = await resp.json();
      const r = json?.chart?.result?.[0];
      if (!r) throw new Error('no result');
      const meta = r.meta || {};
      const ts = r.timestamp || [];
      const close = r.indicators?.quote?.[0]?.close || [];
      const last = close[close.length-1] ?? meta?.regularMarketPrice;
      const prev = meta?.chartPreviousClose ?? meta?.previousClose ?? close.find(v=>v!=null) ?? last;
      return {
        last,
        prevClose: prev,
        change: last - prev,
        changePct: prev ? ((last - prev) / prev * 100) : 0,
        timestamps: ts,
        closes: close
      };
    }

    function renderTicker(el, data) {
      const lastEl = el.querySelector('[data-field="last"]');
      const chgEl = el.querySelector('[data-field="chg"]');
      const timeEl = el.querySelector('[data-field="time"]');
      lastEl.textContent = data.last != null ? fmt(data.last, 2) : '—';
      const up = data.change >= 0;
      chgEl.classList.toggle('up', up);
      chgEl.classList.toggle('down', !up);
      const s = `${data.change>=0?'+':''}${fmt(data.change,2)}  (${data.changePct>=0?'+':''}${fmt(data.changePct,2)}%)`;
      chgEl.textContent = s;
      timeEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
      lastEl.classList.add('fade-in'); chgEl.classList.add('fade-in'); timeEl.classList.add('fade-in');
      setTimeout(()=>{ lastEl.classList.remove('fade-in'); chgEl.classList.remove('fade-in'); timeEl.classList.remove('fade-in'); }, 250);
    }

    function renderSpark(canvas, times, values) {
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);
      const series = values.filter(v=>typeof v==='number' && !isNaN(v));
      if (series.length < 2) return;
      const min = Math.min(...series), max = Math.max(...series);
      const pad = (max-min) * 0.1 || 1e-3;
      const lo = min - pad, hi = max + pad;
      const n = values.length;
      const prev = series[0];
      const yPrev = H - (prev - lo) / (hi - lo) * H;
      ctx.globalAlpha = .7;
      ctx.beginPath(); ctx.moveTo(0,yPrev); ctx.lineTo(W,yPrev);
      ctx.lineWidth = 1; ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.stroke();

      ctx.globalAlpha = 1;
      ctx.beginPath();
      for (let i=0;i<n;i++) {
        const v = values[i]; if (v==null || isNaN(v)) continue;
        const x = (i/(n-1))*W;
        const y = H - (v - lo) / (hi - lo) * H;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      const up = series[series.length-1] >= series[0];
      ctx.lineWidth = 2.25;
      ctx.strokeStyle = getVar(up ? '--good' : '--bad');
      ctx.stroke();
      const g = ctx.createLinearGradient(0,0,0,H);
      const base = hexFromVar(up ? '--good' : '--bad');
      g.addColorStop(0, base + '55');
      g.addColorStop(1, base + '00');
      ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
      ctx.fillStyle = g; ctx.fill();

      function getVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
      function hexFromVar(n){
        const c = getVar(n);
        if (c.startsWith('#')) return c;
        const m = c.match(/(\d+),\s*(\d+),\s*(\d+)/); if(!m) return '#ffffff';
        const h = x=>('0'+Number(x).toString(16)).slice(-2);
        return `#${h(m[1])}${h(m[2])}${h(m[3])}`;
      }
    }

    async function refreshPrices() {
      try {
        const [w, b] = await Promise.all([
          getYahooPrice(CFG.priceSymbols.WTI.sym, '1d', '1m'),
          getYahooPrice(CFG.priceSymbols.BRENT.sym, '1d', '1m')
        ]);
        renderTicker(CFG.priceSymbols.WTI.el, w);
        renderTicker(CFG.priceSymbols.BRENT.el, b);
        renderSpark(document.getElementById('sparkline'), w.timestamps, w.closes);
        localStorage.setItem(CFG.storageKeys.prices, JSON.stringify({ t: Date.now(), w, b }));
        localStorage.setItem(CFG.storageKeys.spark, JSON.stringify({ t: Date.now(), ts: w.timestamps, v: w.closes }));
        markMeta({ lastPriceOk: nowIso() });
        return true;
      } catch (e) {
        const cache = localStorage.getItem(CFG.storageKeys.prices);
        if (cache) {
          const { w, b } = JSON.parse(cache);
          if (w) renderTicker(CFG.priceSymbols.WTI.el, w);
          if (b) renderTicker(CFG.priceSymbols.BRENT.el, b);
          const s = JSON.parse(localStorage.getItem(CFG.storageKeys.spark) || '{}');
          if (s?.v?.length) renderSpark(document.getElementById('sparkline'), s.ts, s.v);
        }
        return false;
      }
    }

    /* ===== RSS fetching with robust handling ===== */
    async function fetchRss(url) {
      const resp = await fetchWithProxies(url, { headers: { 'x-requested-with': 'ur-oil-monitor' }});
      const text = await resp.text();
      return { text, contentType: (resp.headers.get('content-type') || '').toLowerCase() };
    }

    function parseFeed(xmlText, sourceName) {
      const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
      if (doc.querySelector('parsererror')) return [];
      const out = [];
      const rssItems = [...doc.querySelectorAll('item')];
      if (rssItems.length) {
        for (const it of rssItems.slice(0, 25)) {
          out.push({
            title: it.querySelector('title')?.textContent?.trim(),
            link: it.querySelector('link')?.textContent?.trim() || it.querySelector('guid')?.textContent?.trim(),
            pub: it.querySelector('pubDate')?.textContent || it.querySelector('dc\\:date')?.textContent,
            src: sourceName
          });
        }
        return out;
      }
      const atomEntries = [...doc.querySelectorAll('entry')];
      if (atomEntries.length) {
        for (const e of atomEntries.slice(0, 25)) {
          out.push({
            title: e.querySelector('title')?.textContent?.trim(),
            link: e.querySelector('link')?.getAttribute('href'),
            pub: e.querySelector('updated')?.textContent || e.querySelector('published')?.textContent,
            src: sourceName
          });
        }
        return out;
      }
      return [];
    }

    function scrapeHtmlLinks(htmlText, sourceName, baseUrl, tagClass, bucket) {
      const tmp = document.createElement('div');
      tmp.innerHTML = htmlText;
      const anchors = [...tmp.querySelectorAll('a[href]')];
      const items = anchors
        .map(a => ({ title: a.textContent.trim().replace(/\s+/g,' '), href: a.getAttribute('href') }))
        .filter(x => x.title && x.href && !x.href.startsWith('javascript:') && !x.href.startsWith('mailto:'))
        .map(x => {
          let link;
          try { link = new URL(x.href, baseUrl).href; } catch { link = x.href; }
          return { title: x.title || x.text || x.title, link };
        })
        .filter(x => x.title && x.link && !x.link.includes('#'))
        .slice(0, 20)
        .map(x => ({ ...x, pub: null, src: sourceName, bucket, tagClass }));
      return items;
    }

    async function refreshNews() {
      const aggregate = [];
      for (const f of CFG.rssFeeds) {
        try {
          const { text, contentType } = await fetchRss(f.url);
          let items = [];
          const isXml = contentType.includes('xml')
            || text.trim().startsWith('<?xml')
            || text.trim().startsWith('<rss')
            || text.trim().startsWith('<feed');
          if (isXml) {
            items = parseFeed(text, f.name);
          } else {
            items = scrapeHtmlLinks(text, f.name, f.url, f.tagClass, f.bucket);
          }
          aggregate.push(...items.map(x => ({ ...x, bucket: f.bucket, tagClass: f.tagClass })));
        } catch (_) { /* continue */ }
      }
      // Bloomberg energy page scraping (best-effort)
      try {
        const resp = await fetchWithProxies('https://www.bloomberg.com/energy');
        const html = await resp.text();
        aggregate.push(...scrapeHtmlLinks(html, 'Bloomberg', 'https://www.bloomberg.com/energy', 'src-bloomberg', 'Global'));
      } catch (_) { /* optional */ }

      // De-dup + sort
      const seen = new Set();
      const uniq = [];
      for (const it of aggregate) {
        const key = (it.title || '') + (it.link || '');
        if (seen.has(key)) continue;
        seen.add(key); uniq.push(it);
      }
      uniq.sort((a,b)=> (new Date(b.pub||0)) - (new Date(a.pub||0)));

      renderNews(uniq.slice(0, 40));
      localStorage.setItem(CFG.storageKeys.news, JSON.stringify({ t: Date.now(), items: uniq }));
      markMeta({ lastNewsOk: nowIso() });
      return true;
    }

    function timeAgo(d) {
      if (!d) return '';
      const diff = Date.now() - new Date(d).getTime();
      const sec = Math.round(diff/1000);
      if (sec < 60) return `${sec}s`;
      const min = Math.round(sec/60); if (min < 60) return `${min}m`;
      const hr = Math.round(min/60); if (hr < 24) return `${hr}h`;
      const day = Math.round(hr/24); return `${day}d`;
    }

    function renderNews(items) {
      const list = $('#newsList');
      list.innerHTML = '';
      for (const it of items) {
        const li = document.createElement('li');
        li.className = 'news-item fade-in';
        li.innerHTML = `
          <a class="news-headline" href="${it.link}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title || 'Untitled')}</a>
          <div class="news-meta">
            <span class="chip ${it.tagClass||''}">${escapeHtml(it.src||'')}</span>
            <span class="chip">${escapeHtml(it.bucket||'')}</span>
            <span>${it.pub ? escapeHtml(new Date(it.pub).toLocaleString()) : ''} ${it.pub ? '·' : ''} ${escapeHtml(timeAgo(it.pub))}</span>
          </div>
        `;
        list.appendChild(li);
      }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    /* ===== Meta + Persistence ===== */
    function markMeta(patch) {
      const m = JSON.parse(localStorage.getItem(CFG.storageKeys.meta) || '{}');
      localStorage.setItem(CFG.storageKeys.meta, JSON.stringify({ ...m, ...patch }));
    }

    function loadCacheOnBoot() {
      try {
        const p = JSON.parse(localStorage.getItem(CFG.storageKeys.prices) || '{}');
        if (p?.w) renderTicker(CFG.priceSymbols.WTI.el, p.w);
        if (p?.b) renderTicker(CFG.priceSymbols.BRENT.el, p.b);
        const s = JSON.parse(localStorage.getItem(CFG.storageKeys.spark) || '{}');
        if (s?.v) renderSpark(document.getElementById('sparkline'), s.ts, s.v);
        const n = JSON.parse(localStorage.getItem(CFG.storageKeys.news) || '{}');
        if (n?.items?.length) renderNews(n.items.slice(0, 40));
      } catch (_) {}
    }

    /* ===== Schedulers with adaptive backoff ===== */
    let priceTimer = null, newsTimer = null;
    function schedulePrices(delay=CFG.priceIntervalMs) {
      clearTimeout(priceTimer);
      priceTimer = setTimeout(async function tick() {
        const ok = await refreshPrices();
        const next = ok ? CFG.priceIntervalMs : clamp(delay*1.5, CFG.priceIntervalMs, 10*CFG.priceIntervalMs);
        schedulePrices(next);
      }, delay);
    }
    function scheduleNews(delay=CFG.newsIntervalMs) {
      clearTimeout(newsTimer);
      newsTimer = setTimeout(async function tick() {
        const ok = await refreshNews();
        const next = ok ? CFG.newsIntervalMs : clamp(delay*1.5, CFG.newsIntervalMs, 6*CFG.newsIntervalMs);
        scheduleNews(next);
      }, delay);
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        clearTimeout(priceTimer); clearTimeout(newsTimer);
      } else {
        schedulePrices(1000);
        scheduleNews(2000);
      }
    });

    /* ===== Install prompt (PWA) ===== */
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e;
      const btn = document.getElementById('installBtn');
      btn.hidden = false;
      btn.onclick = async () => {
        btn.hidden = true;
        await deferredPrompt.prompt();
        deferredPrompt = null;
      };
    });

    /* ===== Optional Service Worker registration hook ===== */
    (function registerSW(){
      if (!('serviceWorker' in navigator)) return;
      fetch('./sw.js', { method: 'HEAD' })
        .then(r => { if (r.ok) navigator.serviceWorker.register('./sw.js', { scope: './' }); })
        .catch(()=>{ /* no-op */ });
    })();

    /* ===== Boot ===== */
    loadCacheOnBoot();
    refreshPrices();
    refreshNews();
    schedulePrices();
    scheduleNews();

    document.getElementById('refreshBtn').addEventListener('click', () => {
      refreshPrices(); refreshNews();
    });
  </script>

  <!--
    ============================= README (for repo) =============================
    # UR Oil Monitor — Single-file, GitHub Pages (v1.1)

    ## Deploy
    1) Create a new repo with this index.html at root.
    2) Enable GitHub Pages → Deploy from branch → main → /root.
    3) Open https://<user>.github.io/<repo>/.

    ## Data sources (no keys)
    - Prices: Yahoo Finance v8 chart API:
      - WTI (CL=F): https://query1.finance.yahoo.com/v8/finance/chart/CL=F
      - Brent (BZ=F): https://query1.finance.yahoo.com/v8/finance/chart/BZ=F
    - News (RSS/HTML):
      - Oil & Gas Journal: https://www.ogj.com/rss.html
      - Reuters Business: https://feeds.reuters.com/reuters/businessNews
      - Rigzone: https://www.rigzone.com/news/rss/
      - Houston Chronicle Energy: https://www.houstonchronicle.com/business/energy/index.rss
      - Texas Tribune Energy (Atom): https://www.texastribune.org/energy/feed/atom/
      - EIA Today in Energy: https://www.eia.gov/rss/todayinenergy.xml
      - Bloomberg Energy headlines: https://www.bloomberg.com/energy (scrape fallback)

    ## CORS
    - Proxy chain: direct → cors-anywhere → AllOrigins raw → AllOrigins get → r.jina.ai mirror
    - cors-anywhere may require one-time activation (open https://cors-anywhere.herokuapp.com/ and request access).
    - AllOrigins /get returns JSON { contents } and is handled automatically.

    ## Offline
    - LocalStorage caches last successful price payloads and news bundle.
    - App functions in offline mode with cached data and visible status.

    ## UX
    - Mobile-first, dark default, tablet responsive.
    - Touch targets sized; subtle animations; background refresh pause.

    ## Customize
    - Edit CFG.rssFeeds to add/remove sources.
    - Adjust intervals in CFG.priceIntervalMs / CFG.newsIntervalMs.

    ============================================================================
  -->
</body>
</html>