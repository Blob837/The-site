<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>UR NEWS - Terminal Intelligence</title>
<meta name="theme-color" content="#0a0a0a" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Real-time intelligence terminal for breaking news and political analysis">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #0a0a0a;
    --bg-secondary: #0f0f0f;
    --bg-tertiary: #151515;
    --panel: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
    --panel-hover: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
    --line: #1a1a1a;
    --line-bright: #2a2a2a;
    --ink: #f0f0f0;
    --ink-secondary: #d0d0d0;
    --muted: #8a8a8a;
    --muted-dark: #666666;
    --accent: #ff4444;
    --accent-hover: #ff6666;
    --accent-glow: #ff2222;
    --secondary: #666666;
    --secondary-active: #888888;
    --warning: #ffaa44;
    --danger: #ff2244;
    --info: #44aaff;
    --success: #44ff88;
    --popular: #ff44ff;
    --border: #333333;
    --border-hover: #444444;
    --chip: #151515;
    --chip-active: #2a2a2a;
    --glow-red: rgba(255, 68, 68, 0.4);
    --glow-grey: rgba(136, 136, 136, 0.3);
    --glow-blue: rgba(68, 170, 255, 0.4);
    --glow-purple: rgba(255, 68, 255, 0.4);
    --shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.6);
    --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
    --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  
  html {
    background-color: var(--bg);
    scroll-behavior: smooth;
  }
  
  body {
    background: var(--bg);
    color: var(--ink);
    font-family: 'JetBrains Mono', 'SF Mono', ui-monospace, Menlo, Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
    font-weight: 400;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    overflow-x: hidden;
    position: relative;
  }
  
  /* Ultra Enhanced Terminal Effects */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1000;
    background: 
      repeating-linear-gradient(
        90deg, 
        transparent, 
        rgba(255, 68, 68, 0.008) 1px, 
        transparent 2px, 
        transparent 4px
      ),
      repeating-linear-gradient(
        0deg, 
        transparent, 
        rgba(255, 255, 255, 0.005) 1px, 
        transparent 2px, 
        transparent 3px
      );
    animation: crtFlicker 0.15s infinite linear alternate;
    mix-blend-mode: screen;
  }
  
  body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 999;
    background: 
      radial-gradient(ellipse 800px 400px at 20% 30%, rgba(255, 68, 68, 0.15) 0%, transparent 40%),
      radial-gradient(ellipse 800px 400px at 80% 70%, rgba(68, 170, 255, 0.15) 0%, transparent 40%),
      radial-gradient(ellipse 600px 600px at 50% 50%, rgba(255, 68, 255, 0.1) 0%, transparent 50%),
      radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    mix-blend-mode: color-dodge;
    animation: gradientMorph 15s ease-in-out infinite;
  }

  @keyframes gradientMorph {
    0%, 100% { 
      background: 
        radial-gradient(ellipse 800px 400px at 20% 30%, rgba(255, 68, 68, 0.15) 0%, transparent 40%),
        radial-gradient(ellipse 800px 400px at 80% 70%, rgba(68, 170, 255, 0.15) 0%, transparent 40%),
        radial-gradient(ellipse 600px 600px at 50% 50%, rgba(255, 68, 255, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    }
    25% { 
      background: 
        radial-gradient(ellipse 900px 500px at 70% 20%, rgba(255, 68, 68, 0.18) 0%, transparent 45%),
        radial-gradient(ellipse 700px 700px at 30% 80%, rgba(68, 170, 255, 0.12) 0%, transparent 45%),
        radial-gradient(ellipse 500px 800px at 60% 40%, rgba(255, 68, 255, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    }
    50% { 
      background: 
        radial-gradient(ellipse 700px 700px at 80% 70%, rgba(255, 68, 68, 0.2) 0%, transparent 50%),
        radial-gradient(ellipse 900px 400px at 20% 30%, rgba(68, 170, 255, 0.18) 0%, transparent 45%),
        radial-gradient(ellipse 800px 500px at 40% 60%, rgba(255, 68, 255, 0.15) 0%, transparent 55%),
        radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    }
    75% { 
      background: 
        radial-gradient(ellipse 600px 800px at 30% 80%, rgba(255, 68, 68, 0.12) 0%, transparent 40%),
        radial-gradient(ellipse 1000px 300px at 70% 20%, rgba(68, 170, 255, 0.2) 0%, transparent 50%),
        radial-gradient(ellipse 700px 600px at 55% 55%, rgba(255, 68, 255, 0.08) 0%, transparent 45%),
        radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    }
  }

  @keyframes crtFlicker {
    0% { opacity: 1; }
    100% { opacity: 0.985; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(0.98); }
  }

  @keyframes slideIn {
    from {
      transform: translateY(-30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(30px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes glow {
    0%, 100% { 
      box-shadow: 0 0 5px var(--glow-red), 0 0 10px var(--glow-red), 0 0 15px var(--glow-red);
      transform: scale(1);
    }
    50% { 
      box-shadow: 0 0 10px var(--glow-red), 0 0 20px var(--glow-red), 0 0 30px var(--glow-red);
      transform: scale(1.1);
    }
  }

  @keyframes dataStream {
    0% { transform: translateX(-100%); opacity: 0; }
    50% { opacity: 1; }
    100% { transform: translateX(100%); opacity: 0; }
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  @keyframes cardPulse {
    0%, 100% { 
      background-size: 100% 100%;
      filter: brightness(1);
    }
    50% { 
      background-size: 105% 105%;
      filter: brightness(1.05);
    }
  }

  @keyframes popularGlow {
    0%, 100% {
      box-shadow: 
        0 0 20px rgba(255, 68, 255, 0.3),
        0 0 40px rgba(255, 68, 255, 0.2),
        inset 0 0 20px rgba(255, 68, 255, 0.1);
    }
    50% {
      box-shadow: 
        0 0 30px rgba(255, 68, 255, 0.5),
        0 0 60px rgba(255, 68, 255, 0.3),
        inset 0 0 30px rgba(255, 68, 255, 0.2);
    }
  }

  /* Ultra Enhanced Header */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: 
      linear-gradient(180deg, 
        rgba(10, 10, 10, 0.98) 0%, 
        rgba(10, 10, 10, 0.95) 50%,
        rgba(10, 10, 10, 0.9) 100%);
    backdrop-filter: blur(24px) saturate(200%);
    -webkit-backdrop-filter: blur(24px) saturate(200%);
    border-bottom: 2px solid transparent;
    background-clip: padding-box;
    box-shadow: 
      0 0 40px rgba(255, 68, 68, 0.25),
      0 10px 40px rgba(0, 0, 0, 0.6),
      inset 0 1px 0 rgba(255, 255, 255, 0.05),
      inset 0 -1px 0 rgba(255, 68, 68, 0.5);
    position: relative;
  }

  header::before {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
      transparent, 
      var(--accent) 20%, 
      var(--info) 50%, 
      var(--accent) 80%, 
      transparent);
    animation: shimmer 3s ease-in-out infinite;
  }
  
  .bar {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem 1.2rem;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(255, 68, 68, 0.02), 
      rgba(68, 170, 255, 0.02),
      transparent);
    position: relative;
  }
  
  .title {
    font-weight: 800;
    letter-spacing: 2px;
    font-size: 1.4rem;
    flex: 1;
    background: linear-gradient(135deg, 
      var(--accent) 0%, 
      var(--info) 50%, 
      var(--accent) 100%);
    background-size: 200% 200%;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    animation: shimmer 4s ease-in-out infinite;
    filter: drop-shadow(0 0 20px rgba(255, 68, 68, 0.5));
  }
  
  .title::after {
    content: 'â–ˆ';
    background: var(--accent);
    background-clip: text;
    -webkit-background-clip: text;
    animation: pulse 1s infinite;
    margin-left: 4px;
    font-size: 0.9em;
  }
  
  .blip {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, 
      rgba(255, 255, 255, 0.8), 
      var(--accent) 40%, 
      var(--accent-glow) 100%);
    margin-right: 0.8rem;
    box-shadow: 
      0 0 20px var(--accent),
      0 0 40px var(--accent),
      inset 0 0 10px rgba(255, 255, 255, 0.5);
    animation: glow 2s infinite ease-in-out;
    position: relative;
    flex-shrink: 0;
  }
  
  .meta {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
    background: linear-gradient(90deg, 
      var(--muted), 
      var(--accent), 
      var(--info), 
      var(--popular),
      var(--muted));
    background-size: 300% 300%;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 5s ease-in-out infinite;
  }
  
  /* Ultra Enhanced Filters */
  .filters {
    display: flex;
    gap: 0.6rem;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 0 1.2rem 1rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }

  .filters::before,
  .filters::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 40px;
    pointer-events: none;
    z-index: 1;
  }

  .filters::before {
    left: 0;
    background: linear-gradient(90deg, var(--bg) 0%, transparent 100%);
  }

  .filters::after {
    right: 0;
    background: linear-gradient(270deg, var(--bg) 0%, transparent 100%);
  }
  
  .filters::-webkit-scrollbar {
    display: none;
  }
  
  .chip {
    white-space: nowrap;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: linear-gradient(135deg, var(--chip) 0%, rgba(255, 255, 255, 0.02) 100%);
    color: var(--muted);
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    min-width: fit-content;
  }

  .chip::before {
    content: "";
    position: absolute;
    inset: -2px;
    background: linear-gradient(45deg, 
      transparent, 
      rgba(255, 68, 68, 0.3), 
      transparent);
    transform: translateX(-100%);
    transition: transform 0.5s ease;
    opacity: 0;
  }

  .chip:hover::before {
    transform: translateX(100%);
    opacity: 1;
  }
  
  .chip:hover {
    border-color: var(--accent);
    color: var(--ink);
    background: linear-gradient(135deg, 
      rgba(255, 68, 68, 0.1) 0%, 
      rgba(255, 68, 68, 0.05) 100%);
    box-shadow: 
      0 0 20px rgba(255, 68, 68, 0.3),
      var(--shadow-light);
    transform: translateY(-2px) scale(1.05);
  }
  
  .chip.active {
    background: linear-gradient(135deg, 
      var(--accent) 0%, 
      rgba(255, 68, 68, 0.8) 100%);
    color: var(--bg);
    border-color: var(--accent);
    box-shadow: 
      0 0 30px var(--glow-red),
      0 0 60px var(--glow-red),
      inset 0 0 20px rgba(0, 0, 0, 0.3);
    font-weight: 700;
    animation: pulse 2s infinite;
  }

  .chip[data-view="popular"] {
    border-color: var(--popular);
  }

  .chip[data-view="popular"]:hover {
    background: linear-gradient(135deg, 
      rgba(255, 68, 255, 0.1) 0%, 
      rgba(255, 68, 255, 0.05) 100%);
    box-shadow: 
      0 0 20px rgba(255, 68, 255, 0.3),
      var(--shadow-light);
  }

  .chip[data-view="popular"].active {
    background: linear-gradient(135deg, 
      var(--popular) 0%, 
      rgba(255, 68, 255, 0.8) 100%);
    box-shadow: 
      0 0 30px var(--glow-purple),
      0 0 60px var(--glow-purple);
  }
  
  /* Main Content */
  main {
    padding: 1.5rem 1.2rem;
    max-width: 1000px;
    margin: 0 auto;
    padding-bottom: 4rem;
    position: relative;
  }
  
  /* Stats Section */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }
  
  .stat {
    text-align: center;
    padding: 0.8rem;
    background: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.02) 0%, 
      rgba(255, 255, 255, 0.01) 100%);
    border-radius: 12px;
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .stat::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, 
      transparent, 
      rgba(255, 68, 68, 0.1), 
      transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .stat:hover::before {
    opacity: 1;
  }

  .stat:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
    box-shadow: 
      0 10px 30px rgba(255, 68, 68, 0.2),
      var(--shadow-medium);
  }
  
  .stat-value {
    display: block;
    font-size: 1.3rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--info));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px var(--glow-red));
  }
  
  .stat-label {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 0.2rem;
  }
  
  /* Enhanced Cards */
  .card {
    background: linear-gradient(135deg, 
      var(--bg-secondary) 0%, 
      var(--bg-tertiary) 100%);
    border: 1px solid var(--line);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-medium);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    margin-bottom: 1.2rem;
    transform-origin: center;
  }

  .card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, 
      var(--accent), 
      var(--info), 
      var(--warning),
      var(--accent));
    background-size: 300% 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
    animation: shimmer 3s linear infinite;
  }

  .card:hover::before {
    opacity: 1;
  }

  .card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow:
      var(--shadow-heavy),
      0 0 40px rgba(255, 68, 68, 0.15);
    border-color: rgba(255, 68, 68, 0.3);
    background: linear-gradient(135deg, 
      rgba(255, 68, 68, 0.05) 0%, 
      var(--bg-tertiary) 100%);
  }

  .card.open {
    background: linear-gradient(135deg,
      rgba(255, 68, 68, 0.08) 0%,
      rgba(68, 170, 255, 0.05) 50%,
      rgba(255, 170, 68, 0.08) 100%);
    box-shadow:
      var(--shadow-heavy),
      0 0 50px rgba(255, 68, 68, 0.2),
      inset 0 0 30px rgba(255, 68, 68, 0.05);
    border-color: rgba(255, 68, 68, 0.5);
    transform: translateY(-2px) scale(1.005);
    animation: cardPulse 4s ease-in-out infinite;
  }

  .card.open::before {
    opacity: 1;
  }

  .card.popular {
    border-color: rgba(255, 68, 255, 0.3);
    animation: popularGlow 3s ease-in-out infinite;
  }

  .card.popular::before {
    background: linear-gradient(90deg, 
      var(--popular), 
      var(--accent), 
      var(--popular),
      var(--info));
  }

  .card-head {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0.8rem;
    align-items: flex-start;
    padding: 1.2rem;
    cursor: pointer;
    position: relative;
    transition: background 0.2s ease;
  }
  
  .card-head:hover {
    background: linear-gradient(135deg, 
      rgba(255, 255, 255, 0.02) 0%, 
      transparent 100%);
  }
  
  .favicon {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    background: var(--chip);
    display: inline-block;
    background-size: cover;
    background-position: center;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-light);
    flex-shrink: 0;
    margin-top: 2px;
    transition: all 0.3s ease;
  }

  .card:hover .favicon {
    transform: rotate(5deg) scale(1.1);
    box-shadow: 
      0 0 20px rgba(255, 68, 68, 0.3),
      var(--shadow-light);
  }
  
  .titleline {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.3;
    color: var(--ink);
    margin-bottom: 0.5rem;
    transition: color 0.2s ease;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }
  
  .card-head:hover .titleline {
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
  }
  
  .tag {
    font-size: 0.7rem;
    color: var(--muted);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    flex-wrap: wrap;
    margin-top: 0.3rem;
  }
  
  .badge {
    font-size: 0.6rem;
    font-weight: 700;
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--ink);
    background: var(--chip);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    flex-shrink: 0;
    transition: all 0.3s ease;
  }
  
  .badge.alarm {
    border-color: #ff4444;
    color: #ff8888;
    background: linear-gradient(135deg, #2a1010, #3a1515);
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
  }
  
  .badge.angry {
    border-color: #ff6644;
    color: #ffaa88;
    background: linear-gradient(135deg, #2a1510, #3a2010);
    box-shadow: 0 0 15px rgba(255, 102, 68, 0.3);
  }
  
  .badge.grim {
    border-color: #666;
    color: #aaa;
    background: linear-gradient(135deg, #1a1a1a, #252525);
  }
  
  .badge.hope {
    border-color: #44ff44;
    color: #88ff88;
    background: linear-gradient(135deg, #102a10, #153a15);
    box-shadow: 0 0 15px rgba(68, 255, 68, 0.3);
  }
  
  .badge.neutral {
    border-color: #4488ff;
    color: #88bbff;
    background: linear-gradient(135deg, #101520, #151a30);
    box-shadow: 0 0 15px rgba(68, 136, 255, 0.3);
  }

  .popularity-score {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: linear-gradient(135deg, var(--popular), rgba(255, 68, 255, 0.8));
    color: white;
    font-size: 0.55rem;
    font-weight: 700;
    padding: 0.15rem 0.4rem;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 0 15px rgba(255, 68, 255, 0.4);
  }

  .breaking-indicator {
    display: inline-block;
    background: linear-gradient(135deg, var(--danger), rgba(255, 34, 68, 0.8));
    color: white;
    font-size: 0.55rem;
    font-weight: 700;
    padding: 0.15rem 0.4rem;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 0.3rem;
    animation: pulse 1.5s infinite;
    box-shadow: 0 0 15px rgba(255, 34, 68, 0.5);
    flex-shrink: 0;
  }
  
  .time {
    font-size: 0.7rem;
    color: var(--muted);
    font-weight: 500;
    white-space: nowrap;
  }
  
  .expand-btn {
    color: var(--muted);
    font-size: 1.1rem;
    transition: all 0.3s ease;
    user-select: none;
    flex-shrink: 0;
  }

  .card:hover .expand-btn {
    color: var(--accent);
    transform: rotate(90deg);
  }

  .card.open .expand-btn {
    color: var(--accent);
    transform: rotate(180deg);
  }
  
  .card-body {
    padding: 1.2rem;
    font-size: 0.85rem;
    color: var(--ink-secondary);
    line-height: 1.5;
    display: none;
    background: linear-gradient(180deg, 
      rgba(0, 0, 0, 0.3) 0%, 
      rgba(0, 0, 0, 0.5) 100%);
    border-top: 1px solid rgba(255, 68, 68, 0.2);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  
  .card.open .card-body {
    display: block;
    animation: slideUp 0.3s ease-out;
  }

  .card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .article-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: linear-gradient(135deg, var(--accent), rgba(255, 68, 68, 0.8));
    color: var(--bg) !important;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-light);
    text-decoration: none;
    flex: 1;
    justify-content: center;
    border: 1px solid transparent;
  }
  
  .article-link:hover {
    background: linear-gradient(135deg, var(--accent-hover), var(--accent));
    box-shadow: 
      0 0 30px rgba(255, 68, 68, 0.4),
      var(--shadow-medium);
    transform: translateY(-2px);
  }

  .read-btn {
    background: linear-gradient(135deg, var(--info), rgba(68, 170, 255, 0.8));
  }

  .read-btn:hover {
    background: linear-gradient(135deg, rgba(68, 170, 255, 1), var(--info));
    box-shadow: 
      0 0 30px rgba(68, 170, 255, 0.4),
      var(--shadow-medium);
  }
  
  /* Article Reader Modal */
  .reader-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.98);
    backdrop-filter: blur(20px);
    z-index: 2000;
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .reader-modal.active {
    display: flex;
    flex-direction: column;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .reader-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: linear-gradient(180deg, 
      rgba(10, 10, 10, 0.95) 0%, 
      rgba(10, 10, 10, 0.9) 100%);
    border-bottom: 2px solid var(--accent);
    box-shadow: 0 0 30px rgba(255, 68, 68, 0.3);
  }

  .reader-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--accent);
    flex: 1;
    margin-right: 1rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .reader-close {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-size: 1.5rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);
  }

  .reader-close:hover {
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 0 30px rgba(255, 68, 68, 0.6);
  }

  .reader-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }

  .reader-content {
    color: var(--ink-secondary);
    font-size: 0.95rem;
    line-height: 1.8;
  }

  .reader-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: var(--accent);
    font-size: 0.9rem;
    animation: pulse 1.5s infinite;
  }

  .reader-error {
    color: var(--danger);
    text-align: center;
    padding: 2rem;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    color: var(--ink);
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    z-index: 3000;
    font-weight: 600;
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border);
    animation: slideUp 0.3s ease-out;
    max-width: 85%;
    text-align: center;
    font-size: 0.8rem;
  }
  
  .toast.success {
    border-color: var(--success);
    box-shadow: 0 0 30px rgba(68, 255, 136, 0.3);
  }
  
  .toast.error {
    border-color: var(--danger);
    box-shadow: 0 0 30px rgba(255, 34, 68, 0.3);
  }

  /* Buttons */
  .btn.reset {
    border: 2px solid var(--warning);
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    color: var(--ink);
    padding: 0.6rem 0.9rem;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: fixed;
    bottom: 1.2rem;
    right: 1.2rem;
    z-index: 100;
    box-shadow: 0 0 20px rgba(255, 170, 68, 0.2);
    overflow: hidden;
  }
  
  .btn.reset::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(45deg, transparent, rgba(255, 170, 68, 0.2), transparent);
    transform: translateX(-100%);
    transition: transform 0.4s ease;
  }
  
  .btn.reset:hover {
    background: linear-gradient(135deg, var(--warning), rgba(255, 170, 68, 0.8));
    color: var(--bg);
    box-shadow: 
      0 0 35px rgba(255, 170, 68, 0.4),
      var(--shadow-heavy);
    transform: translateY(-3px) scale(1.05);
  }
  
  .btn.reset:hover::before {
    transform: translateX(100%);
  }

  /* Loading skeleton */
  .skeleton {
    background: linear-gradient(90deg, 
      var(--bg-secondary) 0%, 
      var(--line) 50%, 
      var(--bg-secondary) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
    height: 120px;
    margin-bottom: 1rem;
  }

  /* Empty state */
  .empty {
    color: var(--muted);
    text-align: center;
    padding: 3rem 1.5rem;
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-light);
  }
  
  .empty h3 {
    background: linear-gradient(135deg, var(--accent), var(--info));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .card-actions {
      flex-direction: column;
    }
    
    .article-link {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .bar {
      padding: 0.7rem 0.8rem;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    
    .title {
      font-size: 1.1rem;
      letter-spacing: 1px;
    }
    
    .filters {
      padding: 0 0.8rem 0.8rem;
      gap: 0.4rem;
    }
    
    .chip {
      padding: 0.35rem 0.7rem;
      font-size: 0.6rem;
      border-radius: 16px;
    }
    
    main {
      padding: 1rem 0.8rem;
      padding-bottom: 3.5rem;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.6rem;
    }
    
    .reader-body {
      padding: 1rem;
    }
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">
      <span class="blip"></span>UR NEWS
      <span class="meta" id="lastUpdated">â€¢ INITIALIZING FEEDS</span>
    </div>
  </div>
  <div class="filters" id="filters">
    <div class="chip active" data-view="all">ALL SOURCES</div>
    <div class="chip" data-view="popular">ðŸ”¥ POPULAR</div>
    <div class="chip" data-view="by-source">BY SOURCE</div>
    <div class="chip" data-view="conservative">CONSERVATIVE</div>
    <div class="chip" data-view="populist">POPULIST</div>
    <div class="chip" data-view="breaking">BREAKING</div>
  </div>
</header>

<main>
  <div class="toggle-section open" id="statsSection">
    <div class="toggle-header">
      <span class="toggle-title">Intelligence Overview</span>
      <span class="toggle-arrow">â–¼</span>
    </div>
    <div class="toggle-content">
      <div class="stats-grid" id="statsBar">
        <div class="stat">
          <span class="stat-value" id="totalArticles">0</span>
          <span class="stat-label">Articles</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="activeSources">0</span>
          <span class="stat-label">Sources</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="breakingCount">0</span>
          <span class="stat-label">Breaking</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="popularCount">0</span>
          <span class="stat-label">Popular</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="src-grid" id="sourceToggles"></div>
  <div class="list" id="feedList"></div>
  <div class="empty" id="emptyMsg" style="display:none;">
    <h3>NO ACTIVE FEEDS</h3>
    <p>Enable sources above or wait for auto-refresh cycle</p>
  </div>
</main>

<div class="reader-modal" id="readerModal">
  <div class="reader-header">
    <div class="reader-title" id="readerTitle"></div>
    <button class="reader-close" id="readerClose">Ã—</button>
  </div>
  <div class="reader-body">
    <div id="readerContent"></div>
  </div>
</div>

<button class="btn reset" id="resetBtn" title="Reset all sources and settings">RESET</button>

<script>
/* ================= OPTIMIZED PRODUCTION SYSTEM ================= */

const SOURCES = [
  { id:'breitbart',   name:'Breitbart',            url:'https://www.breitbart.com/feed/',                     lane:'populist' },
  { id:'federalist',  name:'The Federalist',       url:'https://thefederalist.com/feed/',                     lane:'conservative' },
  { id:'dailywire',   name:'Daily Wire',           url:'https://www.dailywire.com/feeds/rss.xml',             lane:'conservative' },
  { id:'gateway',     name:'Gateway Pundit',       url:'https://www.thegatewaypundit.com/feed/',              lane:'populist' },
  { id:'infowars',    name:'InfoWars',             url:'https://www.infowars.com/rss.xml',                    lane:'populist' },
  { id:'revolver',    name:'Revolver News',        url:'https://www.revolver.news/feed/',                     lane:'populist' },
  { id:'natfile',     name:'National File',        url:'https://nationalfile.com/feed/',                      lane:'populist' },
  { id:'tplvoice',    name:"People's Voice",       url:'https://thepeoplesvoice.tv/feed/',                    lane:'populist' },
  { id:'libertydaily',name:'Liberty Daily',        url:'https://thelibertydaily.com/rss.xml',                 lane:'populist' },
  { id:'naturalnews', name:'Natural News',         url:'https://www.naturalnews.com/rss.xml',                 lane:'populist' },
  { id:'dailycaller', name:'Daily Caller',         url:'https://dailycaller.com/feed/',                       lane:'conservative' },
  { id:'redstate',    name:'RedState',             url:'https://redstate.com/feed/',                          lane:'conservative' },
  { id:'amgreat',     name:'AmGreatness',          url:'https://amgreatness.com/feed/',                       lane:'conservative' },
  { id:'pjm',         name:'PJ Media',             url:'https://pjmedia.com/feeds/latest',                    lane:'conservative' },
  { id:'nypost',      name:'NY Post',              url:'https://nypost.com/feed/',                            lane:'populist' },
  { id:'townhall',    name:'Townhall',             url:'https://townhall.com/rss',                            lane:'conservative' },
  { id:'foxnews',     name:'Fox News',             url:'https://feeds.foxnews.com/foxnews/latest',            lane:'conservative' },
  { id:'washexam',    name:'Washington Examiner',  url:'https://www.washingtonexaminer.com/feed',             lane:'conservative' },
  { id:'theblaze',    name:'The Blaze',            url:'https://www.theblaze.com/feeds/latest.rss',           lane:'conservative' }
];

const STATE = {
  enabled: new Set(loadEnabled() || SOURCES.map(s=>s.id)),
  items: [],
  view: 'all',
  lastSolo: null,
  loading: false,
  lastFetch: 0,
  autoRefreshTimer: null,
  cache: new Map(),
  expandedCards: new Set(),
  popularityScores: new Map(),
  viewCounts: new Map()
};

// Optimized caching with IndexedDB fallback
const CACHE_TTL = 120000;
const MAX_MEMORY_CACHE = 30;

class SmartCache {
  constructor() {
    this.memory = new Map();
    this.initDB();
  }

  async initDB() {
    if (!window.indexedDB) return;
    try {
      const request = indexedDB.open('URNewsCache', 1);
      request.onsuccess = (e) => { this.db = e.target.result; };
      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('feeds')) {
          db.createObjectStore('feeds', { keyPath: 'url' });
        }
      };
    } catch(e) { console.warn('IndexedDB init failed:', e); }
  }

  async get(url) {
    // Check memory first
    const memCache = this.memory.get(url);
    if (memCache && Date.now() - memCache.timestamp < CACHE_TTL) {
      return memCache.data;
    }

    // Check IndexedDB
    if (this.db) {
      try {
        return await new Promise((resolve, reject) => {
          const trans = this.db.transaction(['feeds'], 'readonly');
          const request = trans.objectStore('feeds').get(url);
          request.onsuccess = () => {
            const result = request.result;
            if (result && Date.now() - result.timestamp < CACHE_TTL) {
              this.memory.set(url, result);
              resolve(result.data);
            } else {
              resolve(null);
            }
          };
          request.onerror = () => resolve(null);
        });
      } catch(e) { return null; }
    }
    return null;
  }

  async set(url, data) {
    const entry = { url, data, timestamp: Date.now() };
    
    // Memory cache with LRU
    if (this.memory.size >= MAX_MEMORY_CACHE) {
      const firstKey = this.memory.keys().next().value;
      this.memory.delete(firstKey);
    }
    this.memory.set(url, entry);

    // IndexedDB
    if (this.db) {
      try {
        const trans = this.db.transaction(['feeds'], 'readwrite');
        trans.objectStore('feeds').put(entry);
      } catch(e) { console.warn('IndexedDB write failed:', e); }
    }
  }
}

const cache = new SmartCache();

// Popularity tracking
function updatePopularity(item) {
  const key = item.link;
  const current = STATE.popularityScores.get(key) || 0;
  const views = STATE.viewCounts.get(key) || 0;
  
  // Decay old popularity scores
  STATE.popularityScores.forEach((score, k) => {
    if (k !== key) STATE.popularityScores.set(k, score * 0.95);
  });
  
  // Boost current item
  const timeFactor = Math.max(0, 1 - (Date.now() - new Date(item.pubDate)) / (24*60*60*1000));
  const score = current + 1 + (timeFactor * 2) + (views * 0.1);
  STATE.popularityScores.set(key, score);
  
  return score;
}

function trackView(item) {
  const key = item.link;
  const views = STATE.viewCounts.get(key) || 0;
  STATE.viewCounts.set(key, views + 1);
  updatePopularity(item);
}

// Ultra-fast parallel fetch
async function fetchTextUltraFast(url) {
  const cached = await cache.get(url);
  if (cached) return cached;

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 5000);

  try {
    const proxies = [
      fetch(url, { 
        mode: 'cors', 
        cache: 'no-cache',
        signal: controller.signal 
      }),
      fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url), { 
        signal: controller.signal 
      })
    ];

    const result = await Promise.race(proxies);
    clearTimeout(timeout);
    
    if (!result.ok) throw new Error(`HTTP ${result.status}`);
    const text = await result.text();
    
    if (text && text.length > 100) {
      await cache.set(url, text);
      return text;
    }
    throw new Error('Empty response');
  } catch(e) {
    clearTimeout(timeout);
    throw e;
  }
}

function parseRSS(xmlString, source) {
  const doc = new DOMParser().parseFromString(xmlString, 'text/xml');
  if (doc.getElementsByTagName('parsererror')[0]) return [];

  return Array.from(doc.querySelectorAll('item, entry'))
    .slice(0, 20)
    .map(item => {
      const title = (item.querySelector('title')?.textContent || '').trim();
      const link = (item.querySelector('link')?.getAttribute('href') || 
                   item.querySelector('link')?.textContent || '').trim();
      const pubDate = (item.querySelector('pubDate, updated, published')?.textContent || '').trim();
      const desc = (item.querySelector('description, summary, content\\:encoded')?.textContent || '').trim();
      
      return {
        title,
        link,
        pubDate: pubDate || new Date().toISOString(),
        source: source.name,
        lane: source.lane,
        id: source.id,
        desc: stripHTML(desc).slice(0, 300),
        isBreaking: isBreakingNews(title, desc),
        popularity: STATE.popularityScores.get(link) || 0
      };
    })
    .filter(x => x.title && x.link && !isLikelyAd(x));
}

function isLikelyAd(item) {
  const text = (item.title + " " + item.desc).toLowerCase();
  const adPatterns = /sponsored|advertisement|promo|deal:|shop|buy now|subscribe|newsletter|podcast:|video:|% off|save \$/i;
  return adPatterns.test(text) || item.title.length < 15;
}

function isBreakingNews(title, desc) {
  const text = (title + " " + desc).toLowerCase();
  return /breaking|urgent|alert|just in|developing|happening now|exclusive|bombshell/i.test(text);
}

function sentimentAnalysis(title, desc) {
  const text = (title + " " + desc).toLowerCase();
  
  const scores = {
    positive: (text.match(/victory|triumph|success|wins?|boom|surge|rally|record high/gi) || []).length * 2,
    alarm: (text.match(/emergency|crisis|catastrophe|shooting|attack|terror|dead|war/gi) || []).length * -4,
    angry: (text.match(/fraud|rigged|corrupt|betrayal|scandal|arrest|impeach/gi) || []).length * -3,
    grim: (text.match(/recession|inflation|shortage|decline|crime|layoffs/gi) || []).length * -2
  };
  
  const total = Object.values(scores).reduce((a, b) => a + b, 0);
  
  if (total >= 3) return { tag: "POSITIVE", cls: "hope" };
  if (total <= -4) return { tag: "CRITICAL", cls: "alarm" };
  if (total <= -3) return { tag: "HOSTILE", cls: "angry" };
  if (total <= -1) return { tag: "NEGATIVE", cls: "grim" };
  return { tag: "NEUTRAL", cls: "neutral" };
}

function stripHTML(html) {
  const temp = document.createElement('div');
  temp.innerHTML = html;
  return (temp.textContent || temp.innerText || '').replace(/\s+/g, ' ').trim();
}

function saveEnabled() {
  localStorage.setItem('urnews.enabled', JSON.stringify([...STATE.enabled]));
  localStorage.setItem('urnews.expanded', JSON.stringify([...STATE.expandedCards]));
}

function loadEnabled() {
  try { 
    const expanded = JSON.parse(localStorage.getItem('urnews.expanded'));
    if (expanded) STATE.expandedCards = new Set(expanded);
    return JSON.parse(localStorage.getItem('urnews.enabled'));
  } catch(e) { 
    return null;
  }
}

// Ultra-optimized feed loader
async function loadFeeds() {
  if (STATE.loading) return;
  STATE.loading = true;
  STATE.lastFetch = Date.now();
  
  const loadingToast = toast('Loading feeds...', 'info');
  
  try {
    const enabledSources = SOURCES.filter(s => STATE.enabled.has(s.id));
    
    // Parallel fetch all at once for speed
    const promises = enabledSources.map(async source => {
      try {
        const text = await fetchTextUltraFast(source.url);
        return parseRSS(text, source);
      } catch (e) {
        console.warn(`Failed: ${source.name}`);
        return [];
      }
    });
    
    const results = await Promise.allSettled(promises);
    const allItems = results
      .filter(r => r.status === 'fulfilled')
      .flatMap(r => r.value)
      .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
    
    STATE.items = allItems.slice(0, 150);
    
    updateStats();
    render();
    
    document.getElementById('lastUpdated').textContent = 
      `â€¢ UPDATED ${new Date().toLocaleTimeString()}`;
    
    if (loadingToast) loadingToast.remove();
    toast(`Loaded ${STATE.items.length} articles`, 'success');
    
  } catch (error) {
    console.error('Feed failed:', error);
    if (loadingToast) loadingToast.remove();
    toast('Feed loading failed', 'error');
  } finally {
    STATE.loading = false;
  }
}

function updateStats() {
  const filtered = STATE.items.filter(item => STATE.enabled.has(item.id));
  const breaking = filtered.filter(item => item.isBreaking);
  const popular = filtered.filter(item => (STATE.popularityScores.get(item.link) || 0) > 5);
  
  document.getElementById('totalArticles').textContent = filtered.length;
  document.getElementById('activeSources').textContent = STATE.enabled.size;
  document.getElementById('breakingCount').textContent = breaking.length;
  document.getElementById('popularCount').textContent = popular.length;
}

// Article reader
async function openReader(item) {
  const modal = document.getElementById('readerModal');
  const title = document.getElementById('readerTitle');
  const content = document.getElementById('readerContent');
  
  modal.classList.add('active');
  title.textContent = item.title;
  content.innerHTML = '<div class="reader-loading">LOADING ARTICLE...</div>';
  
  try {
    const response = await fetch('https://r.jina.ai/' + item.link);
    const text = await response.text();
    
    // Clean and format content
    const cleanText = text
      .replace(/^.*?\n\n/, '') // Remove headers
      .replace(/\n{3,}/g, '\n\n') // Clean spacing
      .split('\n')
      .map(p => p.trim())
      .filter(p => p && p.length > 20)
      .map(p => `<p>${p}</p>`)
      .join('');
    
    content.innerHTML = `<div class="reader-content">${cleanText || 'Unable to load article content.'}</div>`;
  } catch (e) {
    content.innerHTML = `<div class="reader-error">Failed to load article. Please visit the source directly.</div>`;
  }
}

function createCard(item) {
  const article = document.createElement('article');
  const cardId = btoa(item.link).slice(0, 16);
  const isExpanded = STATE.expandedCards.has(cardId);
  const isPopular = (STATE.popularityScores.get(item.link) || 0) > 5;
  
  article.className = `card ${isExpanded ? 'open' : ''} ${isPopular ? 'popular' : ''}`;
  article.dataset.cardId = cardId;
  
  const hostname = new URL(item.link).hostname;
  const sentiment = sentimentAnalysis(item.title, item.desc);
  const timeString = fmtTime(item.pubDate);
  const popularityScore = Math.round(STATE.popularityScores.get(item.link) || 0);
  
  article.innerHTML = `
    <div class="card-head" role="button" tabindex="0" aria-expanded="${isExpanded}">
      <span class="favicon" style="background-image:url('https://www.google.com/s2/favicons?domain=${hostname}&sz=64');" aria-hidden="true"></span>
      <div>
        <div class="titleline">
          ${escapeHTML(item.title)}
          ${item.isBreaking ? '<span class="breaking-indicator">BREAKING</span>' : ''}
          ${isPopular ? `<span class="popularity-score">ðŸ”¥ ${popularityScore}</span>` : ''}
        </div>
        <div class="tag">
          ${escapeHTML(item.source)} â€¢ <span class="time">${escapeHTML(timeString)}</span>
          <span class="badge ${sentiment.cls}">${sentiment.tag}</span>
        </div>
      </div>
      <div class="expand-btn">â–¶</div>
    </div>
    <div class="card-body">
      <div>${escapeHTML(item.desc || 'No summary available.')}</div>
      <div class="card-actions">
        <a href="${escapeHTML(item.link)}" target="_blank" rel="noopener" class="article-link">
          OPEN SOURCE â†—
        </a>
        <button class="article-link read-btn" data-link="${escapeHTML(item.link)}" data-title="${escapeHTML(item.title)}">
          READ HERE ðŸ“–
        </button>
      </div>
    </div>
  `;
  
  const header = article.querySelector('.card-head');
  const expandBtn = article.querySelector('.expand-btn');
  const readBtn = article.querySelector('.read-btn');
  
  const toggleCard = () => {
    const isOpen = article.classList.toggle('open');
    header.setAttribute('aria-expanded', isOpen);
    expandBtn.textContent = isOpen ? 'â–¼' : 'â–¶';
    
    if (isOpen) {
      STATE.expandedCards.add(cardId);
      trackView(item);
      // Close other cards
      document.querySelectorAll('.card.open').forEach(card => {
        if (card !== article) {
          card.classList.remove('open');
          const otherBtn = card.querySelector('.expand-btn');
          if (otherBtn) otherBtn.textContent = 'â–¶';
          STATE.expandedCards.delete(card.dataset.cardId);
        }
      });
    } else {
      STATE.expandedCards.delete(cardId);
    }
    saveEnabled();
  };

  header.addEventListener('click', toggleCard);
  
  readBtn.addEventListener('click', (e) => {
    e.preventDefault();
    openReader(item);
  });
  
  addLongPress(header, () => {
    window.open(item.link, '_blank', 'noopener');
    toast('Opening in new tab...', 'info');
  });
  
  return article;
}

function render() {
  const feedList = document.getElementById('feedList');
  const emptyMsg = document.getElementById('emptyMsg');
  
  // Show loading skeletons during fetch
  if (STATE.loading && feedList.children.length === 0) {
    feedList.innerHTML = Array(5).fill('<div class="skeleton"></div>').join('');
    return;
  }
  
  feedList.innerHTML = '';
  
  let filteredItems = STATE.items.filter(item => STATE.enabled.has(item.id));
  
  // Apply view filters
  switch (STATE.view) {
    case 'popular':
      filteredItems = filteredItems
        .map(item => ({
          ...item,
          popularity: STATE.popularityScores.get(item.link) || 0
        }))
        .sort((a, b) => b.popularity - a.popularity)
        .slice(0, 50);
      break;
    case 'conservative':
      filteredItems = filteredItems.filter(item => item.lane === 'conservative');
      break;
    case 'populist':
      filteredItems = filteredItems.filter(item => item.lane === 'populist');
      break;
    case 'breaking':
      filteredItems = filteredItems.filter(item => item.isBreaking);
      break;
    case 'by-source':
      const grouped = {};
      filteredItems.forEach(item => {
        if (!grouped[item.source]) grouped[item.source] = [];
        grouped[item.source].push(item);
      });
      
      Object.keys(grouped).sort().forEach(sourceName => {
        const header = document.createElement('div');
        header.style.cssText = `
          margin: 2rem 0 1.5rem;
          font-size: 1.1rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 1.5px;
          border-bottom: 2px solid var(--line);
          padding-bottom: 0.5rem;
          background: linear-gradient(90deg, var(--accent), var(--info), var(--accent));
          background-size: 200% 200%;
          background-clip: text;
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          animation: shimmer 3s ease-in-out infinite;
        `;
        header.textContent = `${sourceName} â€¢ ${grouped[sourceName].length} ARTICLES`;
        feedList.appendChild(header);
        
        grouped[sourceName].slice(0, 15).forEach(item => {
          feedList.appendChild(createCard(item));
        });
      });
      
      updateStats();
      return;
  }
  
  if (!filteredItems.length) {
    emptyMsg.style.display = 'block';
    return;
  } else {
    emptyMsg.style.display = 'none';
  }
  
  filteredItems.slice(0, 60).forEach(item => {
    feedList.appendChild(createCard(item));
  });
  
  updateStats();
}

function buildSourceToggles() {
  const container = document.getElementById('sourceToggles');
  container.innerHTML = '';
  container.className = 'src-grid';
  container.style.cssText = `
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding: 1.2rem 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
  `;
  
  SOURCES.forEach(source => {
    const button = document.createElement('button');
    button.className = 'src' + (STATE.enabled.has(source.id) ? ' on' : '');
    button.textContent = source.name;
    button.dataset.id = source.id;
    button.style.cssText = `
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      background: var(--chip);
      border: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    `;

    button.addEventListener('click', () => {
      const sourceId = button.dataset.id;
      const isAlreadySolo = (STATE.enabled.size === 1 && STATE.enabled.has(sourceId));
      
      if (!isAlreadySolo) {
        STATE.lastSolo = new Set(STATE.enabled);
        STATE.enabled = new Set([sourceId]);
        updateSoloState(sourceId);
        toast(`SOLO: ${source.name}`, 'info');
      } else {
        STATE.enabled = STATE.lastSolo || new Set(SOURCES.map(s => s.id));
        clearSoloState();
        toast('SOLO OFF', 'info');
      }
      
      updateButtonStates();
      render();
      saveEnabled();
    });

    addLongPress(button, () => {
      const sourceId = button.dataset.id;
      
      if (STATE.enabled.has(sourceId)) {
        STATE.enabled.delete(sourceId);
      } else {
        STATE.enabled.add(sourceId);
      }
      
      if (STATE.enabled.size === 0) {
        STATE.enabled = new Set([sourceId]);
      }
      
      clearSoloState();
      updateButtonStates();
      render();
      saveEnabled();
      toast(`${STATE.enabled.has(sourceId) ? 'Enabled' : 'Disabled'} ${source.name}`, 'info');
    });

    container.appendChild(button);
  });

  function updateButtonStates() {
    document.querySelectorAll('.src').forEach(btn => {
      const isEnabled = STATE.enabled.has(btn.dataset.id);
      btn.className = 'src' + (isEnabled ? ' on' : '');
      if (isEnabled) {
        btn.style.background = 'var(--secondary)';
        btn.style.color = 'var(--bg)';
        btn.style.borderColor = 'var(--secondary)';
      } else {
        btn.style.background = 'var(--chip)';
        btn.style.color = 'var(--muted)';
        btn.style.borderColor = 'var(--border)';
      }
    });
  }
  
  function updateSoloState(soloId) {
    document.querySelectorAll('.src').forEach(btn => {
      if (btn.dataset.id === soloId) {
        btn.style.outline = '2px dashed var(--warning)';
        btn.style.outlineOffset = '2px';
      }
    });
  }
  
  function clearSoloState() {
    document.querySelectorAll('.src').forEach(btn => {
      btn.style.outline = 'none';
    });
  }

  updateButtonStates();
}

function buildFilters() {
  document.getElementById('filters').addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (!chip) return;
    
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    STATE.view = chip.dataset.view;
    render();
  });
}

function fmtTime(ts) {
  const d = new Date(ts);
  if (isNaN(d)) return 'UNKNOWN';
  
  const diff = (Date.now() - d) / 1000;
  if (diff < 60) return 'LIVE';
  if (diff < 3600) return Math.floor(diff / 60) + 'm';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h';
  if (diff < 604800) return Math.floor(diff / 86400) + 'd';
  return d.toLocaleDateString();
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  
  setTimeout(() => { 
    el.style.opacity = '0'; 
    el.style.transform = 'translateX(-50%) translateY(-10px)';
    setTimeout(() => el.remove(), 300);
  }, 2500);
  
  return el;
}

function addLongPress(target, fn) {
  let timer;
  const start = () => timer = setTimeout(fn, 500);
  const end = () => clearTimeout(timer);
  
  target.addEventListener('touchstart', start, {passive: true});
  target.addEventListener('touchend', end, {passive: true});
  target.addEventListener('touchcancel', end, {passive: true});
  target.addEventListener('mousedown', start);
  target.addEventListener('mouseup', end);
  target.addEventListener('mouseleave', end);
}

function escapeHTML(str = '') {
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
  return str.replace(/[&<>"']/g, c => map[c]);
}

function resetAll() {
  if(confirm('Reset all settings?')) {
    localStorage.clear();
    STATE.enabled = new Set(SOURCES.map(s=>s.id));
    STATE.expandedCards.clear();
    STATE.popularityScores.clear();
    STATE.viewCounts.clear();
    buildSourceToggles();
    loadFeeds();
    toast('System reset', 'success');
  }
}

// Initialize
function initialize() {
  buildFilters();
  buildSourceToggles();
  
  // Toggle sections
  document.querySelectorAll('.toggle-section').forEach(section => {
    const header = section.querySelector('.toggle-header');
    const arrow = section.querySelector('.toggle-arrow');
    header.addEventListener('click', () => {
      const isOpen = section.classList.toggle('open');
      arrow.textContent = isOpen ? 'â–¼' : 'â–¶';
    });
  });
  
  // Reader modal
  document.getElementById('readerClose').addEventListener('click', () => {
    document.getElementById('readerModal').classList.remove('active');
  });
  
  document.getElementById('resetBtn').addEventListener('click', resetAll);
  
  // Auto-refresh
  setInterval(() => {
    if (!STATE.loading && document.visibilityState === 'visible') {
      loadFeeds();
    }
  }, 120000);
  
  // Initial load
  setTimeout(loadFeeds, 100);
  
  // Visibility handling
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && Date.now() - STATE.lastFetch > 180000) {
      loadFeeds();
    }
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initialize);
} else {
  initialize();
}
</script>
</body>
</html>
