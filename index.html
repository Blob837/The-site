<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BiasLens - AI-Powered Media Analysis</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-tertiary: #1a1a24;
            --bg-card: #151521;
            --bg-elevated: #1e1e2e;
            --bg-glass: rgba(30, 30, 46, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-subtle: #64748b;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
            --border-primary: #27272a;
            --border-secondary: #3f3f46;
            --border-accent: #52525b;
            --glow-primary: rgba(99, 102, 241, 0.3);
            --glow-blue: rgba(59, 130, 246, 0.2);
            --glow-red: rgba(239, 68, 68, 0.2);
            --glow-soft: rgba(139, 92, 246, 0.1);
            --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --gradient-card: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
            --gradient-border: linear-gradient(135deg, #667eea, #764ba2);
            --gradient-bias-left: linear-gradient(90deg, #3b82f6, #1d4ed8);
            --gradient-bias-neutral: linear-gradient(90deg, #6b7280, #9ca3af);
            --gradient-bias-right: linear-gradient(90deg, #dc2626, #ef4444);
            --shadow-card: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --shadow-button: 0 10px 15px -3px rgba(99, 102, 241, 0.2), 0 4px 6px -2px rgba(99, 102, 241, 0.1);
            --shadow-glow: 0 0 50px rgba(99, 102, 241, 0.15);
            --blur-glass: blur(16px);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 0%, rgba(236, 72, 153, 0.05) 0%, transparent 50%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'kern' 1;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            padding: 60px 0 80px;
            position: relative;
            overflow: hidden;
        }

        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-hero);
            opacity: 0.03;
            animation: heroShift 20s ease-in-out infinite;
        }

        @keyframes heroShift {
            0%, 100% { transform: translateX(-5%) rotate(-1deg); }
            50% { transform: translateX(5%) rotate(1deg); }
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .logo-container {
            display: inline-flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 8px 24px 8px 8px;
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 100px;
            box-shadow: var(--shadow-glow);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-hero);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
            position: relative;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: var(--gradient-border);
            border-radius: 18px;
            z-index: -1;
            opacity: 0.6;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-title {
            font-size: clamp(48px, 8vw, 72px);
            font-weight: 900;
            margin-bottom: 16px;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            letter-spacing: -0.025em;
        }

        .hero-subtitle {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .hero-description {
            font-size: 16px;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Main Input Section */
        .input-section {
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-border);
            opacity: 0.5;
        }

        .input-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .input-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .input-subtitle {
            font-size: 16px;
            color: var(--text-muted);
        }

        .url-input-container {
            position: relative;
            margin-bottom: 24px;
        }

        .url-input {
            width: 100%;
            padding: 20px 24px;
            border: 2px solid var(--border-primary);
            border-radius: 16px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s var(--transition-smooth);
            -webkit-appearance: none;
            font-family: inherit;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px var(--glow-primary), var(--shadow-card);
            transform: translateY(-2px);
        }

        .url-input::placeholder {
            color: var(--text-subtle);
        }

        .analyze-button {
            width: 100%;
            padding: 20px 32px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--gradient-hero);
            color: white;
            box-shadow: var(--shadow-button);
            -webkit-tap-highlight-color: transparent;
            font-family: inherit;
            min-height: 64px;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.3), 0 10px 10px -5px rgba(99, 102, 241, 0.2);
        }

        .analyze-button:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .analyze-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }

        .button-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-icon {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alternative Input */
        .alternative-input {
            margin-top: 24px;
            border-top: 1px solid var(--border-primary);
            padding-top: 24px;
        }

        .collapsible-trigger {
            width: 100%;
            background: none;
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 16px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s var(--transition-smooth);
            font-family: inherit;
        }

        .collapsible-trigger:hover {
            background: var(--bg-elevated);
            border-color: var(--border-secondary);
        }

        .chevron {
            transition: transform 0.3s var(--transition-smooth);
            color: var(--accent-primary);
        }

        .collapsible-trigger[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s var(--transition-smooth);
        }

        .collapsible-content.open {
            max-height: 400px;
            margin-top: 16px;
        }

        .textarea-container {
            position: relative;
        }

        .textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px 20px;
            border: 2px solid var(--border-primary);
            border-radius: 12px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s var(--transition-smooth);
            line-height: 1.6;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .analyze-text-button {
            width: 100%;
            margin-top: 12px;
            padding: 14px 24px;
            border: 1px solid var(--border-secondary);
            border-radius: 12px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            font-family: inherit;
        }

        .analyze-text-button:hover:not(:disabled) {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Results Section */
        .results-container {
            opacity: 0;
            transform: translateY(40px);
            transition: all 0.8s var(--transition-smooth);
            display: none;
        }

        .results-container.visible {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Score Card */
        .score-card {
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-border);
            opacity: 0.5;
        }

        .score-number {
            font-size: 64px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 8px;
            position: relative;
        }

        .score-label {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 24px;
        }

        .score-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 auto 16px;
            box-shadow: 0 0 20px currentColor;
        }

        /* Bias Scale Card */
        .bias-scale-card {
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .bias-scale-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-border);
            opacity: 0.5;
        }

        .scale-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            color: var(--text-primary);
        }

        .bias-scale {
            position: relative;
            height: 16px;
            background: linear-gradient(90deg, 
                var(--accent-blue) 0%, 
                #4f46e5 25%, 
                #6b7280 45%, 
                #6b7280 55%, 
                #dc2626 75%, 
                var(--accent-red) 100%);
            border-radius: 8px;
            margin: 32px 0;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .scale-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(200%); }
        }

        .scale-ticks {
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            bottom: -2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
        }

        .scale-tick {
            width: 2px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 1px;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }

        .scale-marker {
            position: absolute;
            top: 50%;
            width: 28px;
            height: 28px;
            background: white;
            border: 4px solid var(--bg-primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 
                0 0 0 2px rgba(255, 255, 255, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.4);
            transition: all 1.2s var(--transition-bounce);
            z-index: 10;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .scale-label {
            color: var(--text-muted);
            text-align: center;
            flex: 1;
        }

        .scale-label:first-child { color: var(--accent-blue); }
        .scale-label:last-child { color: var(--accent-red); }

        /* Analysis Section */
        .analysis-section {
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .analysis-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-border);
            opacity: 0.5;
        }

        .analysis-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .ai-badge {
            background: var(--gradient-hero);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .explanation-text {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 32px;
            padding: 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border-left: 4px solid var(--accent-primary);
        }

        .evidence-section {
            margin-bottom: 32px;
        }

        .evidence-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .evidence-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .evidence-chip {
            background: var(--bg-elevated);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s var(--transition-smooth);
        }

        .evidence-chip.positive {
            border-color: var(--accent-red);
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .evidence-chip.negative {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .evidence-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Key Sentences Section */
        .sentences-section {
            margin-top: 32px;
        }

        .sentences-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .bias-sentence {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .bias-sentence:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .bias-sentence::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: currentColor;
        }

        .bias-sentence.left-positive { color: var(--accent-blue); }
        .bias-sentence.left-negative { color: var(--accent-red); }
        .bias-sentence.right-positive { color: var(--accent-red); }
        .bias-sentence.right-negative { color: var(--accent-blue); }
        .bias-sentence.left-framing { color: var(--accent-blue); }
        .bias-sentence.right-framing { color: var(--accent-red); }
        .bias-sentence.emotional-language { color: var(--accent-orange); }

        .sentence-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .sentence-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* History Section */
        .history-section {
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .history-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-border);
            opacity: 0.5;
        }

        .history-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .history-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
        }

        .history-item:hover {
            background: var(--bg-card);
            border-color: var(--border-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .history-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-score {
            font-weight: 700;
            font-size: 16px;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-url {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .no-history {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            padding: 40px 20px;
        }

        /* Error Messages */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            color: var(--accent-red);
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s var(--transition-smooth);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* About Section */
        .about-section {
            background: var(--bg-glass);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .about-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-border);
            opacity: 0.5;
        }

        .about-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .about-title::after {
            content: "🤖";
            font-size: 18px;
        }

        .about-description {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        /* Dev Panel */
        .dev-panel {
            background: var(--bg-primary);
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .dev-panel.visible {
            display: block;
            animation: fadeIn 0.3s var(--transition-smooth);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dev-section {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-primary);
        }

        .dev-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .dev-label {
            color: var(--accent-green);
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .dev-value {
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
                gap: 24px;
            }

            .hero-section {
                padding: 40px 0 60px;
            }

            .hero-title {
                font-size: 48px;
            }

            .input-section {
                padding: 24px;
            }

            .score-card,
            .bias-scale-card,
            .analysis-section {
                padding: 24px;
            }

            .score-number {
                font-size: 48px;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        .analyze-button:focus,
        .url-input:focus,
        .textarea:focus,
        .collapsible-trigger:focus,
        .analyze-text-button:focus,
        .history-item:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Safe area for mobile devices */
        .safe-area {
            padding-bottom: env(safe-area-inset-bottom, 24px);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-background"></div>
            <div class="hero-content">
                <div class="logo-container">
                    <div class="logo-icon">BL</div>
                    <div class="logo-text">BiasLens</div>
                </div>
                <h1 class="hero-title">Decode Media Bias</h1>
                <p class="hero-subtitle">AI-Powered Political Analysis</p>
                <p class="hero-description">
                    Advanced natural language processing that reveals hidden political bias in news articles through contextual analysis, sentiment detection, and linguistic pattern recognition.
                </p>
            </div>
        </section>

        <!-- Input Section -->
        <section class="input-section">
            <div class="input-header">
                <h2 class="input-title">Analyze Any Article</h2>
                <p class="input-subtitle">Paste a URL or article text to get started</p>
            </div>

            <div class="url-input-container">
                <input 
                    type="url" 
                    id="url-input" 
                    class="url-input" 
                    placeholder="https://example.com/news-article" 
                    aria-label="Article URL for analysis"
                >
            </div>

            <button id="analyze-btn" class="analyze-button">
                <div class="button-content" id="button-content">
                    <div class="ai-icon">AI</div>
                    <span id="analyze-text">Analyze with AI</span>
                </div>
                <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
            </button>

            <div class="alternative-input">
                <button class="collapsible-trigger" aria-expanded="false" aria-controls="text-input-content">
                    <span>Alternative: Paste Article Text</span>
                    <span class="chevron">▼</span>
                </button>
                <div class="collapsible-content" id="text-input-content">
                    <div class="textarea-container">
                        <textarea 
                            id="article-text" 
                            class="textarea" 
                            placeholder="Paste the full article text here for direct analysis..."
                            aria-label="Article text for manual analysis"
                        ></textarea>
                        <button id="analyze-text-btn" class="analyze-text-button">
                            Analyze Text
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Error Container -->
        <div id="error-container"></div>

        <!-- Results Section -->
        <div id="results-container" class="results-container">
            <div class="results-grid">
                <!-- Score Card -->
                <div class="score-card">
                    <div class="score-indicator" id="score-indicator"></div>
                    <div id="score-number" class="score-number">0</div>
                    <div class="score-label">Bias Score</div>
                </div>

                <!-- Bias Scale Card -->
                <div class="bias-scale-card">
                    <h3 class="scale-title">Political Spectrum</h3>
                    <div class="bias-scale">
                        <div class="scale-overlay"></div>
                        <div class="scale-ticks">
                            <div class="scale-tick"></div>
                            <div class="scale-tick"></div>
                            <div class="scale-tick"></div>
                            <div class="scale-tick"></div>
                            <div class="scale-tick"></div>
                        </div>
                        <div id="scale-marker" class="scale-marker"></div>
                    </div>
                    <div class="scale-labels">
                        <div class="scale-label">Liberal<br>-100</div>
                        <div class="scale-label">-50</div>
                        <div class="scale-label">Neutral<br>0</div>
                        <div class="scale-label">+50</div>
                        <div class="scale-label">Conservative<br>+100</div>
                    </div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="analysis-section">
                <h3 class="analysis-title">
                    <span>AI Analysis</span>
                    <span class="ai-badge">Neural</span>
                </h3>
                
                <div id="explanation-text" class="explanation-text"></div>

                <div class="evidence-section">
                    <h4 class="evidence-title">Key Evidence</h4>
                    <div id="evidence-chips" class="evidence-chips"></div>
                </div>

                <div class="sentences-section">
                    <h4 class="sentences-title">Identified Bias Patterns</h4>
                    <div id="bias-sentences-list"></div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <section class="history-section">
            <h2 class="history-title">Analysis History</h2>
            <div id="history-list">
                <div id="no-history" class="no-history">
                    No analyses yet — analyze your first article to get started!
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="about-section">
            <h2 class="about-title" id="about-title">How BiasLens Works</h2>
            <p class="about-description">
                BiasLens employs state-of-the-art natural language processing techniques to analyze news articles for political bias. Our AI examines contextual sentiment around political entities, linguistic patterns, argument structure, source attribution, and topic framing to estimate bias on a liberal-conservative spectrum. The analysis focuses on <em>how</em> information is presented rather than just <em>what</em> is reported. 
                <strong>Results are AI-generated estimates</strong> — always apply critical thinking.
            </p>
            
            <div id="dev-panel" class="dev-panel">
                <div class="dev-section">
                    <span class="dev-label">Proxy Used:</span>
                    <div class="dev-value" id="dev-proxy">None</div>
                </div>
                <div class="dev-section">
                    <span class="dev-label">Feature Scores:</span>
                    <div class="dev-value" id="dev-features">N/A</div>
                </div>
                <div class="dev-section">
                    <span class="dev-label">Evidence Signals:</span>
                    <div class="dev-value" id="dev-lexicon">N/A</div>
                </div>
                <div class="dev-section">
                    <span class="dev-label">Outlet Prior:</span>
                    <div class="dev-value" id="dev-outlet">N/A</div>
                </div>
                <div class="dev-section">
                    <span class="dev-label">Score Normalization:</span>
                    <div class="dev-value" id="dev-norm">N/A</div>
                </div>
                <div class="dev-section">
                    <span class="dev-label">Processing Time:</span>
                    <div class="dev-value" id="dev-timing">N/A</div>
                </div>
            </div>
        </section>

        <div class="safe-area"></div>
    </div>

    <script>
        'use strict';

        // Configuration
        const CONFIG = {
            maxWordCount: 2500,
            proxyTimeout: 7000,
            maxRetries: 3,
            storageVersion: 1,
            storageKey: 'biaslens_pro_v1',
            maxHistoryItems: 5
        };

        // CORS Proxy rotation
        const PROXIES = [
            'https://corsproxy.io/?',
            'https://cors-anywhere.herokuapp.com/',
            'https://api.allorigins.win/raw?url=',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        // Outlet bias priors (small influence, max ±8)
        const OUTLET_PRIORS = {
            'cnn.com': -5,
            'msnbc.com': -6,
            'nytimes.com': -3,
            'washingtonpost.com': -3,
            'huffpost.com': -7,
            'foxnews.com': 6,
            'breitbart.com': 8,
            'dailywire.com': 7,
            'nypost.com': 4,
            'wsj.com': 2,
            'reuters.com': 0,
            'ap.org': 0,
            'apnews.com': 0,
            'bbc.com': -1,
            'npr.org': -2
        };

        // Application state
        let currentAnalysis = null;
        let devPanelTaps = 0;
        let devPanelVisible = false;

        // DOM elements
        const elements = {
            urlInput: document.getElementById('url-input'),
            analyzeBtn: document.getElementById('analyze-btn'),
            buttonContent: document.getElementById('button-content'),
            analyzeText: document.getElementById('analyze-text'),
            loadingSpinner: document.getElementById('loading-spinner'),
            articleText: document.getElementById('article-text'),
            analyzeTextBtn: document.getElementById('analyze-text-btn'),
            errorContainer: document.getElementById('error-container'),
            resultsContainer: document.getElementById('results-container'),
            scoreNumber: document.getElementById('score-number'),
            scoreIndicator: document.getElementById('score-indicator'),
            scaleMarker: document.getElementById('scale-marker'),
            explanationText: document.getElementById('explanation-text'),
            evidenceChips: document.getElementById('evidence-chips'),
            biasSentencesList: document.getElementById('bias-sentences-list'),
            historyList: document.getElementById('history-list'),
            noHistory: document.getElementById('no-history'),
            aboutTitle: document.getElementById('about-title'),
            devPanel: document.getElementById('dev-panel'),
            devProxy: document.getElementById('dev-proxy'),
            devFeatures: document.getElementById('dev-features'),
            devLexicon: document.getElementById('dev-lexicon'),
            devOutlet: document.getElementById('dev-outlet'),
            devNorm: document.getElementById('dev-norm'),
            devTiming: document.getElementById('dev-timing')
        };

        // Utility functions
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return ['http:', 'https:'].includes(url.protocol);
            } catch {
                return false;
            }
        }

        function sanitizeUrl(url) {
            if (!url) return null;
            url = url.trim();
            if (!url.startsWith('http')) {
                url = 'https://' + url;
            }
            return isValidUrl(url) ? url : null;
        }

        function showError(message) {
            elements.errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                elements.errorContainer.innerHTML = '';
            }, 5000);
        }

        function setLoading(isLoading) {
            elements.analyzeBtn.disabled = isLoading;
            elements.analyzeTextBtn.disabled = isLoading;
            elements.buttonContent.style.display = isLoading ? 'none' : 'flex';
            elements.loadingSpinner.style.display = isLoading ? 'block' : 'none';
        }

        // Storage functions
        function saveToStorage(analysis) {
            try {
                const stored = localStorage.getItem(CONFIG.storageKey);
                let history = stored ? JSON.parse(stored) : { version: CONFIG.storageVersion, analyses: [] };
                
                if (history.version !== CONFIG.storageVersion) {
                    history = { version: CONFIG.storageVersion, analyses: [] };
                }

                history.analyses.unshift({
                    timestamp: Date.now(),
                    url: analysis.url || 'Manual Text',
                    title: analysis.title || 'Untitled',
                    score: analysis.score
                });

                history.analyses = history.analyses.slice(0, CONFIG.maxHistoryItems);
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(history));
                renderHistory();
            } catch (error) {
                console.warn('Failed to save to localStorage:', error);
            }
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(CONFIG.storageKey);
                if (!stored) return [];
                
                const history = JSON.parse(stored);
                if (history.version !== CONFIG.storageVersion) return [];
                
                return history.analyses || [];
            } catch (error) {
                console.warn('Failed to load from localStorage:', error);
                return [];
            }
        }

        function renderHistory() {
            const history = loadFromStorage();
            
            if (history.length === 0) {
                elements.noHistory.style.display = 'block';
                return;
            }

            elements.noHistory.style.display = 'none';
            
            const historyItems = history.map(item => {
                const date = new Date(item.timestamp).toLocaleDateString();
                const scoreColor = item.score > 0 ? 'var(--accent-red)' : item.score < 0 ? 'var(--accent-blue)' : 'var(--text-secondary)';
                
                return `
                    <div class="history-item" tabindex="0" role="button" onclick="restoreAnalysis(${item.timestamp})" onkeydown="handleHistoryKeydown(event, ${item.timestamp})">
                        <div class="history-meta">
                            <span class="history-score" style="color: ${scoreColor}">${item.score > 0 ? '+' : ''}${item.score}</span>
                            <span class="history-time">${date}</span>
                        </div>
                        <div class="history-url">${item.url}</div>
                    </div>
                `;
            }).join('');

            elements.historyList.innerHTML = historyItems;
        }

        window.restoreAnalysis = function(timestamp) {
            const history = loadFromStorage();
            const item = history.find(h => h.timestamp === timestamp);
            if (!item) return;

            if (item.url !== 'Manual Text') {
                elements.urlInput.value = item.url;
            }
            
            showError(`Restored: ${item.title} (Score: ${item.score})`);
        };

        window.handleHistoryKeydown = function(event, timestamp) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                restoreAnalysis(timestamp);
            }
        };

        // Content extraction from HTML
        function extractContent(html, url) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const unwanted = doc.querySelectorAll('script, style, nav, footer, aside, header, .ad, .advertisement, .sidebar, .related, .comments, .social, .share');
                unwanted.forEach(el => el.remove());

                let title = '';
                const titleEl = doc.querySelector('title, h1, .title, .headline');
                if (titleEl) {
                    title = titleEl.textContent.trim();
                }

                const contentSelectors = [
                    'article', '.article-content', '.content', '.post-content', 
                    '.entry-content', 'main', '.main-content', '.story-body', '.article-body'
                ];

                let content = '';
                for (const selector of contentSelectors) {
                    const element = doc.querySelector(selector);
                    if (element) {
                        content = element.textContent;
                        break;
                    }
                }

                if (!content) {
                    const body = doc.querySelector('body');
                    if (body) {
                        content = body.textContent;
                    }
                }

                content = content
                    .replace(/\s+/g, ' ')
                    .replace(/[""'']/g, '"')
                    .replace(/[–—]/g, '-')
                    .trim();

                const words = content.split(/\s+/);
                if (words.length > CONFIG.maxWordCount) {
                    content = words.slice(0, CONFIG.maxWordCount).join(' ') + '...';
                }

                return { title, content, wordCount: words.length };
            } catch (error) {
                throw new Error('Failed to parse HTML content');
            }
        }

        // Proxy rotation with timeout and error handling
        async function fetchWithProxies(url) {
            const startTime = Date.now();
            let lastError = null;
            let proxyUsed = 'Direct';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.proxyTimeout);
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const text = await response.text();
                    updateDevPanel({ proxy: 'Direct', timing: Date.now() - startTime });
                    return text;
                }
            } catch (error) {
                lastError = error;
            }

            for (let i = 0; i < PROXIES.length; i++) {
                const proxy = PROXIES[i];
                proxyUsed = `Proxy ${i + 1}`;
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), CONFIG.proxyTimeout);
                    
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const response = await fetch(proxyUrl, {
                        signal: controller.signal,
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const text = await response.text();
                        updateDevPanel({ proxy: proxyUsed, timing: Date.now() - startTime });
                        return text;
                    }
                } catch (error) {
                    lastError = error;
                    console.warn(`Proxy ${i + 1} failed:`, error.message);
                }
            }

            throw new Error(`All proxies failed. Last error: ${lastError?.message || 'Unknown error'}`);
        }

        // Natural bias detection algorithm
        function analyzeBias(text, title = '', url = '') {
            const startTime = Date.now();
            
            const normalizedText = text.toLowerCase();
            const sentences = text.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 10);
            
            const politicalEntities = {
                left: ['democrats', 'biden', 'harris', 'pelosi', 'schumer', 'aoc', 'sanders', 'warren'],
                right: ['republicans', 'trump', 'desantis', 'mcconnell', 'cruz', 'hawley', 'greene'],
                neutral: ['congress', 'senate', 'house', 'government', 'administration', 'officials']
            };

            let features = {};
            let evidenceTerms = [];
            let contextualSignals = 0;
            let biasSentences = [];

            // Contextual sentiment analysis
            function analyzeContextualSentiment() {
                let leftSentiment = 0;
                let rightSentiment = 0;
                const contextWindow = 20;
                
                sentences.forEach(sentence => {
                    const words = sentence.toLowerCase().split(/\s+/);
                    let sentenceBias = 0;
                    let sentenceDirection = null;
                    let foundEntities = [];
                    
                    words.forEach((word, index) => {
                        let entityBias = null;
                        if (politicalEntities.left.some(entity => word.includes(entity))) {
                            entityBias = 'left';
                            foundEntities.push(word);
                        }
                        if (politicalEntities.right.some(entity => word.includes(entity))) {
                            entityBias = 'right';
                            foundEntities.push(word);
                        }
                        
                        if (entityBias) {
                            const start = Math.max(0, index - contextWindow);
                            const end = Math.min(words.length, index + contextWindow);
                            const context = words.slice(start, end).join(' ');
                            
                            const positiveContext = /\b(successful|effective|strong|praised|support|defend|champion|fight for|stand up|deliver|accomplish|achieve|brilliant|outstanding|excellent)\b/g;
                            const negativeContext = /\b(failed|ineffective|weak|criticized|attack|oppose|undermine|damage|hurt|threaten|dangerous|extreme|ridiculous|absurd|disaster)\b/g;
                            
                            const positiveMatches = (context.match(positiveContext) || []).length;
                            const negativeMatches = (context.match(negativeContext) || []).length;
                            const sentimentScore = positiveMatches - negativeMatches;
                            
                            if (Math.abs(sentimentScore) > 0) {
                                sentenceBias += sentimentScore;
                                sentenceDirection = entityBias;
                            }
                            
                            if (entityBias === 'left') {
                                leftSentiment += sentimentScore;
                            } else {
                                rightSentiment += sentimentScore;
                            }
                            
                            if (Math.abs(sentimentScore) > 0) {
                                evidenceTerms.push({
                                    term: word,
                                    context: sentimentScore > 0 ? 'positive' : 'negative',
                                    strength: Math.abs(sentimentScore),
                                    bias: entityBias
                                });
                            }
                        }
                    });
                    
                    if (Math.abs(sentenceBias) > 0 && foundEntities.length > 0) {
                        const finalBias = sentenceBias > 0 ? 
                            (sentenceDirection === 'left' ? 'left-positive' : 'right-positive') :
                            (sentenceDirection === 'left' ? 'left-negative' : 'right-negative');
                            
                        biasSentences.push({
                            text: sentence.trim(),
                            bias: finalBias,
                            strength: Math.abs(sentenceBias),
                            entities: foundEntities,
                            type: 'contextual'
                        });
                    }
                });
                
                return { leftSentiment, rightSentiment };
            }

            // Linguistic pattern analysis
            function analyzeLinguisticPatterns() {
                let patterns = { certainty: 0, hedging: 0, emotional: 0, factual: 0 };
                
                const certaintyMarkers = /\b(clearly|obviously|undoubtedly|definitely|certainly|without question|no doubt|absolutely)\b/gi;
                const hedgingMarkers = /\b(might|could|perhaps|possibly|allegedly|reportedly|sources say|appears to|seems to|may have)\b/gi;
                
                patterns.certainty = (normalizedText.match(certaintyMarkers) || []).length;
                patterns.hedging = (normalizedText.match(hedgingMarkers) || []).length;
                
                const emotionalMarkers = /\b(outrageous|shocking|devastating|alarming|dangerous|disaster|crisis|betrayal|attack|defend|fight|slams|blasts|destroys)\b/gi;
                const factualMarkers = /\b(according to|data shows|study found|research indicates|statistics|analysis|report|survey)\b/gi;
                
                patterns.emotional = (normalizedText.match(emotionalMarkers) || []).length;
                patterns.factual = (normalizedText.match(factualMarkers) || []).length;
                
                sentences.forEach(sentence => {
                    const sentenceLower = sentence.toLowerCase();
                    const emotionalMatches = (sentenceLower.match(emotionalMarkers) || []).length;
                    const certaintyMatches = (sentenceLower.match(certaintyMarkers) || []).length;
                    
                    if (emotionalMatches > 1 || certaintyMatches > 1) {
                        const biasStrength = emotionalMatches + certaintyMatches;
                        biasSentences.push({
                            text: sentence.trim(),
                            bias: 'emotional-language',
                            strength: biasStrength,
                            type: 'linguistic',
                            indicators: emotionalMatches > 0 ? 'emotional' : 'certainty'
                        });
                    }
                });
                
                return patterns;
            }

            // Source and attribution analysis
            function analyzeSourcePatterns() {
                let sourceScore = 0;
                
                const anonymousSources = /\b(sources say|unnamed official|according to sources|insiders report|leaked|off the record)\b/gi;
                const namedSources = /\b(said|stated|announced|declared|confirmed|according to [A-Z][a-z]+ [A-Z][a-z]+)\b/gi;
                
                const anonymousCount = (normalizedText.match(anonymousSources) || []).length;
                const namedCount = (normalizedText.match(namedSources) || []).length;
                
                sourceScore = namedCount - (anonymousCount * 0.5);
                
                return { sourceScore, anonymousCount, namedCount };
            }

            // Argument structure analysis
            function analyzeArgumentStructure() {
                let structureScore = 0;
                
                const balanceIndicators = /\b(however|but|on the other hand|meanwhile|in contrast|alternatively|critics argue|supporters say|both sides)\b/gi;
                const onesided = /\b(all|every|always|never|completely|totally|entirely|absolutely no|zero|none)\b/gi;
                
                const balanceCount = (normalizedText.match(balanceIndicators) || []).length;
                const onesidedCount = (normalizedText.match(onesided) || []).length;
                
                structureScore = balanceCount - (onesidedCount * 0.3);
                
                return { structureScore, balanceCount, onesidedCount };
            }

            // Topic framing analysis
            function analyzeTopicFraming() {
                let framingBias = 0;
                
                const economicLeft = /\b(inequality|corporate greed|tax the rich|worker rights|minimum wage|wealth gap)\b/gi;
                const economicRight = /\b(job creators|free market|economic growth|business friendly|tax burden|regulation hurts)\b/gi;
                
                const socialLeft = /\b(social justice|systemic racism|reproductive rights|lgbtq rights|inclusion|equity)\b/gi;
                const socialRight = /\b(traditional values|family values|religious freedom|law and order|personal responsibility)\b/gi;
                
                const govLeft = /\b(public investment|government programs|safety net|public option|infrastructure)\b/gi;
                const govRight = /\b(government overreach|bureaucracy|red tape|states rights|limited government)\b/gi;
                
                const leftFraming = (normalizedText.match(economicLeft) || []).length + 
                                  (normalizedText.match(socialLeft) || []).length +
                                  (normalizedText.match(govLeft) || []).length;
                
                const rightFraming = (normalizedText.match(economicRight) || []).length + 
                                   (normalizedText.match(socialRight) || []).length +
                                   (normalizedText.match(govRight) || []).length;
                
                framingBias = rightFraming - leftFraming;
                
                sentences.forEach(sentence => {
                    const sentenceLower = sentence.toLowerCase();
                    const leftMatches = (sentenceLower.match(economicLeft) || []).length +
                                       (sentenceLower.match(socialLeft) || []).length +
                                       (sentenceLower.match(govLeft) || []).length;
                    const rightMatches = (sentenceLower.match(economicRight) || []).length +
                                        (sentenceLower.match(socialRight) || []).length +
                                        (sentenceLower.match(govRight) || []).length;
                    
                    if (leftMatches > 0 || rightMatches > 0) {
                        const netBias = rightMatches - leftMatches;
                        if (Math.abs(netBias) > 0) {
                            biasSentences.push({
                                text: sentence.trim(),
                                bias: netBias > 0 ? 'right-framing' : 'left-framing',
                                strength: Math.abs(netBias),
                                type: 'framing'
                            });
                        }
                    }
                });
                
                return { framingBias, leftFraming, rightFraming };
            }

            // Execute all analyses
            const sentimentAnalysis = analyzeContextualSentiment();
            const linguisticPatterns = analyzeLinguisticPatterns();
            const sourcePatterns = analyzeSourcePatterns();
            const argumentStructure = analyzeArgumentStructure();
            const topicFraming = analyzeTopicFraming();

            // Composite scoring
            let biasScore = 0;
            
            const sentimentScore = sentimentAnalysis.rightSentiment - sentimentAnalysis.leftSentiment;
            biasScore += sentimentScore * 4;
            features.sentiment = sentimentScore;
            
            biasScore += topicFraming.framingBias * 2.5;
            features.framing = topicFraming.framingBias;
            
            const linguisticBias = (linguisticPatterns.certainty - linguisticPatterns.hedging) + 
                                 (linguisticPatterns.emotional - linguisticPatterns.factual) * 0.5;
            biasScore += linguisticBias * 0.8;
            features.linguistic = linguisticBias;
            
            biasScore -= argumentStructure.structureScore * 0.5;
            features.structure = argumentStructure.structureScore;
            
            biasScore -= sourcePatterns.sourceScore * 0.2;
            features.sources = sourcePatterns.sourceScore;

            // Apply outlet prior
            let outletPrior = 0;
            if (url) {
                try {
                    const hostname = new URL(url).hostname.toLowerCase().replace('www.', '');
                    outletPrior = OUTLET_PRIORS[hostname] || 0;
                    biasScore += outletPrior;
                } catch (error) {
                    // Invalid URL, no prior
                }
            }

            // Title analysis
            if (title) {
                const titleSentiment = title.toLowerCase();
                let titleBias = 0;
                
                if (/\b(slams|blasts|destroys|demolishes|attacks|hits|strikes)\b/.test(titleSentiment)) titleBias += 2;
                if (/\b(defends|supports|champions|stands up|fights for)\b/.test(titleSentiment)) titleBias -= 2;
                if (/\b(crisis|disaster|chaos|failure|threatens)\b/.test(titleSentiment)) titleBias += 1.5;
                if (/\b(progress|success|achievement|breakthrough|delivers)\b/.test(titleSentiment)) titleBias -= 1.5;
                
                biasScore += titleBias * 1.5;
                features.titleBias = titleBias;
            }

            // Normalize to [-100, 100] scale
            const normalizedScore = Math.round(Math.tanh(biasScore / 15) * 100);
            
            // Generate explanation
            const explanation = generateNaturalExplanation(normalizedScore, features, evidenceTerms);
            
            const analysis = {
                score: normalizedScore,
                explanation,
                evidence: evidenceTerms.slice(0, 8),
                biasSentences: biasSentences.sort((a, b) => b.strength - a.strength).slice(0, 5),
                features,
                outletPrior,
                timing: Date.now() - startTime,
                rawScore: biasScore,
                wordCount: text.split(/\s+/).length,
                url,
                title
            };

            updateDevPanel(analysis);
            return analysis;
        }

        function generateNaturalExplanation(score, features, evidenceTerms) {
            let explanation = '';
            
            if (Math.abs(score) < 10) {
                explanation = 'BiasLens detected relatively balanced reporting with neutral tone and framing throughout the article.';
            } else if (score < -30) {
                explanation = 'BiasLens detected strong liberal bias through sympathetic coverage of progressive positions and critical framing of conservative viewpoints.';
            } else if (score < -10) {
                explanation = 'BiasLens detected moderate liberal bias with somewhat favorable treatment of progressive policies and politicians.';
            } else if (score > 30) {
                explanation = 'BiasLens detected strong conservative bias through sympathetic coverage of right-leaning positions and critical framing of liberal viewpoints.';
            } else if (score > 10) {
                explanation = 'BiasLens detected moderate conservative bias with somewhat favorable treatment of traditional policies and politicians.';
            }

            const sentimentSignal = Math.abs(features.sentiment || 0);
            const framingSignal = Math.abs(features.framing || 0);
            const linguisticSignal = Math.abs(features.linguistic || 0);

            if (sentimentSignal > framingSignal && sentimentSignal > linguisticSignal) {
                explanation += ' This assessment is primarily driven by the emotional tone used when discussing political figures and policies.';
            } else if (framingSignal > linguisticSignal) {
                explanation += ' This bias appears mainly in how issues are framed and contextualized rather than explicit opinion.';
            } else if (linguisticSignal > 1) {
                explanation += ' The bias is evident in the certainty of language and emotional word choices used throughout.';
            }

            if (features.sources && features.sources < -2) {
                explanation += ' Heavy reliance on anonymous sources may indicate speculative reporting.';
            } else if (features.structure && features.structure < -2) {
                explanation += ' The article lacks balanced perspectives from multiple viewpoints.';
            }

            return explanation;
        }

        function updateDevPanel(analysis) {
            if (!analysis) return;
            
            elements.devProxy.textContent = analysis.proxy || 'N/A';
            elements.devFeatures.textContent = analysis.features ? 
                Object.entries(analysis.features).map(([k, v]) => `${k}: ${v.toFixed(1)}`).join(', ') : 'N/A';
            elements.devLexicon.textContent = analysis.evidence ? 
                `${analysis.evidence.length} contextual signals found` : 'N/A';
            elements.devOutlet.textContent = analysis.outletPrior ? 
                `${analysis.outletPrior > 0 ? '+' : ''}${analysis.outletPrior}` : '0';
            elements.devNorm.textContent = analysis.rawScore !== undefined ? 
                `Raw: ${analysis.rawScore.toFixed(1)} → Normalized: ${analysis.score}` : 'N/A';
            elements.devTiming.textContent = analysis.timing ? `${analysis.timing}ms` : 'N/A';
        }

        // Display results
        function displayResults(analysis) {
            currentAnalysis = analysis;
            
            // Update score display with color
            elements.scoreNumber.textContent = analysis.score > 0 ? `+${analysis.score}` : analysis.score;
            const scoreColor = analysis.score > 0 ? 'var(--accent-red)' : 
                              analysis.score < 0 ? 'var(--accent-blue)' : 'var(--text-secondary)';
            elements.scoreNumber.style.color = scoreColor;
            elements.scoreIndicator.style.backgroundColor = scoreColor;
            
            // Update bias scale marker position
            const markerPosition = ((analysis.score + 100) / 200) * 100;
            elements.scaleMarker.style.left = `${markerPosition}%`;
            
            // Update explanation
            elements.explanationText.textContent = analysis.explanation;
            
            // Update evidence chips
            if (analysis.evidence && analysis.evidence.length > 0) {
                elements.evidenceChips.innerHTML = analysis.evidence.map(item => {
                    const className = item.bias === 'left' ? 'negative' : 'positive';
                    const contextLabel = item.context === 'positive' ? '+' : item.context === 'negative' ? '-' : '';
                    return `<span class="evidence-chip ${className}">${item.term} ${contextLabel}</span>`;
                }).join('');
            } else {
                elements.evidenceChips.innerHTML = '<span class="evidence-chip">No significant evidence found</span>';
            }
            
            // Update bias sentences
            if (analysis.biasSentences && analysis.biasSentences.length > 0) {
                elements.biasSentencesList.innerHTML = analysis.biasSentences.map(sentence => {
                    let labelText = '';
                    switch (sentence.bias) {
                        case 'left-positive': labelText = 'Positive toward liberals'; break;
                        case 'left-negative': labelText = 'Negative toward liberals'; break;
                        case 'right-positive': labelText = 'Positive toward conservatives'; break;
                        case 'right-negative': labelText = 'Negative toward conservatives'; break;
                        case 'left-framing': labelText = 'Liberal framing'; break;
                        case 'right-framing': labelText = 'Conservative framing'; break;
                        case 'emotional-language': labelText = 'Emotional language'; break;
                        default: labelText = 'Biased language';
                    }
                    
                    return `
                        <div class="bias-sentence ${sentence.bias}">
                            <div class="sentence-label ${sentence.bias}">${labelText}</div>
                            <div class="sentence-text">"${sentence.text}"</div>
                        </div>
                    `;
                }).join('');
            } else {
                elements.biasSentencesList.innerHTML = '<div style="color: var(--text-muted); font-style: italic; text-align: center; padding: 20px;">No clearly biased sentences detected by our AI</div>';
            }
            
            // Show results with animation
            elements.resultsContainer.style.display = 'block';
            setTimeout(() => {
                elements.resultsContainer.classList.add('visible');
            }, 100);
            
            // Save to history
            saveToStorage(analysis);
        }

        // Main analysis functions
        async function analyzeUrl() {
            const url = sanitizeUrl(elements.urlInput.value);
            if (!url) {
                showError('Please enter a valid URL');
                return;
            }

            setLoading(true);
            
            try {
                const html = await fetchWithProxies(url);
                const extracted = extractContent(html, url);
                
                if (!extracted.content || extracted.content.length < 100) {
                    throw new Error('Could not extract meaningful content from the page');
                }

                const analysis = analyzeBias(extracted.content, extracted.title, url);
                displayResults(analysis);
                
            } catch (error) {
                console.error('Analysis failed:', error);
                showError(`Failed to analyze URL: ${error.message}. Try using "Paste Article Text" instead.`);
            } finally {
                setLoading(false);
            }
        }

        async function analyzeText() {
            const text = elements.articleText.value.trim();
            if (!text || text.length < 50) {
                showError('Please paste article text (at least 50 characters)');
                return;
            }

            setLoading(true);
            
            try {
                const analysis = analyzeBias(text, '', 'Manual Text');
                displayResults(analysis);
            } catch (error) {
                console.error('Text analysis failed:', error);
                showError('Failed to analyze text. Please try again.');
            } finally {
                setLoading(false);
            }
        }

        // Event listeners
        elements.analyzeBtn.addEventListener('click', analyzeUrl);
        elements.analyzeTextBtn.addEventListener('click', analyzeText);

        elements.urlInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                analyzeUrl();
            }
        });

        // Collapsible functionality
        document.querySelector('.collapsible-trigger').addEventListener('click', function() {
            const content = document.querySelector('.collapsible-content');
            const isOpen = content.classList.contains('open');
            
            content.classList.toggle('open');
            this.setAttribute('aria-expanded', !isOpen);
        });

        document.querySelector('.collapsible-trigger').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                this.click();
            }
        });

        // Dev panel toggle
        elements.aboutTitle.addEventListener('click', () => {
            devPanelTaps++;
            if (devPanelTaps >= 5) {
                devPanelVisible = !devPanelVisible;
                elements.devPanel.classList.toggle('visible', devPanelVisible);
                devPanelTaps = 0;
            }
            
            setTimeout(() => {
                if (devPanelTaps < 5) devPanelTaps = 0;
            }, 2000);
        });

        // Initialize app
        function initApp() {
            renderHistory();
            elements.resultsContainer.style.display = 'none';
            elements.resultsContainer.classList.remove('visible');
        }

        initApp();
    </script>
</body>
</html>
